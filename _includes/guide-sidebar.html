{% comment %}
  Persistent sidebar for guide pages — renders domain navigation from domains.yaml.
  Version detection — same pattern used in _layouts/guides.html lines 4-9.
{% endcomment %}
{% assign versioned_page = page.url | startswith: '/version/' %}
{% if versioned_page %}
  {% assign docversion = page.url | replace_regex: '^/version/([^/]+)/.*', '\1' %}
{% else %}
  {% assign docversion = 'latest' %}
{% endif %}

{% comment %}
  Detect which domain the current page belongs to,
  so we can open that <details> section by default.
{% endcomment %}
{% assign current_domain = "" %}
{% for domain in site.data.domains.domains %}
  {% for entry in domain.guides %}
    {% if page.url == entry.url %}
      {% assign current_domain = domain.id %}
    {% endif %}
  {% endfor %}
{% endfor %}

<nav class="guide-sidebar" aria-label="Guide navigation">
  {% for domain in site.data.domains.domains %}
  {% if domain.guides.size > 0 %}
  <details {% if current_domain == domain.id %}open{% endif %}>
    <summary>{{ domain.title }}</summary>
    <ul>
      {% for entry in domain.guides %}
      <li {% if page.url == entry.url %}class="active"{% endif %}>
        <a href="{% if docversion == 'latest' %}{{ site.baseurl }}{{ entry.url }}{% else %}{{ site.baseurl }}/version/{{ docversion }}{{ entry.url }}{% endif %}"
           {% if page.url == entry.url %}aria-current="page"{% endif %}>
          {{ entry.nav-title | default: entry.title }}
          {% if entry.type == 'tutorial' %}<span class="type-badge">[T]</span>
          {% elsif entry.type == 'howto' %}<span class="type-badge">[H]</span>
          {% elsif entry.type == 'reference' %}<span class="type-badge">[R]</span>
          {% elsif entry.type == 'concepts' %}<span class="type-badge">[C]</span>
          {% endif %}
        </a>
      </li>
      {% endfor %}
    </ul>
  </details>
  {% endif %}
  {% endfor %}
</nav>
