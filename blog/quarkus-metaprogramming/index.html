<!DOCTYPE html>
<html lang="en">







<head>
  <title>Leveraging Quarkus build-time metaprogramming capabilities to improve Jackson's serialization performance - Quarkus</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="
  connect-src 'self' https://dpm.demdex.net https://adobedc.demdex.net https://route-default-test-mscherer-matamo.apps.ospo-osci.z3b1.p1.openshiftapps.com/ https://search.quarkus.io https://smetrics.redhat.com; 
  script-src 'self' 'unsafe-inline' 'unsafe-eval'
      
      https://assets.adobedtm.com
      js.bizographics.com
      https://www.redhat.com
      https://static.redhat.com
      https://app.requestly.io/
      jsonip.com
      https://ajax.googleapis.com
      https://use.fontawesome.com
      http://www.youtube.com
      http://www.googleadservices.com
      https://googleads.g.doubleclick.net
      https://giscus.app
      https://route-default-test-mscherer-matamo.apps.ospo-osci.z3b1.p1.openshiftapps.com/
      https://app.mailjet.com;

  style-src 'self' https://fonts.googleapis.com https://use.fontawesome.com; 
  img-src 'self' * data:; 
  media-src 'self'; 
  frame-src https://redhat.demdex.net https://www.youtube.com https://embed.restream.io https://app.mailjet.com http://xy0p2.mjt.lu https://mj.quarkus.io https://giscus.app; 
  base-uri 'none'; 
  object-src 'none'; 
  form-action 'none'; 
  font-src 'self' https://use.fontawesome.com https://fonts.gstatic.com;" />
  <script id="adobe_dtm" src="https://www.redhat.com/dtm.js" type="text/javascript"></script>
  <script src="/assets/javascript/highlight.pack.js" type="text/javascript"></script>
  <META HTTP-EQUIV='X-XSS-Protection' CONTENT="1; mode=block">
  <META HTTP-EQUIV='X-Content-Type-Options' CONTENT="nosniff">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Quarkus: Supersonic Subatomic Java">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@QuarkusIO"> 
  <meta name="twitter:creator" content="@QuarkusIO">
  <meta property="og:url" content="https://quarkus.io/blog/quarkus-metaprogramming/" />
  <meta property="og:title" content="Leveraging Quarkus build-time metaprogramming capabilities to improve Jackson's serialization performance" />
  <meta property="og:description" content="Quarkus: Supersonic Subatomic Java" />
  <meta property="og:image" content="https://quarkus.io/assets/images/quarkus_card.png" />
  
  <link rel="canonical" href="https://quarkus.io/blog/quarkus-metaprogramming/">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/guides/stylesheet/config.css" />
  <link rel="stylesheet" href="/assets/css/main.css?2021-07-29" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.5.2/css/all.css" crossorigin="anonymous">
  <link rel="alternate" type="application/rss+xml"  href="/feed.xml" title="Quarkus">
  <script src="/assets/javascript/hl.js" type="text/javascript"></script>
  
  
  
  
  <link rel="alternate" hreflang="en" href="https://quarkus.io/blog/quarkus-metaprogramming/" />
  
  <link rel="alternate" hreflang="pt-br" href="https://pt.quarkus.io/blog/quarkus-metaprogramming/" />
  
  <link rel="alternate" hreflang="es" href="https://es.quarkus.io/blog/quarkus-metaprogramming/" />
  
  <link rel="alternate" hreflang="zh" href="https://cn.quarkus.io/blog/quarkus-metaprogramming/" />
  
  <link rel="alternate" hreflang="ja" href="https://ja.quarkus.io/blog/quarkus-metaprogramming/" />
  
  <link rel="alternate" hreflang="x-default" href="https://quarkus.io/" />  
  <script src="/assets/javascript/tracking.js"></script>
  
  <script src="/assets/javascript/colormode.js" type="text/javascript"></script>

</head>

<body class="post">

  
  <div class="nav-wrapper">
  <div class="grid-wrapper">
    <div class="width-12-12">
      <input type="checkbox" id="checkbox" />
      <nav id="main-nav" class="main-nav">
        <div class="logo-wrapper">
           <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_600px_reverse.png" class="project-logo" title="Quarkus"></a>
        </div>
    <label class="nav-toggle" for="checkbox">
      <i class="fa fa-bars"></i>
    </label>
    <ul id="menu" class="menu">
      <li class="dropdown">
        <span href="/about/">Why<i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/about" class="">WHAT IS QUARKUS?</a></li>
          <li><a href="/container-first" class="">CONTAINER FIRST</a></li>
          <li><a href="/continuum" class="">VERSATILITY</a></li>
          <li><a href="/developer-joy" class="">DEVELOPER JOY</a></li>
          <li><a href="/kubernetes-native" class="">KUBERNETES NATIVE</a></li>
          <li><a href="/standards" class="">STANDARDS</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="/learn/">Learn<i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/get-started" class="">GET STARTED</a></li>
          <li><a href="/guides" class="">DOCUMENTATION</a></li>
          <li><a href="/qtips" class="">"Q" TIP VIDEOS</a></li>          
          <li><a href="/books" class="">BOOKS</a></li>
          </ul>
      </li>
      <li class="dropdown">
        <span href="https://quarkus.io/extensions/">Extensions<i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <!-- Note that quarkus.io is hardcoded here, because it is the only url which supports extensions -->
          <li><a href="https://quarkus.io/extensions/" class="">BROWSE EXTENSIONS</a></li>
          <li><a href="/faq/#what-is-a-quarkus-extension" class="">USE EXTENSIONS</a></li>
          <li><a href="/guides/writing-extensions" class="">CREATE EXTENSIONS</a></li>
          <li><a href="https://hub.quarkiverse.io" class="">SHARE EXTENSIONS</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="/community/">Community<i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/support/" class="">SUPPORT</a></li>
          <li><a href="/blog" class="active">BLOG</a></li>
          <li><a href="/discussion" class="">DISCUSSION</a></li>
          <li><a href="/working-groups" class="">WORKING GROUPS</a></li>
          <li><a href="/insights" class="">PODCAST</a></li>
          <li><a href="/events" class="">EVENTS</a></li>
          <li><a href="/newsletter" class="">NEWSLETTER</a></li>
          <li><a href="https://github.com/orgs/quarkusio/projects/13/views/1" class="">ROADMAP</a></li>
          </ul>
      </li>
      <li>
        <a href="https://code.quarkus.io" class="button-cta secondary white">START CODING</a>
      </li>
      <li class="dropdown">
        <span href="/language/"><div class="fas fa-globe langicon"></div><i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="https://quarkus.io/blog/quarkus-metaprogramming/" >OFFICIAL (ENGLISH)</a></li>
          <li><a href="https://pt.quarkus.io/blog/quarkus-metaprogramming/">PORTUGUÊS (BR)</a></li>
          <li><a href="https://es.quarkus.io/blog/quarkus-metaprogramming/">ESPAÑOL</a></li>
          <li><a href="https://cn.quarkus.io/blog/quarkus-metaprogramming/">简体中文</a></li>
          <li><a href="https://ja.quarkus.io/blog/quarkus-metaprogramming/">日本語</a></li>
          </ul>
      </li>
      <li>
        <span href="#" class="modeswitcher" id='theme-toggle'><i class="fas fa-sun"></i><i class="fas fa-moon"></i><i class="fas fa-cog"></i></span>
      </li>
    </ul>
      </nav>
    </div>
  </div>
</div>

  <div class="content">
    <div class="full-width-breadcrumb-bg align-self">
  <div class="width-12-12">
      <p class="returnlink"><a href="/blog">Blog</a> <i class="fas fa-chevron-right"></i> Leveraging Quarkus build-time metaprogramming capabilities to improve Jackson's serialization performance</p>
  </div>
</div>

<div class="post-page grid-wrapper">
  <div class="width-8-12 width-12-12-m doc-content">
    <div class="grid-wrapper">
      <div class="width-12-12">
        <div class="post-date">
          August 19, 2024 
          
            <span class="tags"><a href="/blog/tag/gizmo">#gizmo</a><a href="/blog/tag/jandex">#jandex</a><a href="/blog/tag/jackson">#jackson</a><a href="/blog/tag/performance">#performance</a></span>
          
        </div>
        <h1 class="post-title">Leveraging Quarkus build-time metaprogramming capabilities to improve Jackson's serialization performance</h1>
        <div class="grid-wrapper">
          <div class="width-8-12 width-12-12-m byline-wrapper">
            
            
              <img class="headshot" src="https://www.gravatar.com/avatar/48dfeef188c592772a5a0bcbdea7b7df">
            
            <p class="byline">By <a href="/author/mariofusco">Mario Fusco</a></p>
          </div>
          <div class="width-12-12">
              <div class="paragraph">
<p>One of the key architectural decisions taken by Quarkus designers has been moving as much work as possible from the startup time to the build time. This choice implies a clear separation between the deployment (aka. build-time) and runtime parts of each extension, and allows to perform the biggest part of the work once and for all during the build, thus allowing the typical Quarkus application to have a smaller footprint and faster load time.</p>
</div>
<div class="paragraph">
<p>A consequence of this architecture is the possibility of extensively leveraging <a href="https://en.wikipedia.org/wiki/Metaprogramming">metaprogramming</a>, identifying and analyzing the Java classes implementing the domain model of a given application and generating other code intended to opportunely and efficiently manipulate those classes. In particular the goal of the improvement discussed in this article is replacing the standard Jackson serialization mechanism, based on reflection, with code generated at build time.</p>
</div>
<div class="paragraph">
<p>Reflection is used (and abused) by many Java frameworks and libraries to support dynamic behavior. If more work is done at build time, this dynamism is no longer needed. Reducing reflection to a bare minimum gives performance improvements. It also makes the application more suitable for compilation to a native binary (the <a href="https://docs.oracle.com/en/learn/understanding-reflection-graalvm-native-image/index.html#step-2-the-closed-world-assumption">GraalVM closed world assumption</a>).</p>
</div>
<div class="paragraph">
<p>A similar idea has been already implemented also in the area of object to JSON serialization by <a href="https://github.com/quarkusio/qson">Qson</a>, a Quarkus extension that generates through Gizmo the bytecode of deserializer (parser) and serializer (writer) classes. However, this is a full replacement of Jackson and comes with some, quite significant, <a href="https://github.com/quarkusio/qson?tab=readme-ov-file#limitations">limitations</a>.</p>
</div>
<div class="paragraph">
<p>If you decide to remain on the most common choice and keep using Jackson for the JSON serialization of objects returned by the invocation of a REST endpoint, you will still pay the price of the heavily reflection-based implementation offered out of the box by that library. In this article I will illustrate how I filled this gap and, most importantly, what I learned on how to write a Quarkus extension, or in my case improve an existing one, and in particular on how to use tools like Jandex and Gizmo.</p>
</div>
<div class="sect1">
<h2 id="out-of-the-box-jacksons-reflection-based-serialization"><a class="anchor" href="#out-of-the-box-jacksons-reflection-based-serialization"></a>Out-of-the-box Jackson’s reflection-based serialization</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before trying to remove the use of reflection from Jackson&#8217;s serialization, let’s look at the current situation. To do so I added a <a href="https://github.com/franz1981/quarkus-profiling-workshop/blob/b0f1f61e2ed5f8b196d62bd74ad15d658e949d8c/src/main/java/profiling/workshop/json/CustomerLookupResource.java#L18">new REST endpoint</a> to the <a href="https://github.com/franz1981/quarkus-profiling-workshop">benchmark suite</a> written by <a href="https://x.com/forked_franz">Francesco Nigro</a> and myself that we also used for our <a href="https://www.youtube.com/watch?v=Cw4nN5L-2vU">Devoxx Belgium workshop on profiling</a>. The goal of this benchmark is stressing the JSON serialization, so this endpoint doesn’t do anything else other than returning and then serializing in JSON a fixed object, in essence, writing and returning a JSON like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "address": {
    "street": "viale Michelangelo",
    "town": "Mondragone"
  },
  "children": [
    {
      "age": 12,
      "firstName": "Sofia",
      "lastName": "Fusco"
    },
    {
      "age": 9,
      "firstName": "Marilena",
      "lastName": "Fusco"
    }
  ],
  "creditCards": [
    {
      "limit": 100,
      "name": "Visa"
    },
    {
      "limit": 150,
      "name": "Amex"
    }
  ],
  "age": 50,
  "firstName": "Mario",
  "lastName": "Fusco"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Running the benchmark suite against that endpoint I got the following result.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">Profiling for 20 seconds
Done
  Thread Stats   Avg  	Stdev 	Max   +/- Stdev
    Latency   115.82μs   77.29μs  14.88ms   93.27%
    Req/Sec   79104.05  14774.96  101709.00 	87.80
  3243266 requests in 40.001s,   1.30GB read
Requests/sec: 81079.62
Transfer/sec:  33.33MB</code></pre>
</div>
</div>
<div class="paragraph">
<p>or in other words my laptop can process just a bit more than 81K requests per second when serving that endpoint. We will see how getting rid of reflection will bring a 12% improvement of this figure, allowing it to process more than 92K requests per second, and in particular producing the following result.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">Profiling for 20 seconds
Done
  Thread Stats   Avg  	Stdev 	Max   +/- Stdev
    Latency   102.25μs   70.14μs  19.66ms   92.95%
    Req/Sec   90045.27  15073.98  103537.00 	97.56
  3691856 requests in 40.001s,   1.48GB read
Requests/sec: 92294.09
Transfer/sec:  37.94MB</code></pre>
</div>
</div>
<div class="paragraph">
<p>Being intended to be used for profiling, our benchmark suite also automatically produces a flamegraph of the benchmark under investigation. Zooming the resulting flamegraph on the <a href="https://github.com/quarkusio/quarkus/blob/5f2d29b4500e88ebd6a3c7a8731f6165fb6b64e0/extensions/resteasy-reactive/rest-jackson/runtime/src/main/java/io/quarkus/resteasy/reactive/jackson/runtime/serialisers/FullyFeaturedServerJacksonMessageBodyWriter.java#L52">method of the rest-jackson extension</a> triggering the JSON serialization we find the following situation where we can see that the <code>ObjectWriter::writeValue</code> Jackson’s method actually converting the object to its JSON representation has been found on the stack of 252 samples during the benchmark execution.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/images/posts/metaprogramming/f1.png" alt="f1">
</div>
<div class="title">Figure 1. Flamegraph of out of the box Jackson’s serialization</div>
</div>
<div class="paragraph">
<p>Further zooming the flamegraph on the Jackson’s <code>BeanPropertyWriter::serializeAsField</code> method and searching for the word “reflect” it is possible to see in how many different places, evidenced in purple in this flamegraph, Jackson needs to use Java reflection in order to read the state of the object to be serialized and write it into a JSON string.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/images/posts/metaprogramming/f2.png" alt="f2">
</div>
<div class="title">Figure 2. Use of reflection in out of the box Jackson’s serialization</div>
</div>
<div class="paragraph">
<p>As expected this use case requires a quite heavy use of reflection which is the thing that we want to avoid. We have already found that the JSON serialization is performed by the rest-jackson extension, so let’s see how we can modify it to achieve this goal.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="overriding-jackson-serialization"><a class="anchor" href="#overriding-jackson-serialization"></a>Overriding Jackson serialization</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Jackson makes it possible to override its standard reflection-based serialization behavior in a pretty simple way. It is sufficient to implement a class extending its <code>StdSerializer</code> thus defining how an instance of a given pojo should be rendered in JSON, something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class PersonSerializer extends StdSerializer {
    public PersonSerializer() {
        super(Person.class);
    }

    public void serialize(Object obj, JsonGenerator jsonGen, SerializerProvider serProv) throws IOException {
        Person person = (Person)obj;
        jsonGen.writeStartObject();
        jsonGen.writeNumberField("age", person.getAge());
        jsonGen.writeStringField("name", person.getName());
        jsonGen.writeEndObject();
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>and then to add this serializer to a module and register it on the ObjectMapper used by Jackson to perform the JSON serialization.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">SimpleModule module = new SimpleModule();
module.addSerializer(Person.class, new PersonSerializer());
ObjectMapper mapper = new ObjectMapper();
mapper.registerModule(module);</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this setup everytime Jackson will have to convert an instance of the <code>Person</code> class into its JSON representation it will do this through this custom serializer instead of accessing the person’s fields via reflection.</p>
</div>
<div class="paragraph">
<p>The strategy to implement reflection-free JSON serialization is then quite straightforward, but of course it would be great if the Quarkus extension could generate and register those serializers automatically and effortlessly. The first step to achieve this is discovering at deployment time for which classes we need to generate those serializers. In our case they are the classes returned by all the REST endpoints in our application, but of course the same approach could be extended to a wider scope.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="discovering-and-indexing-the-classes-to-be-serialized-with-jandex"><a class="anchor" href="#discovering-and-indexing-the-classes-to-be-serialized-with-jandex"></a>Discovering and indexing the classes to be serialized with Jandex</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In general <a href="https://quarkus.io/guides/cdi-reference#bean_discovery">bean discovery</a> is performed by Quarkus, which indexes all the beans that are part of the CDI process through <a href="https://smallrye.io/jandex/">Jandex</a>. Since it finds all the bean classes having a <a href="https://jakarta.ee/specifications/cdi/4.1/jakarta-cdi-spec-4.1.html#bean_defining_annotations">bean defining annotation</a>, this already includes all services exposing one or more REST endpoints that must have such an annotation. This means that all endpoints are already discovered by default. Even better, the <a href="https://jakarta.ee/specifications/cdi/4.1/jakarta-cdi-spec-4.1.html#bean_defining_annotations">quarkus-rest</a> extension already collects <a href="https://github.com/quarkusio/quarkus/blob/4ee036a19d64f537bea7836a25d5362091b0e8fc/extensions/resteasy-reactive/rest/deployment/src/main/java/io/quarkus/resteasy/reactive/server/deployment/ResteasyReactiveResourceMethodEntriesBuildItem.java#L30">an Entry for each rest method</a> in the <code>ResteasyReactiveResourceMethodEntriesBuildItem</code>.</p>
</div>
<div class="paragraph">
<p>Here each of these entries contains an instance of the Jandex <code>MethodInfo</code> that carries all the necessary offline reflection information about the signature of a Java method implementing a specific REST endpoint. As anticipated we are interested in the types returned by those methods, because those are the classes of the objects that will require to be converted in JSON as response to the REST endpoints invocation.</p>
</div>
<div class="paragraph">
<p>Now we have all the building blocks to start developing a <a href="https://quarkus.io/guides/writing-extensions#build-step-processors"><code>BuildStep</code></a> that collects, without duplications, all those return types, represented as Jandex <code>ClassInfo</code> s, and pass them to another service that will have the responsibility of generating the bytecode of a Jackson serializer for each of them.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
public void handleEndpointParams(ResteasyReactiveResourceMethodEntriesBuildItem resourceMethodEntries, JaxRsResourceIndexBuildItem jaxRsIndex) {

    	IndexView indexView = jaxRsIndex.getIndexView();

    	Map&lt;String, ClassInfo&gt; jsonClasses = new HashMap&lt;&gt;();
    	for (ResteasyReactiveResourceMethodEntriesBuildItem.Entry entry : resourceMethodEntries.getEntries()) {
        	MethodInfo methodInfo = entry.getMethodInfo();
        	ClassInfo returnClassInfo = indexView.getClassByName(methodInfo.returnType().name());
        	if (returnClassInfo != null) {
            	jsonClasses.put(returnClassInfo.name().toString(), returnClassInfo);
        	}
    	}

    	if (!jsonClasses.isEmpty()) {
        	// TODO: generate serializers for each returned type
    	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>where the <code>JaxRsResourceIndexBuildItem</code> provides the Jandex <code>IndexView</code> that allows access to all reflection information collected and indexed by Jandex. Since we already know that the JSON serialization will be triggered by the rest-jackson extension it is convenient to simply add this new <code>BuildStep</code> to the <a href="https://github.com/quarkusio/quarkus/blob/main/extensions/resteasy-reactive/rest-jackson/deployment/src/main/java/io/quarkus/resteasy/reactive/jackson/deployment/processor/ResteasyReactiveJacksonProcessor.java">BuildStepsProcessor already present in that extension</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="generating-the-jackson-serializers-with-gizmo"><a class="anchor" href="#generating-the-jackson-serializers-with-gizmo"></a>Generating the Jackson serializers with Gizmo</h2>
<div class="sectionbody">
<div class="paragraph">
<p>At this point we know the classes for which it will be necessary to automatically generate the bytecode implementing a Jackson serializer, something similar to the one sketched when discussing how to customize Jackson serialization.</p>
</div>
<div class="paragraph">
<p>Quarkus makes heavy use of <a href="https://github.com/quarkusio/gizmo/blob/main/USAGE.adoc">Gizmo</a> in all the many cases when it needs to perform some bytecode generation. Generating bytecode is a relatively low level task, so using a library like Gizmo, with a convenient higher level API that abstracts lots of the underlying complexity, is practically mandatory to perform this difficult task with a reasonable level of productivity and to keep the code readable and maintainable.</p>
</div>
<div class="paragraph">
<p>We don’t make an exception this time, so for each of the Jandex <code>ClassInfo</code> collected during the former step, Gizmo is used to generate the bytecode of a class extending the Jackson’s <code>StdSerializer</code> and having a name equal to the one of the bean to be serialized plus the <code>$quarkusjacksonserializer</code> suffix.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public void generate(ClassInfo classInfo) {
    String pojoClassName = classInfo.name().toString();
    String generatedClassName = pojoClassName + "$quarkusjacksonserializer";

	try (ClassCreator classCreator = new ClassCreator(
        	new GeneratedClassGizmoAdaptor(generatedClassBuildItemBuildProducer, true), generatedClassName, null,
        	StdSerializer.class.getName())) {

		// TODO: generate the serialize method for the given pojo
	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Without going into too many details the core logic of this serializer is contained in the <code>serialize</code> method that can be generated as follows</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">String JSON_GEN_CLASS_NAME = JsonGenerator.class.getName();
// public void serialize(Object var1, JsonGenerator var2, SerializerProvider var3) throws IOException { ...
MethodCreator serialize = classCreator.getMethodCreator("serialize", "void", "java.lang.Object", JSON_GEN_CLASS_NAME, "com.fasterxml.jackson.databind.SerializerProvider");
serialize.setModifiers(ACC_PUBLIC);
serialize.addException(IOException.class);

// jsonGenerator.writeStartObject();
MethodDescriptor writeStartObject = MethodDescriptor.ofMethod(JSON_GEN_CLASS_NAME, "writeStartObject", "void");
serialize.invokeVirtualMethod(writeStartObject, jsonGenerator);

// TODO: generate fields serialization

// jsonGenerator.writeEndObject();
MethodDescriptor writeEndObject = MethodDescriptor.ofMethod(JSON_GEN_CLASS_NAME, "writeEndObject", "void");
serialize.invokeVirtualMethod(writeEndObject, jsonGenerator);
serialize.returnVoid();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Querying the <code>ClassInfo</code> it is possible to iterate all the fields to be serialized, together with their accessor methods, in order to generate the code serializing in JSON each of those fields. For instance if valueHandle is the handle to the object to be serialized, which is the first argument of the signature of the <code>serialize</code> method, and <code>getterMethod</code> is the <code>MethodInfo</code> of a getter returning a numeric field, the corresponding code generating the serialization of that field can be something like</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// int number = value.getNumber()
ResultHandle fieldValueHandle = serialize.invokeVirtualMethod(MethodDescriptor.of(getterMethod), valueHandle);

// jsonGen.writeNumberField("number", number);
MethodDescriptor writerMethod = MethodDescriptor.ofMethod(JSON_GEN_CLASS_NAME, "writeNumberField", "void", "java.lang.String", "java.lang.Integer");
serialize.invokeVirtualMethod(writerMethod, jsonGenerator, serialize.load(fieldName), fieldValueHandle);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that, doing so, the logic to decide whether a field should be serialized or not, and how, totally bypasses the one implemented in Jackson and could sometimes differ from it. In particular this behavior can be explicitly modified by users through some specific Jackson annotations. To play safe when the serializers generator <a href="https://github.com/quarkusio/quarkus/blob/b3e608507e3bdcbcebe15a3d45de1b6cc6945d10/extensions/resteasy-reactive/rest-jackson/deployment/src/main/java/io/quarkus/resteasy/reactive/jackson/deployment/processor/JacksonSerializerFactory.java#L312">meets any of those annotations</a>, it simply gives up generating a serializer for the specific class containing it. In this circumstance the serialization of that class will be performed with the normal reflection-based mechanism employed by Jackson.</p>
</div>
<div class="paragraph">
<p>Actually I see this as a defect and I tried to figure out if I could reuse Jackson&#8217;s logic in some way also for this serializers generation. As discussed <a href="https://github.com/FasterXML/jackson-modules-base/issues/247">here</a>, the main problem is that a library like Jackson, but also the vast majority of the Java frameworks, doesn’t have a clear separation between deployment and runtime as it happens with Quarkus. This however also demonstrates the clear advantage of this separation as implemented in Quarkus, that allows to develop features and optimizations that are otherwise simply impossible for other tools.</p>
</div>
<div class="paragraph">
<p>Finally, we also need to take into account the fact that during the iteration of the fields of a class, the serializers generator also will very likely encounter other types belonging to the application’s business domain. In our original example the <code>Customer</code> has an <code>Address</code>, a <code>List&lt;Person&gt;</code> who are her children and a <code>CreditCard[]</code>. When this happens these new types are added to a queue of <code>ClassInfo</code> s for which another serializer has to be generated. The whole bytecode generation process terminates only when this queue is empty.</p>
</div>
<div class="paragraph">
<p>At the end of this process all the newly created classes are passed back to the <code>BuildStep</code> that will record them in the <code>ResteasyReactiveServerJacksonRecorder</code> thus making them available also at runtime.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
@Record(ExecutionTime.STATIC_INIT)
public void handleEndpointParams(CombinedIndexBuildItem index,
ResteasyReactiveServerJacksonRecorder recorder,
BuildProducer&lt;GeneratedClassBuildItem&gt; generatedClassBuildItemBuildProducer) {

	Map&lt;String, ClassInfo&gt; jsonClasses = new HashMap&lt;&gt;();

	// ... classes to be serialized discovery [omitted]

	if (!jsonClasses.isEmpty()) {
    	JacksonSerializerFactory factory = new JacksonSerializerFactory(
            	generatedClassBuildItemBuildProducer, index.getComputingIndex());
    	factory.create(jsonClasses.values())
            	.forEach(recorder::recordGeneratedSerializer);
	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For this reason it is necessary to add the <code>@Record</code> annotation to the <code>BuildStep</code> in order to indicate that it also outputs <a href="https://quarkus.io/guides/writing-extensions#bytecode-recording">recorded bytecode</a>. This concludes the description of all the steps necessary to the implementation of this new feature, that can be visually summarized as it follows.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/images/posts/metaprogramming/DeploymentVsRuntime.jpg" alt="DeploymentVsRuntime">
</div>
<div class="title">Figure 3. Blocks diagram describing the implementation of the generated reflection-free Jackson serializers</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="making-it-optional"><a class="anchor" href="#making-it-optional"></a>Making it optional</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Since it was not possible to reuse any of the heuristics used by Jackson to decide if and how a specific field should be serialized, and as discussed there could still exist some edge cases when the generated serializers produce a result that differs from what Jackson would do using reflection, we decided for now to disable this feature by default and give the possibility to users to opt-in. Considering that all the code implementing this new feature is self-contained in a single <code>BuildStep</code>, that is easily achievable using a <a href="https://quarkus.io/guides/writing-extensions#conditional-step-inclusion">conditional step inclusion</a>.</p>
</div>
<div class="paragraph">
<p>For this purpose it is sufficient to <a href="https://quarkus.io/guides/config-mappings">map a configuration to an interface</a> using the <code>@ConfigMapping</code> annotation</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ConfigMapping(prefix = "quarkus.rest.jackson.optimization")
@ConfigRoot(phase = ConfigPhase.BUILD_TIME)
public interface JacksonOptimizationConfig {
    @WithDefault("false")
    boolean enableReflectionFreeSerializers();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>and also having an implementation of a <code>BooleanSupplier</code> reading that configuration</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class IsReflectionFreeSerializersEnabled implements BooleanSupplier {
JacksonOptimizationConfig config;

    	@Override public boolean getAsBoolean() {
        	return config.enableReflectionFreeSerializers();
    	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>so that the <code>BuildStep</code> will be enabled only if this supplier returns true.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep(onlyIf = IsReflectionFreeSerializersEnabled.class)</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this way this optimization is turned off by default (note the <code>@WithDefault("false")</code> annotation on the boolean method) and can be enabled by simply adding the flag</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.rest.jackson.optimization.enable-reflection-free-serializers=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>to the <code>application.properties</code> configuration file. With this last change, the final code of the complete <code>BuildStep</code> is available <a href="https://github.com/quarkusio/quarkus/blob/39ec43201a690e7895b643e6c328d9042e73ccf0/extensions/resteasy-reactive/rest-jackson/deployment/src/main/java/io/quarkus/resteasy/reactive/jackson/deployment/processor/ResteasyReactiveJacksonProcessor.java#L374">here</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="putting-it-at-work-and-measuring-the-results"><a class="anchor" href="#putting-it-at-work-and-measuring-the-results"></a>Putting it at work and measuring the results</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that all the development has been done, let’s try to put this at work with the same benchmark from where we started and check if this change comes with a real performance gain as we hoped. First of all it is necessary to enable this feature by setting the above mentioned flag in the Quarkus <code>application.properties</code> file. Additionally it will be useful to also set a second flag enabling Quarkus to dump the decompiled bytecode generated at deployment time</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.rest.jackson.optimization.enable-reflection-free-serializers=true
quarkus.package.decompiler.enabled=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>In fact thanks to this second flag, after having recompiled our application, it is possible to find the bytecode of the generated classes under the folder <code>target/decompiled/generated-bytecode</code></p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/images/posts/metaprogramming/generated.png" alt="generated">
</div>
<div class="title">Figure 4. The Jackson serializers generated at deployment time</div>
</div>
<div class="paragraph">
<p>Here, other than the code already generated by Quarkus to perform the invocation of the REST endpoints without reflection, you can see all the classes, terminating in <code>$quarkusjacksonserializer</code>, implementing the reflection-free JSON serialization of all the classes in our domain. For instance for the Customer class it generates a Jackson’s <code>StdSerializer</code> implementation like the following.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class Customer$quarkusjacksonserializer extends StdSerializer {
    public Customer$quarkusjacksonserializer() {
        super(Customer.class);
    }

   public void serialize(Object var1, JsonGenerator var2, SerializerProvider var3) throws IOException {
  	Customer var4 = (Customer)var1;
  	var2.writeStartObject();
  	Address var5 = var4.getAddress();
  	var2.writePOJOField("address", var5);
  	List var6 = var4.getChildren();
  	var2.writePOJOField("children", var6);
  	CreditCard[] var7 = var4.getCreditCards();
  	var2.writePOJOField("creditCards", var7);
  	double var9 = var4.getIncome();
  	String[] var8 = new String[]{"admin"};
  	if (JacksonMapperUtil.includeSecureField(var8)) {
     	    var2.writeNumberField("income", var9);
  	}

  	int var11 = var4.getAge();
  	var2.writeNumberField("age", var11);
  	String var12 = ((Person)var4).getFirstName();
  	var2.writeStringField("firstName", var12);
  	String var13 = ((Person)var4).getLastName();
  	var2.writeStringField("lastName", var13);
  	var2.writeEndObject();
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As already anticipated, running again the benchmark with this optimization in place I got the following result</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">Profiling for 20 seconds
Done
  Thread Stats   Avg  	Stdev 	Max   +/- Stdev
    Latency   102.25μs   70.14μs  19.66ms   92.95%
    Req/Sec   90045.27  15073.98  103537.00 	97.56
  3691856 requests in 40.001s,   1.48GB read
Requests/sec: 92294.09
Transfer/sec:  37.94MB</code></pre>
</div>
</div>
<div class="paragraph">
<p>This time Quarkus can serve more than 92K requests per second, compared with the 81K we had before doing this work, quite an interesting improvement. Finally also the corresponding flamegraph helps to make sense of this improvement: there isn’t any trace of usage of Java reflection in it and now the <code>ObjectWriter::writeValue</code> Jackson’s method is sampled only 193 times instead of the 252 observed before.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/images/posts/metaprogramming/f3.png" alt="f3">
</div>
<div class="title">Figure 5. Flamegraph of serialization using the generated Jackson’s serializers demonstrating the absence of any usage of reflection</div>
</div>
<div class="paragraph">
<p>In fact in this case all the objects serializations, the one of the <code>Customer</code> instance returned by the rest endpoint plus all other objects referenced by it, are now performed by the serializers generated during the deployment phase, the ones with the class names terminating in <code>$quarkusjacksonserializer</code> and evidenced in purple in this last flamegraph.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/images/posts/metaprogramming/f4.png" alt="f4">
</div>
<div class="title">Figure 6. Flamegraph of serialization demonstrating how all the necessary generated serializers are invoked</div>
</div>
</div>
</div>
              
          </div>
          <div class="width-12-12"><div class="share-page">
  <a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https://quarkus.io/blog/quarkus-metaprogramming/&title=Leveraging Quarkus build-time metaprogramming capabilities to improve Jackson's serialization performance" rel="nofollow" target="_blank" title="Share on LinkedIn">
    <i class="fa-brands fa-linkedin fa-xl"></i>
  </a>
  <a class="share-x" href="https://x.com/intent/tweet?text=Leveraging Quarkus build-time metaprogramming capabilities to improve Jackson's serialization performance&url=https://quarkus.io/blog/quarkus-metaprogramming/&via=quarkusio&related=quarkusio" rel="nofollow" target="_blank" title="Share on X">
    <i class="fa-brands fa-square-x-twitter fa-xl"></i>
  </a>
  <a class="share-facebook" href="https://facebook.com/sharer.php?u=https://quarkus.io/blog/quarkus-metaprogramming/" rel="nofollow" target="_blank" title="Share on Facebook">
    <i class="fa-brands fa-square-facebook fa-xl"></i>
  </a>
  <a class="share-reddit" href="http://www.reddit.com/submit?url=https://quarkus.io/blog/quarkus-metaprogramming/" onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;" title="Share on Reddit" >
    <i class="fa-brands fa-square-reddit fa-xl"></i>
  </a>
  <a class="share-email" href="mailto:?subject=Leveraging Quarkus build-time metaprogramming capabilities to improve Jackson's serialization performance&amp;body=Leveraging Quarkus build-time metaprogramming capabilities to improve Jackson's serialization performance https://quarkus.io/blog/quarkus-metaprogramming/" title="Share via Email" >
    <i class="fa-solid fa-envelope fa-xl"></i>
  </a>
</div>
</div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="post-page grid-wrapper">
  <div class="width-8-12 width-12-12-m doc-content">
  <script src="https://giscus.app/client.js"
        data-repo="quarkusio/quarkus"
        data-repo-id="MDEwOlJlcG9zaXRvcnkxMzk5MTQ5MzI="
        data-category="Quarkus Blog/Website"
        data-category-id="DIC_kwDOCFbutM4CAFFV"
        data-mapping="og:title"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-theme="preferred_color_scheme"
        data-lang="en"
        crossorigin="anonymous"
        async>
  </script>
  </div>
</div>

  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_reverse.svg" class="project-logo" title="Quarkus"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">Quarkus is open. All dependencies of this project are available under the <a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>Apache Software License 2.0</a> or compatible license.<br /><br />This website was built with <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a>, is hosted on <a href='https://pages.github.com/' target='_blank'>GitHub Pages</a> and is completely open source. If you want to make it better, <a href='https://github.com/quarkusio/quarkusio.github.io' target='_blank'>fork the website</a> and show us what you’ve got.</p>

    
      <div class="width-1-12 project-links">
        <span>Navigation</span>
        <ul class="footer-links">
          
          
            <li><a href="/" target="_blank">Home</a></li>
          
          
          
            <li><a href="/about" target="_blank">About</a></li>
          
          
          
            <li><a href="/blog" target="_blank">Blog</a></li>
          
          
          
            <li><a href="/insights" target="_blank">Podcast</a></li>
          
          
          
            <li><a href="/events" target="_blank">Events</a></li>
          
          
          
            <li><a href="/newsletter" target="_blank">Newsletter</a></li>
          
          
          
            <li><a href="https://github.com/orgs/quarkusio/projects/13/views/1" target="_blank">Roadmap</a></li>
          
          
          
            <li><a href="/security" target="_blank">Security&nbsp;policy</a></li>
          
          
          
            <li><a href="/usage" target="_blank">Usage</a></li>
          
          
          
            <li><a href="/brand" target="_blank">Brand</a></li>
          
          
          
            <li><a href="/desktopwallpapers" target="_blank">Wallpapers</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Follow Us</span>
        <ul class="footer-links">
          
          
            <li><a href="https://x.com/quarkusio" target="_blank">X</a></li>
          
          
          
            <li><a rel="me" href="https://fosstodon.org/@quarkusio" target="_blank">Mastodon</a></li>
            
          
          
            <li><a href="https://www.facebook.com/quarkusio" target="_blank">Facebook</a></li>
          
          
          
            <li><a href="https://www.linkedin.com/company/quarkusio/" target="_blank">Linkedin</a></li>
          
          
          
            <li><a href="https://www.youtube.com/channel/UCaW8QG_QoIk_FnjLgr5eOqg" target="_blank">Youtube</a></li>
          
          
          
            <li><a href="https://github.com/quarkusio" target="_blank">GitHub</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-2-12 project-links">
        <span>Get Help</span>
        <ul class="footer-links">
          
          
            <li><a href="/support" target="_blank">Support</a></li>
          
          
          
            <li><a href="/guides" target="_blank">Guides</a></li>
          
          
          
            <li><a href="/faq" target="_blank">FAQ</a></li>
          
          
          
            <li><a href="/get-started" target="_blank">Get Started</a></li>
          
          
          
            <li><a href="https://stackoverflow.com/questions/tagged/quarkus" target="_blank">Stack Overflow</a></li>
          
          
          
            <li><a href="https://github.com/quarkusio/quarkus/discussions" target="_blank">Discussions</a></li>
          
          
          
            <li><a href="https://groups.google.com/forum/#!forum/quarkus-dev" target="_blank">Development mailing list</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Languages</span>
        <ul class="footer-links">
          
          
            <li><a href="https://quarkus.io/" target="_blank">English</a></li>
          
          
          
            <li><a href="https://pt.quarkus.io/" target="_blank">Português&nbsp;(Brasileiro)</a></li>
          
          
          
            <li><a href="https://es.quarkus.io/" target="_blank">Español</a></li>
          
          
          
            <li><a href="https://cn.quarkus.io/" target="_blank">简体中文</a></li>
          
          
          
            <li><a href="https://ja.quarkus.io/" target="_blank">日本語</a></li>
          
          
        </ul>
      </div>
    

    
      <div class="width-4-12 more-links">
        <span>Quarkus is made of community projects</span>
        <ul class="footer-links">
          
            <li><a blah href="https://vertx.io/" target="_blank">Eclipse Vert.x</a></li>
          
            <li><a blah href="https://smallrye.io" target="_blank">SmallRye</a></li>
          
            <li><a blah href="https://hibernate.org" target="_blank">Hibernate</a></li>
          
            <li><a blah href="https://netty.io" target="_blank">Netty</a></li>
          
            <li><a blah href="https://resteasy.github.io" target="_blank">RESTEasy</a></li>
          
            <li><a blah href="https://camel.apache.org" target="_blank">Apache Camel</a></li>
          
            <li><a blah href="https://microprofile.io" target="_blank">Eclipse MicroProfile</a></li>
          
            <li><a blah href="https://code.quarkus.io/" target="_blank">And many more...</a></li>
          
        </ul>
      </div>
    
  </div>
</div>

  <div class="content redhat-footer">
  <div class="grid-wrapper">
    <span class="licence">
      <i class="fab fa-creative-commons"></i><i class="fab fa-creative-commons-by"></i> <a href="https://creativecommons.org/licenses/by/3.0/" target="_blank">CC by 3.0</a> | <a href="https://www.redhat.com/en/about/privacy-policy">Privacy Policy</a>
    </span>
    <span class="redhat">
      Sponsored by
    </span>
    <span class="redhat-logo">
      <a href="https://www.redhat.com/" target="_blank"><img src="/assets/images/redhat_reversed.svg"></a>
    </span>
  </div>
</div>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/scroll-down.js"></script>
  <script src="/assets/javascript/satellite.js" type="text/javascript"></script>
  <script src="/guides/javascript/config.js" type="text/javascript"></script>
  <script src="/assets/javascript/guides-version-dropdown.js" type="text/javascript"></script>
  <script src="/assets/javascript/back-to-top.js" type="text/javascript"></script>
  <script src="/assets/javascript/clipboard.min.js" type="text/javascript"></script>
  <script src="/assets/javascript/copy.js" type="text/javascript"></script>
  <script src="/assets/javascript/asciidoc-tabs.js" type="text/javascript"></script>
  <script src="/assets/javascript/future-date.js" type="text/javascript"></script>
</body>

</html>
