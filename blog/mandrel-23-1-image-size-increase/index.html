<!DOCTYPE html>
<html lang="en">







<head>
  <title>Exploring why native executables produced with Mandrel 23.1 are bigger than those produced with Mandrel 23.0 - Quarkus</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="
  connect-src 'self' https://dpm.demdex.net https://adobedc.demdex.net https://analytics.ossupstream.org/ https://search.quarkus.io https://smetrics.redhat.com; 
  script-src 'self' 'unsafe-inline' 'unsafe-eval'
      
      https://assets.adobedtm.com
      js.bizographics.com
      https://www.redhat.com
      https://static.redhat.com
      https://app.requestly.io/
      jsonip.com
      https://ajax.googleapis.com
      https://use.fontawesome.com
      http://www.youtube.com
      http://www.googleadservices.com
      https://googleads.g.doubleclick.net
      https://giscus.app
      https://analytics.ossupstream.org/
      https://app.mailjet.com;

  style-src 'self' https://fonts.googleapis.com https://use.fontawesome.com; 
  img-src 'self' * data:; 
  media-src 'self'; 
  frame-src https://redhat.demdex.net https://www.youtube.com https://player.restream.io https://app.mailjet.com http://xy0p2.mjt.lu https://mj.quarkus.io https://giscus.app; 
  base-uri 'none'; 
  object-src 'none'; 
  form-action 'none'; 
  font-src 'self' https://use.fontawesome.com https://fonts.gstatic.com;" />
  <script id="adobe_dtm" src="https://www.redhat.com/dtm.js" type="text/javascript"></script>
  <script src="/assets/javascript/highlight.pack.js" type="text/javascript"></script>
  <META HTTP-EQUIV='X-XSS-Protection' CONTENT="1; mode=block">
  <META HTTP-EQUIV='X-Content-Type-Options' CONTENT="nosniff">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Quarkus: Supersonic Subatomic Java">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@QuarkusIO"> 
  <meta name="twitter:creator" content="@QuarkusIO">
  <meta property="og:url" content="https://quarkus.io/blog/mandrel-23-1-image-size-increase/" />
  <meta property="og:title" content="Exploring why native executables produced with Mandrel 23.1 are bigger than those produced with Mandrel 23.0" />
  <meta property="og:description" content="Quarkus: Supersonic Subatomic Java" />
  <meta property="og:image" content="https://quarkus.io/assets/images/quarkus_card.png" />
  
  <link rel="canonical" href="https://quarkus.io/blog/mandrel-23-1-image-size-increase/">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/guides/stylesheet/config.css" />
  <link rel="stylesheet" href="/assets/css/main.css?2021-07-29" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.5.2/css/all.css" crossorigin="anonymous">
  <link rel="alternate" type="application/rss+xml"  href="/feed.xml" title="Quarkus">
  <script src="/assets/javascript/hl.js" type="text/javascript"></script>
  
  
  
  
  <link rel="alternate" hreflang="en" href="https://quarkus.io/blog/mandrel-23-1-image-size-increase/" />
  
  <link rel="alternate" hreflang="pt-br" href="https://pt.quarkus.io/blog/mandrel-23-1-image-size-increase/" />
  
  <link rel="alternate" hreflang="es" href="https://es.quarkus.io/blog/mandrel-23-1-image-size-increase/" />
  
  <link rel="alternate" hreflang="zh" href="https://cn.quarkus.io/blog/mandrel-23-1-image-size-increase/" />
  
  <link rel="alternate" hreflang="ja" href="https://ja.quarkus.io/blog/mandrel-23-1-image-size-increase/" />
  
  <link rel="alternate" hreflang="x-default" href="https://quarkus.io/" />  
  <script src="/assets/javascript/tracking.js"></script>
  
  <script src="/assets/javascript/colormode.js" type="text/javascript"></script>

</head>

<body class="post">

  
  <div class="nav-wrapper">
  <div class="grid-wrapper">
    <div class="width-12-12">
      <input type="checkbox" id="checkbox" />
      <nav id="main-nav" class="main-nav">
        <div class="logo-wrapper">
           <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_600px_reverse.png" class="project-logo" title="Quarkus"></a>
        </div>
    <label class="nav-toggle" for="checkbox">
      <i class="fa fa-bars"></i>
    </label>
    <ul id="menu" class="menu">
      <li class="dropdown">
        <span href="/about/">Why<i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/about" class="">WHAT IS QUARKUS?</a></li>
          <li><a href="/developer-joy" class="">DEVELOPER JOY</a></li>
          <li><a href="/performance" class="">PERFORMANCE</a></li>
          <li><a href="/kubernetes-native" class="">KUBERNETES NATIVE</a></li>
          <li><a href="/standards" class="">STANDARDS</a></li>
          <li><a href="/versatility" class="">VERSATILITY</a></li>
          <li><a href="/container-first" class="">CONTAINER FIRST</a></li>          
        </ul>
      </li>
      <li class="dropdown">
        <span href="/learn/">Learn<i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/get-started" class="">GET STARTED</a></li>
          <li><a href="/guides" class="">DOCUMENTATION</a></li>
          <li><a href="/userstories/" class="">USER STORIES</a></li>  
          <li><a href="/qtips" class="">"Q" TIP VIDEOS</a></li>          
          <li><a href="/books" class="">BOOKS</a></li>
          </ul>
      </li>
      <li class="dropdown">
        <span href="https://quarkus.io/extensions/">Extensions<i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <!-- Note that quarkus.io is hardcoded here, because it is the only url which supports extensions -->
          <li><a href="https://quarkus.io/extensions/" class="">BROWSE EXTENSIONS</a></li>
          <li><a href="/faq/#what-is-a-quarkus-extension" class="">USE EXTENSIONS</a></li>
          <li><a href="/guides/writing-extensions" class="">CREATE EXTENSIONS</a></li>
          <li><a href="https://hub.quarkiverse.io" class="">SHARE EXTENSIONS</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="/community/">Community<i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/support/" class="">SUPPORT</a></li>
          <li><a href="/blog" class="active">BLOG</a></li>
          <li><a href="/discussion" class="">DISCUSSION</a></li>
          <li><a href="/working-groups" class="">WORKING GROUPS</a></li>
          <li><a href="/insights" class="">PODCAST</a></li>
          <li><a href="/events" class="">EVENTS</a></li>
          <li><a href="/newsletter" class="">NEWSLETTER</a></li>
          <li><a href="https://github.com/orgs/quarkusio/projects/13/views/1" class="">ROADMAP</a></li>
          </ul>
      </li>
      <li>
        <a href="https://code.quarkus.io" class="button-cta secondary white">START CODING</a>
      </li>
      <li class="dropdown">
        <span href="/language/"><div class="fas fa-globe langicon"></div><i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="https://quarkus.io/blog/mandrel-23-1-image-size-increase/" >OFFICIAL (ENGLISH)</a></li>
          <li><a href="https://pt.quarkus.io/blog/mandrel-23-1-image-size-increase/">PORTUGUÊS (BR)</a></li>
          <li><a href="https://es.quarkus.io/blog/mandrel-23-1-image-size-increase/">ESPAÑOL</a></li>
          <li><a href="https://cn.quarkus.io/blog/mandrel-23-1-image-size-increase/">简体中文</a></li>
          <li><a href="https://ja.quarkus.io/blog/mandrel-23-1-image-size-increase/">日本語</a></li>
          </ul>
      </li>
      <li>
        <span href="#" class="modeswitcher" id='theme-toggle'><i class="fas fa-sun"></i><i class="fas fa-moon"></i><i class="fas fa-cog"></i></span>
      </li>
    </ul>
      </nav>
    </div>
  </div>
</div>

  <div class="content">
    <div class="full-width-breadcrumb-bg align-self">
  <div class="width-12-12">
      <p class="returnlink"><a href="/blog">Blog</a> <i class="fas fa-chevron-right"></i> Exploring why native executables produced with Mandrel 23.1 are bigger than those produced with Mandrel 23.0</p>
  </div>
</div>

<div class="post-page grid-wrapper">
  <div class="width-8-12 width-12-12-m doc-content">
    <div class="grid-wrapper">
      <div class="width-12-12">
        <div class="post-date">
          November 08, 2023 
          
            <span class="tags"><a href="/blog/tag/native">#native</a><a href="/blog/tag/graalvm">#graalvm</a><a href="/blog/tag/mandrel">#mandrel</a><a href="/blog/tag/metrics">#metrics</a></span>
          
        </div>
        <h1 class="post-title">Exploring why native executables produced with Mandrel 23.1 are bigger than those produced with Mandrel 23.0</h1>
        <div class="grid-wrapper">
          <div class="width-8-12 width-12-12-m byline-wrapper">
            
            
              <img class="headshot" src="https://www.gravatar.com/avatar/3772ed72c143c2f0fe110d1a4124a46a">
            
            <p class="byline">By <a href="/author/zakkak">Foivos Zakkak</a></p>
          </div>
          <div class="width-12-12">
              <p>This article is a follow-up to <a href="../mandrel-23-0-image-size-increase/">Exploring why native executables produced with Mandrel 23.0 are bigger than with Mandrel 22.3</a>.</p>

<p>Starting with Quarkus 3.5 the default Mandrel version was updated from 23.0 to 23.1.</p>

<p>This update brought a number of bugfixes as well as new features like:</p>

<ol>
  <li>Preview of <a href="https://github.com/oracle/graal/blob/master/docs/reference-manual/native-image/ForeignInterface.md">Foreign Function &amp; Memory API downcalls</a> (part of “Project Panama”, <a href="https://openjdk.org/jeps/442">JEP 442</a>) on AMD64. Must be enabled with <code class="language-plaintext highlighter-rouge">--enable-preview</code>.</li>
  <li>New option <code class="language-plaintext highlighter-rouge">-H:±IndirectBranchTargetMarker</code> to mark indirect branch targets on AMD64 with an endbranch instruction. This is a prerequisite for future Intel CET support.</li>
  <li>Throw <code class="language-plaintext highlighter-rouge">MissingReflectionRegistrationError</code> when attempting to create a proxy class without having it registered at build-time, instead of a <code class="language-plaintext highlighter-rouge">VMError</code>.</li>
  <li>Support for <code class="language-plaintext highlighter-rouge">-XX:+HeapDumpOnOutOfMemoryError</code>.</li>
  <li>New <code class="language-plaintext highlighter-rouge">--parallelism</code> option to control how many threads are used by the build process.</li>
  <li>Simulation of class initializer: Class initializer of classes that are not marked for initialization at image build time are simulated at image build time to avoid executing them at image run time.</li>
  <li>and <a href="https://github.com/oracle/graal/blob/master/substratevm/CHANGELOG.md#graalvm-for-jdk-21-internal-version-2310">more</a></li>
</ol>

<p>However, it also brought an unwanted side effect.
The native executables produced with Mandrel 23.1 are bigger than the ones produced with Mandrel 23.0.
To better understand why that happens we perform a thorough analysis to attribute the size increase to specific changes in Mandrel’s code base.</p>

<h2 id="tldr">TL;DR</h2>

<p>According to our analysis the binary size increase is attributed to two distinct changes, both of which are necessary for getting more accurate profiles when using the <a href="https://github.com/oracle/graal/discussions/7707#discussioncomment-7443058">async-sampler</a>.</p>

<ul>
  <li><a href="https://github.com/oracle/graal/pull/7003"><strong>Add support for profiling of topmost frame</strong></a></li>
  <li><a href="https://github.com/oracle/graal/pull/6763"><strong>ProfilingSampler does not need local variable values</strong></a> (specifically <a href="https://github.com/oracle/graal/commit/d747c30c7691012c39989a8597fd850c68b740ad">the commit “Always store bci in frame info”</a>)</li>
</ul>

<h2 id="better-understanding-what-is-different-between-the-generated-native-executables">Better understanding what is different between the generated native executables</h2>

<p>To perform the analysis we use the <a href="https://github.com/quarkus-qe/quarkus-startstop">Quarkus startstop test</a> (specifically commit <code class="language-plaintext highlighter-rouge">a8bae846881607e376c7c8a96116b6b50ee50b70</code>) which generates, starts, tests, and stops small Quarkus applications and measures various time-related metrics (e.g. time-to-first-OK-request) and memory usage.
We get the test with:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/quarkus-qe/quarkus-startstop
<span class="nb">cd </span>quarkus-startstop
git checkout a8bae846881607e376c7c8a96116b6b50ee50b70
</code></pre></div></div>

<p>and build it with:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mvn clean package <span class="nt">-Pnative</span> <span class="nt">-Dquarkus</span>.version<span class="o">=</span>3.5.0<span class="se">\</span>
    <span class="nt">-Dquarkus</span>.native.builder-image<span class="o">=</span>quay.io/quarkus/ubi-quarkus-mandrel-builder-image:jdk-17
</code></pre></div></div>

<p>changing the builder image tag to <code class="language-plaintext highlighter-rouge">jdk-20</code> and <code class="language-plaintext highlighter-rouge">jdk-21</code> for building with Mandrel 23.0 (based on JDK 20) and Mandrel 23.1 (based on JDK 21) respectively.</p>

<p>The reason we also use <code class="language-plaintext highlighter-rouge">jdk-20</code> although deprecated is to see the effects of the base JDK when using the same code base (<code class="language-plaintext highlighter-rouge">jdk-17</code> and <code class="language-plaintext highlighter-rouge">jdk-20</code> are based on the same Mandrel source code but are built using a different base JDK version).</p>

<p>Looking at the build output (generated by Quarkus in <code class="language-plaintext highlighter-rouge">target/my-app-native-image-sources/my-app-build-output-stats.json</code>) the main differences between the three builds are in the following metrics:</p>

<table>
  <thead>
    <tr>
      <th>Mandrel version</th>
      <th>23.0.2.1 (jdk-17)</th>
      <th>23.0.1.2 (jdk-20)</th>
      <th>23.1.1.0 (jdk-21)</th>
      <th>Increase jdk-17 to jdk-20 %</th>
      <th>Increase jdk-20 to jdk-21 %</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Image Heap Size</td>
      <td>29790208</td>
      <td>30982144</td>
      <td>33546240</td>
      <td>4</td>
      <td>8.3</td>
    </tr>
    <tr>
      <td>Objects count</td>
      <td>351565</td>
      <td>353273</td>
      <td>356059</td>
      <td>0.5</td>
      <td>0.8</td>
    </tr>
    <tr>
      <td>Resources Size</td>
      <td>169205</td>
      <td>174761</td>
      <td>175392</td>
      <td>3.3</td>
      <td>0.36</td>
    </tr>
    <tr>
      <td>Resources Count</td>
      <td>28</td>
      <td>28</td>
      <td>79</td>
      <td>0</td>
      <td>182</td>
    </tr>
    <tr>
      <td>Total Image Size</td>
      <td>60006728</td>
      <td>61734352</td>
      <td>64224536</td>
      <td>2.88</td>
      <td>4</td>
    </tr>
  </tbody>
</table>

<p>Which indicates that the base JDK plays significant role in the image size increase, leaving the question open on whether the further increase in the generated binary size between <code class="language-plaintext highlighter-rouge">jdk-20</code> and <code class="language-plaintext highlighter-rouge">jdk-21</code> is due to the JDK difference or due to changes in Mandrel itself.</p>

<p>It is also interesting that despite the resource count increase between Mandrel 23.0 (jdk-20) and Mandrel 23.1 (jdk-21) the resource size is not affected that much.
As a result, we focus our analysis on the Image Heap Size which increases disproportionally to the objects count between the different Mandrel versions indicating that either some objects became bigger, or the few new objects being added to the heap are quite big.</p>

<h3 id="dashboards">Dashboards</h3>

<p>GraalVM and Mandrel provide the <code class="language-plaintext highlighter-rouge">-H:+DashboardAll</code> and <code class="language-plaintext highlighter-rouge">-H:+DashboardJson</code> flags that can be used to generate dashboards that contain more information about the generated native executable.
The resulting dashboard contains a number of metrics and looks like this:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"points-to"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type-flows"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="err">...</span><span class="w">
    </span><span class="p">]</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"code-breakdown"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"code-size"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"io.smallrye.mutiny.CompositeException.getFirstOrFail(Throwable[]) Throwable"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">575</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="err">...</span><span class="w">
    </span><span class="p">]</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"heap-breakdown"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"heap-size"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Lio/vertx/core/impl/VerticleManager$$Lambda$bf09d38f5d19578a0d041ffd0a524c1cbe1843df;"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">24</span><span class="p">,</span><span class="w">
        </span><span class="nl">"count"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="err">...</span><span class="w">
    </span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Using the aforementioned flags we generate dashboards using both Mandrel 23.1 and 23.0 and compare the results.</p>

<p>To generate the dashboards using Mandrel 23.0 we use the following command:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mvn package <span class="nt">-Pnative</span> <span class="se">\</span>
  <span class="nt">-Dquarkus</span>.version<span class="o">=</span>3.5.0 <span class="se">\</span>
  <span class="nt">-Dquarkus</span>.native.builder-image<span class="o">=</span>quay.io/quarkus/ubi-quarkus-mandrel-builder-image:jdk-20 <span class="se">\</span>
  <span class="nt">-Dquarkus</span>.native.additional-build-args<span class="o">=</span><span class="nt">-H</span>:+DashboardAll,-H:+DashboardJson,-H:DashboardDump<span class="o">=</span>path/to/23.0.dashboard.json
</code></pre></div></div>

<p>Similarly to generate the dashboards using Mandrel 23.1 we use the following command:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mvn package <span class="nt">-Pnative</span> <span class="se">\</span>
  <span class="nt">-Dquarkus</span>.version<span class="o">=</span>3.5.0 <span class="se">\</span>
  <span class="nt">-Dquarkus</span>.native.builder-image<span class="o">=</span>quay.io/quarkus/ubi-quarkus-mandrel-builder-image:jdk-21 <span class="se">\</span>
  <span class="nt">-Dquarkus</span>.native.additional-build-args<span class="o">=</span><span class="nt">-H</span>:+DashboardAll,-H:+DashboardJson,-H:DashboardDump<span class="o">=</span>path/to/23.1.dashboard.json
</code></pre></div></div>

<p>Note: Make sure to change <code class="language-plaintext highlighter-rouge">path/to/</code> to the path where you would like the dashboard json files to be stored, each file is about 370MB big.</p>

<h3 id="analyzing-and-visualizing-the-data">Analyzing and visualizing the data</h3>

<p>To process the data from the dashboards we used a Jupyter notebook, like we do in this article.
To grab the notebook follow <a href="/assets/examples/posts/mandrel-23-1-image-size-increase/quarkus-size-23-0-23-1.ipynb">this link</a>.</p>

<h4 id="loading-the-data-from-the-json-files">Loading the data from the json files</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>

<span class="c1"># load data from JSON file
</span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'23.0.dashboard.json'</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">data23_0</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'23.1.dashboard.json'</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">data23_1</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="c1"># create dataframes from json data
</span><span class="n">df23_0</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data23_0</span><span class="p">)</span>
<span class="n">df23_1</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data23_1</span><span class="p">)</span>

</code></pre></div></div>

<h2 id="is-the-heap-image-bigger-because-the-objects-in-the-heap-are-bigger-than-before-or-because-we-store-more-objects-in-it">Is the heap image bigger because the objects in the heap are bigger than before or because we store more objects in it?</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Get heap-size lists from dataframes
</span><span class="n">heap_size_23_0</span> <span class="o">=</span> <span class="n">df23_0</span><span class="p">[</span><span class="s">'heap-breakdown'</span><span class="p">][</span><span class="s">'heap-size'</span><span class="p">]</span>
<span class="n">heap_size_23_1</span> <span class="o">=</span> <span class="n">df23_1</span><span class="p">[</span><span class="s">'heap-breakdown'</span><span class="p">][</span><span class="s">'heap-size'</span><span class="p">]</span>

<span class="c1"># create dataframes from heap_size lists
</span><span class="n">heap_df23_0</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">heap_size_23_0</span><span class="p">).</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s">'size'</span><span class="p">:</span> <span class="s">'size-23.0'</span><span class="p">,</span> <span class="s">'count'</span><span class="p">:</span> <span class="s">'count-23.0'</span><span class="p">})</span>
<span class="n">heap_df23_1</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">heap_size_23_1</span><span class="p">).</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s">'size'</span><span class="p">:</span> <span class="s">'size-23.1'</span><span class="p">,</span> <span class="s">'count'</span><span class="p">:</span> <span class="s">'count-23.1'</span><span class="p">})</span>
</code></pre></div></div>

<h3 id="whats-the-average-object-size">What’s the average object size?</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="s">"Average object size for Mandrel 23.0: {:.2f}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">heap_df23_0</span><span class="p">[</span><span class="s">'size-23.0'</span><span class="p">].</span><span class="n">mean</span><span class="p">()))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Average object size for Mandrel 23.1: {:.2f}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">heap_df23_1</span><span class="p">[</span><span class="s">'size-23.1'</span><span class="p">].</span><span class="n">mean</span><span class="p">()))</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Average object size for Mandrel 23.0: 8137.46
Average object size for Mandrel 23.1: 8880.06
</code></pre></div></div>

<h3 id="whats-the-minimum-and-maximum-object-size-in-each-case">What’s the minimum and maximum object size in each case?</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="s">"Minimum object size for Mandrel 23.0:"</span><span class="p">,</span> <span class="n">heap_df23_0</span><span class="p">[</span><span class="s">'size-23.0'</span><span class="p">].</span><span class="nb">min</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Minimum object size for Mandrel 23.1:"</span><span class="p">,</span> <span class="n">heap_df23_1</span><span class="p">[</span><span class="s">'size-23.1'</span><span class="p">].</span><span class="nb">min</span><span class="p">())</span>
<span class="n">max_size_23_0</span> <span class="o">=</span> <span class="n">heap_df23_0</span><span class="p">[</span><span class="s">'size-23.0'</span><span class="p">].</span><span class="nb">max</span><span class="p">()</span>
<span class="n">max_size_23_1</span> <span class="o">=</span> <span class="n">heap_df23_1</span><span class="p">[</span><span class="s">'size-23.1'</span><span class="p">].</span><span class="nb">max</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Maximum object size for Mandrel 23.0:"</span><span class="p">,</span> <span class="n">max_size_23_0</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Maximum object size for Mandrel 23.1:"</span><span class="p">,</span> <span class="n">max_size_23_1</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Minimum object size for Mandrel 23.0: 16
Minimum object size for Mandrel 23.1: 16
Maximum object size for Mandrel 23.0: 14149496
Maximum object size for Mandrel 23.1: 16933168
</code></pre></div></div>

<p>We observe that the maximum object size when compiling with Mandrel 23.1 is about 2.6MB bigger than the maximum object size when compiling with Mandrel 23.0.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">max_size_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_size_23_1</span> <span class="o">-</span> <span class="n">max_size_23_0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Max size difference in MB: {:.2f}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">max_size_diff</span><span class="p">))</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Max size difference in MB: 2.65
</code></pre></div></div>

<h3 id="which-objects-are-the-bigger-ones">Which objects are the bigger ones?</h3>

<p>As a result, next we search to see which objects are the bigger ones in both cases and what is their corresponding size in the other Mandrel version.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">max_size_23_0_rows</span> <span class="o">=</span> <span class="n">heap_df23_0</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">heap_df23_0</span><span class="p">[</span><span class="s">'size-23.0'</span><span class="p">]</span> <span class="o">==</span> <span class="n">max_size_23_0</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Objects with size equal to max_size_23_0 in heap_size_23_0:"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">max_size_23_0_rows</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Objects with size equal to max_size_23_0 in heap_size_23_0:
     name  size-23.0  count-23.0
1340   [B   14149496      110914
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">max_size_23_1_rows</span> <span class="o">=</span> <span class="n">heap_df23_1</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">heap_df23_1</span><span class="p">[</span><span class="s">'size-23.1'</span><span class="p">]</span> <span class="o">==</span> <span class="n">max_size_23_1</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Objects with size equal to max_size_23_1 in heap_size_23_1:"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">max_size_23_1_rows</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Objects with size equal to max_size_23_1 in heap_size_23_1:
     name  size-23.1  count-23.1
1351   [B   16933168      111454
</code></pre></div></div>

<p>Not surprisingly, we detect that the object type with the maximum size in both cases is <code class="language-plaintext highlighter-rouge">[B</code>, i.e. byte arrays.</p>

<h3 id="more-byte-arrays-of-similar-size-or-a-few-larger-ones">More byte arrays of similar size or a few larger ones?</h3>

<p>Next we look at the average size of the byte arrays in both versions to see if the increase can be attributed to more similarly sized arrays being added to the image or just a few larger ones.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">max_size_23_0_row</span> <span class="o">=</span> <span class="n">max_size_23_0_rows</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">max_size_23_1_row</span> <span class="o">=</span> <span class="n">max_size_23_1_rows</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Average size of byte arrays in Mandrel 23.0: {:.2f}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">max_size_23_0_row</span><span class="p">[</span><span class="s">'size-23.0'</span><span class="p">]</span><span class="o">/</span><span class="n">max_size_23_0_row</span><span class="p">[</span><span class="s">'count-23.0'</span><span class="p">]))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Average size of byte arrays in Mandrel 23.1: {:.2f}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">max_size_23_1_row</span><span class="p">[</span><span class="s">'size-23.1'</span><span class="p">]</span><span class="o">/</span><span class="n">max_size_23_1_row</span><span class="p">[</span><span class="s">'count-23.1'</span><span class="p">]))</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Average size of byte arrays in Mandrel 23.0: 127.57
Average size of byte arrays in Mandrel 23.1: 151.93
</code></pre></div></div>

<p>We observe that the average byte array size when building with Mandrel 23.1 is bigger, which is an indication that some larger byte arrays are being added to the image heap.</p>

<h2 id="generating-heap-dumps-and-analyzing-them-in-java-mission-control-jmc">Generating heap dumps and analyzing them in Java Mission Control (JMC)</h2>

<p>Since the dashboards don’t provide more info we rebuild our test with <code class="language-plaintext highlighter-rouge">-Dquarkus.native.additional-build-args=-R:+DumpHeapAndExit</code> using both Mandrel versions.
This options instructs the generated native images to create a heap dump and exit.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mvn package <span class="nt">-Pnative</span> <span class="se">\</span>
  <span class="nt">-Dquarkus</span>.version<span class="o">=</span>3.5.0 <span class="se">\</span>
  <span class="nt">-Dquarkus</span>.native.builder-image<span class="o">=</span>quay.io/quarkus/ubi-quarkus-mandrel-builder-image:jdk-20 <span class="se">\</span>
  <span class="nt">-Dquarkus</span>.native.additional-build-args<span class="o">=</span><span class="nt">-R</span>:+DumpHeapAndExit
...
./target/quarkus-runner
Heap dump created at <span class="s1">'quarkus-runner.hprof'</span><span class="nb">.</span>
<span class="nb">mv </span>quarkus-runner.hprof quarkus-runner-23-0.hprof
</code></pre></div></div>

<p>We do the same with Mandrel 23.1 using the <code class="language-plaintext highlighter-rouge">jdk-21</code> tag and open the dumps in Java Mission Control (JMC).
To install JMC one may use <code class="language-plaintext highlighter-rouge">sdk install jmc</code>.</p>

<p>After starting JMC we navigate to <code class="language-plaintext highlighter-rouge">File-&gt;Open</code> and select the heap dumps we just generated.</p>

<p><img src="/assets/images/posts/mandrel-23-1-image-size-increase/jmc-file-open.png" alt="JMC File -&gt; Open" /></p>

<p>Once the heap dumps are loaded we click on the <code class="language-plaintext highlighter-rouge">byte[]</code> class to filter the results and focus on the objects of this type.</p>

<p><img src="/assets/images/posts/mandrel-23-1-image-size-increase/jmc-focus-byte-23-1.png" alt="JMC focus on byte[] for 23.1" /></p>

<p>At this point on the right side of the window we can see the referrers sorted by the total size of the byte arrays they reference.</p>

<p><img src="/assets/images/posts/mandrel-23-1-image-size-increase/jmc-focus-byte-23-1-2.png" alt="JMC focus on byte[] for 23.1" /></p>

<p>We observe that the majority of the byte arrays when using Mandrel 23.1 is referenced by <code class="language-plaintext highlighter-rouge">com.oracle.svm.core.code.ImageCodeInfo.codeInfoEncodings</code> (12%) and <code class="language-plaintext highlighter-rouge">com.oracle.svm.core.code.ImageCodeInfo.frameInfoEncodings</code> (11%), while when using Mandrerl 23.0 the corresponding percentages are 12% and 6%.</p>

<p><img src="/assets/images/posts/mandrel-23-1-image-size-increase/jmc-focus-byte-23-0-2.png" alt="JMC focus on byte[] for 23.0" /></p>

<p>We also observe that when using Mandrel 23.1 the size of <code class="language-plaintext highlighter-rouge">com.oracle.svm.core.code.ImageCodeInfo.frameInfoEncodings</code> is ~2.5MB larger than the corresponding size when using Mandrel 23.0.</p>

<h2 id="attributing-binary-size-increase-to-specific-code-changes">Attributing Binary Size Increase to Specific Code Changes</h2>

<p>As a result, we focus our search on changes in Mandrel’s source code that could affect the frame info encodings using:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git log <span class="nt">--</span> substratevm/src/com.oracle.svm.core/src/com/oracle/svm/core/code/FrameInfo<span class="k">*</span>
</code></pre></div></div>

<p>this way we detected the following two pull requests:</p>

<ol>
  <li><a href="https://github.com/oracle/graal/pull/7003"><strong>Add support for profiling of topmost frame</strong></a> which adds ~1MB of data to the image.</li>
  <li><a href="https://github.com/oracle/graal/pull/6763"><strong>ProfilingSampler does not need local variable values</strong></a> (specifically <a href="https://github.com/oracle/graal/commit/d747c30c7691012c39989a8597fd850c68b740ad">the commit “Always store bci in frame info”</a>) which adds ~1.7MB of data to the image.</li>
</ol>

<p>Both of these changes are necessary to improve the accuracy of the <a href="https://github.com/oracle/graal/discussions/7707#discussioncomment-7443058">async-sampler</a>.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Similarly to when Quarkus upgraded from 22.3 to 23.0, we observe an increase in the size of the generated native executables when going from 23.0 to 23.1.
Once more the changes resulting to that increase in the binary size appear to be well justified.
As <code class="language-plaintext highlighter-rouge">native-image</code> becomes more mature and feature rich it seems inevitable to avoid increasing the size of the generated binaries.</p>

<p>If you think that this kind of info should only be included when the user opts-in, please provide your feedback in <a href="https://github.com/oracle/graal/discussions/7707">this discussion</a>.</p>

              
          </div>
          <div class="width-12-12"><div class="share-page">
  <a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https://quarkus.io/blog/mandrel-23-1-image-size-increase/&title=Exploring why native executables produced with Mandrel 23.1 are bigger than those produced with Mandrel 23.0" rel="nofollow" target="_blank" title="Share on LinkedIn">
    <i class="fa-brands fa-linkedin fa-xl"></i>
  </a>
  <a class="share-x" href="https://x.com/intent/tweet?text=Exploring why native executables produced with Mandrel 23.1 are bigger than those produced with Mandrel 23.0&url=https://quarkus.io/blog/mandrel-23-1-image-size-increase/&via=quarkusio&related=quarkusio" rel="nofollow" target="_blank" title="Share on X">
    <i class="fa-brands fa-square-x-twitter fa-xl"></i>
  </a>
  <a class="share-facebook" href="https://facebook.com/sharer.php?u=https://quarkus.io/blog/mandrel-23-1-image-size-increase/" rel="nofollow" target="_blank" title="Share on Facebook">
    <i class="fa-brands fa-square-facebook fa-xl"></i>
  </a>
  <a class="share-reddit" href="http://www.reddit.com/submit?url=https://quarkus.io/blog/mandrel-23-1-image-size-increase/" onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;" title="Share on Reddit" >
    <i class="fa-brands fa-square-reddit fa-xl"></i>
  </a>
  <a class="share-email" href="mailto:?subject=Exploring why native executables produced with Mandrel 23.1 are bigger than those produced with Mandrel 23.0&amp;body=Exploring why native executables produced with Mandrel 23.1 are bigger than those produced with Mandrel 23.0 https://quarkus.io/blog/mandrel-23-1-image-size-increase/" title="Share via Email" >
    <i class="fa-solid fa-envelope fa-xl"></i>
  </a>
</div>
</div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="post-page grid-wrapper">
  <div class="width-8-12 width-12-12-m doc-content">
  <script src="https://giscus.app/client.js"
        data-repo="quarkusio/quarkus"
        data-repo-id="MDEwOlJlcG9zaXRvcnkxMzk5MTQ5MzI="
        data-category="Quarkus Blog/Website"
        data-category-id="DIC_kwDOCFbutM4CAFFV"
        data-mapping="og:title"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-theme="preferred_color_scheme"
        data-lang="en"
        crossorigin="anonymous"
        async>
  </script>
  </div>
</div>

  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_reverse.svg" class="project-logo" title="Quarkus"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">Quarkus is open. All dependencies of this project are available under the <a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>Apache Software License 2.0</a> or compatible license.<br /><br />This website was built with <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a>, is hosted on <a href='https://pages.github.com/' target='_blank'>GitHub Pages</a> and is completely open source. If you want to make it better, <a href='https://github.com/quarkusio/quarkusio.github.io' target='_blank'>fork the website</a> and show us what you’ve got.</p>

    
      <div class="width-1-12 project-links">
        <span>Navigation</span>
        <ul class="footer-links">
          
          
            <li><a href="/" target="_blank">Home</a></li>
          
          
          
            <li><a href="/about" target="_blank">About</a></li>
          
          
          
            <li><a href="/blog" target="_blank">Blog</a></li>
          
          
          
            <li><a href="/insights" target="_blank">Podcast</a></li>
          
          
          
            <li><a href="/events" target="_blank">Events</a></li>
          
          
          
            <li><a href="/newsletter" target="_blank">Newsletter</a></li>
          
          
          
            <li><a href="/userstories" target="_blank">User Stories</a></li>
          
          
          
            <li><a href="https://github.com/orgs/quarkusio/projects/13/views/1" target="_blank">Roadmap</a></li>
          
          
          
            <li><a href="/security" target="_blank">Security&nbsp;policy</a></li>
          
          
          
            <li><a href="/usage" target="_blank">Usage</a></li>
          
          
          
            <li><a href="/brand" target="_blank">Brand</a></li>
          
          
          
            <li><a href="/desktopwallpapers" target="_blank">Wallpapers</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Follow Us</span>
        <ul class="footer-links">
          
          
            <li><a href="https://x.com/quarkusio" target="_blank">X</a></li>
          
          
          
            <li><a href="https://bsky.app/profile/quarkus.io" target="_blank">Bluesky</a></li>
          
          
          
            <li><a rel="me" href="https://fosstodon.org/@quarkusio" target="_blank">Mastodon</a></li>
            
          
          
            <li><a href="https://www.facebook.com/quarkusio" target="_blank">Facebook</a></li>
          
          
          
            <li><a href="https://www.linkedin.com/company/quarkusio/" target="_blank">Linkedin</a></li>
          
          
          
            <li><a href="https://www.youtube.com/channel/UCaW8QG_QoIk_FnjLgr5eOqg" target="_blank">Youtube</a></li>
          
          
          
            <li><a href="https://github.com/quarkusio" target="_blank">GitHub</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-2-12 project-links">
        <span>Get Help</span>
        <ul class="footer-links">
          
          
            <li><a href="/support" target="_blank">Support</a></li>
          
          
          
            <li><a href="/guides" target="_blank">Guides</a></li>
          
          
          
            <li><a href="/faq" target="_blank">FAQ</a></li>
          
          
          
            <li><a href="/get-started" target="_blank">Get Started</a></li>
          
          
          
            <li><a href="https://stackoverflow.com/questions/tagged/quarkus" target="_blank">Stack Overflow</a></li>
          
          
          
            <li><a href="https://github.com/quarkusio/quarkus/discussions" target="_blank">Discussions</a></li>
          
          
          
            <li><a href="https://groups.google.com/forum/#!forum/quarkus-dev" target="_blank">Development mailing list</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Languages</span>
        <ul class="footer-links">
          
          
            <li><a href="https://quarkus.io/" target="_blank">English</a></li>
          
          
          
            <li><a href="https://pt.quarkus.io/" target="_blank">Português&nbsp;(Brasileiro)</a></li>
          
          
          
            <li><a href="https://es.quarkus.io/" target="_blank">Español</a></li>
          
          
          
            <li><a href="https://cn.quarkus.io/" target="_blank">简体中文</a></li>
          
          
          
            <li><a href="https://ja.quarkus.io/" target="_blank">日本語</a></li>
          
          
        </ul>
      </div>
    

    
      <div class="width-4-12 more-links">
        <span>Quarkus is made of community projects</span>
        <ul class="footer-links">
          
            <li><a blah href="https://vertx.io/" target="_blank">Eclipse Vert.x</a></li>
          
            <li><a blah href="https://smallrye.io" target="_blank">SmallRye</a></li>
          
            <li><a blah href="https://hibernate.org" target="_blank">Hibernate</a></li>
          
            <li><a blah href="https://netty.io" target="_blank">Netty</a></li>
          
            <li><a blah href="https://resteasy.github.io" target="_blank">RESTEasy</a></li>
          
            <li><a blah href="https://camel.apache.org" target="_blank">Apache Camel</a></li>
          
            <li><a blah href="https://microprofile.io" target="_blank">Eclipse MicroProfile</a></li>
          
            <li><a blah href="https://code.quarkus.io/" target="_blank">And many more...</a></li>
          
        </ul>
      </div>
    
  </div>
</div>

  <div class="content redhat-footer">
  <div class="grid-wrapper">
    <span class="licence">
      <i class="fab fa-creative-commons"></i><i class="fab fa-creative-commons-by"></i> <a href="https://creativecommons.org/licenses/by/3.0/" target="_blank">CC by 3.0</a> | <a href="https://www.redhat.com/en/about/privacy-policy">Privacy Policy</a>
    </span>
    <span class="redhat">
      Sponsored by
    </span>
    <span class="redhat-logo">
      <a href="https://www.redhat.com/" target="_blank"><img src="/assets/images/redhat_reversed.svg"></a>
    </span>
  </div>
</div>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/scroll-down.js"></script>
  <script src="/assets/javascript/satellite.js" type="text/javascript"></script>
  <script src="/guides/javascript/config.js" type="text/javascript"></script>
  <script src="/assets/javascript/guides-version-dropdown.js" type="text/javascript"></script>
  <script src="/assets/javascript/back-to-top.js" type="text/javascript"></script>
  <script src="/assets/javascript/clipboard.min.js" type="text/javascript"></script>
  <script src="/assets/javascript/copy.js" type="text/javascript"></script>
  <script src="/assets/javascript/asciidoc-tabs.js" type="text/javascript"></script>
  <script src="/assets/javascript/future-date.js" type="text/javascript"></script>
</body>

</html>
