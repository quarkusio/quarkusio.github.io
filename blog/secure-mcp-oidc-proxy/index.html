<!DOCTYPE html>
<html lang="en">







<head>
  <title>Use Quarkus OIDC Proxy to encrypt Quarkus MCP Server tokens - Quarkus</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="
  connect-src 'self' https://dpm.demdex.net https://adobedc.demdex.net https://analytics.ossupstream.org/ https://search.quarkus.io https://smetrics.redhat.com https://ajax.googleapis.com; 
  script-src 'self' 'unsafe-inline' 'unsafe-eval'
      
      https://assets.adobedtm.com
      js.bizographics.com
      https://www.redhat.com
      https://static.redhat.com
      https://app.requestly.io/
      jsonip.com
      https://ajax.googleapis.com
      https://use.fontawesome.com
      http://www.youtube.com
      http://www.googleadservices.com
      https://googleads.g.doubleclick.net
      https://giscus.app
      https://analytics.ossupstream.org/
      https://app.mailjet.com;

  style-src 'self' https://fonts.googleapis.com https://use.fontawesome.com; 
  img-src 'self' * data:; 
  media-src 'self'; 
  frame-src https://redhat.demdex.net https://www.youtube.com https://player.restream.io https://app.mailjet.com http://xy0p2.mjt.lu https://mj.quarkus.io https://giscus.app; 
  base-uri 'none'; 
  object-src 'none'; 
  form-action 'none'; 
  font-src 'self' https://use.fontawesome.com https://fonts.gstatic.com;" />

  <script id="adobe_dtm" src="https://www.redhat.com/dtm.js" type="text/javascript"></script>
  <script src="/assets/javascript/highlight.pack.js" type="text/javascript"></script>
  <META HTTP-EQUIV='X-XSS-Protection' CONTENT="1; mode=block">
  <META HTTP-EQUIV='X-Content-Type-Options' CONTENT="nosniff">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Quarkus: Supersonic Subatomic Java">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@QuarkusIO"> 
  <meta name="twitter:creator" content="@QuarkusIO">
  <meta property="og:url" content="https://quarkus.io/blog/secure-mcp-oidc-proxy/" />
  <meta property="og:title" content="Use Quarkus OIDC Proxy to encrypt Quarkus MCP Server tokens" />
  <meta property="og:description" content="Quarkus: Supersonic Subatomic Java" />
  <meta property="og:image" content="https://quarkus.io/assets/images/quarkus_card.png" />
  
  <link rel="canonical" href="https://quarkus.io/blog/secure-mcp-oidc-proxy/">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/guides/stylesheet/config.css" />
  <link rel="stylesheet" href="/assets/css/main.css?2021-07-29" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.5.2/css/all.css" crossorigin="anonymous">
  <link rel="alternate" type="application/rss+xml"  href="/feed.xml" title="Quarkus">
  <script src="/assets/javascript/hl.js" type="text/javascript"></script>
  
  
  
  
  <link rel="alternate" hreflang="en" href="https://quarkus.io/blog/secure-mcp-oidc-proxy/" />
  
  <link rel="alternate" hreflang="pt-br" href="https://pt.quarkus.io/blog/secure-mcp-oidc-proxy/" />
  
  <link rel="alternate" hreflang="es" href="https://es.quarkus.io/blog/secure-mcp-oidc-proxy/" />
  
  <link rel="alternate" hreflang="zh" href="https://cn.quarkus.io/blog/secure-mcp-oidc-proxy/" />
  
  <link rel="alternate" hreflang="ja" href="https://ja.quarkus.io/blog/secure-mcp-oidc-proxy/" />
  
  <link rel="alternate" hreflang="x-default" href="https://quarkus.io/" />  
  <script src="/assets/javascript/tracking.js"></script>
  
  <script src="/assets/javascript/colormode.js" type="text/javascript"></script>

</head>

<body class="post">

  
  <div class="nav-wrapper">
  <div class="grid-wrapper">
    <div class="width-12-12">
      <input type="checkbox" id="checkbox" />
      <nav id="main-nav" class="main-nav">
        <div class="logo-wrapper">
           <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_600px_reverse.png" class="project-logo" title="Quarkus"></a>
        </div>
    <label class="nav-toggle" for="checkbox">
      <i class="fa fa-bars"></i>
    </label>
    <ul id="menu" class="menu">
      <li class="dropdown">
        <span href="#">Why<i class="fas fa-chevron-down firsti"></i></span>
        <ul class="submenu">
          <li><a href="/about" class="">WHAT IS QUARKUS?</a></li>
          <li><a href="/developer-joy" class="">DEVELOPER JOY</a></li>
          <li><a href="/performance" class="">PERFORMANCE</a></li>
          <li><a href="/kubernetes-native" class="">KUBERNETES NATIVE</a></li>
          <li><a href="/standards" class="">STANDARDS</a></li>
          <li><a href="/versatility" class="">VERSATILITY</a></li>
          <li><a href="/container-first" class="">CONTAINER FIRST</a></li>
          <li><a href="/spring" class="">USING SPRING?</a></li>
          <li class="tertiarydropdown">
            <span href="#">AI<i class="fas fa-chevron-down"></i></span>
            <ul class="tertiarymenu">
              <li><a href="/ai" class="">AI OVERVIEW</a></li>
              <li><a href="/java-for-ai" class="">JAVA FOR AI</a></li>
              <li><a href="/quarkus-for-ai" class="">WHY QUARKUS FOR AI</a></li>
              <li><a href="/ai-blueprints" class="">AI BLUEPRINTS</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="#">Learn<i class="fas fa-chevron-down firsti"></i></span>
        <ul class="submenu">
          <li><a href="/get-started" class="">GET STARTED</a></li>
          <li><a href="/guides" class="">DOCUMENTATION</a></li>
          <li><a href="/userstories/" class="">USER STORIES</a></li>  
          <li><a href="/qtips" class="">"Q" TIP VIDEOS</a></li>          
          <li><a href="/books" class="">BOOKS</a></li>
          </ul>
      </li>
      <li class="dropdown">
        <span href="#">Extensions<i class="fas fa-chevron-down firsti"></i></span>
        <ul class="submenu">
          <!-- Note that quarkus.io is hardcoded here, because it is the only url which supports extensions -->
          <li><a href="https://quarkus.io/extensions/" class="">BROWSE EXTENSIONS</a></li>
          <li><a href="/faq/#what-is-a-quarkus-extension" class="">USE EXTENSIONS</a></li>
          <li><a href="/guides/writing-extensions" class="">CREATE EXTENSIONS</a></li>
          <li><a href="https://hub.quarkiverse.io" class="">SHARE EXTENSIONS</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="#">Community<i class="fas fa-chevron-down firsti"></i></span>
        <ul class="submenu">
          <li><a href="/support/" class="">SUPPORT</a></li>
          <li><a href="/blog" class="active">BLOG</a></li>
          <li><a href="/discussion" class="">DISCUSSION</a></li>
          <li><a href="/working-groups" class="">WORKING GROUPS</a></li>
          <li><a href="/insights" class="">PODCAST</a></li>
          <li><a href="/events" class="">EVENTS</a></li>
          <li><a href="/newsletter" class="">NEWSLETTER</a></li>
          <li><a href="https://github.com/orgs/quarkusio/projects/13/views/1" class="">ROADMAP</a></li>
          <li><a href="/benefactors" class="">BENEFACTORS</a></li>
          </ul>
      </li>
      <li>
        <a href="https://code.quarkus.io" class="button-cta secondary white">START CODING</a>
      </li>
      <li class="dropdown">
        <span href="/language/"><div class="fas fa-globe langicon"></div><i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="https://quarkus.io/blog/secure-mcp-oidc-proxy/" >OFFICIAL (ENGLISH)</a></li>
          <li><a href="https://pt.quarkus.io/blog/secure-mcp-oidc-proxy/">PORTUGUÊS (BR)</a></li>
          <li><a href="https://es.quarkus.io/blog/secure-mcp-oidc-proxy/">ESPAÑOL</a></li>
          <li><a href="https://cn.quarkus.io/blog/secure-mcp-oidc-proxy/">简体中文</a></li>
          <li><a href="https://ja.quarkus.io/blog/secure-mcp-oidc-proxy/">日本語</a></li>
          </ul>
      </li>
      <li>
        <span href="#" class="modeswitcher" id='theme-toggle'><i class="fas fa-sun"></i><i class="fas fa-moon"></i><i class="fas fa-cog"></i></span>
      </li>
    </ul>
      </nav>
    </div>
  </div>
</div>

  <div class="content">
    <div class="full-width-breadcrumb-bg align-self">
  <div class="width-12-12">
      <p class="returnlink"><a href="/blog">Blog</a> <i class="fas fa-chevron-right"></i> Use Quarkus OIDC Proxy to encrypt Quarkus MCP Server tokens</p>
  </div>
</div>

<div class="post-page grid-wrapper">
  <div class="width-8-12 width-12-12-m doc-content">
    <div class="grid-wrapper">
      <div class="width-12-12">
        <div class="post-date">
          October 01, 2025 
          
            <span class="tags"><a href="/blog/tag/ai">#ai</a><a href="/blog/tag/mcp">#mcp</a><a href="/blog/tag/security">#security</a></span>
          
        </div>
        <h1 class="post-title">Use Quarkus OIDC Proxy to encrypt Quarkus MCP Server tokens</h1>
        <div class="grid-wrapper">
          <div class="width-8-12 width-12-12-m byline-wrapper">
            
            
              <img class="headshot" src="https://www.gravatar.com/avatar/7941c5788c2e02a4f7f51409afca3090">
            
            <p class="byline">By <a href="/author/sberyozkin">Sergey Beryozkin</a></p>
          </div>
          <div class="width-12-12">
              <div class="sect1">
<h2 id="introduction"><a class="anchor" href="#introduction"></a>Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the <a href="https://quarkus.io/blog/secure-mcp-server-oauth2/">Use MCP OAuth2 Flow to access Quarkus MCP Server</a> blog post, we explained how an MCP Client such as <a href="https://github.com/modelcontextprotocol/inspector">MCP Inspector</a> could use the OAuth2 Flow with a pre-registered OAuth2 Client application to discover the MCP server&#8217;s <a href="https://datatracker.ietf.org/doc/html/rfc9728">OAuth2 Protected Resource Metadata</a>, the metadata of the authorization server, login a user and acquire an access token that it could use to access MCP Server provided tools.</p>
</div>
<div class="paragraph">
<p>In this blog post, we will look at how <a href="https://github.com/modelcontextprotocol/inspector">MCP Inspector</a> can register OAuth2 Client applications dynamically, instead of using a pre-registered OAuth2 Client, but also, use <a href="https://github.com/quarkiverse/quarkus-oidc-proxy">Quarkus OIDC Proxy</a> to delegate to <a href="https://www.keycloak.org/">Keycloak</a> during the MCP OAuth2 flow, <a href="#point-of-using-oidc-proxy">analyze why it can be useful</a> and show how it can <a href="#use-oidc-proxy-to-encrypt-tokens">encrypt access and refresh tokens and exclude ID tokens</a>, before they are made available to <a href="https://github.com/modelcontextprotocol/inspector">MCP Inspector</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="demo-flow-diagram"><a class="anchor" href="#demo-flow-diagram"></a>Demo MCP OAuth2 Flow Diagram</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the <a href="https://quarkus.io/blog/secure-mcp-server-oauth2/">Use MCP OAuth2 Flow to access Quarkus MCP Server</a> blog post, we looked at how <a href="https://github.com/modelcontextprotocol/inspector">MCP Inspector</a> could use OAuth 2.0 Flow with a <a href="https://quarkus.io/blog/secure-mcp-server-oauth2/#demo-flow-diagram">pre-registered OAuth2 client</a>.</p>
</div>
<div class="paragraph">
<p>The demo flow diagram in this section is very similar to the one from the <a href="https://quarkus.io/blog/secure-mcp-server-oauth2/#demo-flow-diagram">Use MCP OAuth2 Flow to access Quarkus MCP Server</a> blog post. It shows how <a href="https://github.com/modelcontextprotocol/inspector">MCP Inspector</a> can use <a href="https://datatracker.ietf.org/doc/html/rfc7591">OAuth2 Dynamic Client Registration</a> instead of requiring that an OAuth2 Client is pre-registered, and with the <a href="https://github.com/quarkiverse/quarkus-oidc-proxy">Quarkus OIDC Proxy</a> interposing between MCP Client and Keycloak.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/assets/images/posts/secure_mcp_oidc_proxy/demo_flow_diagram.png" alt="Demo Flow Diagram">
</div>
</div>
<div class="paragraph">
<p>When <a href="https://datatracker.ietf.org/doc/html/rfc7591">OAuth2 Dynamic Client Registration</a> is used, MCP Client such as <a href="https://github.com/modelcontextprotocol/inspector">MCP Inspector</a> requires configuring an MCP <em>Streamable HTTP</em> endpoint URL only.</p>
</div>
<div class="paragraph">
<p>MCP Client starts by accessing the MCP server without a token and gets back HTTP 401 with a <code>WWW-Authenticate</code> <code>resource_metadata</code> parameter that links to the MCP server&#8217;s <a href="https://datatracker.ietf.org/doc/html/rfc9728">OAuth2 Protected Resource Metadata</a> route. The client now fetches a URL of the authorization server that secures the MCP server as well as the MCP server&#8217;s resource identifier.</p>
</div>
<div class="paragraph">
<p>Since <a href="https://github.com/quarkiverse/quarkus-oidc-proxy">Quarkus OIDC Proxy</a> is used, MCP Client does not see a Keycloak URL as the authorization server URL but <code><a href="http://localhost:8080/q/oidc" class="bare">http://localhost:8080/q/oidc</a></code> URL pointing to a default <a href="https://github.com/quarkiverse/quarkus-oidc-proxy">Quarkus OIDC Proxy</a>'s base URL.</p>
</div>
<div class="paragraph">
<p>Next, MCP Client uses the <a href="https://github.com/quarkiverse/quarkus-oidc-proxy">Quarkus OIDC Proxy</a>'s URL to discover its authorization, token, client registration and other endpoint URLs. <a href="https://github.com/quarkiverse/quarkus-oidc-proxy">Quarkus OIDC Proxy</a> provides its metadata by discovering Keycloak&#8217;s metadata and replacing Keycloak-specific URLs with its own proxy-managed URLs, but does not transform other Keycloak metadata such as supported <a href="https://www.rfc-editor.org/rfc/rfc7636">Proof Key for Code Exchange</a> (PKCE) methods.</p>
</div>
<div class="paragraph">
<p>The user is now redirected to <a href="https://github.com/quarkiverse/quarkus-oidc-proxy">Quarkus OIDC Proxy</a> which in turn redirects the user to Keycloak to login.</p>
</div>
<div class="paragraph">
<p>Once the user logs in and authorizes MCP Inspector to access Quarkus MCP server, the user is redirected back to the <code><a href="http://localhost:6274/oauth/callback" class="bare">http://localhost:6274/oauth/callback</a></code> endpoint, MCP client exchanges the returned <code>code</code> to get ID, access and refresh tokens, and uses the access token to access the MCP server, allowing the user to select and run the tool.</p>
</div>
<div class="paragraph">
<p>We are now ready to have a deeper look at how it works in the demo.</p>
</div>
<div class="paragraph">
<p>You can find the complete project source in the <a href="https://github.com/sberyozkin/quarkus-mcp-server-oidc-proxy/tree/main/secure-mcp-http-server-with-oidc-proxy">Secure Quarkus MCP HTTP Server with OIDC Proxy sample</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="create-mcp-server"><a class="anchor" href="#create-mcp-server"></a>Step 1 - Create and start MCP server</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First, let&#8217;s create a secure Quarkus MCP server.</p>
</div>
<div class="sect2">
<h3 id="mcp-server-dependencies"><a class="anchor" href="#mcp-server-dependencies"></a>MCP server maven dependencies</h3>
<div class="paragraph">
<p>Add the following dependencies:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.quarkiverse.mcp&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-mcp-server-sse&lt;/artifactId&gt; <i class="conum" data-value="1"></i><b>(1)</b>
    &lt;version&gt;1.6.0&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-oidc&lt;/artifactId&gt; <i class="conum" data-value="2"></i><b>(2)</b>
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;io.quarkiverse.oidc-proxy&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-oidc-proxy&lt;/artifactId&gt; <i class="conum" data-value="3"></i><b>(3)</b>
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>quarkus-mcp-server-sse</code> is required to support both MCP Streamable HTTP and SSE transports.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>quarkus-oidc</code> is required to secure access to Quarkus MCP Server. Its version is defined in the Quarkus BOM.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>quarkus-oidc-proxy</code> is required to support OIDC proxy between MCP Client and Keycloak</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="mcp-server-configuration"><a class="anchor" href="#mcp-server-configuration"></a>MCP Server Configuration</h3>
<div class="paragraph">
<p>Let&#8217;s configure the MCP server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties"># Require an authenticated access to the MCP server

quarkus.http.auth.permission.authenticated.paths=/mcp/* <i class="conum" data-value="1"></i><b>(1)</b>
quarkus.http.auth.permission.authenticated.policy=authenticated

# Default OIDC tenant that secures the MCP server <i class="conum" data-value="2"></i><b>(2)</b>
# Its required `quarkus.oidc.auth-server-url` property is set by Keycloak Dev Service
# and points to the Keycloak `quarkus-mcp-realm` realm endpoint

quarkus.oidc.token.audience=quarkus-mcp-server <i class="conum" data-value="3"></i><b>(3)</b>
quarkus.oidc.resource-metadata.enabled=true <i class="conum" data-value="4"></i><b>(4)</b>
quarkus.oidc.resource-metadata.authorization-server=http://localhost:8080/q/oidc <i class="conum" data-value="5"></i><b>(5)</b>
quarkus.oidc.resource-metadata.force-https-scheme=false

# Keycloak devservice that supports the default OIDC tenant.

quarkus.keycloak.devservices.realm-path=quarkus-mcp-realm.json <i class="conum" data-value="6"></i><b>(6)</b>
quarkus.keycloak.devservices.create-client=false <i class="conum" data-value="7"></i><b>(7)</b>

# CORS configuration to allow MCP Inspector's SPA script calls

quarkus.http.cors.enabled=true
quarkus.http.cors.origins=http://localhost:6274 <i class="conum" data-value="8"></i><b>(8)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Require authentication for all requests to the MCP server. This authentication policy is enforced by the default OIDC tenant configuration.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Default OIDC tenant secures the MCP server, Keycloak DevService inserts a missing <code>quarkus.oidc.auth-server-url</code> property that links to the Keycloak <code>quarkus-mcp-realm</code> realm endpoint.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Require that tokens that are allowed to access the MCP server must have an audience (<code>aud</code>) claim that contains a <code>quarkus-mcp-server</code> value.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Enable the <a href="https://datatracker.ietf.org/doc/html/rfc9728">OAuth2 Protected Resource Metadata</a> route for the default OIDC tenant. It will help <a href="https://github.com/modelcontextprotocol/inspector">MCP Inspector</a> to find out about the authorization server that secures the MCP server.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Quarkus <a href="https://datatracker.ietf.org/doc/html/rfc9728">OAuth2 Protected Resource Metadata</a> handler is not aware that <a href="https://github.com/quarkiverse/quarkus-oidc-proxy">Quarkus OIDC Proxy</a> is meant to intercept OAuth2 Flow requests between <a href="https://github.com/modelcontextprotocol/inspector">MCP Inspector</a> and Keycloak, so we help it to return a correct URL by setting an absolute URL that points to the base <a href="https://github.com/quarkiverse/quarkus-oidc-proxy">Quarkus OIDC Proxy</a> URL.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Ask Keycloak DevService to upload the <code>quarkus-mcp-realm.json</code> realm file. This realm does not have pre-registered clients.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Ask Keycloak not to add <code>quarkus.oidc.client-id</code> since <a href="https://github.com/modelcontextprotocol/inspector">MCP Inspector</a> will register OAuth2 clients dynamically.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>CORS policy to allow <a href="https://github.com/modelcontextprotocol/inspector">MCP Inspector</a> script requests.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can read about how <a href="https://datatracker.ietf.org/doc/html/rfc9728">OAuth2 Protected Resource Metadata</a> is supported in Quarkus OIDC in the <a href="https://quarkus.io/guides/security-oidc-expanded-configuration#resource-metadata-properties">Expanded OpenId Connect Configuration guide</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="mcp-server-tools"><a class="anchor" href="#mcp-server-tools"></a>MCP User Name Provider tool</h3>
<div class="paragraph">
<p>Let&#8217;s create a single tool that can return a name of the current MCP Client user:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme;

import io.quarkiverse.mcp.server.TextContent;
import io.quarkiverse.mcp.server.Tool;
import io.quarkus.oidc.UserInfo;
import io.quarkus.security.identity.SecurityIdentity;
import jakarta.inject.Inject;

public class ServerFeatures {

    @Inject
    SecurityIdentity identity; <i class="conum" data-value="1"></i><b>(1)</b>

    @Tool(name = "user-name-provider", description = "Provides a name of the current user") <i class="conum" data-value="2"></i><b>(2)</b>
    TextContent provideUserName() {
        return new TextContent(identity.getPrincipal().getName());
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Capture a security identity represented by the verified access token</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>user-name-provider</code> tool returns a name of the current MCP Client user.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>user-name-provider</code> tool is a very simple tool designed to show that an identity of the MCP client user on whose behalf this tool is called by the MCP client is available for the tool to perform a user identity specific action, an important element for a secure agentic AI system.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="keycloak-configuration"><a class="anchor" href="#keycloak-configuration"></a>Keycloak Configuration</h3>
<div class="paragraph">
<p>The Keycloak configuration has already been prepared in the <code>quarkus-mcp-realm.json</code> that Keycloak DevService uploads to Keycloak at the start-up time.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s have a closer look. Please go to <code><a href="http://localhost:8080/q/dev-ui" class="bare">http://localhost:8080/q/dev-ui</a></code> and select an <code>OpenId Connect</code> card:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/assets/images/posts/secure_mcp_oidc_proxy/devui_oidc_card.png" alt="Keycloak Admin">
</div>
</div>
<div class="paragraph">
<p>Click on <code>Keycloak Admin</code>, login as <code>admin:admin</code> and check the <code>quarkus-mcp-realm</code> realm configuration.</p>
</div>
<div class="paragraph">
<p>The <code>quarkus-mcp-realm</code> has only Keycloak specific clients registered that are required to support various Keycloak realm operations, it has no custom clients registered.
This realm has a single user, <code>alice</code> with a password <code>alice</code>.
It also has a custom <code>quarkus-mcp-server</code> client scope with an audience mapping:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/assets/images/posts/secure_mcp_oidc_proxy/quarkus_mcp_server_client_scope.png" alt="Keycloak quarkus-mcp-server client scope">
</div>
</div>
<div class="paragraph">
<p>The <code>quarkus-mcp-server</code> scope has an audience mapping:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/assets/images/posts/secure_mcp_oidc_proxy/quarkus_mcp_server_audience.png" alt="Keycloak quarkus-mcp-server audience mapping">
</div>
</div>
<div class="paragraph">
<p>The <code>quarkus-mcp-realm</code> realm have the <code>quarkus-mcp-server</code> client scope with the <code>quarkus-mcp-server</code> audience mapping to let users specify the <code>quarkus-mcp-server</code> scope in order to request the correct token audience when <a href="https://github.com/modelcontextprotocol/inspector">MCP Inspector</a> initiates OAuth2 Flow.</p>
</div>
<div class="paragraph">
<p><a href="https://www.rfc-editor.org/rfc/rfc8707.html">OAuth2 Resource Indicator</a> specification provides an alternative option, where MCP Client can pass an MCP Server&#8217;s <code>resource</code> indicator to the OAuth2 provider and the provider can add it to the token audience. You can choose to avoid creating custom Keycloak client scopes with an audience mapping once Keycloak starts supporting the <a href="https://www.rfc-editor.org/rfc/rfc8707.html">OAuth2 Resource Indicator</a> specification.</p>
</div>
</div>
<div class="sect2">
<h3 id="start-mcp-server"><a class="anchor" href="#start-mcp-server"></a>Start the MCP server in dev mode</h3>
<div class="paragraph">
<p>Now let&#8217;s start the MCP server in dev mode:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">mvn quarkus:dev</code></pre>
</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/assets/images/posts/secure_mcp_oidc_proxy/quarkus_mcp_server_dev_mode.png" alt="MCP server dev mode">
</div>
</div>
<div class="paragraph">
<p>You can see that default <em>Streamable HTTP</em> and SSE endpoints are available at <code><a href="http://localhost:8080/mcp" class="bare">http://localhost:8080/mcp</a></code> and <code><a href="http://localhost:8080/mcp/sse" class="bare">http://localhost:8080/mcp/sse</a></code> respectively.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="start-mcp-inspector"><a class="anchor" href="#start-mcp-inspector"></a>Step 2: Start the MCP Inspector</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">npx @modelcontextprotocol/inspector@0.16.7</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>While <a href="https://github.com/modelcontextprotocol/inspector">MCP Inspector</a> provides a very good OAuth2 Flow support, it is still a very active project and at the moment, you may observe <a href="https://github.com/modelcontextprotocol/inspector">MCP Inspector</a> failing to connect to the OAuth2 provider in some versions. <a href="https://github.com/modelcontextprotocol/inspector">MCP Inspector</a> v0.16.7 is currently recommended.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/assets/images/posts/secure_mcp_oidc_proxy/mcp_inspector_connect_view.png" alt="MCP Inspector Connect">
</div>
</div>
<div class="paragraph">
<p>As you can see, no pre-configured OAuth2 Client ID is set.</p>
</div>
<div class="paragraph">
<p>Now, do not press <code>Connect</code> immediately. We are going to follow the <a href="https://github.com/modelcontextprotocol/inspector">MCP Inspector</a>'s <code>Guided OAuth Flow</code> to <a href="#use-mcp-inspector-to-access-mcp-server">register an OAuth2 Client, login a user and acquire an access token</a> instead, and request a <code>Connect</code> once the <code>Guided OAuth Flow</code> is complete.</p>
</div>
<div class="paragraph">
<p>We will then have a look at how to <a href="#use-oidc-proxy-to-encrypt-tokens">Encrypt access and refresh tokens and drop ID token</a>.</p>
</div>
<div class="paragraph">
<p>See the <a href="#demo-flow-diagram">Demo MCP OAuth2 Flow Diagram</a> section for an overview of how <a href="https://github.com/modelcontextprotocol/inspector">MCP Inspector</a> performs a <code>Connect</code> request.</p>
</div>
<div class="paragraph">
<p>Please keep your browser&#8217;s <code>Developer Tools&#8217;s `Network</code> tab open if you would like to observe how MCP Inspector probes various MCP server and <a href="https://github.com/quarkiverse/quarkus-oidc-proxy">Quarkus OIDC Proxy</a> endpoints and eventually succeeds in getting a user logged in and acquiring the access token.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="use-mcp-inspector-to-access-mcp-server"><a class="anchor" href="#use-mcp-inspector-to-access-mcp-server"></a>Step 3: Use MCP Inspector to register OAuth2 Client and access MCP Server</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We are now going to use the <a href="https://github.com/modelcontextprotocol/inspector">MCP Inspector</a>'s <code>Guided OAuth Flow</code> to register an OAuth2 Client, login a user and acquire tokens.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/assets/images/posts/secure_mcp_oidc_proxy/mcp_inspector_oauth2_settings.png" alt="MCP Inspector OAuth2 Settings">
</div>
</div>
<div class="paragraph">
<p>Click on <code>Open Auth Settings</code> which you can find opposite the Connection settings that you saw in the <a href="#start-mcp-inspector">Step 2: Start the MCP Inspector</a> section, and click on the <code>Guided OAuth2 Flow</code>:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/assets/images/posts/secure_mcp_oidc_proxy/mcp_inspector_oauth2_flow_progress.png" alt="MCP Inspector OAuth2 Settings Progress">
</div>
</div>
<div class="paragraph">
<p>The <code>Guided OAuth2 Flow</code> may not be highlighted after you select it but <a href="https://github.com/modelcontextprotocol/inspector">MCP Inspector</a> will run it once you press <code>Continue</code>.</p>
</div>
<div class="paragraph">
<p>Press <code>Continue</code> to do the <code>Metadata Discovery</code>:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/assets/images/posts/secure_mcp_oidc_proxy/oauth2_metadata_discovered.png" alt="OAuth2 Metadata Discovered">
</div>
</div>
<div class="paragraph">
<p>As you can see, <a href="https://github.com/modelcontextprotocol/inspector">MCP Inspector</a> discovers the MCP Server&#8217;s <a href="https://datatracker.ietf.org/doc/html/rfc9728">OAuth2 Protected Resource Metadata</a> first, finds out the <a href="https://github.com/quarkiverse/quarkus-oidc-proxy">OIDC Proxy</a>'s URL, and uses it to fetch the the OIDC Proxy&#8217;s metadata. As mentioned in the <a href="#demo-flow-diagram">Demo MCP OAuth2 Flow Diagram</a> section, <a href="https://github.com/quarkiverse/quarkus-oidc-proxy">OIDC Proxy</a> provides its metadata by discovering Keycloak&#8217;s metadata and replacing Keycloak-specific URLs with its own proxy-managed URLs, but does not transform other Keycloak metadata.</p>
</div>
<div class="paragraph">
<p>The next step is the <code>Client Registration</code>, press <code>Continue</code>.</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/modelcontextprotocol/inspector">MCP Inspector</a> posts a client registration request that you can see in the browser&#8217;s developer tools:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/assets/images/posts/secure_mcp_oidc_proxy/oauth2_client_registration_request.png" alt="OAuth2 Client Registration Request">
</div>
</div>
<div class="paragraph">
<p>Note that the <code>token_endpoint_auth_method</code> property is set to <code>none</code> - this is how a <code>public</code> OAuth2 Client is registered, since managing confidential OAuth2 Clients that have secrets is harder for Single-page application (SPA) such as <a href="https://github.com/modelcontextprotocol/inspector">MCP Inspector</a>.</p>
</div>
<div class="paragraph">
<p>The <code>Client Registration</code> succeeds:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/assets/images/posts/secure_mcp_oidc_proxy/oauth2_reg_client_response.png" alt="OAuth2 Client Registration Response">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>client_id</code> is a dynamically generated value. You will see a different <code>client_id</code> when you work with this blog post.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>At this point, we have to pause the <code>Guided OAuth2 Flow</code> sequence, go to Keycloak and assign the <code>quarkus-mcp-server</code> and <code>profile</code> scopes to the registered client.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The whole point of registering OAuth2 Clients dynamically is to avoid having to deal with manually configuring them.
However, as you could see in the Client Registration Request image above, <a href="https://github.com/modelcontextprotocol/inspector">MCP Inspector</a> currently does not allow
to pass OAuth2 scopes during the OAuth2 Client Registration - irrespectively of whether you configure <code>Scope</code> in its <a href="#start-mcp-inspector">Connection settings</a> or not.</p>
</div>
<div class="paragraph">
<p>The scopes impact what an issued access token can do, what kind of information it can include. The current OAuth2 Client application that logins the current user can request some scopes, for the user to authorize the client to use the access token according to permissions enabled by these scopes. Without requesting scopes during the OAuth2 Client Registration, Keycloak can only issue access tokens with a very limited content, with no audience and the logged-in user information included.</p>
</div>
<div class="paragraph">
<p>Therefore, to support this post&#8217;s demo flow, we need to manually assign the required scopes to the registered client directly in the Keycloak Admin Dashboard.</p>
</div>
<div class="paragraph">
<p>In general, the <a href="https://modelcontextprotocol.io/specification/2025-06-18/basic/authorization">MCP Authorization</a>-compliant MCP Clients should be able to use custom OAuth2 scopes during the <a href="https://datatracker.ietf.org/doc/html/rfc7591">OAuth2 Dynamic Client Registration</a> going forward.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>OK, let&#8217;s update the registered client in Keycloak.</p>
</div>
<div class="paragraph">
<p>Login to Keycloak as described in the <a href="#keycloak-configuration">Keycloak Configuration</a> section, select the <code>quarkus-mcp-realm</code> in <code>Manage Realms</code> and the registered client in this realm&#8217;s <code>Clients</code>:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/assets/images/posts/secure_mcp_oidc_proxy/keycloak_reg_client_dashboard.png" alt="Keycloak Registered Client">
</div>
</div>
<div class="paragraph">
<p>Click on its <code>Client Scopes</code> tab, and add <code>profile</code> and <code>quarkus-mcp-server</code> scopes as <code>Default</code> scopes:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/assets/images/posts/secure_mcp_oidc_proxy/add_scopes_to_registered_client.png" alt="Add Scopes Registered Client">
</div>
</div>
<div class="paragraph">
<p>Usually, these scopes should be optional for them to be requested at the authorization code flow login time, but in this case we set them as default scopes since the registered client is currently not aware of such scopes at the registration and login times due to the <a href="https://github.com/modelcontextprotocol/inspector">MCP Inspector</a>'s limitation described above in this section.</p>
</div>
<div class="paragraph">
<p>As far as these two scopes are concerned, the <code>quarkus-mcp-server</code> scope was described in the <a href="#keycloak-configuration">Keycloak Configuration</a> section and is used to ensure the access tokens that are issued to the registered client include the correct MCP server audience, while the <code>profile</code> scope is only added for the access tokens to contain the logged-in user&#8217;s name - adding this scope is not strictly necessary.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s go back to the <a href="https://github.com/modelcontextprotocol/inspector">MCP Inspector</a>'s <code>Guided OAuth Flow</code> where we have already completed the <code>Metadata Discovery</code> and <code>Client Registration</code> steps.</p>
</div>
<div class="paragraph">
<p>Press <code>Continue</code> to begin the <code>Preparing Authorization</code> step and you will see an <code>Authorization URL</code> displayed:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/assets/images/posts/secure_mcp_oidc_proxy/oauth2_prepare_authorization.png" alt="OAuth2 Prepare Authorization">
</div>
</div>
<div class="paragraph">
<p>Click on it using the provided button on the right, and you will be redirected to Keycloak, via <a href="https://github.com/quarkiverse/quarkus-oidc-proxy">OIDC Proxy</a>, to login:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/assets/images/posts/secure_mcp_oidc_proxy/keycloak_realm_login.png" alt="Keycloak Realm Login">
</div>
</div>
<div class="paragraph">
<p>Login as <code>alice:alice</code>, and now Keycloak will request you to give your consent to the registered MCP Inspector Client to access Quarkus MCP Server:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/assets/images/posts/secure_mcp_oidc_proxy/keycloak_consent_screen.png" alt="Keycloak Consent Screen">
</div>
</div>
<div class="paragraph">
<p>This is what using scopes during the client registration, and <code>quarkus-mcp-server</code> scope in particular, give you: a must have option to authorize the registered MCP client application to access the MCP Server on your behalf.</p>
</div>
<div class="paragraph">
<p>Press <code>Yes</code>, Keycloak will redirect you back to the <a href="https://github.com/modelcontextprotocol/inspector">MCP Inspector</a>'s callback page in another tab that will display the authorization code:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/assets/images/posts/secure_mcp_oidc_proxy/copy_authorization_code.png" alt="Copy Authorization Code">
</div>
</div>
<div class="paragraph">
<p>Copy and paste this code into the <code>Prepare Authorization</code> field in the <code>Guided OAuth Flow</code> view:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/assets/images/posts/secure_mcp_oidc_proxy/oauth2_request_authorization.png" alt="OAuth2 Prepare Authorization">
</div>
</div>
<div class="paragraph">
<p>Press <code>Continue</code>. <a href="https://github.com/modelcontextprotocol/inspector">MCP Inspector</a> now successfully acquires the tokens:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/assets/images/posts/secure_mcp_oidc_proxy/token_request_response.png" alt="OAuth2 Get Tokens">
</div>
</div>
<div class="paragraph">
<p>As you can see, 3 tokens, the access and refresh tokens but also the ID token are returned. <a href="https://github.com/modelcontextprotocol/inspector">MCP Inspector</a> does not really need the ID token, it only needs an access token in order to be able to access the MCP server, and optionally, the refresh token to get another access token when the current one expires. We&#8217;ll have a look at how to drop the ID token in the <a href="#use-oidc-proxy-to-encrypt-tokens">Encrypt access and refresh tokens and drop ID token</a> section.</p>
</div>
<div class="paragraph">
<p>Copy the access token from the provided JSON data and paste it into <a href="https://www.jwt.io/">jwt.io</a>:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/assets/images/posts/secure_mcp_oidc_proxy/access_token_claims.png" alt="OAuth2 Access Token Claims">
</div>
</div>
<div class="paragraph">
<p>It contains a required <code>quarkus-mcp-server</code> audience, exactly what the <a href="#mcp-server-configuration">MCP Server expects</a>.</p>
</div>
<div class="paragraph">
<p>Now you are ready to press <code>Connect</code> in the Connection view that you saw in the <a href="#start-mcp-inspector">Step 2: Start the MCP Inspector</a> section.</p>
</div>
<div class="paragraph">
<p>At this point, the access token is already available, so <a href="https://github.com/modelcontextprotocol/inspector">MCP Inspector</a> uses this token to let you select and run the <code>user-name-provider</code> tool:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/assets/images/posts/secure_mcp_oidc_proxy/username_provider_call.png" alt="User Name Provider Call">
</div>
</div>
<div class="paragraph">
<p>Now press <code>Disconnect</code> first, and then <code>Clear OAuth State</code>:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/assets/images/posts/secure_mcp_oidc_proxy/disconnect_clear_oauth2_state.png" alt="Disconnect and clear OAuth2 state">
</div>
</div>
<div class="paragraph">
<p>But keep the <a href="#start-mcp-server">MCP server running</a>, do not stop it.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s see next how <a href="#use-oidc-proxy">OIDC Proxy can encrypt access and refresh tokens and drop ID token</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="use-oidc-proxy"><a class="anchor" href="#use-oidc-proxy"></a>Step 4: Use OIDC Proxy to encrypt access and refresh tokens and drop ID token</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="point-of-using-oidc-proxy"><a class="anchor" href="#point-of-using-oidc-proxy"></a>What is the point of using OIDC Proxy ?</h3>
<div class="paragraph">
<p>You may be wondering by now, what is the point of using <a href="https://github.com/quarkiverse/quarkus-oidc-proxy">Quarkus OIDC Proxy</a> and <a href="https://github.com/quarkiverse/quarkus-mcp-server">Quarkus MCP Server</a> together, with all the proxying going on between <a href="https://github.com/modelcontextprotocol/inspector">MCP Inspector</a> and Keycloak ?</p>
</div>
<div class="paragraph">
<p>And if you have been following the evolution of the MCP Authorization specification, from its older <a href="https://modelcontextprotocol.io/specification/2025-03-26/basic/authorization">2025-03-26 version</a> to the <a href="https://modelcontextprotocol.io/specification/2025-06-18/basic/authorization">latest one</a>, you may want to ask, does the idea of using <a href="https://github.com/quarkiverse/quarkus-oidc-proxy">Quarkus OIDC Proxy</a> bring us back to the days where the MCP Server was expected to do OAuth2 itself in the <a href="https://modelcontextprotocol.io/specification/2025-03-26/basic/authorization">2025-03-26 version</a> ?</p>
</div>
<div class="paragraph">
<p>Not really, <a href="https://github.com/quarkiverse/quarkus-oidc-proxy">Quarkus OIDC Proxy</a> was introduced in the <a href="https://quarkus.io/blog/oidc-proxy/">Use OIDC Proxy to integrate OIDC service endpoints with custom GPT</a> blog post, more than half a year before the original MCP specification was published.</p>
</div>
<div class="paragraph">
<p>The main idea behind <a href="https://github.com/quarkiverse/quarkus-oidc-proxy">Quarkus OIDC Proxy</a> is to let SPA applications write the same OAuth2 code no matter what the connection details and capabilities of the actual proxied OAuth2 provider are, with the <a href="https://github.com/quarkiverse/quarkus-oidc-proxy">Quarkus OIDC Proxy</a> mediating between the client that is trying to perform various OAuth2 actions and the actual provider.</p>
</div>
<div class="paragraph">
<p>For example, as it happens, Keycloak currently does not accept OAuth2 dynamic client registration requests that are sent directly from the <a href="https://github.com/modelcontextprotocol/inspector">MCP Inspector</a> SPA because its client registration endpoint does not support CORS. However, <a href="https://github.com/quarkiverse/quarkus-oidc-proxy">Quarkus OIDC Proxy</a>, by being co-located with the Quarkus MCP Server, does support CORS, and thus can approve and forward OAuth2 client registration requests from the <a href="https://github.com/modelcontextprotocol/inspector">MCP Inspector</a> SPA&#8217;s host to Keycloak. <a href="https://github.com/quarkiverse/quarkus-oidc-proxy">Quarkus OIDC Proxy</a> can also augment or transform some of the OAuth2 requests and responses.</p>
</div>
<div class="paragraph">
<p>Besides helping SPAs write an interoperable OAuth2 code, <a href="https://quarkus.io/blog/oidc-proxy/#security-considerations">it can help with restricting which authorization code flow tokens can be returned and support a locally managed redirect endpoint</a>.</p>
</div>
<div class="paragraph">
<p>Recently, we have also enhanced <a href="https://github.com/quarkiverse/quarkus-oidc-proxy">Quarkus OIDC Proxy</a> to support encrypting access and refresh tokens before returning them to SPA. We&#8217;ll look at it in the next <a href="#use-oidc-proxy-to-encrypt-tokens">Encrypt access and refresh tokens and drop ID token</a> section.</p>
</div>
</div>
<div class="sect2">
<h3 id="use-oidc-proxy-to-encrypt-tokens"><a class="anchor" href="#use-oidc-proxy-to-encrypt-tokens"></a>Encrypt access and refresh tokens and drop ID token</h3>
<div class="paragraph">
<p>When we were discussing the early <a href="https://modelcontextprotocol.io/specification/2025-03-26/basic/authorization">MCP Authorizaton version 2025-03-26</a> options in the <a href="https://quarkus.io/blog/secure-mcp-sse-server/">Getting ready for secure MCP with Quarkus MCP Server</a> blog post, my colleague <a href="https://github.com/BarDweller">Ozzy Osborne</a> thought about the security of access tokens that were made available to MCP Clients and prototyped a Quarkus MCP Server demo where the MCP Server was used to access GitHub but the Claude AI MCP Client only had access to the wrapped access tokens that can not be used directly against GitHub.</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/quarkiverse/quarkus-oidc-proxy">Quarkus OIDC Proxy</a> builds on Ozzy&#8217;s idea to wrap tokens and makes it possible to encrypt both access and refresh tokens that are returned to the MCP Client.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s see how it works.</p>
</div>
<div class="paragraph">
<p>Add the following configuration properties to the <a href="#mcp-server-configuration">MCP Server Configuration</a>, without restarting the <a href="#start-mcp-server">MCP Server</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties"># Public key in JWK format that OIDC Proxy must use to encrypt access and refresh tokens.
# Keys in the PEM format are also supported.

quarkus.oidc-proxy.token-encryption-key-location=publicKey.jwk <i class="conum" data-value="1"></i><b>(1)</b>

# Private key in JWK format that OIDC Proxy must use to decrypt refresh tokens and Quarkus OIDC - bearer access tokens.

# The private and public keys were generated to support tests and demos.
# 'quarkus.oidc.credentials.secret' property can be used encrypt and decrypt tokens instead.

quarkus.oidc.token.decryption-key-location=privateKey.jwk <i class="conum" data-value="2"></i><b>(2)</b>

# This is a hint to Quarkus OIDC that the incoming access tokens must be decrypted,
# given that by default it expects only encrypted ID tokens when `quarkus.oidc.token.decryption-key-location` is set.

quarkus.oidc.token.decrypt-access-token=true <i class="conum" data-value="3"></i><b>(3)</b>

quarkus.oidc-proxy.allow-id-token=false <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="https://github.com/sberyozkin/quarkus-mcp-server-oidc-proxy/blob/main/secure-mcp-http-server-with-oidc-proxy/src/main/resources/publicKey.jwk">Public RSA key</a> that OIDC Proxy must use to encrypt access and refresh tokens, when intercepting the <code>authorization_code</code> and <code>refresh_token</code> grant responses. Note that Quarkus OIDC that protects the MCP Server does not control the communication between <a href="https://github.com/modelcontextprotocol/inspector">MCP Inspector</a> and the token issuer, therefore it can not encrypt the tokens, only OIDC Proxy can.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><a href="https://github.com/sberyozkin/quarkus-mcp-server-oidc-proxy/blob/main/secure-mcp-http-server-with-oidc-proxy/src/main/resources/privateKey.jwk">Private RSA key</a> that OIDC Proxy must use to decrypt refresh tokens and Quarkus OIDC - bearer access tokens. Note that OIDC Proxy does not control access to the Quarkus service endpoint such as Quarkus MCP server but only intercepts requests/responses to/from the token issuer, therefore it can only decrypt refresh tokens when intercepting <code>refresh_token</code> grant requests, while Quarkus OIDC must handle the decryption of the access tokens that were encrypted by OIDC Proxy and are used to access the MCP Server.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This is a hint to Quarkus OIDC that when the <code>quarkus.oidc.token.decryption-key-location</code> is set, that only an access token, either the bearer or authorization code flow one, that must be decrypted.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>As you could see at the end of the <a href="#use-mcp-inspector-to-access-mcp-server">Step 3: Use MCP Inspector to register OAuth2 Client and access MCP Server</a> section, ID token was also returned to <a href="https://github.com/modelcontextprotocol/inspector">MCP Inspector</a> which does not need it. OIDC proxy also does not encrypt ID tokens the same way it can encrypt access and refresh tokens, because the whole point of an ID token when SPA applications login the user is for SPA be able to find some information about the user from the ID token, therefore encrypting it by the OIDC proxy would make it impossible. But an ID token can contain sensitive information so why return it to SPA which does not need it ? So we let <a href="https://github.com/quarkiverse/quarkus-oidc-proxy">OIDC Proxy</a> remove it from the authorization code flow grant response.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Save the updated configuration, Quarkus MCP Server will notice them in dev mode.</p>
</div>
<div class="paragraph">
<p>Now please go back to the <a href="#use-mcp-inspector-to-access-mcp-server">Step 3: Use MCP Inspector to register OAuth2 Client and access MCP Server</a> section and repeat the same steps, including updating another registered client in Keycloak.
Once you completed the <a href="https://github.com/modelcontextprotocol/inspector">MCP Inspector</a>'s <code>Guided OAuth Flow</code>, check the returned tokens:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/assets/images/posts/secure_mcp_oidc_proxy/token_request_response_without_idtoken.png" alt="Token response without the ID token">
</div>
</div>
<div class="paragraph">
<p>As you can see an ID token is no longer returned.
Now copy the access token value. <a href="https://www.jwt.io/">jwt.io</a> no longer accepts encrypted JWT tokens, but you can find another JWT decoder online such as <a href="https://fusionauth.io/dev-tools/jwt-decoder">FusionAuth JWT Decoder</a>.
Paste the access token - the actual claims are encrypted but it can still show the JWT headers:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/assets/images/posts/secure_mcp_oidc_proxy/oauth2_encrypted_access_token.png" alt="Encrypted access token">
</div>
</div>
<div class="paragraph">
<p>These are not signing but encryption algorithms. <code>RSA-OAEP</code> encrypts the generated content encryption key while <code>A256GCM</code> algorithm uses this key to encrypt claims.</p>
</div>
<div class="paragraph">
<p>In this particular demo, the fact that the access and refresh tokens are encrypted primarily eliminates the information leak risk as Keycloak access and refresh tokens are usually in JWT format and can contain sensitive details. We also rely on the MCP Client to use <a href="https://modelcontextprotocol.io/specification/2025-06-18/basic/authorization#authorization-code-protection">Proof Key for Code Exchange</a> to minimize a risk of the authorizaion code being leaked and the attacker acquiring the tokens, and we enforce the CORS policy in the <a href="#mcp-server-configuration">MCP Server Configuration</a> section to allow requests to the MCP Server only from the known <a href="https://github.com/modelcontextprotocol/inspector">MCP Inspector</a>'s host and port.</p>
</div>
<div class="paragraph">
<p>Encrypting access tokens before returning them to the MCP Client is very useful when your MCP Server is implemented to propagate the incoming access tokens to other services, such as GitHub, or downstream microservices that may not enforce specific CORS policies, or token verification constraints such as a token audience check. In such cases, if the MCP Client leaks the access token, the attacker can bypass Quarkus MCP server and access those other services directly. This risk is avoided when the access token is encrypted by <a href="https://github.com/quarkiverse/quarkus-oidc-proxy">OIDC Proxy</a> because those other services won&#8217;t be able to decrypt it.</p>
</div>
<div class="paragraph">
<p>Similarly, when the SPA tries to use a refresh token to refresh the expired access token and the attacker manages to get hold of the refresh token and is aware of the actual token issuer&#8217;s refresh endpoint, then the refresh grant request can go directly to the provider. This risk is avoided when the refresh token is encrypted by <a href="https://github.com/quarkiverse/quarkus-oidc-proxy">OIDC Proxy</a> because the token issuer won&#8217;t be able to decrypt it.</p>
</div>
<div class="paragraph">
<p>Now that we discussed why it may be worth encrypting the access and refresh tokens, please go to the end of the <a href="#use-mcp-inspector-to-access-mcp-server">Step 3: Use MCP Inspector to register OAuth2 Client and access MCP Server</a> section, <code>Connect</code> to the MCP Server, and run the tool to confirm that the encrypted access token is correctly decrypted by the MCP Server.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="security-considerations"><a class="anchor" href="#security-considerations"></a>Security Considerations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The key security recommendation remains the same as the one in the <a href="https://quarkus.io/blog/secure-mcp-server-oauth2/#security-considerations">Use MCP OAuth2 Flow to access Quarkus MCP Server</a> blog post: secure Quarkus MCP servers must enforce that access tokens have a correct audience, for the MCP Server to assert that the current token is meant to access this MCP server only. And indeed, MCP Servers that propagate tokens further should consider exchanging such tokens, for a new token to target the downstream service correctly - it also minimizes the risk discussed next.</p>
</div>
<div class="paragraph">
<p>When your MCP server forwards the tokens, please consider how to minimize a risk of the attacker stealing the tokens from the MCP Client and using them to access directly the same services that MCP Server forwards tokens to. <a href="https://github.com/quarkiverse/quarkus-oidc-proxy">Quarkus OIDC Proxy</a> provides a way to <a href="#use-oidc-proxy-to-encrypt-tokens">encrypt access and refresh tokens</a> that are returned to the MCP Client, making them acceptable only by either the MCP server or <a href="https://github.com/quarkiverse/quarkus-oidc-proxy">OIDC Proxy</a> itself.</p>
</div>
<div class="paragraph">
<p>When MCP Client registers OAuth2 Clients dynamically, please consider enforcing a user consent during the authentication with a standard OpenId Connect <code>prompt=consent</code> parameter. <a href="https://github.com/quarkiverse/quarkus-oidc-proxy">Quarkus OIDC Proxy</a> recognizes the <code>quarkus.oidc.authentication.extra-params.prompt=consent</code> property that you can use if the MCP Client does not add it itself when initiating an authorization code flow for the dynamically registered client.</p>
</div>
<div class="paragraph">
<p>Please note that the <a href="https://github.com/quarkiverse/quarkus-oidc-proxy">Quarkus OIDC Proxy</a> extension currently has an <code>experimental</code> status, therefore, while we do encourage you to experiment with it, we do not recommend to use it in production for the purpose of hardening the <a href="https://github.com/quarkiverse/quarkus-mcp-server">Quarkus MCP Server</a> token security yet.</p>
</div>
<div class="paragraph">
<p>Please never use a wildcard CORS policy in production, get the MCP server accept only known MCP Client SPA origins.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conclusion"><a class="anchor" href="#conclusion"></a>Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this blog post we looked at how <a href="https://github.com/quarkiverse/quarkus-oidc-proxy">Quarkus OIDC Proxy</a> can help to harden the security of <a href="https://github.com/quarkiverse/quarkus-mcp-server">Quarkus MCP Server</a> tokens, by encrypting access and refresh tokens, and removing a possibly sensitive ID token, before the tokens are returned to the MCP Client.</p>
</div>
<div class="paragraph">
<p>We also used <a href="https://github.com/quarkiverse/quarkus-oidc-proxy">Quarkus OIDC Proxy</a> to get OAuth2 Dynamic Client Registration working by controlling the CORS policy at the <a href="https://github.com/quarkiverse/quarkus-mcp-server">Quarkus MCP Server</a> level and forwarding the client registration requests to Keycloak.</p>
</div>
<div class="paragraph">
<p>Please let us know what you think, enjoy !</p>
</div>
</div>
</div>
              
          </div>
          <div class="width-12-12"><div class="share-page">
  <a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https://quarkus.io/blog/secure-mcp-oidc-proxy/&title=Use Quarkus OIDC Proxy to encrypt Quarkus MCP Server tokens" rel="nofollow" target="_blank" title="Share on LinkedIn">
    <i class="fa-brands fa-linkedin fa-xl"></i>
  </a>
  <a class="share-x" href="https://x.com/intent/tweet?text=Use Quarkus OIDC Proxy to encrypt Quarkus MCP Server tokens&url=https://quarkus.io/blog/secure-mcp-oidc-proxy/&via=quarkusio&related=quarkusio" rel="nofollow" target="_blank" title="Share on X">
    <i class="fa-brands fa-square-x-twitter fa-xl"></i>
  </a>
  <a class="share-facebook" href="https://facebook.com/sharer.php?u=https://quarkus.io/blog/secure-mcp-oidc-proxy/" rel="nofollow" target="_blank" title="Share on Facebook">
    <i class="fa-brands fa-square-facebook fa-xl"></i>
  </a>
  <a class="share-reddit" href="http://www.reddit.com/submit?url=https://quarkus.io/blog/secure-mcp-oidc-proxy/" onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;" title="Share on Reddit" >
    <i class="fa-brands fa-square-reddit fa-xl"></i>
  </a>
  <a class="share-email" href="mailto:?subject=Use Quarkus OIDC Proxy to encrypt Quarkus MCP Server tokens&amp;body=Use Quarkus OIDC Proxy to encrypt Quarkus MCP Server tokens https://quarkus.io/blog/secure-mcp-oidc-proxy/" title="Share via Email" >
    <i class="fa-solid fa-envelope fa-xl"></i>
  </a>
</div>
</div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="post-page grid-wrapper">
  <div class="width-8-12 width-12-12-m doc-content">
  <script src="https://giscus.app/client.js"
        data-repo="quarkusio/quarkus"
        data-repo-id="MDEwOlJlcG9zaXRvcnkxMzk5MTQ5MzI="
        data-category="Quarkus Blog/Website"
        data-category-id="DIC_kwDOCFbutM4CAFFV"
        data-mapping="og:title"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-theme="preferred_color_scheme"
        data-lang="en"
        crossorigin="anonymous"
        async>
  </script>
  </div>
</div>

  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_reverse.svg" class="project-logo" title="Quarkus"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">Quarkus is open. All dependencies of this project are available under the <a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>Apache Software License 2.0</a> or compatible license. <i class='fab fa-creative-commons'></i><i class='fab fa-creative-commons-by'></i> <a href='https://creativecommons.org/licenses/by/3.0/' target='_blank'>CC by 3.0</a><br /><br />This website was built with <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a>, is hosted on <a href='https://pages.github.com/' target='_blank'>GitHub Pages</a> and is completely open source. If you want to make it better, <a href='https://github.com/quarkusio/quarkusio.github.io' target='_blank'>fork the website</a> and show us what you’ve got.</p>

    
      <div class="width-1-12 project-links">
        <span>Navigation</span>
        <ul class="footer-links">
          
          
            <li><a href="/" target="_blank">Home</a></li>
          
          
          
            <li><a href="/about" target="_blank">About</a></li>
          
          
          
            <li><a href="/blog" target="_blank">Blog</a></li>
          
          
          
            <li><a href="/insights" target="_blank">Podcast</a></li>
          
          
          
            <li><a href="/events" target="_blank">Events</a></li>
          
          
          
            <li><a href="/newsletter" target="_blank">Newsletter</a></li>
          
          
          
            <li><a href="/userstories" target="_blank">User Stories</a></li>
          
          
          
            <li><a href="https://github.com/orgs/quarkusio/projects/13/views/1" target="_blank">Roadmap</a></li>
          
          
          
            <li><a href="/security" target="_blank">Security&nbsp;policy</a></li>
          
          
          
            <li><a href="/usage" target="_blank">Usage</a></li>
          
          
          
            <li><a href="/brand" target="_blank">Brand</a></li>
          
          
          
            <li><a href="/desktopwallpapers" target="_blank">Wallpapers</a></li>
          
          
          
            <li><a href="https://www.redhat.com/en/about/privacy-policy" target="_blank">Privacy Policy</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Follow Us</span>
        <ul class="footer-links">
          
          
            <li><a href="https://x.com/quarkusio" target="_blank">X</a></li>
          
          
          
            <li><a href="https://bsky.app/profile/quarkus.io" target="_blank">Bluesky</a></li>
          
          
          
            <li><a rel="me" href="https://fosstodon.org/@quarkusio" target="_blank">Mastodon</a></li>
            
          
          
            <li><a href="https://www.threads.com/@quarkusio" target="_blank">Threads</a></li>
          
          
          
            <li><a href="https://www.facebook.com/quarkusio" target="_blank">Facebook</a></li>
          
          
          
            <li><a href="https://www.linkedin.com/company/quarkusio/" target="_blank">Linkedin</a></li>
          
          
          
            <li><a href="https://www.youtube.com/channel/UCaW8QG_QoIk_FnjLgr5eOqg" target="_blank">Youtube</a></li>
          
          
          
            <li><a href="https://github.com/quarkusio" target="_blank">GitHub</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-2-12 project-links">
        <span>Get Help</span>
        <ul class="footer-links">
          
          
            <li><a href="/support" target="_blank">Support</a></li>
          
          
          
            <li><a href="/guides" target="_blank">Guides</a></li>
          
          
          
            <li><a href="/faq" target="_blank">FAQ</a></li>
          
          
          
            <li><a href="/get-started" target="_blank">Get Started</a></li>
          
          
          
            <li><a href="https://stackoverflow.com/questions/tagged/quarkus" target="_blank">Stack Overflow</a></li>
          
          
          
            <li><a href="https://github.com/quarkusio/quarkus/discussions" target="_blank">Discussions</a></li>
          
          
          
            <li><a href="https://groups.google.com/forum/#!forum/quarkus-dev" target="_blank">Development mailing list</a></li>
          
          
          
            <li><a href="https://stats.uptimerobot.com/ze1PfweT2p" target="_blank">Quarkus Service Status</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Languages</span>
        <ul class="footer-links">
          
          
            <li><a href="https://quarkus.io/" target="_blank">English</a></li>
          
          
          
            <li><a href="https://pt.quarkus.io/" target="_blank">Português&nbsp;(Brasileiro)</a></li>
          
          
          
            <li><a href="https://es.quarkus.io/" target="_blank">Español</a></li>
          
          
          
            <li><a href="https://cn.quarkus.io/" target="_blank">简体中文</a></li>
          
          
          
            <li><a href="https://ja.quarkus.io/" target="_blank">日本語</a></li>
          
          
        </ul>
      </div>
    

    
      <div class="width-4-12 more-links">
        <span>Quarkus is made of community projects</span>
        <ul class="footer-links">
          
            <li><a blah href="https://vertx.io/" target="_blank">Eclipse Vert.x</a></li>
          
            <li><a blah href="https://smallrye.io" target="_blank">SmallRye</a></li>
          
            <li><a blah href="https://hibernate.org" target="_blank">Hibernate</a></li>
          
            <li><a blah href="https://netty.io" target="_blank">Netty</a></li>
          
            <li><a blah href="https://resteasy.github.io" target="_blank">RESTEasy</a></li>
          
            <li><a blah href="https://camel.apache.org" target="_blank">Apache Camel</a></li>
          
            <li><a blah href="https://microprofile.io" target="_blank">Eclipse MicroProfile</a></li>
          
            <li><a blah href="https://code.quarkus.io/" target="_blank">And many more...</a></li>
          
        </ul>
      </div>
    
  </div>
</div>

  <div class="content cf-footer">
  <div class="flexcontainer">
    <div class="cf-logo">
      <a class="cf-logo" href="https://www.commonhaus.org/" target="_blank"><img src="https://raw.githubusercontent.com/commonhaus/artwork/main/foundation/brand/svg/CF_logo_horizontal_single_reverse.svg"/></a>
    </div>
    <div class="license">
      Copyright © Quarkus. All rights reserved. For details on our trademarks, please visit our <a href="https://www.commonhaus.org/policies/trademark-policy/">Trademark Policy</a> and <a href="https://www.commonhaus.org/trademarks/">Trademark List</a>. Trademarks of third parties are owned by their respective holders and their mention here does not suggest any endorsement or association.
    </div>
  </div>
</div>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/scroll-down.js"></script>
  <script src="/assets/javascript/satellite.js" type="text/javascript"></script>
  <script src="/guides/javascript/config.js" type="text/javascript"></script>
  <script src="/assets/javascript/guides-version-dropdown.js" type="text/javascript"></script>
  <script src="/assets/javascript/back-to-top.js" type="text/javascript"></script>
  <script src="/assets/javascript/clipboard.min.js" type="text/javascript"></script>
  <script src="/assets/javascript/copy.js" type="text/javascript"></script>
  <script src="/assets/javascript/asciidoc-tabs.js" type="text/javascript"></script>
  <script src="/assets/javascript/future-date.js" type="text/javascript"></script>
  <script src="/assets/javascript/randomize.js" type="text/javascript"></script>
  <script src="/assets/javascript/time.js" type="text/javascript"></script>
</body>

</html>
