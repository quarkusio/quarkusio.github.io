<!DOCTYPE html>
<html lang="en">







<head>
  <title>Use Quarkus MCP client to access secure MCP HTTP server from command line - Quarkus</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="
  connect-src 'self' https://dpm.demdex.net https://adobedc.demdex.net https://analytics.ossupstream.org/ https://search.quarkus.io https://smetrics.redhat.com; 
  script-src 'self' 'unsafe-inline' 'unsafe-eval'
      
      https://assets.adobedtm.com
      js.bizographics.com
      https://www.redhat.com
      https://static.redhat.com
      https://app.requestly.io/
      jsonip.com
      https://ajax.googleapis.com
      https://use.fontawesome.com
      http://www.youtube.com
      http://www.googleadservices.com
      https://googleads.g.doubleclick.net
      https://giscus.app
      https://analytics.ossupstream.org/
      https://app.mailjet.com;

  style-src 'self' https://fonts.googleapis.com https://use.fontawesome.com; 
  img-src 'self' * data:; 
  media-src 'self'; 
  frame-src https://redhat.demdex.net https://www.youtube.com https://player.restream.io https://app.mailjet.com http://xy0p2.mjt.lu https://mj.quarkus.io https://giscus.app; 
  base-uri 'none'; 
  object-src 'none'; 
  form-action 'none'; 
  font-src 'self' https://use.fontawesome.com https://fonts.gstatic.com;" />
  <script id="adobe_dtm" src="https://www.redhat.com/dtm.js" type="text/javascript"></script>
  <script src="/assets/javascript/highlight.pack.js" type="text/javascript"></script>
  <META HTTP-EQUIV='X-XSS-Protection' CONTENT="1; mode=block">
  <META HTTP-EQUIV='X-Content-Type-Options' CONTENT="nosniff">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Quarkus: Supersonic Subatomic Java">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@QuarkusIO"> 
  <meta name="twitter:creator" content="@QuarkusIO">
  <meta property="og:url" content="https://quarkus.io/blog/secure-mcp-oidc-client/" />
  <meta property="og:title" content="Use Quarkus MCP client to access secure MCP HTTP server from command line" />
  <meta property="og:description" content="Quarkus: Supersonic Subatomic Java" />
  <meta property="og:image" content="https://quarkus.io/assets/images/quarkus_card.png" />
  
  <link rel="canonical" href="https://quarkus.io/blog/secure-mcp-oidc-client/">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/guides/stylesheet/config.css" />
  <link rel="stylesheet" href="/assets/css/main.css?2021-07-29" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.5.2/css/all.css" crossorigin="anonymous">
  <link rel="alternate" type="application/rss+xml"  href="/feed.xml" title="Quarkus">
  <script src="/assets/javascript/hl.js" type="text/javascript"></script>
  
  
  
  
  <link rel="alternate" hreflang="en" href="https://quarkus.io/blog/secure-mcp-oidc-client/" />
  
  <link rel="alternate" hreflang="pt-br" href="https://pt.quarkus.io/blog/secure-mcp-oidc-client/" />
  
  <link rel="alternate" hreflang="es" href="https://es.quarkus.io/blog/secure-mcp-oidc-client/" />
  
  <link rel="alternate" hreflang="zh" href="https://cn.quarkus.io/blog/secure-mcp-oidc-client/" />
  
  <link rel="alternate" hreflang="ja" href="https://ja.quarkus.io/blog/secure-mcp-oidc-client/" />
  
  <link rel="alternate" hreflang="x-default" href="https://quarkus.io/" />  
  <script src="/assets/javascript/tracking.js"></script>
  
  <script src="/assets/javascript/colormode.js" type="text/javascript"></script>

</head>

<body class="post">

  
  <div class="nav-wrapper">
  <div class="grid-wrapper">
    <div class="width-12-12">
      <input type="checkbox" id="checkbox" />
      <nav id="main-nav" class="main-nav">
        <div class="logo-wrapper">
           <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_600px_reverse.png" class="project-logo" title="Quarkus"></a>
        </div>
    <label class="nav-toggle" for="checkbox">
      <i class="fa fa-bars"></i>
    </label>
    <ul id="menu" class="menu">
      <li class="dropdown">
        <span href="/about/">Why<i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/about" class="">WHAT IS QUARKUS?</a></li>
          <li><a href="/developer-joy" class="">DEVELOPER JOY</a></li>
          <li><a href="/performance" class="">PERFORMANCE</a></li>
          <li><a href="/kubernetes-native" class="">KUBERNETES NATIVE</a></li>
          <li><a href="/standards" class="">STANDARDS</a></li>
          <li><a href="/versatility" class="">VERSATILITY</a></li>
          <li><a href="/container-first" class="">CONTAINER FIRST</a></li>  
          <li><a href="/spring" class="">USING SPRING?</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="/learn/">Learn<i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/get-started" class="">GET STARTED</a></li>
          <li><a href="/guides" class="">DOCUMENTATION</a></li>
          <li><a href="/userstories/" class="">USER STORIES</a></li>  
          <li><a href="/qtips" class="">"Q" TIP VIDEOS</a></li>          
          <li><a href="/books" class="">BOOKS</a></li>
          </ul>
      </li>
      <li class="dropdown">
        <span href="https://quarkus.io/extensions/">Extensions<i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <!-- Note that quarkus.io is hardcoded here, because it is the only url which supports extensions -->
          <li><a href="https://quarkus.io/extensions/" class="">BROWSE EXTENSIONS</a></li>
          <li><a href="/faq/#what-is-a-quarkus-extension" class="">USE EXTENSIONS</a></li>
          <li><a href="/guides/writing-extensions" class="">CREATE EXTENSIONS</a></li>
          <li><a href="https://hub.quarkiverse.io" class="">SHARE EXTENSIONS</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="/community/">Community<i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/support/" class="">SUPPORT</a></li>
          <li><a href="/blog" class="active">BLOG</a></li>
          <li><a href="/discussion" class="">DISCUSSION</a></li>
          <li><a href="/working-groups" class="">WORKING GROUPS</a></li>
          <li><a href="/insights" class="">PODCAST</a></li>
          <li><a href="/events" class="">EVENTS</a></li>
          <li><a href="/newsletter" class="">NEWSLETTER</a></li>
          <li><a href="https://github.com/orgs/quarkusio/projects/13/views/1" class="">ROADMAP</a></li>
          </ul>
      </li>
      <li>
        <a href="https://code.quarkus.io" class="button-cta secondary white">START CODING</a>
      </li>
      <li class="dropdown">
        <span href="/language/"><div class="fas fa-globe langicon"></div><i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="https://quarkus.io/blog/secure-mcp-oidc-client/" >OFFICIAL (ENGLISH)</a></li>
          <li><a href="https://pt.quarkus.io/blog/secure-mcp-oidc-client/">PORTUGUÊS (BR)</a></li>
          <li><a href="https://es.quarkus.io/blog/secure-mcp-oidc-client/">ESPAÑOL</a></li>
          <li><a href="https://cn.quarkus.io/blog/secure-mcp-oidc-client/">简体中文</a></li>
          <li><a href="https://ja.quarkus.io/blog/secure-mcp-oidc-client/">日本語</a></li>
          </ul>
      </li>
      <li>
        <span href="#" class="modeswitcher" id='theme-toggle'><i class="fas fa-sun"></i><i class="fas fa-moon"></i><i class="fas fa-cog"></i></span>
      </li>
    </ul>
      </nav>
    </div>
  </div>
</div>

  <div class="content">
    <div class="full-width-breadcrumb-bg align-self">
  <div class="width-12-12">
      <p class="returnlink"><a href="/blog">Blog</a> <i class="fas fa-chevron-right"></i> Use Quarkus MCP client to access secure MCP HTTP server from command line</p>
  </div>
</div>

<div class="post-page grid-wrapper">
  <div class="width-8-12 width-12-12-m doc-content">
    <div class="grid-wrapper">
      <div class="width-12-12">
        <div class="post-date">
          July 23, 2025 
          
            <span class="tags"><a href="/blog/tag/ai">#ai</a><a href="/blog/tag/mcp">#mcp</a><a href="/blog/tag/security">#security</a></span>
          
        </div>
        <h1 class="post-title">Use Quarkus MCP client to access secure MCP HTTP server from command line</h1>
        <div class="grid-wrapper">
          <div class="width-8-12 width-12-12-m byline-wrapper">
            
            
              <img class="headshot" src="https://www.gravatar.com/avatar/7941c5788c2e02a4f7f51409afca3090">
            
            <p class="byline">By <a href="/author/sberyozkin">Sergey Beryozkin</a></p>
          </div>
          <div class="width-12-12">
              <div class="sect1">
<h2 id="introduction"><a class="anchor" href="#introduction"></a>Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the <a href="https://quarkus.io/blog/secure-mcp-client/">Use Quarkus MCP client to access secure MCP HTTP servers</a> blog post, we explained how a user can login to Quarkus LangChain4j AI server application with GitHub OAuth2 and have Google AI Gemini use <a href="https://docs.quarkiverse.io/quarkus-langchain4j/dev/mcp.html">Quarkus MCP Client</a> to access a secure <a href="https://github.com/quarkiverse/quarkus-mcp-server">Quarkus MCP Server</a> user name provider tool with a GitHub access token.</p>
</div>
<div class="paragraph">
<p>However, not every AI service application is going to be designed to require a user login: for example, it may run as a command line application or cron scheduler. But also, not every AI service application that requires a user login will be able to use a user login token to access a secure MCP server because such a server may only support tokens of different type.</p>
</div>
<div class="paragraph">
<p>In this blog post, we will explain how <a href="https://docs.quarkiverse.io/quarkus-langchain4j/dev/mcp.html">Quarkus MCP Client</a> that runs in a command line Quarkus LangChain4j AI application can itself acquire an access token using an OAuth2 <code>client_credentials</code> grant and use it to access a secure <a href="https://github.com/quarkiverse/quarkus-mcp-server">Quarkus MCP Server</a> service account name provider tool.</p>
</div>
<div class="paragraph">
<p>We will work with <a href="https://www.keycloak.org/">Keycloak</a> and rely on it to demonstrate how to approach securing complex, distributed AI applications that may span multiple security boundaries, by requiring that access tokens are restricted to specific audiences, and exchanging them to acquire new, correct audiences.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="demo-architecture"><a class="anchor" href="#demo-architecture"></a>Demo architecture</h2>
<div class="sectionbody">
<div class="imageblock text-center">
<div class="content">
<img src="/assets/images/posts/secure_mcp_oidc_client/demo-architecture.png" alt="Command Line Poem Service Architecture">
</div>
</div>
<div class="paragraph">
<p>As you can see in the diagram above, a command line agent uses a <code>Poem Service</code> AI service to create a poem. The <code>Poem Service</code> uses <code>AI Gemini</code> and requests <code>MCP Client</code> to complete a tool call to help <code>AI Gemini</code> to find out the service account name.</p>
</div>
<div class="paragraph">
<p>The MCP client must use an access token. It uses an OAuth2 <code>client_credential</code> grant to acquire a service account token and propagate it to the secure MCP server. This service account token&#8217;s audience restricts it to accessing the MCP server only.</p>
</div>
<div class="paragraph">
<p>The MCP server tool implementation must access a REST server to complete the tool action. However, it can not use the current access token that is restricted to accessing this MCP server because the REST server accepts tokens that are meant to access this REST server only.</p>
</div>
<div class="paragraph">
<p>Therefore, the MCP server exchanges the current token to set the REST server audience before propagating it, with the REST server successfully completing the secure tool call, with the response returned to the MCP Client.</p>
</div>
<div class="paragraph">
<p>We are now ready to start working on the demo.</p>
</div>
<div class="paragraph">
<p>You can find the complete project source in the <a href="https://github.com/quarkiverse/quarkus-langchain4j/tree/main/samples/secure-mcp-cmd-client-server">Quarkus LangChain4j Command Line Secure MCP Client Server sample</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="create-mcp-server"><a class="anchor" href="#create-mcp-server"></a>Step 1 - Create and start MCP server</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First, let&#8217;s create a secure Quarkus MCP SSE server that can enforce an authenticated access to its tool, verify that the access token has a correct audience, and complete a tool action by exchanging the current access token for a new access token with the REST server audience and propagating this token to the REST server to get the required service account name.</p>
</div>
<div class="sect2">
<h3 id="mcp-server-dependencies"><a class="anchor" href="#mcp-server-dependencies"></a>MCP server maven dependencies</h3>
<div class="paragraph">
<p>Add the following dependencies:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.quarkiverse.mcp&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-mcp-server-sse&lt;/artifactId&gt; <i class="conum" data-value="1"></i><b>(1)</b>
    &lt;version&gt;1.4.0&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-oidc&lt;/artifactId&gt; <i class="conum" data-value="2"></i><b>(2)</b>
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-rest&lt;/artifactId&gt; <i class="conum" data-value="3"></i><b>(3)</b>
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-rest-client-oidc-token-propagation&lt;/artifactId&gt; <i class="conum" data-value="4"></i><b>(4)</b>
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>quarkus-mcp-server-sse</code> is required to support MCP Streamable HTTP and SSE transports.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>quarkus-oidc</code> is required to secure access to MCP SSE endpoints. Its version is defined in the Quarkus BOM.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>quarkus-rest</code> is required to support REST server that the MCP tool has to call. Its version is defined in the Quarkus BOM.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>quarkus-rest-client-oidc-token-propagation</code> also brings <code>quarkus-rest-client</code> and is required to support a REST client call to REST server with the token exchange and propagation. Its version is defined in the Quarkus BOM.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="mcp-server-tool"><a class="anchor" href="#mcp-server-tool"></a>MCP Service Account Name Tool</h3>
<div class="paragraph">
<p>Let&#8217;s create a tool that can return a name of the current service account.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package io.quarkiverse.langchain4j.sample;

import org.eclipse.microprofile.rest.client.inject.RestClient;
import io.quarkiverse.mcp.server.TextContent;
import io.quarkiverse.mcp.server.Tool;
import jakarta.inject.Inject;

public class ServiceAccountNameProvider { <i class="conum" data-value="1"></i><b>(1)</b>

    @RestClient
    @Inject
    ServiceAccountNameRestClient serviceAccountNameRestClient; <i class="conum" data-value="2"></i><b>(2)</b>

    @Tool(name = "sevice-account-name-provider", description = "Provides a name of the current service account") <i class="conum" data-value="1"></i><b>(1)</b>
    TextContent provideServiceAccountName() {
        return new TextContent(serviceAccountNameRestClient.getServiceAccountName()); <i class="conum" data-value="2"></i><b>(2)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Provide a tool that can return a name of the current service account.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use an injected <code>ServiceAccountNameRestClient</code> to access the REST server to complete the service account name request. See the <a href="#service-account-name-rest-client">Service Account Name REST client</a> section below for more details.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The MCP server tool can be invoked only if the current MCP request is authenticated.</p>
</div>
<div class="paragraph">
<p>In this blog post we do not enforce the secure tool access with annotations such as <a href="https://quarkus.io/blog/secure-mcp-client/#mcp-server-tool">@PermissionAllowed</a> or <a href="https://quarkus.io/blog/secure-mcp-sse-server/#tool">@Authenticated</a> but only use the HTTP security policy configuration instead.</p>
</div>
<div class="paragraph">
<p>See how both main MCP SSE and tool endpoints are secured in the <a href="#mcp-server-configuration">MCP Server Configuration</a> section below.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="service-account-name-rest-client"><a class="anchor" href="#service-account-name-rest-client"></a>Service Account Name REST client</h3>
<div class="paragraph">
<p>The <a href="#mcp-server-tool">MCP Service Account Name Tool</a> uses the Service Account Name REST client to call the REST server to complete a service account name request.</p>
</div>
<div class="paragraph">
<p>This REST client looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package io.quarkiverse.langchain4j.sample;

import org.eclipse.microprofile.rest.client.inject.RegisterRestClient;
import io.quarkus.oidc.token.propagation.common.AccessToken;
import jakarta.ws.rs.GET;
import jakarta.ws.rs.Produces;

@RegisterRestClient
@AccessToken <i class="conum" data-value="2"></i><b>(2)</b>
public interface ServiceAccountNameRestClient {

    @GET
    @Produces("text/plain")
    String getServiceAccountName(); <i class="conum" data-value="1"></i><b>(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Get a service account name from the REST server. See the <a href="#service-account-name-rest-server">Service Account Name REST server</a> section below for more details.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use <code>@AccessToken</code> annotation to require the access token exchange and propagation. This single <code>@AccessToken</code> annotation, supported by an additional configuration in the <a href="#mcp-server-configuration">MCP Server Configuration</a> section below, is all that is required to support this complex access token flow.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="service-account-name-rest-server"><a class="anchor" href="#service-account-name-rest-server"></a>Service Account Name REST server</h3>
<div class="paragraph">
<p>The <a href="#mcp-server-tool">MCP Service Account Name Tool</a> uses the <a href="#service-account-name-rest-client">Service Account Name REST client</a> to get a service account name from the Service Account Name REST server.</p>
</div>
<div class="paragraph">
<p>This REST server looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package io.quarkiverse.langchain4j.sample;

import io.quarkus.security.Authenticated;
import io.quarkus.security.identity.SecurityIdentity;
import jakarta.inject.Inject;
import jakarta.ws.rs.GET;
import jakarta.ws.rs.Path;
import jakarta.ws.rs.Produces;

@Path("/service-account-name")
public class ServiceAccountNameRestServer {

    @Inject
    SecurityIdentity securityIdentity;

    @GET
    @Produces("text/plain")
    @Authenticated <i class="conum" data-value="1"></i><b>(1)</b>
    public String getServiceAccountName() {
        return securityIdentity.getPrincipal().getName(); <i class="conum" data-value="2"></i><b>(2)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Provide a secure REST resource method that can return a service account name</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use an injected <code>SecurityIdentity</code> to complete the method&#8217;s task, in this case - return a service account identity name.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In this demo, the REST server is collocated with the MCP server to simplify the demo. Of course, in production, such REST servers will most likely be remote.</p>
</div>
<div class="paragraph">
<p>Next, let&#8217;s have a look, in the <a href="#mcp-server-configuration">MCP Server Configuration</a> section, how access to both the <a href="#mcp-server-tool">MCP Service Account Name Tool</a> and this server is restricted to tokens with specific audiences only.</p>
</div>
</div>
<div class="sect2">
<h3 id="mcp-server-configuration"><a class="anchor" href="#mcp-server-configuration"></a>MCP Server Configuration</h3>
<div class="paragraph">
<p>Let&#8217;s configure our secure MCP server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties"># MCP server
quarkus.mcp.server.server-info.name=Service Account Name Provider <i class="conum" data-value="1"></i><b>(1)</b>
quarkus.mcp.server.traffic-logging.enabled=true
quarkus.mcp.server.traffic-logging.text-limit=1000

# Require an authenticated access to MCP server
quarkus.http.auth.permission.authenticated.paths=/mcp/* <i class="conum" data-value="2"></i><b>(2)</b>
quarkus.http.auth.permission.authenticated.policy=authenticated

# Default Quarkus OIDC tenant that verifies access tokens which reach the MCP server.
quarkus.oidc.client-id=quarkus-mcp-server <i class="conum" data-value="3"></i><b>(3)</b>
quarkus.oidc.token.audience=quarkus-mcp-server <i class="conum" data-value="4"></i><b>(4)</b>

# Request a token exchange before the token propagation
quarkus.rest-client-oidc-token-propagation.exchange-token=true <i class="conum" data-value="4"></i><b>(4)</b>

# OIDC client that performs the current token exchange
quarkus.oidc-client.auth-server-url=${quarkus.oidc.auth-server-url} <i class="conum" data-value="5"></i><b>(5)</b>
quarkus.oidc-client.client-id=${quarkus.oidc.client-id}
quarkus.oidc-client.credentials.secret=${quarkus.oidc.credentials.secret}
quarkus.oidc-client.scopes=quarkus-mcp-service-scope
quarkus.oidc-client.grant.type=exchange
quarkus.oidc-client.grant-options.exchange.subject_token_type=urn:ietf:params:oauth:token-type:access_token <i class="conum" data-value="6"></i><b>(6)</b>

# REST client which accesses a protected REST server, by propagating the exchanged token
io.quarkiverse.langchain4j.sample.ServiceAccountNameRestClient/mp-rest/url=http://localhost:8080/service-account-name  <i class="conum" data-value="7"></i><b>(7)</b>

# OIDC `service-account-name-rest-server` tenant that secures a protected REST server.
quarkus.oidc.service-account-name-rest-server.auth-server-url=${quarkus.oidc.auth-server-url} <i class="conum" data-value="8"></i><b>(8)</b>
quarkus.oidc.service-account-name-rest-server.token.audience=quarkus-mcp-service <i class="conum" data-value="9"></i><b>(9)</b>
quarkus.oidc.service-account-name-rest-server.tenant-paths=/service-account-name

# Keycloak devservice that enables a default OIDC tenant that secures MCP server.
quarkus.keycloak.devservices.image-name=quay.io/keycloak/keycloak:26.3.1 <i class="conum" data-value="10"></i><b>(10)</b>
quarkus.keycloak.devservices.port=8081
# Keycloak may require more memory on some systems
quarkus.keycloak.devservices.container-memory-limit=1250M</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declare MCP server and enable traffic logging.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Enforce an authenticated access to the main MCP SSE and tool endpoints. The configured pattern covers both the initial '/mcp/sse' handshake and '/mcp/messages/' requests.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Default OIDC tenant that secures the MCP SSE endpoint and tool. It is supported by Keycloak Dev Service in dev mode. In simple cases you do not even have to configure the default OIDC tenant. But in this demo, the default OIDC tenant is required to enforce that the tokens which reach the MCP server contain a <code>quarkus-mcp-server</code> audience.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Request an access token exchange before the <a href="#service-account-name-rest-client">Service Account Name REST client</a> propagates it.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Configure OIDC client to perform the token exchange</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Set the <a href="https://datatracker.ietf.org/doc/html/rfc8693#name-token-type-identifiers">type</a> of a new token that the current token will be exchanged for to <code>access_token</code>. Starting from Quarkus 3.25, an expected new  token type will be set to <code>access_token</code> by default, and users will not have to configure this property when the access token type is required when exchanging tokens.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Configure the <a href="#service-account-name-rest-client">Service Account Name REST client</a> with the REST server address. The REST server is collocated with the MCP server only to simplify the demo.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>The OIDC tenant that protects the REST server only.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>The OIDC tenant that protects the REST server requires that the tokens that are used to access it contain a REST server <code>quarkus-mcp-service</code> audience.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Configure Keycloak dev service to use one of the latest released Keycloak images, and make it run on a fixed <code>8081</code> port to simplify the <a href="#poem-service-configuration">Poem Service Configuration</a> where an access to Keycloak is also required.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="start-mcp-server"><a class="anchor" href="#start-mcp-server"></a>Start the MCP server in dev mode</h3>
<div class="paragraph">
<p>Now let&#8217;s start the MCP server in dev mode:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">mvn quarkus:dev</code></pre>
</div>
</div>
<div class="paragraph">
<p>and go to the <a href="#keycloak-setup">Step 2 - Keycloak setup</a> in the next section to complete the Keycloak configuration that is required to support the secure MCP server token audience and exchange requirements.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="keycloak-setup"><a class="anchor" href="#keycloak-setup"></a>Step 2 - Keycloak setup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When we <a href="#start-mcp-server">started the MCP server in dev mode</a>, Keycloak Dev Service launched a Keycloak container, made it available on port <code>8081</code>, created a <code>quarkus</code> realm with the <code>quarkus-mcp-server</code> client - this client name was configured with the <code>quarkus.oidc.client-id=quarkus-mcp-server</code> property in the <a href="#mcp-server-configuration">MCP Server Configuration</a> section.</p>
</div>
<div class="paragraph">
<p>The <code>quarkus-mcp-server</code> client represents a confidential OIDC client that protects the MCP server.</p>
</div>
<div class="paragraph">
<p>But MCP server and REST server have additional token audience and exchange requirements and we must complete the Keycloak setup to support those requirements. Let&#8217;s do it.</p>
</div>
<div class="paragraph">
<p>Go to <code><a href="http://localhost:8081" class="bare">http://localhost:8081</a></code> and login as a Keycloak admin, with the <code>admin</code> name and <code>admin</code> password credentials.</p>
</div>
<div class="paragraph">
<p>Select the <code>quarkus</code> realm:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/assets/images/posts/secure_mcp_oidc_client/quarkus-realm.png" alt="Quarkus Realm">
</div>
</div>
<div class="paragraph">
<p>First, create a <code>quarkus-mcp-client</code> OIDC client that the Quarkus MCP client will use to acquire OAuth2 <code>client_credentials</code> tokens for accessing the MCP server.</p>
</div>
<div class="paragraph">
<p>Start with the <code>General Settings</code>:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/assets/images/posts/secure_mcp_oidc_client/quarkus-mcp-client.png" alt="Quarkus MCP Client">
</div>
</div>
<div class="paragraph">
<p>and enable <code>Client authentication</code> and <code>Service accounts roles</code> capabilities:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/assets/images/posts/secure_mcp_oidc_client/quarkus-mcp-client-service-account.png" alt="Quarkus MCP Client Service Account">
</div>
</div>
<div class="paragraph">
<p>Save the <code>quarkus-mcp-client</code> OIDC client. Click on its <code>Credentials</code> tab and copy the generated secret to export it later as the <a href="#oidc-client-secret">OIDC client secret</a> in order to run the command line AI <code>Poem Service</code> application.</p>
</div>
<div class="paragraph">
<p>For the Quarkus MCP client to be able to access MCP server with access tokens that the <code>quarkus-mcp-client</code> OIDC client will acquire, these tokens must contain an audience (<code>aud</code>) claim with a <code>quarkus-mcp-server</code> audience. The MCP server is configured in the <a href="#mcp-server-configuration">MCP Server Configuration</a> section to require this audience.</p>
</div>
<div class="paragraph">
<p>Keycloak supports several options for adding an audience (<code>aud</code>) claim to issued tokens. We will use an option that involves creating a custom <code>Client scope</code> with an <code>Audience</code> mapping.</p>
</div>
<div class="paragraph">
<p>Go to the <code>Client scopes</code> and create an <code>Optional</code> <code>quarkus-mcp-server-scope</code>:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/assets/images/posts/secure_mcp_oidc_client/quarkus-mcp-server-scope.png" alt="Quarkus MCP Server Scope">
</div>
</div>
<div class="paragraph">
<p>Once the <code>quarkus-mcp-server-scope</code> scope is created, go to its <code>Mappings</code> tab, and choose <code>Configure a new mapper</code> option and select <code>Audience</code>:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/assets/images/posts/secure_mcp_oidc_client/quarkus-mcp-server-scope-aud.png" alt="Quarkus MCP Server Scope Audience">
</div>
</div>
<div class="paragraph">
<p>Name this mapper as <code>quarkus-mcp-server-as-audience</code> and choose <code>quarkus-mcp-server</code> as an <code>Included Client Audience</code>:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/assets/images/posts/secure_mcp_oidc_client/quarkus-mcp-server-scope-aud-details.png" alt="Quarkus MCP Server Scope Audience Details">
</div>
</div>
<div class="paragraph">
<p>Once the <code>quarkus-mcp-server-scope</code> is created, add it as an <code>Optional</code> scope to the <code>quarkus-mcp-client</code>:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/assets/images/posts/secure_mcp_oidc_client/add-quarkus-mcp-server-scope-to-quarkus-mcp-client.png" alt="Add Scope to Client">
</div>
</div>
<div class="paragraph">
<p>Now, when Quarkus MCP client will use the <code>quarkus-mcp-client</code> OIDC client to acquire tokens, it will request a <code>quarkus-mcp-server-scope</code> token scope, resulting in Keycloak issuing tokens with an audience that contains the <code>quarkus-mcp-server</code> - exactly what the Quarkus MCP server requires.</p>
</div>
<div class="paragraph">
<p>Next, we need to support Quarkus MCP server exchanging the incoming access token with the <code>quarkus-mcp-server</code> audience for a new token that will contain a REST server audience instead.</p>
</div>
<div class="paragraph">
<p>Create a <code>quarkus-mcp-service</code> OIDC client that represents the REST server, similarly to how you created the <code>quarkus-mcp-client</code> OIDC client. Next, create a <code>quarkus-mcp-service-scope</code> client scope, similarly to how you created the <code>quarkus-mcp-server-scope</code> client scope, choosing the <code>quarkus-mcp-service</code> as an <code>Included Client Audience</code> when creating an audience mapping for this scope.</p>
</div>
<div class="paragraph">
<p>Once the <code>quarkus-mcp-service-scope</code> is created, add it as an <code>Optional</code>  client scope to the <code>quarkus-mcp-server</code> MCP Server OIDC client, similarly to how you added the <code>quarkus-mcp-server-scope</code> to the <code>quarkus-mcp-client</code> above.</p>
</div>
<div class="paragraph">
<p>Finally, update the <code>quarkus-mcp-server</code> capability to support a <code>Standard Token Exchange</code>, see the <a href="https://www.keycloak.org/securing-apps/token-exchange#_standard-token-exchange-enable">How to enable token exchange</a> example in the Keycloak documentation.</p>
</div>
<div class="paragraph">
<p>Now, the <code>quarkus-mcp-server</code> OIDC client that secures the MCP server can also exchange the incoming token and request a new <code>quarkus-mcp-service</code> audience by adding the <code>quarkus-mcp-service-scope</code> scope to the token exchange grant request, exactly what the REST server requires.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you actively work with another OAuth2 provider that can produce tokens with required audiences and exchange them using a standard token exchange grant, then you can also try to adapt this demo to work with that provider instead.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="create-poem-service"><a class="anchor" href="#create-poem-service"></a>Step 3 - Create and run Poem Service from command line</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The MCP server is now <a href="#start-mcp-server">running</a> and ready to accept tool calls. Let&#8217;s create a command line AI <code>Poem Service</code> that will work with AI Gemini and use Quarkus MCP client to complete tool calls.</p>
</div>
<div class="sect2">
<h3 id="poem-service-maven-dependencies"><a class="anchor" href="#poem-service-maven-dependencies"></a>Poem Service Maven dependencies</h3>
<div class="paragraph">
<p>Add the following dependencies:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.quarkiverse.langchain4j&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-langchain4j-ai-gemini&lt;/artifactId&gt; <i class="conum" data-value="1"></i><b>(1)</b>
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;io.quarkiverse.langchain4j&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-langchain4j-mcp&lt;/artifactId&gt; <i class="conum" data-value="2"></i><b>(2)</b>
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;io.quarkiverse.langchain4j&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-langchain4j-oidc-client-mcp-auth-provider&lt;/artifactId&gt; <i class="conum" data-value="3"></i><b>(3)</b>
&lt;/dependency&gt;
&lt;dependency&gt;
   &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
   &lt;artifactId&gt;quarkus-picocli&lt;/artifactId&gt; <i class="conum" data-value="4"></i><b>(4)</b>
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>quarkus-langchain4j-ai-gemini</code> brings support for AI Gemini.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>quarkus-langchain4j-mcp</code> provides core MCP Client support.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>quarkus-langchain4j-oidc-cient-mcp-auth-provider</code> provides an implementation of <a href="https://docs.quarkiverse.io/quarkus-langchain4j/dev/mcp.html#_authorization">McpClientAuthProvider</a> that can supply access tokens that it itself acquires with an OAuth2 <code>client_credentials</code> grant (or any other supported grant that does not require a user input). Note, this dependency is different from the <code>quarkus-langchain4j-oidc-mcp-auth-provider</code> one that supplies tokens already available after an authorization code flow completes, it was demoed in the <a href="https://quarkus.io/blog/secure-mcp-client/#poem-service-maven-dependencies">Use Quarkus MCP client to access secure MCP HTTP servers</a> blog post to propagate GitHub login access tokens.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>quarkus-picocli</code> supports building command-line Quarkus applications. Its version is defined in the Quarkus BOM.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="ai-gemini-key"><a class="anchor" href="#ai-gemini-key"></a>AI Gemini API key</h3>
<div class="paragraph">
<p><code>Poem Service</code> relies on AI Gemini to create a poem.</p>
</div>
<div class="paragraph">
<p>Get <a href="https://aistudio.google.com/app/apikey">AI Gemini API key</a> and export it as an <code>AI_GEMINI_API_KEY</code> environment property.</p>
</div>
</div>
<div class="sect2">
<h3 id="oidc-client-secret"><a class="anchor" href="#oidc-client-secret"></a>OIDC client secret</h3>
<div class="paragraph">
<p>Quarkus MCP client will use an implementation of <a href="https://docs.quarkiverse.io/quarkus-langchain4j/dev/mcp.html#_authorization">McpClientAuthProvider</a> provided by the <code>quarkus-langchain4j-oidc-cient-mcp-auth-provider</code> dependency.</p>
</div>
<div class="paragraph">
<p>This <code>McpClientAuthProvider</code> uses the <a href="#poem-service-configuration">configured OIDC client</a> to acquire access tokens using an OAuth2 <code>client_credentials</code> grant, where an OIDC client secret must be provided.</p>
</div>
<div class="paragraph">
<p>Export the OIDC <code>quarkus-mcp-client</code> client secret that you copied when working through the <a href="#keycloak-setup">Step 2 - Keycloak setup</a> section as an <code>OIDC_CLIENT_SECRET</code> environment property.</p>
</div>
</div>
<div class="sect2">
<h3 id="poem-service"><a class="anchor" href="#poem-service"></a>Poem Service</h3>
<div class="paragraph">
<p><code>Poem Service</code> is a simple Quarkus LangChain4j AI service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package io.quarkiverse.langchain4j.sample;

import dev.langchain4j.service.UserMessage;
import io.quarkiverse.langchain4j.RegisterAiService;
import io.quarkiverse.langchain4j.mcp.runtime.McpToolBox;

@RegisterAiService
public interface PoemService {
    @UserMessage("""
            Write a short 1 paragraph poem in {language} about a Java programming language.
            Provide a translation to English if the original poem language is not English.
            Dedicate the poem to the service account, refer to this account by its name.""") <i class="conum" data-value="1"></i><b>(1)</b>
    @McpToolBox("service-account-name") <i class="conum" data-value="2"></i><b>(2)</b>
    String writePoem(String language); <i class="conum" data-value="1"></i><b>(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Request to write a poem about Java.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use Quarkus MCP <code>service-account-name</code> client configured in the <a href="#poem-service-configuration">Poem Service Configuration</a> section to call a tool that can provide a service account name.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This service is called from the <code>PoemCommand</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package io.quarkiverse.langchain4j.sample;

import java.util.concurrent.Callable;
import jakarta.enterprise.context.control.ActivateRequestContext;
import jakarta.inject.Inject;
import picocli.CommandLine.Command;
import picocli.CommandLine.Option;

@Command(name = "poem", mixinStandardHelpOptions = true, description = "Create a poem", version = "v1.0")
@ActivateRequestContext
public class PoemCommand implements Callable&lt;Integer&gt; {

    @Option(names = { "-l", "--language" }, description = "Poem language", defaultValue = "English")
    String poemLanguage;

    @Inject
    PoemService poemService;

    @Override
    public Integer call() {
        System.out.println(poemService.writePoem(poemLanguage)); <i class="conum" data-value="1"></i><b>(1)</b>
        return 0;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Call <code>PoemService</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="poem-service-configuration"><a class="anchor" href="#poem-service-configuration"></a>Poem Service Configuration</h3>
<div class="paragraph">
<p>Let&#8217;s see how the command line <code>Poem Service</code> configuration looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.langchain4j.mcp.service-account-name.transport-type=http <i class="conum" data-value="1"></i><b>(1)</b>
quarkus.langchain4j.mcp.service-account-name.url=http://localhost:8081/mcp/sse/ <i class="conum" data-value="2"></i><b>(2)</b>

quarkus.oidc-client.auth-server-url=http://localhost:8081/realms/quarkus <i class="conum" data-value="3"></i><b>(3)</b>
quarkus.oidc-client.client-id=quarkus-mcp-client <i class="conum" data-value="4"></i><b>(4)</b>
quarkus.oidc-client.credentials.secret=${oidc_client_secret} <i class="conum" data-value="5"></i><b>(5)</b>
quarkus.oidc-client.scopes=quarkus-mcp-server-scope <i class="conum" data-value="6"></i><b>(6)</b>

quarkus.langchain4j.ai.gemini.api-key=${ai_gemini_api_key} <i class="conum" data-value="7"></i><b>(7)</b>
quarkus.langchain4j.ai.gemini.log-requests=true <i class="conum" data-value="8"></i><b>(8)</b>
quarkus.langchain4j.ai.gemini.log-responses=true</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Enable MCP client HTTP transport. In this demo we use SSE, but <code>Streamable HTTP</code> is also supported.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Point to the Quarkus MCP server endpoint that you started in the <a href="#start-mcp-server">Start the MCP server in dev mode</a> step.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Configure <a href="https://quarkus.io/guides/security-openid-connect-client-reference">OIDC client</a> to acquire access tokens using OAuth2 <code>client_credentials</code> grant, a default grant type supported by the OIDC client. OIDC client points to a Keycloak <code>quarkus</code> realm, note the fixed <code>8081</code> port that you requested Keycloak Dev Service to use for Keycloak in the <a href="#keycloak-setup">Step 2 - Keycloak setup</a> section.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>OIDC client id, you created the OIDC <code>quarkus-mcp-client</code> client in the <a href="#keycloak-setup">Step 2 - Keycloak setup</a> section.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>OIDC <code>quarkus-mcp-client</code> client secret that you exported during the <a href="#oidc-client-secret">OIDC client secret</a> step.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Request that the tokens issued to <code>quarkus-mcp-client</code> must contain a <code>quarkus-mcp-server</code> MCP server audience. You created a client <code>quarkus-mcp-server-scope</code> scope with a <code>quarkus-mcp-server</code> client audience mapping in the <a href="#keycloak-setup">Step 2 - Keycloak setup</a> section.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>AI Gemini key that you acquired and exported during the <a href="#ai-gemini-key">AI Gemini API key</a> step.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Enable AI Gemini request and response logging</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Please pay attention to the fact that the MCP client configuration has a <code>service-account-name</code> name. You referred to this configuration with the <code>@McpToolBox("service-account-name")</code> annotation in the <a href="#poem-service">Poem Service</a> section.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="package-poem-service"><a class="anchor" href="#package-poem-service"></a>Package Poem Service</h3>
<div class="paragraph">
<p>Package the command line <code>Poem Service</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">mvn clean package</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="run-poem-service"><a class="anchor" href="#run-poem-service"></a>Run Poem Service</h3>
<div class="paragraph">
<p>Run the command line <code>Poem Service</code> that you packaged in the <a href="#package-poem-service">Package Poem Service</a> section:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">java -jar target/quarkus-app/quarkus-run.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should get a response such as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">For service-account-quarkus-mcp-client, this Java ode I write,
A language strong, with classes bright, and objects shining light.
From simple apps to systems grand, its power knows no end,
With threads and streams, a helping hand,  a journey without bend.
Its virtual machine, a sturdy friend,  on which great feats depend.</code></pre>
</div>
</div>
<div class="paragraph">
<p>How about trying another language ?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">java -jar target/quarkus-app/quarkus-run.jar --language Greek</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should get a response such as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">Here's a short poem in Greek about Java, dedicated to the service account "service-account-quarkus-mcp-client":

**Greek:**

Ω, Java, γλώσσα ισχυρή και γρήγορη,
για προγραμματισμό, εργαλείο ακριβές.
Στον service-account-quarkus-mcp-client αφιερωμένη,
η δύναμή σου, πάντα  αξιοθαύμαστη.

**English Translation:**

O Java, language strong and fast,
For programming, a precise tool.
Dedicated to service-account-quarkus-mcp-client,
Your power, always admirable.</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="have-token-audiences-made-any-difference"><a class="anchor" href="#have-token-audiences-made-any-difference"></a>Have token audiences made any difference ?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For the command line <code>Poem Service</code> to <a href="#run-poem-service">run successfully</a>, Quarkus MCP client had to acquire a token with a <code>quarkus-mcp-server</code> audience to access the MCP server.</p>
</div>
<div class="paragraph">
<p>Here is how a token that Keycloak issues to the MCP client looks like:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/assets/images/posts/secure_mcp_oidc_client/token-with-quarkus-mcp-server-aud.png" alt="Token with quarkus-mcp-server audience">
</div>
</div>
<div class="paragraph">
<p>The token <code>aud</code> claim contains two audience values, one of them is a required <code>quarkus-mcp-server</code> audience.</p>
</div>
<div class="paragraph">
<p>For the MCP <code>quarkus-mcp-server</code> server to complete the Quarkus MCP client request, it had to verify that the token had a correct <code>quarkus-mcp-server</code> audience, and exchange it for a new token with a <code>quarkus-mcp-service</code> audience to access the REST server.</p>
</div>
<div class="paragraph">
<p>Here is how an exchanged token that a Keycloak issues to the MCP server looks like:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/assets/images/posts/secure_mcp_oidc_client/token-with-quarkus-mcp-service-aud.png" alt="Token with quarkus-mcp-service audience">
</div>
</div>
<div class="paragraph">
<p>The token <code>aud</code> claim contains a required <code>quarkus-mcp-service</code> audience.</p>
</div>
<div class="paragraph">
<p>Note this token still retains a record of the original <code>quarkus-mcp-client</code> client that acquired the previous token, but also lists <code>quarkus-mcp-server</code> as the authorizing party (<code>azp</code>).</p>
</div>
<div class="paragraph">
<p>Let&#8217;s try to access both MCP server and REST server without an audience claim.</p>
</div>
<div class="paragraph">
<p>Ensure the MCP server is <a href="#start-mcp-server">running</a> and <a href="#keycloak-setup">Keycloak is configured</a>.</p>
</div>
<div class="paragraph">
<p>In the demo, the OIDC <code>quarkus-mcp-client</code> client acquires tokens that are used to access the MCP server.</p>
</div>
<div class="paragraph">
<p>Use the following curl command to acquire a <code>client_credentials</code> token for the <code>quarkus-mcp-client</code> client, omitting a <code>quarkus-mcp-server-scope</code> grant property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">curl -X POST -H "Content-Type: application/x-www-form-urlencoded" -d "grant_type=client_credentials&amp;client_id=quarkus-mcp-client&amp;client_secret=keycloak_quarkus_mcp_client_secret" http://localhost:8081/realms/quarkus/protocol/openid-connect/token</code></pre>
</div>
</div>
<div class="paragraph">
<p>and confirm at <a href="https://jwt.io/">jwt.io</a> that the returned JWT token has no audience claim.</p>
</div>
<div class="paragraph">
<p>Try to access the MCP server with this token:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">curl -H "Authorization: Bearer &lt;token&gt;" http://localhost:8080/mcp/sse</code></pre>
</div>
</div>
<div class="paragraph">
<p>and you will get HTTP 401.</p>
</div>
<div class="paragraph">
<p>What about the REST server ? In the demo, the OIDC <code>quarkus-mcp-server</code> client acquires tokens that are used to access the REST server.</p>
</div>
<div class="paragraph">
<p>Use the following curl command to acquire a <code>client_credentials</code> token  for the <code>quarkus-mcp-server</code> client, omitting a <code>quarkus-mcp-service-scope</code> grant property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">curl -X POST -H "Content-Type: application/x-www-form-urlencoded" -d "grant_type=client_credentials&amp;client_id=quarkus-mcp-server&amp;client_secret=secret" http://localhost:8081/realms/quarkus/protocol/openid-connect/token</code></pre>
</div>
</div>
<div class="paragraph">
<p>and confirm at <a href="https://jwt.io/">jwt.io</a> that the returned JWT token has no audience claim.</p>
</div>
<div class="paragraph">
<p>Try to access the REST server with this token:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">curl -H "Authorization: Bearer &lt;token&gt;" http://localhost:8080/service-account-name</code></pre>
</div>
</div>
<div class="paragraph">
<p>and you will get HTTP 401.</p>
</div>
<div class="paragraph">
<p>You can also enforce a stricter verification by requiring that tokens received by both MCP and REST servers were issued to the <code>quarkus-mcp-client</code> and <code>quarkus-mcp-server</code> respectively by adding the following configuration fragment to the <a href="#mcp-server-configuration">MCP Server Configuration</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties"># Tokens that are accepted by MCP server must have been requested by `quarkus-mcp-client`

quarkus.oidc.token.required-claims.azp=quarkus-mcp-client

# Tokens that are accepted by REST server must have been requested by `quarkus-mcp-server`

quarkus.oidc.service-account-name-rest-server.token.required-claims.azp=quarkus-mcp-server</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="resource-indicator"><a class="anchor" href="#resource-indicator"></a>Note about Resource Indicators</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <a href="https://modelcontextprotocol.io/specification/2025-06-18/basic/authorization">latest 2025-06-18 MCP authorization specification</a> <a href="https://modelcontextprotocol.io/specification/2025-06-18/basic/authorization#token-audience-binding-and-validation">requires</a> the use of <a href="https://www.rfc-editor.org/rfc/rfc8707.html">OAuth2 Resource Indicators</a>.</p>
</div>
<div class="paragraph">
<p>OAuth2 Resource Indicator allows for a fine grained token audience restriction, in the presence of multiple, diverse resource servers that must be accessed with tokens.</p>
</div>
<div class="paragraph">
<p>For a simple demo that we created in this blog post, having a token to contain an audience only is sufficient.</p>
</div>
<div class="paragraph">
<p>If your provider already supports <a href="https://www.rfc-editor.org/rfc/rfc8707.html">OAuth2 Resource Indicators</a> and you need to have a token to also include a resource indicator, configure OIDC client to request it.</p>
</div>
<div class="paragraph">
<p>For example, you can add <code>quarkus.oidc-client.grant.client.extra-params.resource=http://localhost:8080/mcp</code> to the <a href="#poem-service-configuration">Poem Service Configuration</a>.</p>
</div>
<div class="paragraph">
<p>In this case, to have the MCP server verify that an access token contains a correct resource indicator, add <code>quarkus.oidc.token.required-claims.resource=http://localhost:8080/mcp</code> to the <a href="#mcp-server-configuration">MCP Server Configuration</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="security-considerations"><a class="anchor" href="#security-considerations"></a>Security Considerations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ensuring that each participant in your distributed AI system is properly secured and accepts tokens thar are meant to access this participant only is crucial.</p>
</div>
<div class="paragraph">
<p>Token audience restriction is one of the key OAuth2 mechanisms that supports this goal, with <a href="#resource-indicator">resource indicators</a> allowing to achieve a finer-grained audience restriction.</p>
</div>
<div class="paragraph">
<p><a href="https://datatracker.ietf.org/doc/html/rfc8693">Token exchange</a> can help to correctly switch the OAuth2 security context when the tokens are flowing in a multi-hop distributed AI application.</p>
</div>
<div class="paragraph">
<p>Read more about the <a href="https://modelcontextprotocol.io/specification/draft/basic/authorization#access-token-privilege-restriction">Access Token Privilege Restriction</a> in the <a href="https://modelcontextprotocol.io/specification/2025-06-18/basic/authorization">latest 2025-06-18 MCP authorization specification</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conclusion"><a class="anchor" href="#conclusion"></a>Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this blog post, we demonstrated how <a href="https://docs.quarkiverse.io/quarkus-langchain4j/dev/mcp.html">Quarkus MCP Client</a> can access secure MCP servers by acquiring access tokens using an OAuth2 <code>client_credentials</code> grant and propagating them to the secure Quarkus MCP server.</p>
</div>
<div class="paragraph">
<p>We also looked into restricting tokens to specific audiences and started learning about an important OAuth2 <a href="https://datatracker.ietf.org/doc/html/rfc8693">token exchange</a> grant.</p>
</div>
<div class="paragraph">
<p>We have more content dedicated to AI and MCP security lined up for you, stay tuned !</p>
</div>
</div>
</div>
              
          </div>
          <div class="width-12-12"><div class="share-page">
  <a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https://quarkus.io/blog/secure-mcp-oidc-client/&title=Use Quarkus MCP client to access secure MCP HTTP server from command line" rel="nofollow" target="_blank" title="Share on LinkedIn">
    <i class="fa-brands fa-linkedin fa-xl"></i>
  </a>
  <a class="share-x" href="https://x.com/intent/tweet?text=Use Quarkus MCP client to access secure MCP HTTP server from command line&url=https://quarkus.io/blog/secure-mcp-oidc-client/&via=quarkusio&related=quarkusio" rel="nofollow" target="_blank" title="Share on X">
    <i class="fa-brands fa-square-x-twitter fa-xl"></i>
  </a>
  <a class="share-facebook" href="https://facebook.com/sharer.php?u=https://quarkus.io/blog/secure-mcp-oidc-client/" rel="nofollow" target="_blank" title="Share on Facebook">
    <i class="fa-brands fa-square-facebook fa-xl"></i>
  </a>
  <a class="share-reddit" href="http://www.reddit.com/submit?url=https://quarkus.io/blog/secure-mcp-oidc-client/" onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;" title="Share on Reddit" >
    <i class="fa-brands fa-square-reddit fa-xl"></i>
  </a>
  <a class="share-email" href="mailto:?subject=Use Quarkus MCP client to access secure MCP HTTP server from command line&amp;body=Use Quarkus MCP client to access secure MCP HTTP server from command line https://quarkus.io/blog/secure-mcp-oidc-client/" title="Share via Email" >
    <i class="fa-solid fa-envelope fa-xl"></i>
  </a>
</div>
</div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="post-page grid-wrapper">
  <div class="width-8-12 width-12-12-m doc-content">
  <script src="https://giscus.app/client.js"
        data-repo="quarkusio/quarkus"
        data-repo-id="MDEwOlJlcG9zaXRvcnkxMzk5MTQ5MzI="
        data-category="Quarkus Blog/Website"
        data-category-id="DIC_kwDOCFbutM4CAFFV"
        data-mapping="og:title"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-theme="preferred_color_scheme"
        data-lang="en"
        crossorigin="anonymous"
        async>
  </script>
  </div>
</div>

  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_reverse.svg" class="project-logo" title="Quarkus"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">Quarkus is open. All dependencies of this project are available under the <a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>Apache Software License 2.0</a> or compatible license. <i class='fab fa-creative-commons'></i><i class='fab fa-creative-commons-by'></i> <a href='https://creativecommons.org/licenses/by/3.0/' target='_blank'>CC by 3.0</a><br /><br />This website was built with <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a>, is hosted on <a href='https://pages.github.com/' target='_blank'>GitHub Pages</a> and is completely open source. If you want to make it better, <a href='https://github.com/quarkusio/quarkusio.github.io' target='_blank'>fork the website</a> and show us what you’ve got.</p>

    
      <div class="width-1-12 project-links">
        <span>Navigation</span>
        <ul class="footer-links">
          
          
            <li><a href="/" target="_blank">Home</a></li>
          
          
          
            <li><a href="/about" target="_blank">About</a></li>
          
          
          
            <li><a href="/blog" target="_blank">Blog</a></li>
          
          
          
            <li><a href="/insights" target="_blank">Podcast</a></li>
          
          
          
            <li><a href="/events" target="_blank">Events</a></li>
          
          
          
            <li><a href="/newsletter" target="_blank">Newsletter</a></li>
          
          
          
            <li><a href="/userstories" target="_blank">User Stories</a></li>
          
          
          
            <li><a href="https://github.com/orgs/quarkusio/projects/13/views/1" target="_blank">Roadmap</a></li>
          
          
          
            <li><a href="/security" target="_blank">Security&nbsp;policy</a></li>
          
          
          
            <li><a href="/usage" target="_blank">Usage</a></li>
          
          
          
            <li><a href="/brand" target="_blank">Brand</a></li>
          
          
          
            <li><a href="/desktopwallpapers" target="_blank">Wallpapers</a></li>
          
          
          
            <li><a href="https://www.redhat.com/en/about/privacy-policy" target="_blank">Privacy Policy</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Follow Us</span>
        <ul class="footer-links">
          
          
            <li><a href="https://x.com/quarkusio" target="_blank">X</a></li>
          
          
          
            <li><a href="https://bsky.app/profile/quarkus.io" target="_blank">Bluesky</a></li>
          
          
          
            <li><a rel="me" href="https://fosstodon.org/@quarkusio" target="_blank">Mastodon</a></li>
            
          
          
            <li><a href="https://www.threads.com/@quarkusio" target="_blank">Threads</a></li>
          
          
          
            <li><a href="https://www.facebook.com/quarkusio" target="_blank">Facebook</a></li>
          
          
          
            <li><a href="https://www.linkedin.com/company/quarkusio/" target="_blank">Linkedin</a></li>
          
          
          
            <li><a href="https://www.youtube.com/channel/UCaW8QG_QoIk_FnjLgr5eOqg" target="_blank">Youtube</a></li>
          
          
          
            <li><a href="https://github.com/quarkusio" target="_blank">GitHub</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-2-12 project-links">
        <span>Get Help</span>
        <ul class="footer-links">
          
          
            <li><a href="/support" target="_blank">Support</a></li>
          
          
          
            <li><a href="/guides" target="_blank">Guides</a></li>
          
          
          
            <li><a href="/faq" target="_blank">FAQ</a></li>
          
          
          
            <li><a href="/get-started" target="_blank">Get Started</a></li>
          
          
          
            <li><a href="https://stackoverflow.com/questions/tagged/quarkus" target="_blank">Stack Overflow</a></li>
          
          
          
            <li><a href="https://github.com/quarkusio/quarkus/discussions" target="_blank">Discussions</a></li>
          
          
          
            <li><a href="https://groups.google.com/forum/#!forum/quarkus-dev" target="_blank">Development mailing list</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Languages</span>
        <ul class="footer-links">
          
          
            <li><a href="https://quarkus.io/" target="_blank">English</a></li>
          
          
          
            <li><a href="https://pt.quarkus.io/" target="_blank">Português&nbsp;(Brasileiro)</a></li>
          
          
          
            <li><a href="https://es.quarkus.io/" target="_blank">Español</a></li>
          
          
          
            <li><a href="https://cn.quarkus.io/" target="_blank">简体中文</a></li>
          
          
          
            <li><a href="https://ja.quarkus.io/" target="_blank">日本語</a></li>
          
          
        </ul>
      </div>
    

    
      <div class="width-4-12 more-links">
        <span>Quarkus is made of community projects</span>
        <ul class="footer-links">
          
            <li><a blah href="https://vertx.io/" target="_blank">Eclipse Vert.x</a></li>
          
            <li><a blah href="https://smallrye.io" target="_blank">SmallRye</a></li>
          
            <li><a blah href="https://hibernate.org" target="_blank">Hibernate</a></li>
          
            <li><a blah href="https://netty.io" target="_blank">Netty</a></li>
          
            <li><a blah href="https://resteasy.github.io" target="_blank">RESTEasy</a></li>
          
            <li><a blah href="https://camel.apache.org" target="_blank">Apache Camel</a></li>
          
            <li><a blah href="https://microprofile.io" target="_blank">Eclipse MicroProfile</a></li>
          
            <li><a blah href="https://code.quarkus.io/" target="_blank">And many more...</a></li>
          
        </ul>
      </div>
    
  </div>
</div>

  <div class="content cf-footer">
  <div class="flexcontainer">
    <span class="cf-logo">
      <a href="https://www.commonhaus.org/" target="_blank"><img src="https://raw.githubusercontent.com/commonhaus/artwork/main/foundation/brand/svg/CF_logo_horizontal_single_reverse.svg"/></a>
    </span>
    <span class="license">
      Copyright © Quarkus. All rights reserved. For details on our trademarks, please visit our <a href="https://www.commonhaus.org/policies/trademark-policy/">Trademark Policy</a> and <a href="https://www.commonhaus.org/trademarks/">Trademark List</a>. Trademarks of third parties are owned by their respective holders and their mention here does not suggest any endorsement or association.
    </span>
    <span class="sponsorcontainer">
      <span class="sponsor">
        Sponsored by
      </span>
      <span class="sponsor-logo">
        <a href="https://www.redhat.com/" target="_blank"><img src="/assets/images/redhat_reversed.svg"></a>
      </span>
    </span>
  </div>
</div>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/scroll-down.js"></script>
  <script src="/assets/javascript/satellite.js" type="text/javascript"></script>
  <script src="/guides/javascript/config.js" type="text/javascript"></script>
  <script src="/assets/javascript/guides-version-dropdown.js" type="text/javascript"></script>
  <script src="/assets/javascript/back-to-top.js" type="text/javascript"></script>
  <script src="/assets/javascript/clipboard.min.js" type="text/javascript"></script>
  <script src="/assets/javascript/copy.js" type="text/javascript"></script>
  <script src="/assets/javascript/asciidoc-tabs.js" type="text/javascript"></script>
  <script src="/assets/javascript/future-date.js" type="text/javascript"></script>
  <script src="/assets/javascript/randomize.js" type="text/javascript"></script>
</body>

</html>
