<!DOCTYPE html>
<html lang="en">







<head>
  <title>Changing the Quarkus loggers level from Unleash - Quarkus</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="
  connect-src 'self' https://dpm.demdex.net https://adobedc.demdex.net https://route-default-test-mscherer-matamo.apps.ospo-osci.z3b1.p1.openshiftapps.com/ https://search.quarkus.io https://smetrics.redhat.com; 
  script-src 'self' 'unsafe-inline' 'unsafe-eval'
      
      https://assets.adobedtm.com
      js.bizographics.com
      https://www.redhat.com
      https://static.redhat.com
      https://app.requestly.io/
      jsonip.com
      https://ajax.googleapis.com
      https://use.fontawesome.com
      http://www.youtube.com
      http://www.googleadservices.com
      https://googleads.g.doubleclick.net
      https://giscus.app
      https://route-default-test-mscherer-matamo.apps.ospo-osci.z3b1.p1.openshiftapps.com/
      https://app.mailjet.com;

  style-src 'self' https://fonts.googleapis.com https://use.fontawesome.com; 
  img-src 'self' * data:; 
  media-src 'self'; 
  frame-src https://redhat.demdex.net https://www.youtube.com https://embed.restream.io https://app.mailjet.com http://xy0p2.mjt.lu https://mj.quarkus.io https://giscus.app; 
  base-uri 'none'; 
  object-src 'none'; 
  form-action 'none'; 
  font-src 'self' https://use.fontawesome.com https://fonts.gstatic.com;" />
  <script id="adobe_dtm" src="https://www.redhat.com/dtm.js" type="text/javascript"></script>
  <script src="/assets/javascript/highlight.pack.js" type="text/javascript"></script>
  <META HTTP-EQUIV='X-XSS-Protection' CONTENT="1; mode=block">
  <META HTTP-EQUIV='X-Content-Type-Options' CONTENT="nosniff">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Quarkus: Supersonic Subatomic Java">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@QuarkusIO"> 
  <meta name="twitter:creator" content="@QuarkusIO">
  <meta property="og:url" content="https://quarkus.io/blog/changing-loggers-level-from-unleash/" />
  <meta property="og:title" content="Changing the Quarkus loggers level from Unleash" />
  <meta property="og:description" content="Quarkus: Supersonic Subatomic Java" />
  <meta property="og:image" content="https://quarkus.io/assets/images/quarkus_card.png" />
  
  <link rel="canonical" href="https://quarkus.io/blog/changing-loggers-level-from-unleash/">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/guides/stylesheet/config.css" />
  <link rel="stylesheet" href="/assets/css/main.css?2021-07-29" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.5.2/css/all.css" crossorigin="anonymous">
  <link rel="alternate" type="application/rss+xml"  href="/feed.xml" title="Quarkus">
  <script src="/assets/javascript/hl.js" type="text/javascript"></script>
  
  
  
  
  <link rel="alternate" hreflang="en" href="https://quarkus.io/blog/changing-loggers-level-from-unleash/" />
  
  <link rel="alternate" hreflang="pt-br" href="https://pt.quarkus.io/blog/changing-loggers-level-from-unleash/" />
  
  <link rel="alternate" hreflang="es" href="https://es.quarkus.io/blog/changing-loggers-level-from-unleash/" />
  
  <link rel="alternate" hreflang="zh" href="https://cn.quarkus.io/blog/changing-loggers-level-from-unleash/" />
  
  <link rel="alternate" hreflang="ja" href="https://ja.quarkus.io/blog/changing-loggers-level-from-unleash/" />
  
  <link rel="alternate" hreflang="x-default" href="https://quarkus.io/" />  
  <script src="/assets/javascript/tracking.js"></script>
  
  <script src="/assets/javascript/colormode.js" type="text/javascript"></script>

</head>

<body class="post">

  
  <div class="nav-wrapper">
  <div class="grid-wrapper">
    <div class="width-12-12">
      <input type="checkbox" id="checkbox" />
      <nav id="main-nav" class="main-nav">
        <div class="logo-wrapper">
           <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_600px_reverse.png" class="project-logo" title="Quarkus"></a>
        </div>
    <label class="nav-toggle" for="checkbox">
      <i class="fa fa-bars"></i>
    </label>
    <ul id="menu" class="menu">
      <li class="dropdown">
        <span href="/about/">Why<i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/about" class="">WHAT IS QUARKUS?</a></li>
          <li><a href="/container-first" class="">CONTAINER FIRST</a></li>
          <li><a href="/continuum" class="">VERSATILITY</a></li>
          <li><a href="/developer-joy" class="">DEVELOPER JOY</a></li>
          <li><a href="/kubernetes-native" class="">KUBERNETES NATIVE</a></li>
          <li><a href="/standards" class="">STANDARDS</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="/learn/">Learn<i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/get-started" class="">GET STARTED</a></li>
          <li><a href="/guides" class="">DOCUMENTATION</a></li>
          <li><a href="/qtips" class="">"Q" TIP VIDEOS</a></li>          
          <li><a href="/books" class="">BOOKS</a></li>
          </ul>
      </li>
      <li class="dropdown">
        <span href="https://quarkus.io/extensions/">Extensions<i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <!-- Note that quarkus.io is hardcoded here, because it is the only url which supports extensions -->
          <li><a href="https://quarkus.io/extensions/" class="">BROWSE EXTENSIONS</a></li>
          <li><a href="/faq/#what-is-a-quarkus-extension" class="">USE EXTENSIONS</a></li>
          <li><a href="/guides/writing-extensions" class="">CREATE EXTENSIONS</a></li>
          <li><a href="https://hub.quarkiverse.io" class="">SHARE EXTENSIONS</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="/community/">Community<i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/support/" class="">SUPPORT</a></li>
          <li><a href="/blog" class="active">BLOG</a></li>
          <li><a href="/discussion" class="">DISCUSSION</a></li>
          <li><a href="/working-groups" class="">WORKING GROUPS</a></li>
          <li><a href="/insights" class="">PODCAST</a></li>
          <li><a href="/events" class="">EVENTS</a></li>
          <li><a href="/newsletter" class="">NEWSLETTER</a></li>
          <li><a href="https://github.com/orgs/quarkusio/projects/13/views/1" class="">ROADMAP</a></li>
          </ul>
      </li>
      <li>
        <a href="https://code.quarkus.io" class="button-cta secondary white">START CODING</a>
      </li>
      <li class="dropdown">
        <span href="/language/"><div class="fas fa-globe langicon"></div><i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="https://quarkus.io/blog/changing-loggers-level-from-unleash/" >OFFICIAL (ENGLISH)</a></li>
          <li><a href="https://pt.quarkus.io/blog/changing-loggers-level-from-unleash/">PORTUGUÊS (BR)</a></li>
          <li><a href="https://es.quarkus.io/blog/changing-loggers-level-from-unleash/">ESPAÑOL</a></li>
          <li><a href="https://cn.quarkus.io/blog/changing-loggers-level-from-unleash/">简体中文</a></li>
          <li><a href="https://ja.quarkus.io/blog/changing-loggers-level-from-unleash/">日本語</a></li>
          </ul>
      </li>
      <li>
        <span href="#" class="modeswitcher" id='theme-toggle'><i class="fas fa-sun"></i><i class="fas fa-moon"></i><i class="fas fa-cog"></i></span>
      </li>
    </ul>
      </nav>
    </div>
  </div>
</div>

  <div class="content">
    <div class="full-width-breadcrumb-bg align-self">
  <div class="width-12-12">
      <p class="returnlink"><a href="/blog">Blog</a> <i class="fas fa-chevron-right"></i> Changing the Quarkus loggers level from Unleash</p>
  </div>
</div>

<div class="post-page grid-wrapper">
  <div class="width-8-12 width-12-12-m doc-content">
    <div class="grid-wrapper">
      <div class="width-12-12">
        <div class="post-date">
          April 03, 2024 
          
            <span class="tags"><a href="/blog/tag/unleash">#unleash</a><a href="/blog/tag/logging">#logging</a><a href="/blog/tag/development-tips">#development-tips</a></span>
          
        </div>
        <h1 class="post-title">Changing the Quarkus loggers level from Unleash</h1>
        <div class="grid-wrapper">
          <div class="width-8-12 width-12-12-m byline-wrapper">
            
            
              <img class="headshot" src="https://www.gravatar.com/avatar/6fb5fa9805facd958bc8f61cf13078e5">
            
            <p class="byline">By <a href="/author/gwenneg">Gwenneg Lepage</a></p>
          </div>
          <div class="width-12-12">
              <div class="sect1">
<h2 id="introduction"><a class="anchor" href="#introduction"></a>Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I&#8217;m part of a Red Hat team that is responsible for a dozen of Quarkus apps which run in Red Hat OpenShift, with multiple pods each.
While these apps all have different purposes, they also share a common fate: something will go wrong eventually.
When it does, we&#8217;ll need to understand and fix the problem as fast as possible.
Lowering the level of a logger is often helpful, but our apps are containerized and updating an environment variable to change the logger level isn&#8217;t always as easy at it sounds.
We also don&#8217;t want to expose REST endpoints in most of our apps, so extensions such as <a href="https://github.com/quarkiverse/quarkus-logging-manager" target="_blank" rel="noopener">quarkus-logging-manager</a> are not an option.</p>
</div>
<div class="paragraph">
<p>Our apps have another thing in common: they depend on <a href="https://docs.quarkiverse.io/quarkus-unleash/dev/index.html" target="_blank" rel="noopener">quarkus-unleash</a> because we&#8217;re fetching our feature toggles from <a href="https://www.getunleash.io/" target="_blank" rel="noopener">Unleash</a>.
When I read <a href="https://medium.com/safe-engineering/how-unleash-enhanced-our-troubleshooting-experience-by-100x-e0c82b6df825" target="_blank" rel="noopener">Zero downtime log level changes using Unleash</a> from Aman Jain, it made me want to try the same thing with Quarkus.
I&#8217;ll show you below how I successfully did that.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This blog post contains incremental code snippets.
Each one of them is an enhanced version of the previous one and addresses a specific technical challenge.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="changing-a-logger-level-programmatically"><a class="anchor" href="#changing-a-logger-level-programmatically"></a>Changing a logger level programmatically</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s start with the obvious requirement: how to change the level of a logger programmatically with Quarkus.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As described in the <a href="https://quarkus.io/guides/logging" target="_blank" rel="noopener">Logging configuration guide</a>, Quarkus supports multiple logging APIs.
I only tested the following code with the JBoss Logging API as well as the <code>io.quarkus.logging.Log</code> API.
I can&#8217;t guarantee that everything will work out of the box with other logging APIs.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The JBoss Logging API doesn&#8217;t offer a way to change the level of a logger programmatically, so we need the help of the <code>java.util.logging</code> API to do it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import java.util.logging.Level; <i class="conum" data-value="1"></i><b>(1)</b>
import java.util.logging.Logger; <i class="conum" data-value="1"></i><b>(1)</b>

public class LogLevelManager {

    public void setLoggerLevel(String loggerName, String levelName) {
        Logger logger = Logger.getLogger(loggerName); <i class="conum" data-value="2"></i><b>(2)</b>
        Level level = Level.parse(levelName); <i class="conum" data-value="3"></i><b>(3)</b>
        logger.setLevel(level);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Make sure you&#8217;re importing classes from the <code>java.util.logging</code> package.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Any category as described in the <a href="https://quarkus.io/guides/logging#logging-categories" target="_blank" rel="noopener">Logging configuration guide</a> will work as the logger name.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>Level#parse</code> will throw exceptions if the level name is not valid. Please handle them carefully.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="setting-a-logger-level-from-unleash"><a class="anchor" href="#setting-a-logger-level-from-unleash"></a>Setting a logger level from Unleash</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So, we&#8217;re able to set a logger level programmatically.
Now, how do we feed the <code>LogLevelManager#setLoggerLevel</code> method with data from Unleash?</p>
</div>
<div class="sect2">
<h3 id="unleash-variants-to-the-rescue"><a class="anchor" href="#unleash-variants-to-the-rescue"></a>Unleash variants to the rescue</h3>
<div class="paragraph">
<p>In Unleash, the feature toggles can be associated with <a href="https://docs.getunleash.io/reference/feature-toggle-variants" target="_blank" rel="noopener">variants</a> which are meant to facilitate A/B testing and experimentation.
Each variant is defined with a set of properties, including the optional <code>payload</code> that can be used to pass JSON data from Unleash to our Quarkus app.
That&#8217;s how we&#8217;ll set the level of our Quarkus app loggers:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/images/posts/changing-loggers-level-from-unleash/payload.png" alt="Unleash variant payload">
</div>
</div>
</div>
<div class="sect2">
<h3 id="retrieving-the-variant-payload"><a class="anchor" href="#retrieving-the-variant-payload"></a>Retrieving the variant payload</h3>
<div class="paragraph">
<p>Now, let&#8217;s see how we&#8217;ll retrieve from the Quarkus app the variant payload defined in Unleash.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/images/posts/changing-loggers-level-from-unleash/connecting.png" alt="Connecting Quarkus to Unleash">
</div>
</div>
<div class="paragraph">
<p>First, the Quarkus app needs to depend on the <a href="https://docs.quarkiverse.io/quarkus-unleash/dev/index.html" target="_blank" rel="noopener">quarkus-unleash</a> extension.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll also use a very simple data structure to deserialize the payload with Jackson:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class LogConfig {
    public String category;
    public String level;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, here&#8217;s an update of the <code>LogLevelManager</code> class to make it get the variant from Unleash, deserialize the payload and change the level of a series of loggers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import io.getunleash.Unleash;
import io.getunleash.Variant;
import io.getunleash.variant.Payload;
import io.quarkus.logging.Log;
import jakarta.enterprise.context.ApplicationScoped;
import jakarta.inject.Inject;

import java.util.Optional;
import java.util.logging.Level;
import java.util.logging.Logger;

@ApplicationScoped <i class="conum" data-value="1"></i><b>(1)</b>
public class LogLevelManager {

    private static final String UNLEASH_TOGGLE_NAME = "my-app.log-levels";

    @Inject
    Unleash unleash; <i class="conum" data-value="2"></i><b>(2)</b>

    @Inject
    ObjectMapper objectMapper;

    public void updateLoggersLevel() {
        for (LogConfig logConfig : getLogConfigs()) {
            try {
                setLoggerLevel(logConfig.category, logConfig.level);
            } catch (Exception e) {
                Log.error("Could not the set level of a logger", e);
            }
        }
    }

    private LogConfig[] getLogConfigs() {
        Variant variant = unleash.getVariant(UNLEASH_TOGGLE_NAME); <i class="conum" data-value="3"></i><b>(3)</b>
        if (variant.isEnabled()) { <i class="conum" data-value="4"></i><b>(4)</b>
            Optional&lt;Payload&gt; payload = variant.getPayload();
            if (payload.isPresent() &amp;&amp; payload.get().getType().equals("json") &amp;&amp; payload.get().getValue() != null) {
                try {
                    return objectMapper.readValue(payload.get().getValue(), LogConfig[].class);
                } catch (JsonProcessingException e) {
                    Log.error("Variant payload deserialization failed", e);
                }
            }
        }
        return new LogConfig[0]; <i class="conum" data-value="5"></i><b>(5)</b>
    }

    private void setLoggerLevel(String loggerName, String levelName) {
        Logger logger = Logger.getLogger(loggerName);
        Level currentLevel = logger.getLevel();
        Level newLevel = Level.parse(levelName);
        if (!newLevel.equals(currentLevel)) {
            logger.setLevel(newLevel);
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>From now on, <code>LogLevelManager</code> is an <code>@ApplicationScoped</code> bean.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>Unleash</code> is an <code>@ApplicationScoped</code> bean produced by the <a href="https://docs.quarkiverse.io/quarkus-unleash/dev/index.html" target="_blank" rel="noopener">quarkus-unleash</a> extension.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Be careful about the argument passed to <code>Unleash#getVariant</code>: it has to be the toggle name, not the variant name.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>variant.isEnabled()</code> will return <code>false</code> if the toggle is disabled in Unleash or if the toggle has no variants.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>If the method is unable to find a variant payload or if it fails to deserialize that payload for any reasons, an empty <code>LogConfig</code> array will be returned.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We can now retrieve the loggers configuration from Unleash, that&#8217;s great!
But that new <code>LogLevelManager#updateLoggerslevel</code> method isn&#8217;t used yet.
Where should it be used from, and when?</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/images/posts/changing-loggers-level-from-unleash/triggering.png" alt="Triggering the loggers level update">
</div>
</div>
<div class="paragraph">
<p>We need that method to be executed as soon as the loggers configuration is changed in Unleash.
So, its execution has to be periodically scheduled somehow.
We could make the method <code>@Scheduled</code> with the <a href="https://quarkus.io/guides/scheduler-reference" target="_blank" rel="noopener">quarkus-scheduler</a> extension, but there is a better approach thanks to the Unleash SDK.
Let&#8217;s jump to the next section.</p>
</div>
</div>
<div class="sect2">
<h3 id="the-subscriber-api-from-unleash"><a class="anchor" href="#the-subscriber-api-from-unleash"></a>The Subscriber API from Unleash</h3>
<div class="paragraph">
<p>The Unleash Client SDK for Java comes with a feature that will be very helpful here: the <a href="https://docs.getunleash.io/reference/sdks/java#subscriber-api" target="_blank" rel="noopener">Subscriber API</a>.
The <a href="https://github.com/Unleash/unleash-client-java/blob/main/src/main/java/io/getunleash/event/UnleashSubscriber.java" target="_blank" rel="noopener">UnleashSubscriber</a> interface can indeed be implemented to subscribe to various Unleash events, including <code>FeatureToggleResponse</code> which is emitted when the Unleash client fetches toggles from the server.</p>
</div>
<div class="paragraph">
<p>Using the Subscriber API with the <a href="https://docs.quarkiverse.io/quarkus-unleash/dev/index.html" target="_blank" rel="noopener">quarkus-unleash</a> extension is extremely simple.
<code>UnleashSubscriber</code> needs to be implemented in a CDI bean and that&#8217;s it!
The extension will pass the bean to the Unleash client builder automatically.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import io.getunleash.Unleash;
import io.getunleash.Variant;
import io.getunleash.event.UnleashSubscriber;
import io.getunleash.repository.FeatureToggleResponse;
import io.getunleash.variant.Payload;
import io.quarkus.logging.Log;
import jakarta.enterprise.context.ApplicationScoped;
import jakarta.inject.Inject;

import java.util.Optional;
import java.util.logging.Level;
import java.util.logging.Logger;

import static io.getunleash.repository.FeatureToggleResponse.Status.CHANGED;

@ApplicationScoped
public class LogLevelManager implements UnleashSubscriber { <i class="conum" data-value="1"></i><b>(1)</b>

    private static final String UNLEASH_TOGGLE_NAME = "my-app.log-levels";

    @Inject
    Unleash unleash;

    @Inject
    ObjectMapper objectMapper;

    @Override
    public void togglesFetched(FeatureToggleResponse toggleResponse) { <i class="conum" data-value="2"></i><b>(2)</b>
        if (toggleResponse.getStatus() == CHANGED) { <i class="conum" data-value="3"></i><b>(3)</b>
            updateLoggersLevel();
        }
    }

    // Unchanged, except for the access modifier.
    private void updateLoggersLevel() {
        for (LogConfig logConfig : getLogConfigs()) {
            try {
                setLoggerLevel(logConfig.category, logConfig.level);
            } catch (Exception e) {
                Log.error("Could not the set level of a logger", e);
            }
        }
    }

    // Unchanged.
    private LogConfig[] getLogConfigs() {
        Variant variant = unleash.getVariant(UNLEASH_TOGGLE_NAME);
        if (variant.isEnabled()) {
            Optional&lt;Payload&gt; payload = variant.getPayload();
            if (payload.isPresent() &amp;&amp; payload.get().getType().equals("json") &amp;&amp; payload.get().getValue() != null) {
                try {
                    return objectMapper.readValue(payload.get().getValue(), LogConfig[].class);
                } catch (JsonProcessingException e) {
                    Log.error("Variant payload deserialization failed", e);
                }
            }
        }
        return new LogConfig[0];
    }

    // Unchanged.
    private void setLoggerLevel(String loggerName, String levelName) {
        Logger logger = Logger.getLogger(loggerName);
        Level currentLevel = logger.getLevel();
        Level newLevel = Level.parse(levelName);
        if (!newLevel.equals(currentLevel)) {
            logger.setLevel(newLevel);
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We&#8217;re still using the same <code>LogLevelManager</code> class, but now it&#8217;s implementing <code>UnleashSubscriber</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This method is invoked every time the Unleash client fetches toggles from the server.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We&#8217;ll update the loggers level only if the toggles changed server-side.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Okay, the <code>LogLevelManager#updateLoggerslevel</code> method is now automatically invoked whenever the client fetches new data from the server.
But what about scheduling that periodically?
Well, the Unleash client already relies on an internal scheduled executor to fetch the toggles.
Therefore, we don&#8217;t need to bother scheduling anything in our app.
It will work automagically!</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/images/posts/changing-loggers-level-from-unleash/automagically.png" alt="LogLevelManager with UnleashSubscriber">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="one-variant-to-rule-them-all"><a class="anchor" href="#one-variant-to-rule-them-all"></a>One variant to rule them all</h2>
<div class="sectionbody">
<div class="paragraph">
<p>At the beginning of this post, I mentioned that my team is responsible for a dozen of Quarkus apps.
Each app runs with a varying number of replicas.
Let&#8217;s simplify and consider all of them as hosts.</p>
</div>
<div class="paragraph">
<p>We have dozens of hosts and yet only one Unleash variant to manage the loggers level for all of them.
Here&#8217;s how I implemented that.</p>
</div>
<div class="paragraph">
<p>First, the data structure of the variant payload needs a small addition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class LogConfig {
    public String hostName; <i class="conum" data-value="1"></i><b>(1)</b>
    public String category;
    public String level;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>That&#8217;s new!</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now, we can introduce a host filtering capability in <code>LogLevelManager</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import io.getunleash.Unleash;
import io.getunleash.Variant;
import io.getunleash.event.UnleashSubscriber;
import io.getunleash.repository.FeatureToggleResponse;
import io.getunleash.variant.Payload;
import io.quarkus.logging.Log;
import jakarta.enterprise.context.ApplicationScoped;
import jakarta.inject.Inject;
import org.eclipse.microprofile.config.inject.ConfigProperty;

import java.util.Optional;
import java.util.logging.Level;
import java.util.logging.Logger;

import static io.getunleash.repository.FeatureToggleResponse.Status.CHANGED;

@ApplicationScoped
public class LogLevelManager implements UnleashSubscriber {

    private static final String UNLEASH_TOGGLE_NAME = "my-app.log-levels";

    @ConfigProperty(name = "host-name", defaultValue = "localhost") <i class="conum" data-value="1"></i><b>(1)</b>
    String hostName;

    @Inject
    Unleash unleash;

    @Inject
    ObjectMapper objectMapper;

    // Unchanged.
    @Override
    public void togglesFetched(FeatureToggleResponse toggleResponse) {
        if (toggleResponse.getStatus() == CHANGED) {
            updateLoggersLevel();
        }
    }

    private void updateLoggersLevel() {
        for (LogConfig logConfig : getLogConfigs()) {
            try {
                if (shouldThisHostBeUpdated(logConfig)) { <i class="conum" data-value="2"></i><b>(2)</b>
                    setLoggerLevel(logConfig.category, logConfig.level);
                }
            } catch (Exception e) {
                Log.error("Could not the set level of a logger", e);
            }
        }
    }

    // Unchanged.
    private LogConfig[] getLogConfigs() {
        Variant variant = unleash.getVariant(UNLEASH_TOGGLE_NAME);
        if (variant.isEnabled()) {
            Optional&lt;Payload&gt; payload = variant.getPayload();
            if (payload.isPresent() &amp;&amp; payload.get().getType().equals("json") &amp;&amp; payload.get().getValue() != null) {
                try {
                    return objectMapper.readValue(payload.get().getValue(), LogConfig[].class);
                } catch (JsonProcessingException e) {
                    Log.error("Variant payload deserialization failed", e);
                }
            }
        }
        return new LogConfig[0];
    }

    private boolean shouldThisHostBeUpdated(LogConfig logConfig) {
        if (logConfig.hostName == null) {
            return true;
        }
        if (logConfig.hostName.endsWith("*")) { <i class="conum" data-value="3"></i><b>(3)</b>
            return hostName.startsWith(logConfig.hostName.substring(0, logConfig.hostName.length() - 1));
        } else {
            return hostName.equals(logConfig.hostName);
        }
    }

    // Unchanged.
    private void setLoggerLevel(String loggerName, String levelName) {
        Logger logger = Logger.getLogger(loggerName);
        Level currentLevel = logger.getLevel();
        Level newLevel = Level.parse(levelName);
        if (!newLevel.equals(currentLevel)) {
            logger.setLevel(newLevel);
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In OpenShift, we&#8217;re passing the generated pod name through the <code>HOST_NAME</code> environment variable.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>That&#8217;s new!</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This block is used to filter hosts based on a host name prefix. That&#8217;s enough for our use case, but a regular expression could be used for finer filtering.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here&#8217;s how the variant payload may look like after these changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "hostName": "unstable-service-7dbbcb4cc-9d9hl",
    "category": "io.quarkus.arc",
    "level": "FINE"
  },
  {
    "hostName": "awesome-app*",
    "category": "org.acme.SomeService",
    "level": "WARNING"
  },
  {
    "category": "org.apache.kafka.clients",
    "level": "FINER"
  }
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>In that payload:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the first entry will affect a specific host: <code>unstable-service-7dbbcb4cc-9d9hl</code></p>
</li>
<li>
<p>the second entry will affect all hosts whose name starts with <code>awesome-app</code></p>
</li>
<li>
<p>the third entry will affect all hosts regardless of their names</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="reverting-changes-automatically"><a class="anchor" href="#reverting-changes-automatically"></a>Reverting changes automatically</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Changing the level of loggers through an Unleash variant should be a temporary action, mostly for troubleshooting purposes.
This means we need to revert the level of the loggers eventually when the troubleshooting is over.
Doing so by hand would be painful, so let&#8217;s see how we can automate that.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import io.getunleash.Unleash;
import io.getunleash.Variant;
import io.getunleash.event.UnleashSubscriber;
import io.getunleash.repository.FeatureToggleResponse;
import io.getunleash.variant.Payload;
import io.quarkus.logging.Log;
import jakarta.enterprise.context.ApplicationScoped;
import jakarta.inject.Inject;
import org.eclipse.microprofile.config.inject.ConfigProperty;

import java.util.Arrays;
import java.util.Map;
import java.util.Optional;
import java.util.Set;
import java.util.concurrent.ConcurrentHashMap;
import java.util.logging.Level;
import java.util.logging.Logger;

import static io.getunleash.repository.FeatureToggleResponse.Status.CHANGED;
import static java.util.stream.Collectors.toSet;

@ApplicationScoped
public class LogLevelManager implements UnleashSubscriber {

    private static final String UNLEASH_TOGGLE_NAME = "my-app.log-levels";

    @ConfigProperty(name = "host-name", defaultValue = "localhost")
    String hostName;

    @Inject
    Unleash unleash;

    @Inject
    ObjectMapper objectMapper;

    private final Map&lt;String, Level&gt; originalLoggerLevels = new ConcurrentHashMap&lt;&gt;();

    // Unchanged.
    @Override
    public void togglesFetched(FeatureToggleResponse toggleResponse) {
        if (toggleResponse.getStatus() == CHANGED) {
            updateLoggersLevel();
        }
    }

    public void updateLoggersLevel() {
        LogConfig[] logConfigs = getLogConfigs();
        for (LogConfig logConfig : logConfigs) {
            try {
                if (shouldThisHostBeUpdated(logConfig)) {
                    setLoggerLevel(logConfig.category, logConfig.level);
                }
            } catch (Exception e) {
                Log.error("Could not the set level of a logger", e);
            }
        }
        revertLoggersLevel(logConfigs); <i class="conum" data-value="1"></i><b>(1)</b>
    }

    // Unchanged.
    private LogConfig[] getLogConfigs() {
        Variant variant = unleash.getVariant(UNLEASH_TOGGLE_NAME);
        if (variant.isEnabled()) {
            Optional&lt;Payload&gt; payload = variant.getPayload();
            if (payload.isPresent() &amp;&amp; payload.get().getType().equals("json") &amp;&amp; payload.get().getValue() != null) {
                try {
                    return objectMapper.readValue(payload.get().getValue(), LogConfig[].class);
                } catch (JsonProcessingException e) {
                    Log.error("Variant payload deserialization failed", e);
                }
            }
        }
        return new LogConfig[0];
    }

    // Unchanged.
    private boolean shouldThisHostBeUpdated(LogConfig logConfig) {
        if (logConfig.hostName == null) {
            return true;
        }
        if (logConfig.hostName.endsWith("*")) {
            return hostName.startsWith(logConfig.hostName.substring(0, logConfig.hostName.length() - 1));
        } else {
            return hostName.equals(logConfig.hostName);
        }
    }

    private void setLoggerLevel(String loggerName, String levelName) {
        Logger logger = Logger.getLogger(loggerName);
        Level currentLevel = logger.getLevel();
        Level newLevel = Level.parse(levelName);
        if (!newLevel.equals(currentLevel)) {
            originalLoggerLevels.putIfAbsent(loggerName, currentLevel); <i class="conum" data-value="2"></i><b>(2)</b>
            logger.setLevel(newLevel);
        }
    }

    private void revertLoggersLevel(LogConfig[] logConfigs) {
        if (logConfigs.length == 0) {
            originalLoggerLevels.forEach(this::revertLoggerLevel);
            originalLoggerLevels.clear();
        } else {
            Set&lt;String&gt; knownLoggers = Arrays.stream(logConfigs)
                    .filter(this::shouldThisHostBeUpdated)
                    .map(logConfig -&gt; logConfig.category)
                    .collect(toSet());
            originalLoggerLevels.entrySet().removeIf(entry -&gt; {
                boolean remove = !knownLoggers.contains(entry.getKey());
                if (remove) {
                    revertLoggerLevel(entry.getKey(), entry.getValue()); <i class="conum" data-value="3"></i><b>(3)</b>
                }
                return remove;
            });
        }
    }

    private void revertLoggerLevel(String loggerName, Level originalLevel) {
        Logger logger = Logger.getLogger(loggerName);
        logger.setLevel(originalLevel); <i class="conum" data-value="4"></i><b>(4)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>That&#8217;s new!</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The original logger level is now stored in memory and will be used when the changes are eventually reverted.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>If the level of a logger was previously modified from Unleash and that logger is no longer part of the latest Unleash variant payload, its level will be reverted to the original value.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>If the original level is <code>null</code>, then the logger will inherit the level from its parent logger.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conclusion"><a class="anchor" href="#conclusion"></a>Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>LogLevelManager</code> class is still far from perfect, but it finally meets the requirements of this blog post:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>it changes the level of Quarkus loggers automatically and immediately, based on a variant payload from Unleash</p>
</li>
<li>
<p>it automatically reverts all changes to the previous loggers configuration when needed</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Thanks for reading this post! I hope it will help you troubleshoot your applications faster.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="special-thanks"><a class="anchor" href="#special-thanks"></a>Special thanks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Thanks to Mikel Alejo Barcina for helping me fix a bug in the code above!</p>
</div>
</div>
</div>
              
          </div>
          <div class="width-12-12"><div class="share-page">
  <a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https://quarkus.io/blog/changing-loggers-level-from-unleash/&title=Changing the Quarkus loggers level from Unleash" rel="nofollow" target="_blank" title="Share on LinkedIn">
    <i class="fa-brands fa-linkedin fa-xl"></i>
  </a>
  <a class="share-x" href="https://x.com/intent/tweet?text=Changing the Quarkus loggers level from Unleash&url=https://quarkus.io/blog/changing-loggers-level-from-unleash/&via=quarkusio&related=quarkusio" rel="nofollow" target="_blank" title="Share on X">
    <i class="fa-brands fa-square-x-twitter fa-xl"></i>
  </a>
  <a class="share-facebook" href="https://facebook.com/sharer.php?u=https://quarkus.io/blog/changing-loggers-level-from-unleash/" rel="nofollow" target="_blank" title="Share on Facebook">
    <i class="fa-brands fa-square-facebook fa-xl"></i>
  </a>
  <a class="share-reddit" href="http://www.reddit.com/submit?url=https://quarkus.io/blog/changing-loggers-level-from-unleash/" onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;" title="Share on Reddit" >
    <i class="fa-brands fa-square-reddit fa-xl"></i>
  </a>
  <a class="share-email" href="mailto:?subject=Changing the Quarkus loggers level from Unleash&amp;body=Changing the Quarkus loggers level from Unleash https://quarkus.io/blog/changing-loggers-level-from-unleash/" title="Share via Email" >
    <i class="fa-solid fa-envelope fa-xl"></i>
  </a>
</div>
</div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="post-page grid-wrapper">
  <div class="width-8-12 width-12-12-m doc-content">
  <script src="https://giscus.app/client.js"
        data-repo="quarkusio/quarkus"
        data-repo-id="MDEwOlJlcG9zaXRvcnkxMzk5MTQ5MzI="
        data-category="Quarkus Blog/Website"
        data-category-id="DIC_kwDOCFbutM4CAFFV"
        data-mapping="og:title"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-theme="preferred_color_scheme"
        data-lang="en"
        crossorigin="anonymous"
        async>
  </script>
  </div>
</div>

  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_reverse.svg" class="project-logo" title="Quarkus"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">Quarkus is open. All dependencies of this project are available under the <a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>Apache Software License 2.0</a> or compatible license.<br /><br />This website was built with <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a>, is hosted on <a href='https://pages.github.com/' target='_blank'>GitHub Pages</a> and is completely open source. If you want to make it better, <a href='https://github.com/quarkusio/quarkusio.github.io' target='_blank'>fork the website</a> and show us what you’ve got.</p>

    
      <div class="width-1-12 project-links">
        <span>Navigation</span>
        <ul class="footer-links">
          
          
            <li><a href="/" target="_blank">Home</a></li>
          
          
          
            <li><a href="/about" target="_blank">About</a></li>
          
          
          
            <li><a href="/blog" target="_blank">Blog</a></li>
          
          
          
            <li><a href="/insights" target="_blank">Podcast</a></li>
          
          
          
            <li><a href="/events" target="_blank">Events</a></li>
          
          
          
            <li><a href="/newsletter" target="_blank">Newsletter</a></li>
          
          
          
            <li><a href="https://github.com/orgs/quarkusio/projects/13/views/1" target="_blank">Roadmap</a></li>
          
          
          
            <li><a href="/security" target="_blank">Security&nbsp;policy</a></li>
          
          
          
            <li><a href="/usage" target="_blank">Usage</a></li>
          
          
          
            <li><a href="/brand" target="_blank">Brand</a></li>
          
          
          
            <li><a href="/desktopwallpapers" target="_blank">Wallpapers</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Follow Us</span>
        <ul class="footer-links">
          
          
            <li><a href="https://x.com/quarkusio" target="_blank">X</a></li>
          
          
          
            <li><a rel="me" href="https://fosstodon.org/@quarkusio" target="_blank">Mastodon</a></li>
            
          
          
            <li><a href="https://www.facebook.com/quarkusio" target="_blank">Facebook</a></li>
          
          
          
            <li><a href="https://www.linkedin.com/company/quarkusio/" target="_blank">Linkedin</a></li>
          
          
          
            <li><a href="https://www.youtube.com/channel/UCaW8QG_QoIk_FnjLgr5eOqg" target="_blank">Youtube</a></li>
          
          
          
            <li><a href="https://github.com/quarkusio" target="_blank">GitHub</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-2-12 project-links">
        <span>Get Help</span>
        <ul class="footer-links">
          
          
            <li><a href="/support" target="_blank">Support</a></li>
          
          
          
            <li><a href="/guides" target="_blank">Guides</a></li>
          
          
          
            <li><a href="/faq" target="_blank">FAQ</a></li>
          
          
          
            <li><a href="/get-started" target="_blank">Get Started</a></li>
          
          
          
            <li><a href="https://stackoverflow.com/questions/tagged/quarkus" target="_blank">Stack Overflow</a></li>
          
          
          
            <li><a href="https://github.com/quarkusio/quarkus/discussions" target="_blank">Discussions</a></li>
          
          
          
            <li><a href="https://groups.google.com/forum/#!forum/quarkus-dev" target="_blank">Development mailing list</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Languages</span>
        <ul class="footer-links">
          
          
            <li><a href="https://quarkus.io/" target="_blank">English</a></li>
          
          
          
            <li><a href="https://pt.quarkus.io/" target="_blank">Português&nbsp;(Brasileiro)</a></li>
          
          
          
            <li><a href="https://es.quarkus.io/" target="_blank">Español</a></li>
          
          
          
            <li><a href="https://cn.quarkus.io/" target="_blank">简体中文</a></li>
          
          
          
            <li><a href="https://ja.quarkus.io/" target="_blank">日本語</a></li>
          
          
        </ul>
      </div>
    

    
      <div class="width-4-12 more-links">
        <span>Quarkus is made of community projects</span>
        <ul class="footer-links">
          
            <li><a blah href="https://vertx.io/" target="_blank">Eclipse Vert.x</a></li>
          
            <li><a blah href="https://smallrye.io" target="_blank">SmallRye</a></li>
          
            <li><a blah href="https://hibernate.org" target="_blank">Hibernate</a></li>
          
            <li><a blah href="https://netty.io" target="_blank">Netty</a></li>
          
            <li><a blah href="https://resteasy.github.io" target="_blank">RESTEasy</a></li>
          
            <li><a blah href="https://camel.apache.org" target="_blank">Apache Camel</a></li>
          
            <li><a blah href="https://microprofile.io" target="_blank">Eclipse MicroProfile</a></li>
          
            <li><a blah href="https://code.quarkus.io/" target="_blank">And many more...</a></li>
          
        </ul>
      </div>
    
  </div>
</div>

  <div class="content redhat-footer">
  <div class="grid-wrapper">
    <span class="licence">
      <i class="fab fa-creative-commons"></i><i class="fab fa-creative-commons-by"></i> <a href="https://creativecommons.org/licenses/by/3.0/" target="_blank">CC by 3.0</a> | <a href="https://www.redhat.com/en/about/privacy-policy">Privacy Policy</a>
    </span>
    <span class="redhat">
      Sponsored by
    </span>
    <span class="redhat-logo">
      <a href="https://www.redhat.com/" target="_blank"><img src="/assets/images/redhat_reversed.svg"></a>
    </span>
  </div>
</div>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/scroll-down.js"></script>
  <script src="/assets/javascript/satellite.js" type="text/javascript"></script>
  <script src="/guides/javascript/config.js" type="text/javascript"></script>
  <script src="/assets/javascript/guides-version-dropdown.js" type="text/javascript"></script>
  <script src="/assets/javascript/back-to-top.js" type="text/javascript"></script>
  <script src="/assets/javascript/clipboard.min.js" type="text/javascript"></script>
  <script src="/assets/javascript/copy.js" type="text/javascript"></script>
  <script src="/assets/javascript/asciidoc-tabs.js" type="text/javascript"></script>
  <script src="/assets/javascript/future-date.js" type="text/javascript"></script>
</body>

</html>
