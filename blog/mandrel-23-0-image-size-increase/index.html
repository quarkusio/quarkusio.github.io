<!DOCTYPE html>
<html lang="en">







<head>
  <title>Exploring why native executables produced with Mandrel 23.0 are bigger than those produced with Mandrel 22.3 - Quarkus</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="
  connect-src 'self' https://dpm.demdex.net https://adobedc.demdex.net https://route-default-test-mscherer-matamo.apps.ospo-osci.z3b1.p1.openshiftapps.com/ https://search.quarkus.io https://smetrics.redhat.com; 
  script-src 'self' 'unsafe-inline' 'unsafe-eval'
      
      https://assets.adobedtm.com
      js.bizographics.com
      https://www.redhat.com
      https://static.redhat.com
      https://app.requestly.io/
      jsonip.com
      https://ajax.googleapis.com
      https://use.fontawesome.com
      http://www.youtube.com
      http://www.googleadservices.com
      https://googleads.g.doubleclick.net
      https://giscus.app
      https://route-default-test-mscherer-matamo.apps.ospo-osci.z3b1.p1.openshiftapps.com/
      https://app.mailjet.com;

  style-src 'self' https://fonts.googleapis.com https://use.fontawesome.com; 
  img-src 'self' * data:; 
  media-src 'self'; 
  frame-src https://redhat.demdex.net https://www.youtube.com https://embed.restream.io https://app.mailjet.com http://xy0p2.mjt.lu https://mj.quarkus.io https://giscus.app; 
  base-uri 'none'; 
  object-src 'none'; 
  form-action 'none'; 
  font-src 'self' https://use.fontawesome.com https://fonts.gstatic.com;" />
  <script id="adobe_dtm" src="https://www.redhat.com/dtm.js" type="text/javascript"></script>
  <script src="/assets/javascript/highlight.pack.js" type="text/javascript"></script>
  <META HTTP-EQUIV='X-XSS-Protection' CONTENT="1; mode=block">
  <META HTTP-EQUIV='X-Content-Type-Options' CONTENT="nosniff">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Quarkus: Supersonic Subatomic Java">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@QuarkusIO"> 
  <meta name="twitter:creator" content="@QuarkusIO">
  <meta property="og:url" content="https://quarkus.io/blog/mandrel-23-0-image-size-increase/" />
  <meta property="og:title" content="Exploring why native executables produced with Mandrel 23.0 are bigger than those produced with Mandrel 22.3" />
  <meta property="og:description" content="Quarkus: Supersonic Subatomic Java" />
  <meta property="og:image" content="https://quarkus.io/assets/images/quarkus_card.png" />
  
  <link rel="canonical" href="https://quarkus.io/blog/mandrel-23-0-image-size-increase/">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/guides/stylesheet/config.css" />
  <link rel="stylesheet" href="/assets/css/main.css?2021-07-29" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.5.2/css/all.css" crossorigin="anonymous">
  <link rel="alternate" type="application/rss+xml"  href="/feed.xml" title="Quarkus">
  <script src="/assets/javascript/hl.js" type="text/javascript"></script>
  
  
  
  
  <link rel="alternate" hreflang="en" href="https://quarkus.io/blog/mandrel-23-0-image-size-increase/" />
  
  <link rel="alternate" hreflang="pt-br" href="https://pt.quarkus.io/blog/mandrel-23-0-image-size-increase/" />
  
  <link rel="alternate" hreflang="es" href="https://es.quarkus.io/blog/mandrel-23-0-image-size-increase/" />
  
  <link rel="alternate" hreflang="zh" href="https://cn.quarkus.io/blog/mandrel-23-0-image-size-increase/" />
  
  <link rel="alternate" hreflang="ja" href="https://ja.quarkus.io/blog/mandrel-23-0-image-size-increase/" />
  
  <link rel="alternate" hreflang="x-default" href="https://quarkus.io/" />  
  <script src="/assets/javascript/tracking.js"></script>
  
  <script src="/assets/javascript/colormode.js" type="text/javascript"></script>

</head>

<body class="post">

  
  <div class="nav-wrapper">
  <div class="grid-wrapper">
    <div class="width-12-12">
      <input type="checkbox" id="checkbox" />
      <nav id="main-nav" class="main-nav">
        <div class="logo-wrapper">
           <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_600px_reverse.png" class="project-logo" title="Quarkus"></a>
        </div>
    <label class="nav-toggle" for="checkbox">
      <i class="fa fa-bars"></i>
    </label>
    <ul id="menu" class="menu">
      <li class="dropdown">
        <span href="/about/">Why<i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/about" class="">WHAT IS QUARKUS?</a></li>
          <li><a href="/container-first" class="">CONTAINER FIRST</a></li>
          <li><a href="/continuum" class="">VERSATILITY</a></li>
          <li><a href="/developer-joy" class="">DEVELOPER JOY</a></li>
          <li><a href="/kubernetes-native" class="">KUBERNETES NATIVE</a></li>
          <li><a href="/standards" class="">STANDARDS</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="/learn/">Learn<i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/get-started" class="">GET STARTED</a></li>
          <li><a href="/guides" class="">DOCUMENTATION</a></li>
          <li><a href="/qtips" class="">"Q" TIP VIDEOS</a></li>          
          <li><a href="/books" class="">BOOKS</a></li>
          </ul>
      </li>
      <li class="dropdown">
        <span href="https://quarkus.io/extensions/">Extensions<i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <!-- Note that quarkus.io is hardcoded here, because it is the only url which supports extensions -->
          <li><a href="https://quarkus.io/extensions/" class="">BROWSE EXTENSIONS</a></li>
          <li><a href="/faq/#what-is-a-quarkus-extension" class="">USE EXTENSIONS</a></li>
          <li><a href="/guides/writing-extensions" class="">CREATE EXTENSIONS</a></li>
          <li><a href="https://hub.quarkiverse.io" class="">SHARE EXTENSIONS</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="/community/">Community<i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/support/" class="">SUPPORT</a></li>
          <li><a href="/blog" class="active">BLOG</a></li>
          <li><a href="/discussion" class="">DISCUSSION</a></li>
          <li><a href="/working-groups" class="">WORKING GROUPS</a></li>
          <li><a href="/insights" class="">PODCAST</a></li>
          <li><a href="/events" class="">EVENTS</a></li>
          <li><a href="/newsletter" class="">NEWSLETTER</a></li>
          <li><a href="https://github.com/orgs/quarkusio/projects/13/views/1" class="">ROADMAP</a></li>
          </ul>
      </li>
      <li>
        <a href="https://code.quarkus.io" class="button-cta secondary white">START CODING</a>
      </li>
      <li class="dropdown">
        <span href="/language/"><div class="fas fa-globe langicon"></div><i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="https://quarkus.io/blog/mandrel-23-0-image-size-increase/" >OFFICIAL (ENGLISH)</a></li>
          <li><a href="https://pt.quarkus.io/blog/mandrel-23-0-image-size-increase/">PORTUGUÊS (BR)</a></li>
          <li><a href="https://es.quarkus.io/blog/mandrel-23-0-image-size-increase/">ESPAÑOL</a></li>
          <li><a href="https://cn.quarkus.io/blog/mandrel-23-0-image-size-increase/">简体中文</a></li>
          <li><a href="https://ja.quarkus.io/blog/mandrel-23-0-image-size-increase/">日本語</a></li>
          </ul>
      </li>
      <li>
        <span href="#" class="modeswitcher" id='theme-toggle'><i class="fas fa-sun"></i><i class="fas fa-moon"></i><i class="fas fa-cog"></i></span>
      </li>
    </ul>
      </nav>
    </div>
  </div>
</div>

  <div class="content">
    <div class="full-width-breadcrumb-bg align-self">
  <div class="width-12-12">
      <p class="returnlink"><a href="/blog">Blog</a> <i class="fas fa-chevron-right"></i> Exploring why native executables produced with Mandrel 23.0 are bigger than those produced with Mandrel 22.3</p>
  </div>
</div>

<div class="post-page grid-wrapper">
  <div class="width-8-12 width-12-12-m doc-content">
    <div class="grid-wrapper">
      <div class="width-12-12">
        <div class="post-date">
          November 02, 2023 
          
            <span class="tags"><a href="/blog/tag/native">#native</a><a href="/blog/tag/graalvm">#graalvm</a><a href="/blog/tag/mandrel">#mandrel</a><a href="/blog/tag/metrics">#metrics</a></span>
          
        </div>
        <h1 class="post-title">Exploring why native executables produced with Mandrel 23.0 are bigger than those produced with Mandrel 22.3</h1>
        <div class="grid-wrapper">
          <div class="width-8-12 width-12-12-m byline-wrapper">
            
            
              <img class="headshot" src="https://www.gravatar.com/avatar/3772ed72c143c2f0fe110d1a4124a46a">
            
            <p class="byline">By <a href="/author/zakkak">Foivos Zakkak</a></p>
          </div>
          <div class="width-12-12">
              <p>Starting with Quarkus 3.2 the default Mandrel version was updated from 22.3 to 23.0.</p>

<p>This update brought a number of bugfixes as well as new features like:</p>

<ol>
  <li>Better support for profiling and debugging using <code class="language-plaintext highlighter-rouge">perf</code> and <code class="language-plaintext highlighter-rouge">gdb</code>.</li>
  <li>Finer control over the monitoring features included in the native executable.</li>
  <li>Support for more JFR events.</li>
</ol>

<p>However, it also brought an unwanted side effect.
The native executables produced with Mandrel 23.0 are bigger than the ones produced with Mandrel 22.3.
To better understand why that happens we perform a thorough analysis to attribute the size increase to specific changes in Mandrel’s code base.</p>

<h2 id="tldr">TL;DR</h2>

<p>According to our analysis the binary size increase is attributed to three distinct changes, all of which are well justified:</p>

<ol>
  <li><a href="https://github.com/oracle/graal/pull/5156">Skipping constant folding of reflection methods with side effects</a>.</li>
  <li><a href="https://github.com/oracle/graal/pull/5330">Reducing the number of stores that are executed by the serial GC write barriers to improve performance by reducing the number of cache misses</a>.</li>
  <li><a href="https://github.com/oracle/graal/commit/4de58f1b3c484213951622c03d74f3435a20c4ef#diff-991a434bbfc9a6af5514e4609380d5fbfe7618585d5b1b3f11fa2a7431ca7ab0L1388-R1388">Enabling code alignment to compensate for the performance penalty of Intel’s jump conditional code erratum</a>.</li>
</ol>

<h2 id="better-understanding-what-is-different-between-the-generated-native-executables">Better understanding what is different between the generated native executables</h2>

<p>The first step in our analysis is to understand where the binary size increase comes from.
Usually such an increase is attributed to one of the following:</p>

<ol>
  <li>More code being generated, due to more code becoming reachable.</li>
  <li>More code being generated, due to more aggressive inlining.</li>
  <li>More data being stored in the image heap, due to more objects being reachable.</li>
  <li>More data being stored in the image heap, due to more types being registered for reflection thus requiring more code metadata to be stored.</li>
</ol>

<p>To perform the analysis we use the <a href="https://github.com/quarkus-qe/quarkus-startstop">Quarkus startstop test</a> (specifically commit <code class="language-plaintext highlighter-rouge">a8bae846881607e376c7c8a96116b6b50ee50b70</code>) which generates, starts, tests, and stops small Quarkus applications and measures various time-related metrics (e.g. time-to-first-OK-request) and memory usage.
We get the test with:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/quarkus-qe/quarkus-startstop
<span class="nb">cd </span>quarkus-startstop
git checkout a8bae846881607e376c7c8a96116b6b50ee50b70
</code></pre></div></div>

<p>and build it with:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mvn clean package <span class="nt">-Pnative</span> <span class="nt">-Dquarkus</span>.version<span class="o">=</span>3.2.6.Final<span class="se">\</span>
    <span class="nt">-Dquarkus</span>.native.builder-image<span class="o">=</span>quay.io/quarkus/ubi-quarkus-mandrel-builder-image:jdk-17
</code></pre></div></div>

<p>changing the builder image tag to <code class="language-plaintext highlighter-rouge">22.3-java17</code> for building with Mandrel 22.3.</p>

<p>Looking at the build output (generated by Quarkus in <code class="language-plaintext highlighter-rouge">target/my-app-native-image-sources/my-app-build-output-stats.json</code>) the main differences between the two builds are in the following metrics:</p>

<table>
  <thead>
    <tr>
      <th>Mandrel version</th>
      <th>22.3.3.1</th>
      <th>23.0.1.2</th>
      <th>Increase %</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Image Heap Size</td>
      <td>28807168</td>
      <td>29499392</td>
      <td>2.4</td>
    </tr>
    <tr>
      <td>Image Code Area</td>
      <td>27680208</td>
      <td>29625424</td>
      <td>7</td>
    </tr>
    <tr>
      <td>Total Image Size</td>
      <td>56826648</td>
      <td>59467728</td>
      <td>4.6</td>
    </tr>
    <tr>
      <td>Classes registered for reflection</td>
      <td>645</td>
      <td>4317</td>
      <td>570</td>
    </tr>
  </tbody>
</table>

<p>Hinting that any of the reasons 1-4 mentioned above is possible.</p>

<h3 id="dashboards">Dashboards</h3>

<p>GraalVM and Mandrel provide the <code class="language-plaintext highlighter-rouge">-H:+DashboardAll</code> and <code class="language-plaintext highlighter-rouge">-H:+DashboardJson</code> flags that can be used to generate dashboards that contain more information about the generated native executable.
The resulting dashboard contains a number of metrics and looks like this:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"points-to"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type-flows"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="err">...</span><span class="w">
    </span><span class="p">]</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"code-breakdown"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"code-size"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"io.smallrye.mutiny.CompositeException.getFirstOrFail(Throwable[]) Throwable"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">575</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="err">...</span><span class="w">
    </span><span class="p">]</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"heap-breakdown"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"heap-size"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Lio/vertx/core/impl/VerticleManager$$Lambda$bf09d38f5d19578a0d041ffd0a524c1cbe1843df;"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">24</span><span class="p">,</span><span class="w">
        </span><span class="nl">"count"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="err">...</span><span class="w">
    </span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Using the aforementioned flags we generate dashboards using both Mandrel 22.3 and 23.0 and compare the results.</p>

<p>To generate the dashboards using Mandrel 23.0 we use the following command:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mvn package <span class="nt">-Pnative</span> <span class="se">\</span>
  <span class="nt">-Dquarkus</span>.version<span class="o">=</span>3.2.6.Final <span class="se">\</span>
  <span class="nt">-Dquarkus</span>.native.builder-image<span class="o">=</span>quay.io/quarkus/ubi-quarkus-mandrel-builder-image:jdk-17 <span class="se">\</span>
  <span class="nt">-Dquarkus</span>.native.additional-build-args<span class="o">=</span><span class="nt">-H</span>:+DashboardAll,-H:+DashboardJson,-H:DashboardDump<span class="o">=</span>path/to/23.0.dashboard.json
</code></pre></div></div>

<p>Similarly to generate the dashboards using Mandrel 22.3 we use the following command:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mvn package <span class="nt">-Pnative</span> <span class="se">\</span>
  <span class="nt">-Dquarkus</span>.version<span class="o">=</span>3.2.6.Final <span class="se">\</span>
  <span class="nt">-Dquarkus</span>.native.builder-image<span class="o">=</span>quay.io/quarkus/ubi-quarkus-mandrel-builder-image:22.3-java17 <span class="se">\</span>
  <span class="nt">-Dquarkus</span>.native.additional-build-args<span class="o">=</span><span class="nt">-H</span>:+DashboardAll,-H:+DashboardJson,-H:DashboardDump<span class="o">=</span>path/to/22.3.dashboard.json
</code></pre></div></div>

<p>Note: Make sure to change <code class="language-plaintext highlighter-rouge">path/to/</code> to the path where you would like the dashboard json files to be stored, each file is about 370MB big.</p>

<h3 id="analyzing-and-visualizing-the-data">Analyzing and visualizing the data</h3>

<p>To process the data from the dashboards we used a Jupyter notebook, like we did to create this article.
To grab the notebook follow <a href="/assets/examples/posts/mandrel-23-0-image-size-increase/quarkus-size-22-3-23-0.ipynb">this link</a>.</p>

<p>For those willing to use a spreadsheet instead, a CSV file can be created to facilitate the analysis in a spreadsheet.
E.g. using <code class="language-plaintext highlighter-rouge">jq</code>:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jq <span class="nt">-r</span> <span class="nt">-s</span> <span class="s1">'(["Name", "22.3 size", "23.0 size"], (map(."code-breakdown"."code-size") | flatten | group_by(.name) | map({name: .[0].name, size22: .[0].size, size23: .[1].size})[] | [.name, .size22, .size23])) | @csv'</span> 22.3.dashboard.json 23.0.dashboard.json <span class="o">&gt;</span> analysis.csv
</code></pre></div></div>

<h4 id="loading-the-data-from-the-json-files">Loading the data from the json files</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>

<span class="c1"># load data from JSON file
</span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'22.3.dashboard.json'</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">data22_3</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'23.0.dashboard.json'</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">data23_0</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="c1"># create dataframes from json data
</span><span class="n">df22_3</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data22_3</span><span class="p">)</span>
<span class="n">df23_0</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data23_0</span><span class="p">)</span>

</code></pre></div></div>

<h2 id="key-observations">Key Observations</h2>

<p>The key questions we want to answer using the aforementioned data are:</p>

<ol>
  <li>Is the code area bigger due to more methods being compiled?</li>
  <li>Is the code area bigger due to more code being generated per method?</li>
  <li>Is the heap image bigger because we store more objects in it?</li>
  <li>Is the heap image bigger because we store more metadata?</li>
</ol>

<h3 id="code-area-size-increase">Code Area Size Increase</h3>

<p>We first answer the code area related questions.</p>

<h4 id="is-the-code-area-bigger-due-to-more-methods-being-compiled">Is the code area bigger due to more methods being compiled?</h4>

<p>To answer this question we get the two lists of the compiled methods and compare their sizes:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Get code-size lists from dataframes
</span><span class="n">code_size_22_3</span> <span class="o">=</span> <span class="n">df22_3</span><span class="p">[</span><span class="s">'code-breakdown'</span><span class="p">][</span><span class="s">'code-size'</span><span class="p">]</span>
<span class="n">code_size_23_0</span> <span class="o">=</span> <span class="n">df23_0</span><span class="p">[</span><span class="s">'code-breakdown'</span><span class="p">][</span><span class="s">'code-size'</span><span class="p">]</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Compiled methods with 22_3:"</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">code_size_22_3</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Compiled methods with 23_0:"</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">code_size_23_0</span><span class="p">))</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Compiled methods with 22_3: 46298
Compiled methods with 23_0: 46299
</code></pre></div></div>

<p>The results indicate that the answer is no.
In both cases the number of compiled methods is the same (off by 1).
As a result the code size increase is not coming from more methods becoming reachable and compiled.</p>

<h4 id="is-the-code-area-bigger-due-to-more-code-being-generated-per-method">Is the code area bigger due to more code being generated per method?</h4>

<p>To answer this question we calculate the percentage difference between the compiled methods:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="c1"># create dataframes from code_size lists
</span><span class="n">code_df22_3</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">code_size_22_3</span><span class="p">).</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s">'size'</span><span class="p">:</span> <span class="s">'size-22.3'</span><span class="p">})</span>
<span class="n">code_df23_0</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">code_size_23_0</span><span class="p">).</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s">'size'</span><span class="p">:</span> <span class="s">'size-23.0'</span><span class="p">})</span>

<span class="c1"># merge dataframes
</span><span class="n">merged_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">merge</span><span class="p">(</span><span class="n">code_df22_3</span><span class="p">,</span> <span class="n">code_df23_0</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s">'name'</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s">'outer'</span><span class="p">).</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># create column with size increase as percentage skipping entries with 0 size
</span><span class="n">percentage_increase</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="p">(</span>
    <span class="p">((</span><span class="n">row</span><span class="p">[</span><span class="s">'size-23.0'</span><span class="p">]</span> <span class="o">-</span> <span class="n">row</span><span class="p">[</span><span class="s">'size-22.3'</span><span class="p">])</span> <span class="o">/</span> <span class="n">row</span><span class="p">[</span><span class="s">'size-22.3'</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span> 
    <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s">'size-22.3'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="s">'size-23.0'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> 
    <span class="k">else</span> <span class="mi">0</span>
<span class="p">)</span>
<span class="n">merged_df</span><span class="p">[</span><span class="s">'size-increase'</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">.</span><span class="nb">apply</span><span class="p">(</span><span class="n">percentage_increase</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<p>We count the number of methods, the number of those that didn’t change size, the number of those that their size increased, and the number of those that their size decreased:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">total_compiled_methods</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged_df</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Total number of compiled methods: </span><span class="si">{</span><span class="n">total_compiled_methods</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="n">zero_increase_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">merged_df</span><span class="p">[</span><span class="s">'size-increase'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">).</span><span class="nb">sum</span><span class="p">()</span>
<span class="n">zero_increase_percent</span> <span class="o">=</span> <span class="p">(</span><span class="n">zero_increase_count</span> <span class="o">/</span> <span class="n">total_compiled_methods</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Number of methods that their compiled size remains the same: </span><span class="si">{</span><span class="n">zero_increase_count</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">zero_increase_percent</span><span class="p">:.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">%)"</span><span class="p">)</span>
<span class="n">positive_increase_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">merged_df</span><span class="p">[</span><span class="s">'size-increase'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">).</span><span class="nb">sum</span><span class="p">()</span>
<span class="n">positive_increase_percent</span> <span class="o">=</span> <span class="p">(</span><span class="n">positive_increase_count</span> <span class="o">/</span> <span class="n">total_compiled_methods</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Number of methods that their compiled size increased: </span><span class="si">{</span><span class="n">positive_increase_count</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">positive_increase_percent</span><span class="p">:.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">%)"</span><span class="p">)</span>
<span class="n">negative_increase_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">merged_df</span><span class="p">[</span><span class="s">'size-increase'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">).</span><span class="nb">sum</span><span class="p">()</span>
<span class="n">negative_increase_percent</span> <span class="o">=</span> <span class="p">(</span><span class="n">negative_increase_count</span> <span class="o">/</span> <span class="n">total_compiled_methods</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Number of methods that their compiled size decreased: </span><span class="si">{</span><span class="n">negative_increase_count</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">negative_increase_percent</span><span class="p">:.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">%)"</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Total number of compiled methods: 48476
Number of methods that their compiled size remains the same: 13947 (28.77%)
Number of methods that their compiled size increased: 33351 (68.80%)
Number of methods that their compiled size decreased: 1178 (2.43%)
</code></pre></div></div>

<p>The results indicate that 68.8% of the compiled methods are bigger when compiled by 23.0 in comparison to when they are compiled by 22.3.
But how much bigger?
To answer this we print a histogram of the size increase:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># plot histogram
</span><span class="n">plt</span><span class="p">.</span><span class="n">hist</span><span class="p">(</span><span class="n">merged_df</span><span class="p">[</span><span class="s">'size-increase'</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="s">"auto"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Percentage difference'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'Frequency'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="s">'Histogram of percentage difference in code size (full range)'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/assets/images/posts/mandrel-23-0-image-size-increase/index_9_0.png" alt="png" /></p>

<p>We observe that due to a large number of methods retaining the same size and due to some outliers the histogram is hard to read.
So we remove the methods with no size changes and limit our focus in the range [-5, 25]:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># create column with size increase as percentage skipping entries with 0 size
</span><span class="n">zero_filter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">'size-increase'</span><span class="p">]</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s">'size-increase'</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">None</span>
<span class="n">merged_df</span><span class="p">[</span><span class="s">'size-increase'</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">.</span><span class="nb">apply</span><span class="p">(</span><span class="n">zero_filter</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># drop rows with None values
</span><span class="n">merged_df</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="c1"># plot histogram
</span><span class="n">plt</span><span class="p">.</span><span class="n">hist</span><span class="p">(</span><span class="n">merged_df</span><span class="p">[</span><span class="s">'size-increase'</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="s">"auto"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Percentage difference'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'Frequency'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="s">'Histogram of percentage difference in code size in the range [-5%, 25%] excluding 0%'</span><span class="p">)</span>
<span class="c1"># show the plot
</span><span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/assets/images/posts/mandrel-23-0-image-size-increase/index_11_0.png" alt="png" /></p>

<p>This plot shows that the majority of the affected methods get a code size increase between 0 and 10 %, which is inline with the overall size increase we observe in the code area.</p>

<h5 id="why">Why?</h5>

<p>To see why the same methods get compiled to larger machine code when using Mandrel 23.0 we first inspected how many methods are getting inlined in each case.
To do so, we build the native executables with debug info generation enabled using the <code class="language-plaintext highlighter-rouge">-Dquarkus.native.debug.enabled=true</code> parameter.
To make sure that inline DIEs are included when building with Mandrel 22.3 we also pass the <code class="language-plaintext highlighter-rouge">-Dquarkus.native.additional-build-args=-H:-OmitInlinedMethodDebugLineInfo</code> option, e.g.:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mvn clean package <span class="nt">-Pnative</span> <span class="nt">-Dquarkus</span>.version<span class="o">=</span>3.2.6.Final<span class="se">\</span>
    <span class="nt">-Dquarkus</span>.native.builder-image<span class="o">=</span>quay.io/quarkus/ubi-quarkus-mandrel-builder-image:jdk-17<span class="se">\</span>
    <span class="nt">-Dquarkus</span>.native.debug.enabled<span class="o">=</span><span class="nb">true</span><span class="se">\</span>
    <span class="nt">-Dquarkus</span>.native.additional-build-args<span class="o">=</span><span class="nt">-H</span>:-OmitInlinedMethodDebugLineInfo
</code></pre></div></div>

<p>After the image is built we count the number of <em>inlined</em> Debug Info Entries (DIEs) using the following command:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>readelf <span class="nt">--debug-dump</span><span class="o">=</span>info quarkus-runner | <span class="nb">grep</span> <span class="nt">-i</span> <span class="s2">"DW_TAG_inlined_subroutine"</span> | <span class="nb">wc</span> <span class="nt">-l</span>
</code></pre></div></div>

<p>The results are shown in the table below:</p>

<table>
  <thead>
    <tr>
      <th>Mandrel version</th>
      <th>22.3</th>
      <th>23.0</th>
      <th>Increase %</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Inlined methods</td>
      <td>2798414</td>
      <td>2817686</td>
      <td>0.69 %</td>
    </tr>
  </tbody>
</table>

<p>While they indicate a slight increase in the number of inlined methods between Mandrel 22.3 and 23.0, the increase is so small that it doesn’t align with the overall code size increase.</p>

<p>As a next step, we hand-picked a number of methods with different code sizes in the generated native executables and inspected their disassembled code (using <code class="language-plaintext highlighter-rouge">gdb</code>).</p>

<p>For example inspecting <code class="language-plaintext highlighter-rouge">InstrumentedUnpooledUnsafeNoCleanerDirectByteBuf.allocateDirect(int)</code> from <code class="language-plaintext highlighter-rouge">io.netty.buffer.UnpooledByteBufAllocator</code> using:</p>

<pre><code class="language-gdb">(gdb) x/20i 'io.netty.buffer.UnpooledByteBufAllocator$InstrumentedUnpooledUnsafeNoCleanerDirectByteBuf::allocateDirect(int)'
</code></pre>

<p>we see that the one extra byte comes from an additional <code class="language-plaintext highlighter-rouge">nop</code> between two calls.</p>

<p><strong>Mandrel 22.3</strong></p>

<pre><code class="language-asm">sub    $0x18,%rsp
cmp    0x8(%r15),%rsp
jbe    0x96ad8f
mov    %rdi,0x8(%rsp)
mov    %esi,%edi
mov    %esi,0x14(%rsp)
call   0xb7e870
nop
call   0x756e10
nop
</code></pre>

<p><strong>Mandrel 23.0</strong></p>

<pre><code class="language-asm">sub    $0x18,%rsp
cmp    0x8(%r15),%rsp
jbe    0x96ad8f
mov    %rdi,0x8(%rsp)
mov    %esi,%edi
mov    %esi,0x14(%rsp)
call   0xb7e870
nop
nop                     // &lt;==== extra nop
call   0x756e10
nop
</code></pre>

<p>We observed this pattern in multiple methods which is an indication of some code alignment change.
However, there were also methods with increased compiled code size without having an increased number of <code class="language-plaintext highlighter-rouge">nop</code>s, hinting that the code size increase is not caused by a single change as we confirm in <a href="#attributing-binary-size-increase-to-specific-code-changes">Attributing Binary Size Increase to Specific Code Changes</a>.</p>

<h3 id="image-heap-size-increase">Image Heap Size Increase</h3>

<p>Upon initial inspection, it was noted that there was an increase of approximately 650KB in the image heap size.
As a result next we opted to answer whether:</p>

<ol>
  <li>The heap image is bigger because we store more objects in it?</li>
  <li>The heap image is bigger because we store more metadata?</li>
</ol>

<h4 id="is-the-heap-image-bigger-because-we-store-more-objects-in-it">Is the heap image bigger because we store more objects in it?</h4>

<p>Using the dashboard data we first checked whether the number of objects in the image heap is different between the two versions:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Get heap-size lists from dataframes
</span><span class="n">heap_size_22_3</span> <span class="o">=</span> <span class="n">df22_3</span><span class="p">[</span><span class="s">'heap-breakdown'</span><span class="p">][</span><span class="s">'heap-size'</span><span class="p">]</span>
<span class="n">heap_size_23_0</span> <span class="o">=</span> <span class="n">df23_0</span><span class="p">[</span><span class="s">'heap-breakdown'</span><span class="p">][</span><span class="s">'heap-size'</span><span class="p">]</span>

<span class="c1"># create dataframes from heap_size lists
</span><span class="n">heap_df22_3</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">heap_size_22_3</span><span class="p">).</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s">'size'</span><span class="p">:</span> <span class="s">'size-22.3'</span><span class="p">,</span> <span class="s">'count'</span><span class="p">:</span> <span class="s">'count-22.3'</span><span class="p">})</span>
<span class="n">heap_df23_0</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">heap_size_23_0</span><span class="p">).</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s">'size'</span><span class="p">:</span> <span class="s">'size-23.0'</span><span class="p">,</span> <span class="s">'count'</span><span class="p">:</span> <span class="s">'count-23.0'</span><span class="p">})</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Number of objects in image heap with 22.3: "</span><span class="p">,</span> <span class="n">heap_df22_3</span><span class="p">[</span><span class="s">'count-22.3'</span><span class="p">].</span><span class="nb">sum</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Number of objects in image heap with 23.0: "</span><span class="p">,</span> <span class="n">heap_df23_0</span><span class="p">[</span><span class="s">'count-23.0'</span><span class="p">].</span><span class="nb">sum</span><span class="p">())</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Number of objects in image heap with 22.3:  340870
Number of objects in image heap with 23.0:  348063
</code></pre></div></div>

<p>We observe that the image generated with 22.3 has ~7000 (or roughly 2%) more objects in the image heap.
We then check to see if these additional objects are from different types being instantiated:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="s">"Types in image heap with 22.3:"</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">heap_size_22_3</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Types in image heap with 23.0:"</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">heap_size_23_0</span><span class="p">))</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Types in image heap with 22.3: 3681
Types in image heap with 23.0: 3679
</code></pre></div></div>

<p>The results indicate that the number of types in the image heap remain about the same, hinting that 23.0 instantiates more objects of the same types in the image heap.
To see which types are those seeing the larger, in terms of heap size, increase in the image heap we run:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># merge dataframes
</span><span class="n">merged_heap_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">merge</span><span class="p">(</span><span class="n">heap_df22_3</span><span class="p">,</span> <span class="n">heap_df23_0</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s">'name'</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s">'outer'</span><span class="p">).</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">merged_heap_df</span><span class="p">[</span><span class="s">'count-diff'</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_heap_df</span><span class="p">[</span><span class="s">'count-23.0'</span><span class="p">]</span> <span class="o">-</span> <span class="n">merged_heap_df</span><span class="p">[</span><span class="s">'count-22.3'</span><span class="p">]</span>
<span class="n">merged_heap_df</span><span class="p">[</span><span class="s">'size-diff'</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_heap_df</span><span class="p">[</span><span class="s">'size-23.0'</span><span class="p">]</span> <span class="o">-</span> <span class="n">merged_heap_df</span><span class="p">[</span><span class="s">'size-22.3'</span><span class="p">]</span>
<span class="c1"># get top 10 types with the biggest difference in occupied heap size
</span><span class="n">merged_heap_df</span><span class="p">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s">'size-diff'</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">).</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)[[</span><span class="s">'name'</span><span class="p">,</span> <span class="s">'count-diff'</span><span class="p">,</span> <span class="s">'size-diff'</span><span class="p">]]</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>name</th>
      <th>count-diff</th>
      <th>size-diff</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1340</th>
      <td>[B</td>
      <td>2042.0</td>
      <td>894704.0</td>
    </tr>
    <tr>
      <th>2384</th>
      <td>Ljava/lang/invoke/DirectMethodHandle;</td>
      <td>1293.0</td>
      <td>71920.0</td>
    </tr>
    <tr>
      <th>2901</th>
      <td>Ljava/lang/String;</td>
      <td>2032.0</td>
      <td>65024.0</td>
    </tr>
    <tr>
      <th>3684</th>
      <td>Ljdk/internal/module/ServicesCatalog$ServicePr...</td>
      <td>1058.0</td>
      <td>42320.0</td>
    </tr>
    <tr>
      <th>2582</th>
      <td>[Ljava/lang/Object;</td>
      <td>246.0</td>
      <td>36472.0</td>
    </tr>
    <tr>
      <th>898</th>
      <td>[Ljava/lang/String;</td>
      <td>9.0</td>
      <td>28024.0</td>
    </tr>
    <tr>
      <th>1297</th>
      <td>Ljava/lang/invoke/MethodType;</td>
      <td>276.0</td>
      <td>15456.0</td>
    </tr>
    <tr>
      <th>3238</th>
      <td>Ljava/util/concurrent/ConcurrentHashMap$Node;</td>
      <td>274.0</td>
      <td>13152.0</td>
    </tr>
    <tr>
      <th>1065</th>
      <td>Ljava/util/HashMap;</td>
      <td>146.0</td>
      <td>10512.0</td>
    </tr>
    <tr>
      <th>3244</th>
      <td>[Ljava/lang/Class;</td>
      <td>261.0</td>
      <td>9680.0</td>
    </tr>
  </tbody>
</table>
</div>

<p>The results indicate an increase of ~870KB of bytes in byte arrays, which unfortunately is not very informative, especially combined with the size of other types significantly differing between the two versions (possibly due to GraalVM internal code changes which result in different allocation patterns).</p>

<h4 id="is-the-heap-image-bigger-because-we-store-more-metadata">Is the heap image bigger because we store more metadata?</h4>

<p>As shown in <a href="#better-understanding-what-is-different-between-the-generated-native-executables">Better understanding what is different between the generated native executables</a> there appears to be a significant increase in the number of types registered for reflection (645 in Mandrel 22.3 vs. 4317 in Mandrel 23.0).
This, along with the reported (in the <code class="language-plaintext highlighter-rouge">native-image</code> output) increase of code metadata, initially led us to think that there is some change in Mandrel that results in more types being registered for reflection.
In the end, as discussed in <a href="#attributing-binary-size-increase-to-specific-code-changes">Attributing Binary Size Increase to Specific Code Changes</a>, contrary to our intuition, the increase is not related to the increase in the reported types registered for reflection which is due to <a href="https://github.com/oracle/graal/commit/23d70b802b2dbc9b7d2324a31141c32b6575083f#diff-54ef73a23b10bd907d5869cc88b651fae7fef0467ccfaf8f50472cdd1e114eceR385">a fix in the way the reported types registered for reflection are measured</a>.
Instead, the increase of the code metadata stored in the image heap is due to <a href="https://github.com/oracle/graal/pull/5156">skipping constant folding of reflection methods with side effects</a>, a fix introduced in 23.0 to prevent undesired effects when folding invocations using reflection.</p>

<h2 id="attributing-binary-size-increase-to-specific-code-changes">Attributing Binary Size Increase to Specific Code Changes</h2>

<p>At this point, we have a rough understanding of what is different in the generated native executables, but we still don’t know why.
Is this increase in the size of native executables well justified?</p>

<p>To answer this question, we decided to detect the code base changes that resulted in the observed behaviors.
To do so, we used <code class="language-plaintext highlighter-rouge">git bisect</code>, marking the 22.3 release’s commit as <em>good</em> and the 23.0 release’s commit as <em>bad</em>.
For each commit, we built an instance of Mandrel and compiled our test application to see the code and heap area size.
If the sizes matched the ones from 22.3, we marked the commit as <em>good</em> otherwise we marked it as <em>bad</em>.
During this process, we noticed that there were commits resulting in binary sizes bigger than the ones generated with 22.3 but smaller than 23.0.
This confirmed our expectation that the binary size increase was the result of more than one change in the code base.
To reduce the <code class="language-plaintext highlighter-rouge">git bisect</code> cost we noted down the code and heap area sizes for each tested commit hash.
Then using that info, we replayed the bisect process a few times using the output of <code class="language-plaintext highlighter-rouge">git bisect log</code> and changing which commits we considered <em>good</em>, once we identified the first, second, and so forth change contributing to the binary size increase.</p>

<h3 id="identified-causes-of-code-size-increase">Identified Causes of Code Size Increase</h3>

<p>The above process led us to the conclusion that the binary size increase is mainly mainly the result of the following three changes:</p>

<ul>
  <li>
    <p><a href="https://github.com/oracle/graal/pull/5156"><strong>Skipping constant folding of reflection methods with side effects</strong></a>: A fix introduced in 23.0 to prevent undesired effects when folding invocations using reflection (e.g. triggering build time initialization of classes that should be run time initialized).
This change is responsible for the image heap size increase.</p>
  </li>
  <li>
    <p><a href="https://github.com/oracle/graal/pull/5330"><strong>Reducing the number of stores that are executed by the serial GC write barriers to improve performance by reducing the number of cache misses</strong></a>: This change essentially adds two additional instructions, a <code class="language-plaintext highlighter-rouge">cmpb   $0x0,0x30(%rcx,%rax,1)</code> and a <code class="language-plaintext highlighter-rouge">je</code>, to each inlined instance of the serial GC write barrier.
The aim of this change is to avoid unnecessary stores in the GC write barriers in order to reduce cache line invalidations and improve performance.
According to our measurements, the total impact of this change is ~1MB increase of code area in our test case which inlines the write barrier 90697 times when using Mandrel 22.3 and 93686 times when using Mandrel 23.0.
To measure the number the barrier was inlined we inspect the number of breakpoint locations set in <code class="language-plaintext highlighter-rouge">gdb</code> when running <code class="language-plaintext highlighter-rouge">b CardTable.java:91</code>, i.e. when setting a breakpoint in <code class="language-plaintext highlighter-rouge">com.oracle.svm.core.genscavenge.remset.CardTable#setDirty</code>.
E.g.:</p>

    <pre><code class="language-gdb">(gdb) b CardTable.java:91
Breakpoint 1 at 0x407574: CardTable.java:91. (93686 locations)
</code></pre>
  </li>
  <li>
    <p><a href="https://github.com/oracle/graal/commit/4de58f1b3c484213951622c03d74f3435a20c4ef#diff-991a434bbfc9a6af5514e4609380d5fbfe7618585d5b1b3f11fa2a7431ca7ab0L1388-R1388"><strong>Enabling code alignment to compensate for the performance penalty of Intel’s Jump Conditional Code Erratum</strong></a>: According to <a href="https://www.intel.com/content/dam/support/us/en/documents/processors/mitigations-jump-conditional-code-erratum.pdf">Intel’s white paper about “Mitigations for Jump Conditional Code Erratum”</a>:</p>

    <blockquote>
      <p>Software can compensate for the performance effects of the workaround for this erratum with optimizations that align the code such that jump instructions (and macro-fused jump instructions) do not cross 32-byte boundaries or end on a 32-byte boundary.
Such aligning can reduce or eliminate the performance penalty caused by the transition of execution from Decoded ICache to the legacy decode pipeline.</p>
    </blockquote>

    <p>As a result, this change results in an increased number of <code class="language-plaintext highlighter-rouge">nop</code> instructions in the generated code, but can result in up to 4% performance improvements according to the same document:</p>

    <blockquote>
      <p>Intel has observed performance effects associated with the workaround ranging from
0-4% on many industry-standard benchmarks.
In subcomponents of these benchmarks, Intel has observed outliers higher than the 0-4% range.
Other workloads not observed by Intel may behave differently.
Intel has in turn developed software-based tools to minimize the impact on potentially affected applications and workloads.</p>
    </blockquote>

    <p>According to our measurements, the total impact of this change is ~900KB in our test case.</p>
  </li>
</ul>

<h2 id="conclusion">Conclusion</h2>

<p>In conclusion, the increase in the size of native executables produced with Mandrel 23.0 compared to Mandrel 22.3 can be attributed to the above three specific changes in the Mandrel code base.</p>

<p>While these changes do contribute to the increase in native executable size, they also come with performance and correctness benefits.
Therefore, the larger executables are a trade-off to ensure better application performance and avoid undesired side effects.</p>

              
          </div>
          <div class="width-12-12"><div class="share-page">
  <a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https://quarkus.io/blog/mandrel-23-0-image-size-increase/&title=Exploring why native executables produced with Mandrel 23.0 are bigger than those produced with Mandrel 22.3" rel="nofollow" target="_blank" title="Share on LinkedIn">
    <i class="fa-brands fa-linkedin fa-xl"></i>
  </a>
  <a class="share-x" href="https://x.com/intent/tweet?text=Exploring why native executables produced with Mandrel 23.0 are bigger than those produced with Mandrel 22.3&url=https://quarkus.io/blog/mandrel-23-0-image-size-increase/&via=quarkusio&related=quarkusio" rel="nofollow" target="_blank" title="Share on X">
    <i class="fa-brands fa-square-x-twitter fa-xl"></i>
  </a>
  <a class="share-facebook" href="https://facebook.com/sharer.php?u=https://quarkus.io/blog/mandrel-23-0-image-size-increase/" rel="nofollow" target="_blank" title="Share on Facebook">
    <i class="fa-brands fa-square-facebook fa-xl"></i>
  </a>
  <a class="share-reddit" href="http://www.reddit.com/submit?url=https://quarkus.io/blog/mandrel-23-0-image-size-increase/" onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;" title="Share on Reddit" >
    <i class="fa-brands fa-square-reddit fa-xl"></i>
  </a>
  <a class="share-email" href="mailto:?subject=Exploring why native executables produced with Mandrel 23.0 are bigger than those produced with Mandrel 22.3&amp;body=Exploring why native executables produced with Mandrel 23.0 are bigger than those produced with Mandrel 22.3 https://quarkus.io/blog/mandrel-23-0-image-size-increase/" title="Share via Email" >
    <i class="fa-solid fa-envelope fa-xl"></i>
  </a>
</div>
</div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="post-page grid-wrapper">
  <div class="width-8-12 width-12-12-m doc-content">
  <script src="https://giscus.app/client.js"
        data-repo="quarkusio/quarkus"
        data-repo-id="MDEwOlJlcG9zaXRvcnkxMzk5MTQ5MzI="
        data-category="Quarkus Blog/Website"
        data-category-id="DIC_kwDOCFbutM4CAFFV"
        data-mapping="og:title"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-theme="preferred_color_scheme"
        data-lang="en"
        crossorigin="anonymous"
        async>
  </script>
  </div>
</div>

  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_reverse.svg" class="project-logo" title="Quarkus"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">Quarkus is open. All dependencies of this project are available under the <a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>Apache Software License 2.0</a> or compatible license.<br /><br />This website was built with <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a>, is hosted on <a href='https://pages.github.com/' target='_blank'>GitHub Pages</a> and is completely open source. If you want to make it better, <a href='https://github.com/quarkusio/quarkusio.github.io' target='_blank'>fork the website</a> and show us what you’ve got.</p>

    
      <div class="width-1-12 project-links">
        <span>Navigation</span>
        <ul class="footer-links">
          
          
            <li><a href="/" target="_blank">Home</a></li>
          
          
          
            <li><a href="/about" target="_blank">About</a></li>
          
          
          
            <li><a href="/blog" target="_blank">Blog</a></li>
          
          
          
            <li><a href="/insights" target="_blank">Podcast</a></li>
          
          
          
            <li><a href="/events" target="_blank">Events</a></li>
          
          
          
            <li><a href="/newsletter" target="_blank">Newsletter</a></li>
          
          
          
            <li><a href="https://github.com/orgs/quarkusio/projects/13/views/1" target="_blank">Roadmap</a></li>
          
          
          
            <li><a href="/security" target="_blank">Security&nbsp;policy</a></li>
          
          
          
            <li><a href="/usage" target="_blank">Usage</a></li>
          
          
          
            <li><a href="/brand" target="_blank">Brand</a></li>
          
          
          
            <li><a href="/desktopwallpapers" target="_blank">Wallpapers</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Follow Us</span>
        <ul class="footer-links">
          
          
            <li><a href="https://x.com/quarkusio" target="_blank">X</a></li>
          
          
          
            <li><a rel="me" href="https://fosstodon.org/@quarkusio" target="_blank">Mastodon</a></li>
            
          
          
            <li><a href="https://www.facebook.com/quarkusio" target="_blank">Facebook</a></li>
          
          
          
            <li><a href="https://www.linkedin.com/company/quarkusio/" target="_blank">Linkedin</a></li>
          
          
          
            <li><a href="https://www.youtube.com/channel/UCaW8QG_QoIk_FnjLgr5eOqg" target="_blank">Youtube</a></li>
          
          
          
            <li><a href="https://github.com/quarkusio" target="_blank">GitHub</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-2-12 project-links">
        <span>Get Help</span>
        <ul class="footer-links">
          
          
            <li><a href="/support" target="_blank">Support</a></li>
          
          
          
            <li><a href="/guides" target="_blank">Guides</a></li>
          
          
          
            <li><a href="/faq" target="_blank">FAQ</a></li>
          
          
          
            <li><a href="/get-started" target="_blank">Get Started</a></li>
          
          
          
            <li><a href="https://stackoverflow.com/questions/tagged/quarkus" target="_blank">Stack Overflow</a></li>
          
          
          
            <li><a href="https://github.com/quarkusio/quarkus/discussions" target="_blank">Discussions</a></li>
          
          
          
            <li><a href="https://groups.google.com/forum/#!forum/quarkus-dev" target="_blank">Development mailing list</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Languages</span>
        <ul class="footer-links">
          
          
            <li><a href="https://quarkus.io/" target="_blank">English</a></li>
          
          
          
            <li><a href="https://pt.quarkus.io/" target="_blank">Português&nbsp;(Brasileiro)</a></li>
          
          
          
            <li><a href="https://es.quarkus.io/" target="_blank">Español</a></li>
          
          
          
            <li><a href="https://cn.quarkus.io/" target="_blank">简体中文</a></li>
          
          
          
            <li><a href="https://ja.quarkus.io/" target="_blank">日本語</a></li>
          
          
        </ul>
      </div>
    

    
      <div class="width-4-12 more-links">
        <span>Quarkus is made of community projects</span>
        <ul class="footer-links">
          
            <li><a blah href="https://vertx.io/" target="_blank">Eclipse Vert.x</a></li>
          
            <li><a blah href="https://smallrye.io" target="_blank">SmallRye</a></li>
          
            <li><a blah href="https://hibernate.org" target="_blank">Hibernate</a></li>
          
            <li><a blah href="https://netty.io" target="_blank">Netty</a></li>
          
            <li><a blah href="https://resteasy.github.io" target="_blank">RESTEasy</a></li>
          
            <li><a blah href="https://camel.apache.org" target="_blank">Apache Camel</a></li>
          
            <li><a blah href="https://microprofile.io" target="_blank">Eclipse MicroProfile</a></li>
          
            <li><a blah href="https://code.quarkus.io/" target="_blank">And many more...</a></li>
          
        </ul>
      </div>
    
  </div>
</div>

  <div class="content redhat-footer">
  <div class="grid-wrapper">
    <span class="licence">
      <i class="fab fa-creative-commons"></i><i class="fab fa-creative-commons-by"></i> <a href="https://creativecommons.org/licenses/by/3.0/" target="_blank">CC by 3.0</a> | <a href="https://www.redhat.com/en/about/privacy-policy">Privacy Policy</a>
    </span>
    <span class="redhat">
      Sponsored by
    </span>
    <span class="redhat-logo">
      <a href="https://www.redhat.com/" target="_blank"><img src="/assets/images/redhat_reversed.svg"></a>
    </span>
  </div>
</div>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/scroll-down.js"></script>
  <script src="/assets/javascript/satellite.js" type="text/javascript"></script>
  <script src="/guides/javascript/config.js" type="text/javascript"></script>
  <script src="/assets/javascript/guides-version-dropdown.js" type="text/javascript"></script>
  <script src="/assets/javascript/back-to-top.js" type="text/javascript"></script>
  <script src="/assets/javascript/clipboard.min.js" type="text/javascript"></script>
  <script src="/assets/javascript/copy.js" type="text/javascript"></script>
  <script src="/assets/javascript/asciidoc-tabs.js" type="text/javascript"></script>
  <script src="/assets/javascript/future-date.js" type="text/javascript"></script>
</body>

</html>
