<!DOCTYPE html>
<html lang="en">







<head>
  <title>Use virtual threads in REST applications - 3.15 - Quarkus</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="
  connect-src 'self' https://dpm.demdex.net https://adobedc.demdex.net https://route-default-test-mscherer-matamo.apps.ospo-osci.z3b1.p1.openshiftapps.com/ https://search.quarkus.io https://smetrics.redhat.com; 
  script-src 'self' 'unsafe-inline' 'unsafe-eval'
      
      https://assets.adobedtm.com
      js.bizographics.com
      https://www.redhat.com
      https://static.redhat.com
      https://app.requestly.io/
      jsonip.com
      https://ajax.googleapis.com
      https://use.fontawesome.com
      http://www.youtube.com
      http://www.googleadservices.com
      https://googleads.g.doubleclick.net
      https://giscus.app
      https://route-default-test-mscherer-matamo.apps.ospo-osci.z3b1.p1.openshiftapps.com/
      https://app.mailjet.com;

  style-src 'self' https://fonts.googleapis.com https://use.fontawesome.com; 
  img-src 'self' * data:; 
  media-src 'self'; 
  frame-src https://redhat.demdex.net https://www.youtube.com https://embed.restream.io https://app.mailjet.com http://xy0p2.mjt.lu https://mj.quarkus.io https://giscus.app; 
  base-uri 'none'; 
  object-src 'none'; 
  form-action 'none'; 
  font-src 'self' https://use.fontawesome.com https://fonts.gstatic.com;" />
  <script id="adobe_dtm" src="https://www.redhat.com/dtm.js" type="text/javascript"></script>
  <script src="/assets/javascript/highlight.pack.js" type="text/javascript"></script>
  <META HTTP-EQUIV='X-XSS-Protection' CONTENT="1; mode=block">
  <META HTTP-EQUIV='X-Content-Type-Options' CONTENT="nosniff">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Quarkus: Supersonic Subatomic Java">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@QuarkusIO"> 
  <meta name="twitter:creator" content="@QuarkusIO">
  <meta property="og:url" content="https://quarkus.io/version/3.15/guides/rest-virtual-threads" />
  <meta property="og:title" content="Use virtual threads in REST applications - 3.15" />
  <meta property="og:description" content="Quarkus: Supersonic Subatomic Java" />
  <meta property="og:image" content="https://quarkus.io/assets/images/quarkus_card.png" />
  
  <link rel="canonical" href="https://quarkus.io/guides/rest-virtual-threads">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/guides/stylesheet/config.css" />
  <link rel="stylesheet" href="/assets/css/main.css?2021-07-29" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.5.2/css/all.css" crossorigin="anonymous">
  <link rel="alternate" type="application/rss+xml"  href="/feed.xml" title="Quarkus">
  <script src="/assets/javascript/hl.js" type="text/javascript"></script>
  
  
  
  
  <link rel="alternate" hreflang="en" href="https://quarkus.io/version/3.15/guides/rest-virtual-threads" />
  
  <link rel="alternate" hreflang="pt-br" href="https://pt.quarkus.io/version/3.15/guides/rest-virtual-threads" />
  
  <link rel="alternate" hreflang="es" href="https://es.quarkus.io/version/3.15/guides/rest-virtual-threads" />
  
  <link rel="alternate" hreflang="zh" href="https://cn.quarkus.io/version/3.15/guides/rest-virtual-threads" />
  
  <link rel="alternate" hreflang="ja" href="https://ja.quarkus.io/version/3.15/guides/rest-virtual-threads" />
  
  <link rel="alternate" hreflang="x-default" href="https://quarkus.io/" />  
  <script src="/assets/javascript/tracking.js"></script>
  
  <script src="/assets/javascript/colormode.js" type="text/javascript"></script>

</head>

<body class="guides">

  
  <div class="nav-wrapper">
  <div class="grid-wrapper">
    <div class="width-12-12">
      <input type="checkbox" id="checkbox" />
      <nav id="main-nav" class="main-nav">
        <div class="logo-wrapper">
           <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_600px_reverse.png" class="project-logo" title="Quarkus"></a>
        </div>
    <label class="nav-toggle" for="checkbox">
      <i class="fa fa-bars"></i>
    </label>
    <ul id="menu" class="menu">
      <li class="dropdown">
        <span href="/about/">Why<i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/about" class="">WHAT IS QUARKUS?</a></li>
          <li><a href="/container-first" class="">CONTAINER FIRST</a></li>
          <li><a href="/continuum" class="">VERSATILITY</a></li>
          <li><a href="/developer-joy" class="">DEVELOPER JOY</a></li>
          <li><a href="/kubernetes-native" class="">KUBERNETES NATIVE</a></li>
          <li><a href="/standards" class="">STANDARDS</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="/learn/">Learn<i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/get-started" class="">GET STARTED</a></li>
          <li><a href="/guides" class="active">DOCUMENTATION</a></li>
          <li><a href="/qtips" class="">"Q" TIP VIDEOS</a></li>          
          <li><a href="/books" class="">BOOKS</a></li>
          </ul>
      </li>
      <li class="dropdown">
        <span href="https://quarkus.io/extensions/">Extensions<i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <!-- Note that quarkus.io is hardcoded here, because it is the only url which supports extensions -->
          <li><a href="https://quarkus.io/extensions/" class="">BROWSE EXTENSIONS</a></li>
          <li><a href="/faq/#what-is-a-quarkus-extension" class="">USE EXTENSIONS</a></li>
          <li><a href="/guides/writing-extensions" class="">CREATE EXTENSIONS</a></li>
          <li><a href="https://hub.quarkiverse.io" class="">SHARE EXTENSIONS</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="/community/">Community<i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/support/" class="">SUPPORT</a></li>
          <li><a href="/blog" class="">BLOG</a></li>
          <li><a href="/discussion" class="">DISCUSSION</a></li>
          <li><a href="/working-groups" class="">WORKING GROUPS</a></li>
          <li><a href="/insights" class="">PODCAST</a></li>
          <li><a href="/events" class="">EVENTS</a></li>
          <li><a href="/newsletter" class="">NEWSLETTER</a></li>
          <li><a href="https://github.com/orgs/quarkusio/projects/13/views/1" class="">ROADMAP</a></li>
          </ul>
      </li>
      <li>
        <a href="https://code.quarkus.io" class="button-cta secondary white">START CODING</a>
      </li>
      <li class="dropdown">
        <span href="/language/"><div class="fas fa-globe langicon"></div><i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="https://quarkus.io/version/3.15/guides/rest-virtual-threads" >OFFICIAL (ENGLISH)</a></li>
          <li><a href="https://pt.quarkus.io/version/3.15/guides/rest-virtual-threads">PORTUGUÊS (BR)</a></li>
          <li><a href="https://es.quarkus.io/version/3.15/guides/rest-virtual-threads">ESPAÑOL</a></li>
          <li><a href="https://cn.quarkus.io/version/3.15/guides/rest-virtual-threads">简体中文</a></li>
          <li><a href="https://ja.quarkus.io/version/3.15/guides/rest-virtual-threads">日本語</a></li>
          </ul>
      </li>
      <li>
        <span href="#" class="modeswitcher" id='theme-toggle'><i class="fas fa-sun"></i><i class="fas fa-moon"></i><i class="fas fa-cog"></i></span>
      </li>
    </ul>
      </nav>
    </div>
  </div>
</div>

  <div class="content">
    







<section class="full-width-version-bg flexfilterbar guides">
  <div class="guideflexcontainer">
    <div class="docslink">
      <a class="returnlink" href="/version/3.15/guides/"> Back to Guides</a>
    </div>
    <div class="flexlabel">
      <label>By Version</label>
    </div>
    <div class="guidepulldown version">
    <select id="guide-version-dropdown">
      
        
        
        <option value="main" >Main - SNAPSHOT</option>
        
        
        
        <option value="latest" >3.16.2 - Latest</option>
        
        
        
        <option value="3.15" selected>3.15</option>
        
        
        
        
        
        
        
        
        
        
        
        
        </select>
    </div>
  </div>
</section>

<div class="guide">
  <div class="grid-wrapper">
    <div class="grid__item width-8-12 width-12-12-m">
      
      <h1 class="text-caps">Use virtual threads in REST applications </h1>
      <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In this guide, we see how you can use virtual threads in a REST application.
Because virtual threads are all about I/O, we will also use the REST client.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="prerequisites"><a class="anchor" href="#prerequisites"></a>Prerequisites</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To complete this guide, you need:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Roughly 15 minutes</p>
</li>
<li>
<p>An IDE</p>
</li>
<li>
<p>JDK 17+ installed with <code>JAVA_HOME</code> configured appropriately</p>
</li>
<li>
<p>Apache Maven 3.9.8</p>
</li>
<li>
<p>Optionally the <a href="cli-tooling">Quarkus CLI</a> if you want to use it</p>
</li>
<li>
<p>Optionally Mandrel or GraalVM installed and <a href="building-native-image#configuring-graalvm">configured appropriately</a> if you want to build a native executable (or Docker if you use a native container build)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="architecture"><a class="anchor" href="#architecture"></a>Architecture</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The application built into this guide is quite simple.
It calls a weather service for two cities (Valence, France, and Athens, Greece) and decides the best place based on the current temperature.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="create-the-maven-project"><a class="anchor" href="#create-the-maven-project"></a>Create the Maven project</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First, we need a new project. Create a new project with the following command:</p>
</div>
<div class="sidebarblock primary asciidoc-tabs-sync-cli">
<div class="content">
<div class="title">CLI</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">quarkus create app org.acme:rest-virtual-threads \
    --extension='rest-jackson,quarkus-rest-client-jackson' \
    --no-code
cd rest-virtual-threads</code></pre>
</div>
</div>
<div class="paragraph">
<p>To create a Gradle project, add the <code>--gradle</code> or <code>--gradle-kotlin-dsl</code> option.</p>
</div>
<div class="paragraph">
<p>For more information about how to install and use the Quarkus CLI, see the <a href="cli-tooling">Quarkus CLI</a> guide.</p>
</div>
</div>
</div>
<div class="sidebarblock secondary asciidoc-tabs-sync-maven">
<div class="content">
<div class="title">Maven</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mvn io.quarkus.platform:quarkus-maven-plugin:3.15.1:create \
    -DprojectGroupId=org.acme \
    -DprojectArtifactId=rest-virtual-threads \
    -Dextensions='rest-jackson,quarkus-rest-client-jackson' \
    -DnoCode
cd rest-virtual-threads</code></pre>
</div>
</div>
<div class="paragraph">
<p>To create a Gradle project, add the <code>-DbuildTool=gradle</code> or <code>-DbuildTool=gradle-kotlin-dsl</code> option.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>For Windows users:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If using cmd, (don&#8217;t use backward slash <code>\</code> and put everything on the same line)</p>
</li>
<li>
<p>If using Powershell, wrap <code>-D</code> parameters in double quotes e.g. <code>"-DprojectArtifactId=rest-virtual-threads"</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This command generates a new project importing the Quarkus REST (formerly RESTEasy Reactive), REST client, and <a href="https://github.com/FasterXML/jackson">Jackson</a> extensions,
and in particular, adds the following dependencies:</p>
</div>
<div class="listingblock primary asciidoc-tabs-target-sync-cli asciidoc-tabs-target-sync-maven">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
  &lt;artifactId&gt;quarkus-rest-jackson&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
  &lt;artifactId&gt;quarkus-rest-client-jackson&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-target-sync-gradle">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gradle hljs" data-lang="gradle">implementation("io.quarkus:quarkus-rest-jackson")
implementation("quarkus-rest-client-jackson")</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You might wonder why we use <em>reactive</em> extensions.
Virtual threads have limitations, and we can only integrate them properly when using the reactive extensions.
No worries: your code will be written 100% in a synchronous / imperative style.</p>
</div>
<div class="paragraph">
<p>Check the <a href="./virtual-threads#why-not">virtual thread reference guide</a> for details.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="prepare-the-pom-xml-file"><a class="anchor" href="#prepare-the-pom-xml-file"></a>Prepare the <code>pom.xml</code> file</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We need to customize the <code>pom.xml</code> file to use virtual threads.</p>
</div>
<div class="paragraph">
<p>1) Locate the line with <code>&lt;maven.compiler.release&gt;17&lt;/maven.compiler.release&gt;</code>, and replace it with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">    &lt;maven.compiler.release&gt;21&lt;/maven.compiler.release&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>2) In the maven-surefire-plugin and maven-failsafe-plugin configurations, add the following <code>argLine</code> parameter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;plugin&gt;
  &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;
  &lt;version&gt;${surefire-plugin.version}&lt;/version&gt;
  &lt;configuration&gt;
    &lt;systemPropertyVariables&gt;
      &lt;java.util.logging.manager&gt;org.jboss.logmanager.LogManager&lt;/java.util.logging.manager&gt;
      &lt;maven.home&gt;${maven.home}&lt;/maven.home&gt;
    &lt;/systemPropertyVariables&gt;
    &lt;argLine&gt;-Djdk.tracePinnedThreads&lt;/argLine&gt; &lt;!-- Added line --&gt;
  &lt;/configuration&gt;
&lt;/plugin&gt;
&lt;plugin&gt;
  &lt;artifactId&gt;maven-failsafe-plugin&lt;/artifactId&gt;
  &lt;version&gt;${surefire-plugin.version}&lt;/version&gt;
  &lt;executions&gt;
    &lt;execution&gt;
      &lt;goals&gt;
        &lt;goal&gt;integration-test&lt;/goal&gt;
        &lt;goal&gt;verify&lt;/goal&gt;
      &lt;/goals&gt;
      &lt;configuration&gt;
        &lt;systemPropertyVariables&gt;
          &lt;native.image.path&gt;${project.build.directory}/${project.build.finalName}-runner&lt;/native.image.path&gt;
          &lt;java.util.logging.manager&gt;org.jboss.logmanager.LogManager&lt;/java.util.logging.manager&gt;
          &lt;maven.home&gt;${maven.home}&lt;/maven.home&gt;
        &lt;/systemPropertyVariables&gt;
        &lt;argLine&gt;-Djdk.tracePinnedThreads&lt;/argLine&gt; &lt;!-- Added line --&gt;
      &lt;/configuration&gt;
    &lt;/execution&gt;
  &lt;/executions&gt;
&lt;/plugin&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>-Djdk.tracePinnedThreads</code> will detect pinned carrier threads while running tests (See <a href="./virtual-threads#pinning">the virtual thread reference guide for details</a>).</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">--enable-preview on Java 19 and 20</div>
<div class="paragraph">
<p>If you are using a Java 19 or 20, add the <code>--enable-preview</code> flag in the <code>argLine</code> and as <code>parameters</code> of the maven compiler plugin.
Note that we strongly recommend Java 21.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="create-the-weather-client"><a class="anchor" href="#create-the-weather-client"></a>Create the weather client</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section is not about virtual threads.
Because we need to do some I/O to demonstrate virtual threads usage, we need a client doing I/O operations.
In addition, the REST client is virtual thread friendly: it does not pin and handle propagation correctly.</p>
</div>
<div class="paragraph">
<p>Create the <code>src/main/java/org/acme/WeatherService.java</code> class with the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme;

import com.fasterxml.jackson.annotation.JsonProperty;
import io.quarkus.rest.client.reactive.ClientQueryParam;
import jakarta.ws.rs.GET;
import org.eclipse.microprofile.rest.client.inject.RegisterRestClient;
import org.jboss.resteasy.reactive.RestQuery;

@RegisterRestClient(baseUri = "https://api.open-meteo.com/v1/forecast")
public interface WeatherService {

    @GET
    @ClientQueryParam(name = "current_weather", value = "true")
    WeatherResponse getWeather(@RestQuery double latitude, @RestQuery double longitude);


    record WeatherResponse(@JsonProperty("current_weather") Weather weather) {
        // represents the response
    }

    record Weather(double temperature, double windspeed) {
        // represents the inner object
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This class models the HTTP interaction with the weather service.
Read more about the rest client in the dedicated <a href="./rest-client">guide</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="create-the-http-endpoint"><a class="anchor" href="#create-the-http-endpoint"></a>Create the HTTP endpoint</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now, create the <code>src/main/java/org/acme/TheBestPlaceToBeResource.java</code> class with the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme;

import io.smallrye.common.annotation.RunOnVirtualThread;
import jakarta.ws.rs.GET;
import jakarta.ws.rs.Path;
import org.eclipse.microprofile.rest.client.inject.RestClient;

@Path("/")
public class TheBestPlaceToBeResource {

    static final double VALENCE_LATITUDE = 44.9;
    static final double VALENCE_LONGITUDE = 4.9;

    static final double ATHENS_LATITUDE = 37.9;
    static final double ATHENS_LONGITUDE = 23.7;

    @RestClient WeatherService service;

    @GET
    @RunOnVirtualThread <i class="conum" data-value="1"></i><b>(1)</b>
    public String getTheBestPlaceToBe() {
        var valence = service.getWeather(VALENCE_LATITUDE, VALENCE_LONGITUDE).weather().temperature();
        var athens = service.getWeather(ATHENS_LATITUDE, ATHENS_LONGITUDE).weather().temperature();

        // Advanced decision tree
        if (valence &gt; athens &amp;&amp; valence &lt;= 35) {
            return "Valence! (" + Thread.currentThread() + ")";
        } else if (athens &gt; 35) {
            return "Valence! (" + Thread.currentThread() + ")";
        } else {
            return "Athens (" + Thread.currentThread() + ")";
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Instructs Quarkus to invoke this method on a virtual thread</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="run-the-application-in-dev-mode"><a class="anchor" href="#run-the-application-in-dev-mode"></a>Run the application in dev mode</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Make sure that you use OpenJDK and JVM versions supporting virtual thread and launch the <em>dev mode</em> with <code>./mvnw quarkus:dev</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">&gt; java --version
openjdk 21 2023-09-19 LTS <i class="conum" data-value="1"></i><b>(1)</b>
OpenJDK Runtime Environment Temurin-21+35 (build 21+35-LTS)
OpenJDK 64-Bit Server VM Temurin-21+35 (build 21+35-LTS, mixed mode)

&gt; ./mvnw quarkus:dev <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Must be 19+, we recommend 21+</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Launch the dev mode</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then, in a browser, open <a href="http://localhost:8080" class="bare">http://localhost:8080</a>.
You should get something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">Valence! (VirtualThread[#144]/runnable@ForkJoinPool-1-worker-6)</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, the endpoint runs on a virtual thread.</p>
</div>
<div class="paragraph">
<p>It&#8217;s essential to understand what happened behind the scene:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Quarkus creates the virtual thread to invoke your endpoint (because of the <code>@RunOnVirtualThread</code> annotation).</p>
</li>
<li>
<p>When the code invokes the rest client, the virtual thread is blocked, BUT the carrier thread is not blocked (that&#8217;s the virtual thread <em>magic touch</em>).</p>
</li>
<li>
<p>Once the first invocation of the rest client completes, the virtual thread is rescheduled and continues its execution.</p>
</li>
<li>
<p>The second rest client invocation happens, and the virtual thread is blocked again (but not the carrier thread).</p>
</li>
<li>
<p>Finally, when the second invocation of the rest client completes, the virtual thread is rescheduled and continues its execution.</p>
</li>
<li>
<p>The method returns the result. The virtual thread terminates.</p>
</li>
<li>
<p>The result is captured by Quarkus and written in the HTTP response</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="verify-pinning-using-tests"><a class="anchor" href="#verify-pinning-using-tests"></a>Verify pinning using tests</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the <code>pom.xml,</code> we added an <code>argLine</code> argument to the surefire and failsafe plugins:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;argLine&gt;-Djdk.tracePinnedThreads&lt;/argLine&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>-Djdk.tracePinnedThreads</code> dumps the stack trace if a virtual thread cannot be <em>unmounted</em> smoothly (meaning that it blocks the carrier thread).
That&#8217;s what we call <em>pinning</em> (more info in <a href="./virtual-threads#pinning">the virtual thread reference guide</a>).</p>
</div>
<div class="paragraph">
<p>We recommend enabling this flag in tests.
Thus, you can check that your application behaves correctly when using virtual threads.
Just check your log after having run the test.
If you see a stack trace&#8230;&#8203; better check what&#8217;s wrong.
If your code (or one of your dependencies) pins, it might be better to use regular worker thread instead.</p>
</div>
<div class="paragraph">
<p>Create the <code>src/test/java/org/acme/TheBestPlaceToBeResourceTest.java</code> class with the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme;

import io.quarkus.test.junit.QuarkusTest;
import io.restassured.RestAssured;
import org.junit.jupiter.api.Test;

@QuarkusTest
class TheBestPlaceToBeResourceTest {

    @Test
    void verify() {
        RestAssured.get("/")
                .then()
                .statusCode(200);
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is a straightforward test, but at least it will detect if our application is pinning.
Run the test with either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>r</code> in dev mode (using continuous testing)</p>
</li>
<li>
<p><code>./mvnw test</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As you will see, it does not pin - no stack trace.
It is because the REST client is implemented in a virtual-thread-friendly way.</p>
</div>
<div class="paragraph">
<p>The same approach can be used with integration tests.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conclusion"><a class="anchor" href="#conclusion"></a>Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This guide shows how you can use virtual threads with Quarkus REST and the REST client.
Learn more about virtual threads support on:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="./messaging-virtual-threads">@RunOnVirtualThread in messaging applications</a> (this guide covers Apache Kafka)</p>
</li>
<li>
<p><a href="./grpc-virtual-threads">@RunOnVirtualThread in gRPC services</a></p>
</li>
<li>
<p><a href="./virtual-threads">the virtual thread reference guide</a> (include native compilation and containerization)</p>
</li>
</ul>
</div>
</div>
</div>
    </div>
    <div class="grid__item width-4-12 width-12-12-m tocwrapper">
      <div class="hide-mobile toc"><ul class="sectlevel1">
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#architecture">Architecture</a></li>
<li><a href="#create-the-maven-project">Create the Maven project</a></li>
<li><a href="#prepare-the-pom-xml-file">Prepare the <code>pom.xml</code> file</a></li>
<li><a href="#create-the-weather-client">Create the weather client</a></li>
<li><a href="#create-the-http-endpoint">Create the HTTP endpoint</a></li>
<li><a href="#run-the-application-in-dev-mode">Run the application in dev mode</a></li>
<li><a href="#verify-pinning-using-tests">Verify pinning using tests</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul></div>
    </div>
  </div>
  <h2>Related content</h2>
  <div class="grid-wrapper relations">
    <div class="grid__item width-6-12 width-12-12-m">
      <h3>On the same extensions</h3>
      <ul class="related-content">
      
        
        <li class="guide"><a href="/version/3.15/guides/rest-migration">Migrating to Quarkus REST (formerly RESTEasy Reactive)</a></li>
      
        
        <li class="guide"><a href="/version/3.15/guides/rest">Writing REST Services with Quarkus REST (formerly RESTEasy Reactive)</a></li>
      
        
        <li class="guide"><a href="/version/3.15/guides/rest-client">Using the REST Client</a></li>
      
        
        <li class="guide"><a href="/version/3.15/guides/rest-json">Writing JSON REST Services</a></li>
      
        
        <li class="reference"><a href="/version/3.15/guides/security-authorize-web-endpoints-reference">Authorization of web endpoints</a></li>
      </ul>
    </div>
    <div class="grid__item width-6-12 width-12-12-m">
      <h3>On the same topics</h3>
      <ul class="related-content">
      
        
        <li class="guide"><a href="/version/3.15/guides/rest">Writing REST Services with Quarkus REST (formerly RESTEasy Reactive)</a></li>
      
        
        <li class="guide"><a href="/version/3.15/guides/rest-migration">Migrating to Quarkus REST (formerly RESTEasy Reactive)</a></li>
      
        
        <li class="guide"><a href="/version/3.15/guides/rest-client">Using the REST Client</a></li>
      
        
        <li class="guide"><a href="/version/3.15/guides/rest-json">Writing JSON REST Services</a></li>
      
        
        <li class="reference"><a href="/version/3.15/guides/security-authorize-web-endpoints-reference">Authorization of web endpoints</a></li>
      
        
        <li class="guide"><a href="/version/3.15/guides/rest-data-panache">Generating Jakarta REST resources with Panache</a></li>
      
        
        <li class="guide"><a href="/version/3.15/guides/grpc-virtual-threads">Quarkus Virtual Thread support for gRPC services</a></li>
      
        
        <li class="guide"><a href="/version/3.15/guides/messaging-virtual-threads">Quarkus Virtual Thread support with Reactive Messaging</a></li>
      
        
        <li class="guide"><a href="/version/3.15/guides/resteasy">RESTEasy Classic</a></li>
      
        
        <li class="guide"><a href="/version/3.15/guides/openapi-swaggerui">Using OpenAPI and Swagger UI</a></li>
      
        
        <li class="guide"><a href="/version/3.15/guides/resteasy-client">Using the legacy REST Client</a></li>
      
        
        <li class="guide"><a href="/version/3.15/guides/resteasy-client-multipart">Using the legacy REST Client with Multipart</a></li>
      
        
        <li class="reference"><a href="/version/3.15/guides/virtual-threads">Virtual Thread support reference</a></li>
      </ul>
    </div>
    </div>
  </div>

  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_reverse.svg" class="project-logo" title="Quarkus"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">Quarkus is open. All dependencies of this project are available under the <a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>Apache Software License 2.0</a> or compatible license.<br /><br />This website was built with <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a>, is hosted on <a href='https://pages.github.com/' target='_blank'>GitHub Pages</a> and is completely open source. If you want to make it better, <a href='https://github.com/quarkusio/quarkusio.github.io' target='_blank'>fork the website</a> and show us what you’ve got.</p>

    
      <div class="width-1-12 project-links">
        <span>Navigation</span>
        <ul class="footer-links">
          
          
            <li><a href="/" target="_blank">Home</a></li>
          
          
          
            <li><a href="/about" target="_blank">About</a></li>
          
          
          
            <li><a href="/blog" target="_blank">Blog</a></li>
          
          
          
            <li><a href="/insights" target="_blank">Podcast</a></li>
          
          
          
            <li><a href="/events" target="_blank">Events</a></li>
          
          
          
            <li><a href="/newsletter" target="_blank">Newsletter</a></li>
          
          
          
            <li><a href="https://github.com/orgs/quarkusio/projects/13/views/1" target="_blank">Roadmap</a></li>
          
          
          
            <li><a href="/security" target="_blank">Security&nbsp;policy</a></li>
          
          
          
            <li><a href="/usage" target="_blank">Usage</a></li>
          
          
          
            <li><a href="/brand" target="_blank">Brand</a></li>
          
          
          
            <li><a href="/desktopwallpapers" target="_blank">Wallpapers</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Follow Us</span>
        <ul class="footer-links">
          
          
            <li><a href="https://x.com/quarkusio" target="_blank">X</a></li>
          
          
          
            <li><a rel="me" href="https://fosstodon.org/@quarkusio" target="_blank">Mastodon</a></li>
            
          
          
            <li><a href="https://www.facebook.com/quarkusio" target="_blank">Facebook</a></li>
          
          
          
            <li><a href="https://www.linkedin.com/company/quarkusio/" target="_blank">Linkedin</a></li>
          
          
          
            <li><a href="https://www.youtube.com/channel/UCaW8QG_QoIk_FnjLgr5eOqg" target="_blank">Youtube</a></li>
          
          
          
            <li><a href="https://github.com/quarkusio" target="_blank">GitHub</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-2-12 project-links">
        <span>Get Help</span>
        <ul class="footer-links">
          
          
            <li><a href="/support" target="_blank">Support</a></li>
          
          
          
            <li><a href="/guides" target="_blank">Guides</a></li>
          
          
          
            <li><a href="/faq" target="_blank">FAQ</a></li>
          
          
          
            <li><a href="/get-started" target="_blank">Get Started</a></li>
          
          
          
            <li><a href="https://stackoverflow.com/questions/tagged/quarkus" target="_blank">Stack Overflow</a></li>
          
          
          
            <li><a href="https://github.com/quarkusio/quarkus/discussions" target="_blank">Discussions</a></li>
          
          
          
            <li><a href="https://groups.google.com/forum/#!forum/quarkus-dev" target="_blank">Development mailing list</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Languages</span>
        <ul class="footer-links">
          
          
            <li><a href="https://quarkus.io/" target="_blank">English</a></li>
          
          
          
            <li><a href="https://pt.quarkus.io/" target="_blank">Português&nbsp;(Brasileiro)</a></li>
          
          
          
            <li><a href="https://es.quarkus.io/" target="_blank">Español</a></li>
          
          
          
            <li><a href="https://cn.quarkus.io/" target="_blank">简体中文</a></li>
          
          
          
            <li><a href="https://ja.quarkus.io/" target="_blank">日本語</a></li>
          
          
        </ul>
      </div>
    

    
      <div class="width-4-12 more-links">
        <span>Quarkus is made of community projects</span>
        <ul class="footer-links">
          
            <li><a blah href="https://vertx.io/" target="_blank">Eclipse Vert.x</a></li>
          
            <li><a blah href="https://smallrye.io" target="_blank">SmallRye</a></li>
          
            <li><a blah href="https://hibernate.org" target="_blank">Hibernate</a></li>
          
            <li><a blah href="https://netty.io" target="_blank">Netty</a></li>
          
            <li><a blah href="https://resteasy.github.io" target="_blank">RESTEasy</a></li>
          
            <li><a blah href="https://camel.apache.org" target="_blank">Apache Camel</a></li>
          
            <li><a blah href="https://microprofile.io" target="_blank">Eclipse MicroProfile</a></li>
          
            <li><a blah href="https://code.quarkus.io/" target="_blank">And many more...</a></li>
          
        </ul>
      </div>
    
  </div>
</div>

  <div class="content redhat-footer">
  <div class="grid-wrapper">
    <span class="licence">
      <i class="fab fa-creative-commons"></i><i class="fab fa-creative-commons-by"></i> <a href="https://creativecommons.org/licenses/by/3.0/" target="_blank">CC by 3.0</a> | <a href="https://www.redhat.com/en/about/privacy-policy">Privacy Policy</a>
    </span>
    <span class="redhat">
      Sponsored by
    </span>
    <span class="redhat-logo">
      <a href="https://www.redhat.com/" target="_blank"><img src="/assets/images/redhat_reversed.svg"></a>
    </span>
  </div>
</div>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/scroll-down.js"></script>
  <script src="/assets/javascript/satellite.js" type="text/javascript"></script>
  <script src="/guides/javascript/config.js" type="text/javascript"></script>
  <script src="/assets/javascript/guides-version-dropdown.js" type="text/javascript"></script>
  <script src="/assets/javascript/back-to-top.js" type="text/javascript"></script>
  <script src="/assets/javascript/clipboard.min.js" type="text/javascript"></script>
  <script src="/assets/javascript/copy.js" type="text/javascript"></script>
  <script src="/assets/javascript/asciidoc-tabs.js" type="text/javascript"></script>
  <script src="/assets/javascript/future-date.js" type="text/javascript"></script>
</body>

</html>
