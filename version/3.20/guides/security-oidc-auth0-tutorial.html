<!DOCTYPE html>
<html lang="en">







<head>
  <title>Protect Quarkus web application by using an Auth0 OpenID Connect provider - 3.20 - Quarkus</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="
  connect-src 'self' https://dpm.demdex.net https://adobedc.demdex.net https://analytics.ossupstream.org/ https://search.quarkus.io https://smetrics.redhat.com; 
  script-src 'self' 'unsafe-inline' 'unsafe-eval'
      
      https://assets.adobedtm.com
      js.bizographics.com
      https://www.redhat.com
      https://static.redhat.com
      https://app.requestly.io/
      jsonip.com
      https://ajax.googleapis.com
      https://use.fontawesome.com
      http://www.youtube.com
      http://www.googleadservices.com
      https://googleads.g.doubleclick.net
      https://giscus.app
      https://analytics.ossupstream.org/
      https://app.mailjet.com;

  style-src 'self' https://fonts.googleapis.com https://use.fontawesome.com; 
  img-src 'self' * data:; 
  media-src 'self'; 
  frame-src https://redhat.demdex.net https://www.youtube.com https://player.restream.io https://app.mailjet.com http://xy0p2.mjt.lu https://mj.quarkus.io https://giscus.app; 
  base-uri 'none'; 
  object-src 'none'; 
  form-action 'none'; 
  font-src 'self' https://use.fontawesome.com https://fonts.gstatic.com;" />
  <script id="adobe_dtm" src="https://www.redhat.com/dtm.js" type="text/javascript"></script>
  <script src="/assets/javascript/highlight.pack.js" type="text/javascript"></script>
  <META HTTP-EQUIV='X-XSS-Protection' CONTENT="1; mode=block">
  <META HTTP-EQUIV='X-Content-Type-Options' CONTENT="nosniff">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Quarkus: Supersonic Subatomic Java">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@QuarkusIO"> 
  <meta name="twitter:creator" content="@QuarkusIO">
  <meta property="og:url" content="https://quarkus.io/version/3.20/guides/security-oidc-auth0-tutorial" />
  <meta property="og:title" content="Protect Quarkus web application by using an Auth0 OpenID Connect provider - 3.20" />
  <meta property="og:description" content="Quarkus: Supersonic Subatomic Java" />
  <meta property="og:image" content="https://quarkus.io/assets/images/quarkus_card.png" />
  
  <link rel="canonical" href="https://quarkus.io/guides/security-oidc-auth0-tutorial">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/guides/stylesheet/config.css" />
  <link rel="stylesheet" href="/assets/css/main.css?2021-07-29" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.5.2/css/all.css" crossorigin="anonymous">
  <link rel="alternate" type="application/rss+xml"  href="/feed.xml" title="Quarkus">
  <script src="/assets/javascript/hl.js" type="text/javascript"></script>
  
  
  
  
  <link rel="alternate" hreflang="en" href="https://quarkus.io/version/3.20/guides/security-oidc-auth0-tutorial" />
  
  <link rel="alternate" hreflang="pt-br" href="https://pt.quarkus.io/version/3.20/guides/security-oidc-auth0-tutorial" />
  
  <link rel="alternate" hreflang="es" href="https://es.quarkus.io/version/3.20/guides/security-oidc-auth0-tutorial" />
  
  <link rel="alternate" hreflang="zh" href="https://cn.quarkus.io/version/3.20/guides/security-oidc-auth0-tutorial" />
  
  <link rel="alternate" hreflang="ja" href="https://ja.quarkus.io/version/3.20/guides/security-oidc-auth0-tutorial" />
  
  <link rel="alternate" hreflang="x-default" href="https://quarkus.io/" />  
  <script src="/assets/javascript/tracking.js"></script>
  
  <script src="/assets/javascript/colormode.js" type="text/javascript"></script>

</head>

<body class="guides">

  
  <div class="nav-wrapper">
  <div class="grid-wrapper">
    <div class="width-12-12">
      <input type="checkbox" id="checkbox" />
      <nav id="main-nav" class="main-nav">
        <div class="logo-wrapper">
           <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_600px_reverse.png" class="project-logo" title="Quarkus"></a>
        </div>
    <label class="nav-toggle" for="checkbox">
      <i class="fa fa-bars"></i>
    </label>
    <ul id="menu" class="menu">
      <li class="dropdown">
        <span href="/about/">Why<i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/about" class="">WHAT IS QUARKUS?</a></li>
          <li><a href="/developer-joy" class="">DEVELOPER JOY</a></li>
          <li><a href="/performance" class="">PERFORMANCE</a></li>
          <li><a href="/kubernetes-native" class="">KUBERNETES NATIVE</a></li>
          <li><a href="/standards" class="">STANDARDS</a></li>
          <li><a href="/versatility" class="">VERSATILITY</a></li>
          <li><a href="/container-first" class="">CONTAINER FIRST</a></li>          
        </ul>
      </li>
      <li class="dropdown">
        <span href="/learn/">Learn<i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/get-started" class="">GET STARTED</a></li>
          <li><a href="/guides" class="active">DOCUMENTATION</a></li>
          <li><a href="/userstories/" class="">USER STORIES</a></li>  
          <li><a href="/qtips" class="">"Q" TIP VIDEOS</a></li>          
          <li><a href="/books" class="">BOOKS</a></li>
          </ul>
      </li>
      <li class="dropdown">
        <span href="https://quarkus.io/extensions/">Extensions<i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <!-- Note that quarkus.io is hardcoded here, because it is the only url which supports extensions -->
          <li><a href="https://quarkus.io/extensions/" class="">BROWSE EXTENSIONS</a></li>
          <li><a href="/faq/#what-is-a-quarkus-extension" class="">USE EXTENSIONS</a></li>
          <li><a href="/guides/writing-extensions" class="">CREATE EXTENSIONS</a></li>
          <li><a href="https://hub.quarkiverse.io" class="">SHARE EXTENSIONS</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="/community/">Community<i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/support/" class="">SUPPORT</a></li>
          <li><a href="/blog" class="">BLOG</a></li>
          <li><a href="/discussion" class="">DISCUSSION</a></li>
          <li><a href="/working-groups" class="">WORKING GROUPS</a></li>
          <li><a href="/insights" class="">PODCAST</a></li>
          <li><a href="/events" class="">EVENTS</a></li>
          <li><a href="/newsletter" class="">NEWSLETTER</a></li>
          <li><a href="https://github.com/orgs/quarkusio/projects/13/views/1" class="">ROADMAP</a></li>
          </ul>
      </li>
      <li>
        <a href="https://code.quarkus.io" class="button-cta secondary white">START CODING</a>
      </li>
      <li class="dropdown">
        <span href="/language/"><div class="fas fa-globe langicon"></div><i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="https://quarkus.io/version/3.20/guides/security-oidc-auth0-tutorial" >OFFICIAL (ENGLISH)</a></li>
          <li><a href="https://pt.quarkus.io/version/3.20/guides/security-oidc-auth0-tutorial">PORTUGUÊS (BR)</a></li>
          <li><a href="https://es.quarkus.io/version/3.20/guides/security-oidc-auth0-tutorial">ESPAÑOL</a></li>
          <li><a href="https://cn.quarkus.io/version/3.20/guides/security-oidc-auth0-tutorial">简体中文</a></li>
          <li><a href="https://ja.quarkus.io/version/3.20/guides/security-oidc-auth0-tutorial">日本語</a></li>
          </ul>
      </li>
      <li>
        <span href="#" class="modeswitcher" id='theme-toggle'><i class="fas fa-sun"></i><i class="fas fa-moon"></i><i class="fas fa-cog"></i></span>
      </li>
    </ul>
      </nav>
    </div>
  </div>
</div>

  <div class="content">
    







<section class="full-width-version-bg flexfilterbar guides">
  <div class="guideflexcontainer">
    <div class="docslink">
      <a class="returnlink" href="/version/3.20/guides/"> Back to Guides</a>
    </div>
    <div class="flexlabel">
      <label>By Version</label>
    </div>
    <div class="guidepulldown version">
    <select id="guide-version-dropdown">
      
        
        
        <option value="main" >Main - SNAPSHOT</option>
        
        
        
        <option value="latest" >3.23.4 - Latest</option>
        
        
        
        <option value="3.20" selected>3.20</option>
        
        
        
        <option value="3.15" >3.15</option>
        
        
        
        <option value="3.8" >3.8</option>
        
        
        
        
        
        
        
        
        
        </select>
    </div>
  </div>
</section>

<div class="guide">
  <div class="grid-wrapper">
    <div class="grid__item width-8-12 width-12-12-m">
      
      <h1 class="text-caps">Protect Quarkus web application by using an Auth0 OpenID Connect provider </h1>
      <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><a href="security-architecture">Quarkus Security</a> provides comprehensive OpenId Connect (OIDC) and OAuth2 support with its <code>quarkus-oidc</code> extension, supporting both <a href="security-oidc-code-flow-authentication">Authorization code flow</a> and <a href="security-oidc-bearer-token-authentication">Bearer token</a> authentication mechanisms.</p>
</div>
<div class="paragraph">
<p>With Quarkus, you can easily configure OIDC providers such as <a href="https://www.keycloak.org/documentation">Keycloak</a>, <a href="https://developer.okta.com/">Okta</a>, <a href="https://auth0.com/docs/">Auth0</a>, and other <a href="security-openid-connect-providers">well-known social OIDC and OAuth2 providers</a>.</p>
</div>
<div class="paragraph">
<p>Learn how to use the Quarkus OpenID Connect extension (<code>quarkus-oidc</code>) together with the <a href="https://auth0.com/docs/">Auth0</a> OIDC provider to protect your API endpoints.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="prerequisites"><a class="anchor" href="#prerequisites"></a>Prerequisites</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Review the following documentation before you begin:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://auth0.com/docs/">Auth0 docs site</a></p>
</li>
<li>
<p><a href="security-oidc-code-flow-authentication">Quarkus OpenID Connect Authorization code flow mechanism for protecting web applications</a></p>
</li>
<li>
<p><a href="security-oidc-bearer-token-authentication">Quarkus OpenID Connect (OIDC) Bearer token authentication</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="create-an-auth0-application"><a class="anchor" href="#create-an-auth0-application"></a>Create an Auth0 application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Go to the Auth0 dashboard and create a regular web application.
For example, create an Auth0 application called <code>QuarkusAuth0</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/auth0-create-application.png" alt="Create Auth0 application">
</div>
</div>
<div class="paragraph">
<div class="title">Result</div>
<p>Your Auth0 application gets created with a client ID, secret, and HTTPS-based domain.
Make a note of these properties because you will need them to complete the Quarkus configuration in the next step.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/auth0-created-application.png" alt="Created Auth0 application">
</div>
</div>
<div class="paragraph">
<p>Next, while still in the Auth0 dashboard, add some users to your application.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/auth0-add-user.png" alt="Add Auth0 application users">
</div>
</div>
<div class="paragraph">
<p>Now that you have successfully created and configured your Auth0 application, you are ready to start creating and configuring a Quarkus endpoint.
In the steps that follow, you will continue to configure and update the Auth0 application as well.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="create-a-quarkus-application"><a class="anchor" href="#create-a-quarkus-application"></a>Create a Quarkus application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Use the following Maven command to create a Quarkus REST (formerly RESTEasy Reactive) application that can be secured with the Quarkus OIDC extension.</p>
</div>
<div class="sidebarblock primary asciidoc-tabs-sync-cli">
<div class="content">
<div class="title">CLI</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">quarkus create app org.acme:quarkus-auth0 \
    --extension='rest,oidc' \
    --no-code
cd quarkus-auth0</code></pre>
</div>
</div>
<div class="paragraph">
<p>To create a Gradle project, add the <code>--gradle</code> or <code>--gradle-kotlin-dsl</code> option.</p>
</div>
<div class="paragraph">
<p>For more information about how to install and use the Quarkus CLI, see the <a href="cli-tooling">Quarkus CLI</a> guide.</p>
</div>
</div>
</div>
<div class="sidebarblock secondary asciidoc-tabs-sync-maven">
<div class="content">
<div class="title">Maven</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mvn io.quarkus.platform:quarkus-maven-plugin:3.20.1:create \
    -DprojectGroupId=org.acme \
    -DprojectArtifactId=quarkus-auth0 \
    -Dextensions='rest,oidc' \
    -DnoCode
cd quarkus-auth0</code></pre>
</div>
</div>
<div class="paragraph">
<p>To create a Gradle project, add the <code>-DbuildTool=gradle</code> or <code>-DbuildTool=gradle-kotlin-dsl</code> option.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>For Windows users:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If using cmd, (don&#8217;t use backward slash <code>\</code> and put everything on the same line)</p>
</li>
<li>
<p>If using Powershell, wrap <code>-D</code> parameters in double quotes e.g. <code>"-DprojectArtifactId=quarkus-auth0"</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Create the application workspace and import it into your favorite IDE.
Let&#8217;s add a Jakarta REST endpoint that can only be accessed by authenticated users:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme;

import org.eclipse.microprofile.jwt.JsonWebToken;

import io.quarkus.oidc.IdToken;
import io.quarkus.security.Authenticated;
import jakarta.inject.Inject;
import jakarta.ws.rs.GET;
import jakarta.ws.rs.Path;
import jakarta.ws.rs.Produces;
import jakarta.ws.rs.core.MediaType;

@Path("/hello")
public class GreetingResource {

    @Inject
    @IdToken                                        <i class="conum" data-value="1"></i><b>(1)</b>
    JsonWebToken idToken;

    @GET
    @Authenticated                                  <i class="conum" data-value="2"></i><b>(2)</b>
    @Produces(MediaType.TEXT_PLAIN)
    public String hello() {
        return "Hello, " + idToken.getName();
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The injected <code>JsonWebToken</code> (JWT) bean has an <code>@IdToken</code> qualifier, which means it represents not an access token but OIDC <code>ID token</code>.
<code>IdToken</code> provides information in the form of claims about the current user authenticated during the OIDC authorization code flow and you can use <code>JsonWebToken</code> API to access these claims.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>io.quarkus.security.Authenticated</code> annotation is added to the <code>hello()</code> method, which means that only authenticated users can access it.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The access token acquired during the authorization code flow, alongside the ID token, is not used directly by the endpoint but is used only to access downstream services on behalf of the currently authenticated user.
More to come on the topic of "access tokens", later in this tutorial.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Configure OIDC in the Quarkus <code>application.properties</code> file  by using the properties from the Auth0 application that you created earlier.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-configuration hljs" data-lang="configuration"># Make sure the application domain is prefixed with 'https://'
quarkus.oidc.auth-server-url=https://dev-3ve0cgn7.us.auth0.com
quarkus.oidc.application-type=web-app
quarkus.oidc.client-id=sKQu1dXjHB6r0sra0Y1YCqBZKWXqCkly
quarkus.oidc.credentials.secret=${client-secret}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In completing this step, you have just configured Quarkus to use the domain, client ID, and secret of your Auth0 application.
Setting the property <code>quarkus.oidc.application-type=web-app</code> instructs Quarkus to use the OIDC authorization code flow, but there are also other methods, which are discussed later on in the tutorial.</p>
</div>
<div class="paragraph">
<p>The endpoint address will be  http://localhost:8080/hello, which must also be registered as an allowed callback URL in your Auth0 application.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/auth0-allowed-callback.png" alt="Auth0 allowed callback URL">
</div>
</div>
<div class="paragraph">
<p>After completing this step, when you access the Quarkus http://localhost:8080/hello endpoint from a browser, Auth0 redirects you back to the same address after the authentication is completed.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>By default, Quarkus automatically uses the current request path as the callback path.
But you can override the default behavior and configure a specific callback path by setting the Quarkus <code>quarkus.oidc.authentication.redirect-path</code> property.</p>
</div>
<div class="paragraph">
<p>In production, your application will most likely have a larger URL space, with multiple endpoint addresses available.
In such cases, you can set a dedicated callback (redirect) path and register this URL in the provider&#8217;s dashboard, as outlined in the following configuration example:</p>
</div>
<div class="paragraph">
<p><code>quarkus.oidc.authentication.redirect-path=/authenticated-welcome</code></p>
</div>
<div class="paragraph">
<p>In the example scenario, Quarkus calls <code>/authenticated-welcome</code> after accepting a redirect from Auth0, completing the authorization code flow,  and creating the session cookie.
Successfully authenticated users are also allowed to access other parts of the secured application space, without needing to authenticate again. For example, the endpoint callback method can use a JAX-RS API to redirect users to other parts of the secured application where a session cookie will be verified.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now you are ready to start testing the endpoint.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="test-the-quarkus-endpoint"><a class="anchor" href="#test-the-quarkus-endpoint"></a>Test the Quarkus endpoint</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Start Quarkus in dev mode:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ mvn quarkus:dev</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This is the only time during this tutorial when you are expected to manually start Quarkus in dev mode.
The configuration and code update steps in the remaining sections of this tutorial are automatically observed and processed by Quarkus without you needing to restart the application manually.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Open the browser and access <a href="http://localhost:8080/hello" class="bare">http://localhost:8080/hello</a>.</p>
</div>
<div class="paragraph">
<p>You will be redirected to Auth0 and prompted to log in:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/auth0-login.png" alt="Auth0 Login">
</div>
</div>
<div class="paragraph">
<p>and authorize the <code>QuarkusAuth0</code> application to access your account:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/auth0-authorize.png" alt="Auth0 Authorize">
</div>
</div>
<div class="paragraph">
<p>Finally, you will be redirected back to the Quarkus endpoint which will return the following response:
<code>Hello, auth0|60e5a305e8da5a006aef5471</code></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Notice that the current username does not get returned.
To learn more about why this behavior occurs, you can use OIDC Dev UI as explained in the <a href="security-openid-connect-dev-services#dev-ui-all-oidc-providers">Dev UI for all OpenID Connect Providers</a> section of the "Dev Services and UI for OpenID Connect (OIDC)" guide and the following section.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="looking-at-auth0-tokens-in-the-oidc-dev-ui"><a class="anchor" href="#looking-at-auth0-tokens-in-the-oidc-dev-ui"></a>Looking at Auth0 tokens in the OIDC Dev UI</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Quarkus provides a great <a href="dev-ui">Dev UI</a> experience.
Specifically, Quarkus offers built-in support for developing and testing OIDC endpoints with a Keycloak container.
<a href="security-openid-connect-dev-services#dev-services-for-keycloak">DevService for Keycloak</a> is automatically started and used if the address of the OIDC provider is not specified for the Quarkus <code>quarkus.oidc.auth-server-url</code> configuration property.</p>
</div>
<div class="paragraph">
<p>You can continue using the Quarkus OIDC Dev UI when the provider is already configured.
Use the following instructions to update your configuration:</p>
</div>
<div class="paragraph">
<p>First, change your Quarkus application type from <code>web-app</code> to <code>hybrid</code>, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-configuration hljs" data-lang="configuration">quarkus.oidc.auth-server-url=https://dev-3ve0cgn7.us.auth0.com
quarkus.oidc.application-type=hybrid <i class="conum" data-value="1"></i><b>(1)</b>
quarkus.oidc.client-id=sKQu1dXjHB6r0sra0Y1YCqBZKWXqCkly
quarkus.oidc.credentials.secret=${client-secret}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Application type is changed to <code>hybrid</code> because OIDC Dev UI currently supports <code>SPA</code> (single-page application) mode only.
OIDC Dev UI single-page application, using its own Java Script, authenticates users to the OIDC provider and uses the access token as a Bearer token to access the Quarkus endpoint as a service.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Typically, Quarkus must be configured with <code>quarkus.oidc.application-type=service</code> to support <code>Bearer</code> token authentication, but it also supports a <code>hybrid</code> application type, which means it can support both the authorization code and bearer token flows at the same time.</p>
</div>
<div class="paragraph">
<p>You also need to configure the Auth0 application to allow the callbacks to the OIDC Dev UI.
Use the following URL format:</p>
</div>
<div class="paragraph">
<p><code><a href="http://localhost:8080/q/dev-ui/io.quarkus.quarkus-oidc/${provider-name}-provider" class="bare">http://localhost:8080/q/dev-ui/io.quarkus.quarkus-oidc/${provider-name}-provider</a></code></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Where in this example, the <code>${provider-name}</code> is <code>auth0</code></p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/auth0-allowed-callbacks.png" alt="Auth0 Allowed Callbacks">
</div>
</div>
<div class="paragraph">
<p>Now you are ready to use OIDC Dev UI with Auth0.</p>
</div>
<div class="paragraph">
<p>Open <a href="http://localhost:8080/q/dev/" class="bare">http://localhost:8080/q/dev/</a> in a browser session. An OpenId Connect card that links to an Auth0 provider SPA displays, as follows:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/auth0-devui.png" alt="Auth0 DevUI">
</div>
</div>
<div class="paragraph">
<p>Click <strong>Auth0 provider</strong> followed by <strong>Login into Single Page Application</strong>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/auth0-devui-login-to-spa.png" alt="Auth0 DevUI Login to SPA">
</div>
</div>
<div class="paragraph">
<p>You will be redirected to Auth0 to log in.
You will then be redirected to the OIDC Dev UI dashboard, as follows:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/auth0-devui-dashboard-without-name.png" alt="Auth0 DevUI Dashboard Without Name">
</div>
</div>
<div class="paragraph">
<p>Here, you can look at both ID and access tokens in the encoded and decoded formats, copy them to the clipboard or use them to test the service endpoint. We will test the endpoint later but for now let&#8217;s check the ID token:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/auth0-idtoken-without-name.png" alt="Auth0 IdToken without name">
</div>
</div>
<div class="paragraph">
<p>As you can see it does not have any claim representing a user name but if you check its <code>sub</code> (subject) claim you will see its value matches what you got in the response when you accessed the Quarkus endpoint directly from the browser, <code>auth0|60e5a305e8da5a006aef5471</code>.</p>
</div>
<div class="paragraph">
<p>Fix it by configuring Quarkus to request a standard OIDC <code>profile</code> scope during the authentication process which should result in the ID token including more information:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-configuration hljs" data-lang="configuration">quarkus.oidc.auth-server-url=https://dev-3ve0cgn7.us.auth0.com
quarkus.oidc.application-type=hybrid
quarkus.oidc.client-id=sKQu1dXjHB6r0sra0Y1YCqBZKWXqCkly
quarkus.oidc.credentials.secret=${client-secret}

quarkus.oidc.authentication.scopes=profile <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Request <code>profile</code> scope in addition to the default <code>openid</code> scope.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Go back to <a href="http://localhost:8080/q/dev/" class="bare">http://localhost:8080/q/dev/</a>, repeat the process of logging in to <code>Auth0</code> and check the ID token again, now you should see the ID token containing the <code>name</code> claim:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/auth0-idtoken-with-name.png" alt="Auth0 IdToken with name">
</div>
</div>
<div class="paragraph">
<p>You should get the name when you access the Quarkus endpoint directly from the browser. Clear the browser cookie cache, access <a href="http://localhost:8080/hello" class="bare">http://localhost:8080/hello</a> and yet again, you get <code>Hello, auth0|60e5a305e8da5a006aef5471</code> returned. Hmm, what is wrong ?</p>
</div>
<div class="paragraph">
<p>The answer lies with the specifics of the <code>org.eclipse.microprofile.jwt.JsonWebToken#getName()</code> implementation, which, according to the <a href="https://github.com/eclipse/microprofile-jwt-auth">MicroProfile MP JWT RBAC  specification</a>, checks an MP JWT specific <code>upn</code> claim, trying <code>preferred_username</code> next and finally <code>sub</code> which explains why you get the <code>Hello, auth0|60e5a305e8da5a006aef5471</code> answer even with the ID token containing the <code>name</code> claim. We can fix it easily by changing the endpoint <code>hello()</code> method&#8217;s implementation to return a specific claim value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme;

import org.eclipse.microprofile.jwt.JsonWebToken;

import io.quarkus.oidc.IdToken;
import io.quarkus.security.Authenticated;
import jakarta.inject.Inject;
import jakarta.ws.rs.GET;
import jakarta.ws.rs.Path;
import jakarta.ws.rs.Produces;
import jakarta.ws.rs.core.MediaType;

@Path("/hello")
public class GreetingResource {

    @Inject
    @IdToken
    JsonWebToken idToken;

    @GET
    @Authenticated
    @Produces(MediaType.TEXT_PLAIN)
    public String hello() {
        return "Hello, " + idToken.getClaim("name");
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now clear the browser cache, access <a href="http://localhost:8080/hello" class="bare">http://localhost:8080/hello</a> and finally the user name is returned.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="logout-support"><a class="anchor" href="#logout-support"></a>Logout support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that you have the users signing in to Quarkus with the help of Auth0, you probably want to support a user-initiated logout. Quarkus supports <a href="https://quarkus.io/guides/security-oidc-code-flow-authentication#logout-and-expiration">RP-initiated and other standard OIDC logout mechanisms, as well as the local session logout</a>.</p>
</div>
<div class="paragraph">
<p>Currently, Auth0 does not support the standard OIDC RP-initiated logout and does not provide an end session endpoint URL in its discoverable metadata, but it provides its own logout mechanism which works nearly exactly the same as the standard one.</p>
</div>
<div class="paragraph">
<p>It is easy to support it with Quarkus OIDC. You must configure an Auth0 end session endpoint URL and have Quarkus include both the <code>client-id</code> query parameter and the post logout URL as the <code>returnTo</code> query parameter in the RP-initated logout redirect request to Auth0:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-configuration hljs" data-lang="configuration">quarkus.oidc.auth-server-url=https://dev-3ve0cgn7.us.auth0.com
quarkus.oidc.application-type=hybrid
quarkus.oidc.client-id=sKQu1dXjHB6r0sra0Y1YCqBZKWXqCkly
quarkus.oidc.credentials.secret=${client-secret}
quarkus.oidc.authentication.scopes=openid,profile

quarkus.oidc.end-session-path=v2/logout <i class="conum" data-value="1"></i><b>(1)</b>
quarkus.oidc.logout.post-logout-uri-param=returnTo <i class="conum" data-value="2"></i><b>(2)</b>
quarkus.oidc.logout.extra-params.client_id=${quarkus.oidc.client-id} <i class="conum" data-value="3"></i><b>(3)</b>
quarkus.oidc.logout.path=/logout <i class="conum" data-value="4"></i><b>(4)</b>
quarkus.oidc.logout.post-logout-path=/hello/post-logout <i class="conum" data-value="5"></i><b>(5)</b>

quarkus.http.auth.permission.authenticated.paths=/logout
quarkus.http.auth.permission.authenticated.policy=authenticated <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Auth0 does not include the end session URL in its metadata, so complement it with manually configuring the Auth0 end session endpoint URL.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Auth0 will not recognize a standard <code>post_logout_redirect_uri</code> query parameter and expects a parameter <code>returnTo</code> instead.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Auth0 expects <code>client-id</code> in the logout request.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Authenticated requests to <code>/logout</code> path will be treated as RP-inititated logout requests.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>This is a public resource to where the logged out user should be returned to.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Make sure the <code>/logout</code> path is protected.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here we have customized the Auth0 end session endpoint URL and indicated to Quarkus that an <code><a href="http://localhost:8080/logout" class="bare">http://localhost:8080/logout</a></code> request must trigger a logout of the currently authenticated user. An interesting thing about the <code>/logout</code> path is that it is <code>virtual</code>, it is not supported by any method in the JAX-RS endpoint, so for Quarkus OIDC to be able to react to <code>/logout</code> requests we attach an <code>authenticated</code> <a href="https://quarkus.io/guides/security-authorize-web-endpoints-reference#authorization-using-configuration">HTTP security policy</a> to this path directly in the configuration.</p>
</div>
<div class="paragraph">
<p>We also have configured Quarkus to return the logged out user to the public <code>/hello/post-logout</code> resource, and this path is included in the logout request as the Auth0 specific <code>returnTo</code> query parameter. Finally, the Quarkus application&#8217;s <code>client-id</code> is included in the logout URL as well.</p>
</div>
<div class="paragraph">
<p>Update the endpoint to accept the post logout redirects:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme;

import org.eclipse.microprofile.jwt.JsonWebToken;

import io.quarkus.oidc.IdToken;
import io.quarkus.security.Authenticated;
import jakarta.inject.Inject;
import jakarta.ws.rs.GET;
import jakarta.ws.rs.Path;
import jakarta.ws.rs.Produces;
import jakarta.ws.rs.core.MediaType;

@Path("/hello")
public class GreetingResource {

    @Inject
    @IdToken
    JsonWebToken idToken;

    @GET
    @Authenticated
    @Produces(MediaType.TEXT_PLAIN)
    public String hello() {
        return "Hello, " + idToken.getClaim("name");
    }

    @GET
    @Path("post-logout")
    @Produces(MediaType.TEXT_PLAIN)
    public String postLogout() {
        return "You were logged out";
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note the addition of the public <code>/hello/post-logout</code> resource method.</p>
</div>
<div class="paragraph">
<p>Before we test the logout, make sure the <code>Auth0</code> application is configured to allow this post logout redirect back to Quarkus after the user has been logged out:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/auth0-allowed-logout.png" alt="Auth0 Allowed Logout">
</div>
</div>
<div class="paragraph">
<p>Now, clear the browser cookie cache, access <a href="http://localhost:8080/hello" class="bare">http://localhost:8080/hello</a>, login to Quarkus with Auth0, get the user name returned, and go to <code><a href="http://localhost:8080/logout" class="bare">http://localhost:8080/logout</a></code>. You&#8217;ll see the <code>You were logged out</code> message displayed in the browser.</p>
</div>
<div class="paragraph">
<p>Next, go to the <a href="http://localhost:8080/q/dev/" class="bare">http://localhost:8080/q/dev/</a>, login to Auth0 from the Dev UI SPA and notice you can now logout from the OIDC Dev UI too, see the symbol representing the logout next to the <code>Logged in as Sergey Beryozkin</code> text:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/auth0-devui-dashboard-with-name.png" alt="Auth0 Dashboard with name and Logout">
</div>
</div>
<div class="paragraph">
<p>For the logout to work from OIDC DevUI, the Auth0 application&#8217;s list of allowed logout callbacks has to be updated to include the OIDC DevUI endpoint:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/auth0-allowed-logouts.png" alt="Auth0 Allowed Logouts">
</div>
</div>
<div class="paragraph">
<p>Now logout directly from OIDC Dev UI and login as a new user - add more users to the registered Auth0 application if required.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="role-based-access-control"><a class="anchor" href="#role-based-access-control"></a>Role-based access control</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We have confirmed that the Quarkus endpoint can be accessed by users who have authenticated with the help of <code>Auth0</code>.</p>
</div>
<div class="paragraph">
<p>The next step is to introduce role-based access control (RBAC) to have users in a specific role only, such as <code>admin</code>, be able to access the endpoint.</p>
</div>
<div class="paragraph">
<p>See also the <a href="#permission-based-access-control">Permission Based Access Control</a> section below.</p>
</div>
<div class="paragraph">
<p>Auth0 tokens do not include any claims containing roles by default, so, first, you must customize the <code>Login</code> flow of the <code>Auth0</code> application with a custom action which will add the roles to tokens. Select <code>Actions/Flows/Login</code> in the <code>Auth0</code> dashboard, choose <code>Add Action/Build Custom</code>, name it as <code>AddRoleClaim</code>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/auth0-add-role-action.png" alt="Auth0 Add Role Action">
</div>
</div>
<div class="paragraph">
<p>Add the following action script to it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">exports.onExecutePostLogin = async (event, api) =&gt; {
  const namespace = 'https://quarkus-security.com';
  if (event.authorization) {
    api.idToken.setCustomClaim(`${namespace}/roles`, event.authorization.roles);
    api.accessToken.setCustomClaim(`${namespace}/roles`, event.authorization.roles);
  }
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note a custom Auth0 claim has to be namespace qualified, so the claim which will contain roles will be named as "https://quarkus-security.com/roles". Have a look at the ID token content we analyzed in the previous sections and you will see how this claim is represented, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "https://quarkus-security.com/roles": [
      "admin"
  ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Auth0</code> Login Flow diagram should look like this now:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/auth0-login-flow.png" alt="Auth0 Login Flow">
</div>
</div>
<div class="paragraph">
<p>You must add a role such as <code>admin</code> to the users registered in the <code>Auth0</code> application.</p>
</div>
<div class="paragraph">
<p>Create an <code>admin</code> role:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/auth0-create-role.png" alt="Auth0 Create Role">
</div>
</div>
<div class="paragraph">
<p>and add it to the registered user:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/auth0-add-role-to-user.png" alt="Auth0 Add Role to User">
</div>
</div>
<div class="paragraph">
<p>Next, update the Quarkus endpoint to require that only users with the <code>admin</code> role can access the endpoint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme;

import org.eclipse.microprofile.jwt.JsonWebToken;

import io.quarkus.oidc.IdToken;
import jakarta.annotation.security.RolesAllowed;
import jakarta.inject.Inject;
import jakarta.ws.rs.GET;
import jakarta.ws.rs.Path;
import jakarta.ws.rs.Produces;
import jakarta.ws.rs.core.MediaType;

@Path("/hello")
public class GreetingResource {

    @Inject
    @IdToken
    JsonWebToken idToken;

    @GET
    @RolesAllowed("admin")
    @Produces(MediaType.TEXT_PLAIN)
    public String hello() {
        return "Hello, " + idToken.getClaim("name");
    }

    @GET
    @Path("post-logout")
    @Produces(MediaType.TEXT_PLAIN)
    public String postLogout() {
        return "You were logged out";
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Open <a href="http://localhost:8080/hello" class="bare">http://localhost:8080/hello</a>, authenticate to Auth0 and get <code>403</code>. The reason you get <code>403</code> is because Quarkus OIDC does not know which claim in the <code>Auth0</code> tokens represents the roles information, by default a <code>groups</code> claim is checked, while Auth0 tokens are now expected to have an "https://quarkus-security.com/roles" claim.</p>
</div>
<div class="paragraph">
<p>Fix it by telling Quarkus OIDC which claim must be checked to enforce RBAC:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-configuration hljs" data-lang="configuration">quarkus.oidc.auth-server-url=https://dev-3ve0cgn7.us.auth0.com
quarkus.oidc.application-type=hybrid
quarkus.oidc.authentication.scopes=profile
quarkus.oidc.client-id=sKQu1dXjHB6r0sra0Y1YCqBZKWXqCkly
quarkus.oidc.credentials.secret=${client-secret}

quarkus.oidc.roles.role-claim-path="https://quarkus-security.com/roles" <i class="conum" data-value="1"></i><b>(1)</b>

# Logout
quarkus.oidc.end-session-path=v2/logout
quarkus.oidc.logout.post-logout-uri-param=returnTo
quarkus.oidc.logout.extra-params.client_id=${quarkus.oidc.client-id}
quarkus.oidc.logout.path=/logout
quarkus.oidc.logout.post-logout-path=/hello/post-logout
quarkus.http.auth.permission.authenticated.paths=/logout
quarkus.http.auth.permission.authenticated.policy=authenticated</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Point to the custom roles claim. The path to the roles claim is in double quotes because the claim is namespace qualified.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now, clear the browser cookie cache, access <a href="http://localhost:8080/hello" class="bare">http://localhost:8080/hello</a> again, authenticate to Auth0 and get an expected user name.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="opaque-access-tokens"><a class="anchor" href="#opaque-access-tokens"></a>Access Quarkus with opaque Auth0 access tokens</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The main goal of this section is to explain how Quarkus can be tuned to accept <code>opaque</code> bearer Auth0 access tokens as opposed to Auth0 JWT access tokens because Auth0 access tokens issued during the authorization code flow are opaque by default and they can only be used to request <code>UserInfo</code> in addition to the information about the current user which is already available in ID token. Learning how to verify opaque tokens can be useful because many OIDC and OAuth2 providers will issue opaque access tokens only.</p>
</div>
<div class="paragraph">
<p>For more information on how to configure Auth0 and Quarkus to have authorization code access tokens issued in the JWT format and propagated to service endpoints, see the following <a href="#token-propagation">Propagate access tokens to microservices</a> and <a href="#jwt-access-tokens">Access tokens in JWT format</a> sections.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>So far we have only tested the Quarkus endpoint using OIDC authorization code flow. In this flow you use the browser to access the Quarkus endpoint, Quarkus itself manages the authorization code flow, a user is redirected to Auth0, logs in, is redirected back to Quarkus, Quarkus completes the flow by exchanging the code for the ID, access, and refresh tokens, and works with the ID token representing the successful user authentication. The access token is not relevant at the moment. As mentioned earlier, in the authorization code flow, Quarkus will only use the access token to access downstream services on behalf of the currently authenticated user.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s imagine though that the Quarkus endpoint we have developed has to accept <code>Bearer</code> access tokens too: it may be that the other Quarkus endpoint which is propagating it to this endpoint or it can be SPA which uses the access token to access the Quarkus endpoint. And Quarkus OIDC DevUI SPA which we already used to analyze the ID token fits perfectly for using the access token available to SPA to test the Quarkus endpoint.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s go again to <a href="http://localhost:8080/q/dev-ui" class="bare">http://localhost:8080/q/dev-ui</a>, select the <code>OpenId Connect</code> card, login to Auth0, and check the Access token content:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/auth0-devui-accesstoken.png" alt="Auth0 DevUI Access Token">
</div>
</div>
<div class="paragraph">
<p>This access token, as opposed to the ID token we looked at earlier, cannot be verified by Quarkus directly. This is because the access token is in <code>JWE</code> (encrypted) as opposed to <code>JWS</code> (signed) format. You can see from the decoded token headers that it has been encrypted directly with a secret key known to Auth0 only, and therefore its content cannot be decrypted by Quarkus. From the Quarkus&#8217;s perspective this access token is an <code>opaque</code> one, Quarkus cannot use public Auth0 asymmetric verification keys to verify it.</p>
</div>
<div class="paragraph">
<p>To confirm it, enter <code>/hello</code> as the <code>Service Address</code> in the <code>Test Service</code> area and press <code>With Access Token</code> and you will get the HTTP <code>401</code> status:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/auth0-devui-test-accesstoken-401.png" alt="Auth0 Dev UI Test Access token 401">
</div>
</div>
<div class="paragraph">
<p>For Quarkus be able to accept such access tokens, one of the two options should be available.
The first option is to introspect the opaque token remotely using a provider&#8217;s introspection endpoint. Token introspection is typically supported at the <code>OAuth2</code> level, and since <code>OIDC</code> is built on top of <code>OAuth2</code>, some OIDC providers such as Keycloak support the token introspection as well. However, Auth0 does not support the token introspection, you can check it by looking at the publicly available Auth0 metadata, add <code>/.well-known/openid-configuration</code> to the address of your configured Auth0 provider, and open the resulting URL, <code><a href="https://dev-3ve0cgn7.us.auth0.com/.well-known/openid-configuration" class="bare">https://dev-3ve0cgn7.us.auth0.com/.well-known/openid-configuration</a></code>. You will see that Auth0 does not have an introspection endpoint:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/auth0-well-known-config.png" alt="Auth0 Well Known Config">
</div>
</div>
<div class="paragraph">
<p>Therefore the other option, indirect access token verification, where the access token is used to acquire <code>UserInfo</code> from Auth0 can be used to accept and verify opaque Auth0 tokens. This option works because OIDC providers have to verify access tokens before they can issue <code>UserInfo</code> and Auth0 has a <code>UserInfo</code> endpoint.</p>
</div>
<div class="paragraph">
<p>So lets configure Quarkus to request that the access tokens must be verified by using them to acquire <code>UserInfo</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-configuration hljs" data-lang="configuration">quarkus.oidc.auth-server-url=https://dev-3ve0cgn7.us.auth0.com
quarkus.oidc.application-type=hybrid
quarkus.oidc.authentication.scopes=profile
quarkus.oidc.client-id=sKQu1dXjHB6r0sra0Y1YCqBZKWXqCkly
quarkus.oidc.credentials.secret=${client-secret}

# Point to the custom roles claim
quarkus.oidc.roles.role-claim-path="https://quarkus-security.com/roles"

# Logout
quarkus.oidc.end-session-path=v2/logout
quarkus.oidc.logout.post-logout-uri-param=returnTo
quarkus.oidc.logout.extra-params.client_id=${quarkus.oidc.client-id}
quarkus.oidc.logout.path=/logout
quarkus.oidc.logout.post-logout-path=/hello/post-logout
quarkus.http.auth.permission.authenticated.paths=/logout
quarkus.http.auth.permission.authenticated.policy=authenticated

quarkus.oidc.token.verify-access-token-with-user-info=true <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Verify access tokens indirectly by using them to request <code>UserInfo</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Update the endpoint code to expect <code>UserInfo</code> as opposed to <code>ID token</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme;

import io.quarkus.oidc.UserInfo;
import jakarta.annotation.security.RolesAllowed;
import jakarta.inject.Inject;
import jakarta.ws.rs.GET;
import jakarta.ws.rs.Path;
import jakarta.ws.rs.Produces;
import jakarta.ws.rs.core.MediaType;

@Path("/hello")
public class GreetingResource {

    @Inject
    UserInfo userInfo;

    @GET
    @RolesAllowed("admin")
    @Produces(MediaType.TEXT_PLAIN)
    public String hello() {
        return "Hello, " + userInfo.getName();
    }

    @GET
    @Path("post-logout")
    @Produces(MediaType.TEXT_PLAIN)
    public String postLogout() {
        return "You were logged out";
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This code will now work both for the authorization code and bearer access token flows.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s go to the OIDC Dev UI where we looked at the access token, enter <code>/hello</code> as the <code>Service Address</code> in the <code>Test Service</code> area and press <code>With Access Token</code> and you will get <code>200</code>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/auth0-devui-test-accesstoken-200.png" alt="Auth0 Dev UI Test Access token">
</div>
</div>
<div class="paragraph">
<p>To confirm that it really does work, update the test endpoint to allow a <code>user</code> role only with <code>@RolesAllowed("user")</code>. Try to access the endpoint from OIDC Dev UI again, and you will get the HTTP <code>403</code> error. Revert the code back to <code>@RolesAllowed("admin")</code> to get the reassuring HTTP <code>200</code> status again.</p>
</div>
<div class="paragraph">
<p>When verifying the opaque access token indirectly, by using it to request <code>UserInfo</code>, Quarkus will use <code>UserInfo</code> as the source of the roles information, if any. As it happens, Auth0 includes the custom role claim which was created earlier in the <code>UserInfo</code> response as well.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As has already been mentioned in the introduction to this section, the main goal of this section is to explain how Quarkus can verify opaque access tokens. In general, propagating access tokens whose only purpose is to allow retrieving <code>UserInfo</code> to services should be avoided unless the front-end JAX-RS endpoint or SPA prefers to delegate UserInfo retrieval to the trusted service.</p>
</div>
<div class="paragraph">
<p>For a recommended approach of working with Auth0 access tokens, see the following <a href="#token-propagation">Propagate access tokens to microservices</a> and <a href="#jwt-access-tokens">Access tokens in JWT format</a> sections.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Typically one uses access tokens to access remote services but OIDC DevUI SPA dashboard also offers an option to test with the ID token. This option is only available to emulate the cases where SPA delegates to the endpoint to verify and retrieve some information from the ID token for SPA to use - but ID token will still be sent to the endpoint as Bearer token by OIDC DevUI. Prefer testing with the access token in most cases.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You can use SwaggerUI or GraphQL from OIDC DevUI for testing the service, instead of manually entering the service path to test.
For example, if you add</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
   &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
   &lt;artifactId&gt;quarkus-smallrye-openapi&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>to your application&#8217;s pom then you will see a Swagger link in OIDC Dev UI:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/auth0-devui-testservice-swagger.png" alt="Auth0 Dev UI Test with Swagger">
</div>
</div>
<div class="paragraph">
<p>Click the Swagger link and start testing the service.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="token-propagation"><a class="anchor" href="#token-propagation"></a>Propagate access tokens to microservices</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that we have managed to use OIDC authorization code flow and used both ID token and UserInfo to access the user information, the next typical task is to propagate the current Auth0 access token to access the downstream service on behalf of the currently authenticated user.</p>
</div>
<div class="paragraph">
<p>In fact, the last code example, showing the injected <code>UserInfo</code>, is a concrete example of the access token propagation, in this case, Quarkus propagates the Auth0 access token to the Auth0 <code>UserInfo</code> endpoint to acquire <code>UserInfo</code>. Quarkus does it without users having to do anything themselves.</p>
</div>
<div class="paragraph">
<p>But what about propagating access tokens to some custom services ? It is very easy to achieve in Quarkus, both for the authorization code and bearer token flows. All you need to do is to create a REST Client interface for calling the service requiring a Bearer token access and annotate it with <code>@AccessToken</code> and the access token arriving to the front-end endpoint as the Auth0 Bearer access token or acquired by Quarkus after completing the Auth0 authorization code flow, will be propagated to the target microservice. This is as easy as it can get.</p>
</div>
<div class="paragraph">
<p>For examples of propagating access tokens, see the following sections in this tutorial.
For more information about token propagation, see <a href="security-openid-connect-client-reference#token-propagation-rest">OIDC token propagation</a>.</p>
</div>
<div class="sect2">
<h3 id="jwt-access-tokens"><a class="anchor" href="#jwt-access-tokens"></a>Access tokens in JWT format</h3>
<div class="paragraph">
<p>We have already looked in detail at how Quarkus OIDC can handle <a href="#opaque-access-tokens">Access Quarkus with opaque Auth0 access tokens</a>, but we don&#8217;t want to propagate Auth0 opaque tokens to micro services which do something useful on behalf on the currently authenticated user, beyond checking its UserInfo.</p>
</div>
<div class="paragraph">
<p>A microservice which the front-end Quarkus application will access by propagating authorization code flow access tokens to it is represented in the Auth0 dashboard as an <code>API</code>. Let&#8217;s add it in the <code>Applications/APIs</code>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/auth0-api.png" alt="Auth0 API">
</div>
</div>
<div class="paragraph">
<p>The <code><a href="https://quarkus-auth0" class="bare">https://quarkus-auth0</a></code> identifier of the created <code>QuarkusAuth0API</code> will serve as this API&#8217;s <code>audience</code>. Providing this audience as a query parameter in the authorization code flow redirect to Auth0 will ensure that Auth0 issues access tokens in the JWT format.</p>
</div>
</div>
<div class="sect2">
<h3 id="api-microservice"><a class="anchor" href="#api-microservice"></a>API microservice</h3>
<div class="paragraph">
<p>Add the following dependencies to the project to support OIDC token propagation and REST clients:</p>
</div>
<div class="listingblock primary asciidoc-tabs-target-sync-cli asciidoc-tabs-target-sync-maven">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-rest-client-jackson&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
   &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
   &lt;artifactId&gt;quarkus-rest-client-oidc-token-propagation&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create <code>ApiEchoService</code> service class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme;

import io.quarkus.security.Authenticated;
import jakarta.ws.rs.POST;
import jakarta.ws.rs.Path;
import jakarta.ws.rs.Produces;
import jakarta.ws.rs.core.MediaType;

@Path("/echo")
public class ApiEchoService {

    @POST
    @Authenticated
    @Produces(MediaType.TEXT_PLAIN)
    public String echoUserName(String username) {
        return username;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And configure it as an OIDC <code>service</code> application which will only fetch public verification keys from Auth0.
The configuration for this microservice should only have a single line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-configuration hljs" data-lang="configuration">quarkus.oidc.auth-server-url=https://dev-3ve0cgn7.us.auth0.com</code></pre>
</div>
</div>
<div class="paragraph">
<p>which is all what is needed for the OIDC <code>service</code> application to fetch Auth0 public verification keys and use them to verify Auth0 access tokens in JWT format.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In this tutorial you have already configured the OIDC <code>hybrid</code> application which can handle both authorization code and bearer token authentication flows. In production you will run microservices as separate servers but for the sake of simplicity <code>ApiEchoService</code> will not have to be started as a second server with its own configuration containing <code>quarkus.oidc.auth-server-url=https://dev-3ve0cgn7.us.auth0.com</code> only, and therefore the current configuration which already has the Auth0 dev tenant address configured will be reused.</p>
</div>
<div class="paragraph">
<p>The <code>hybrid</code> OIDC application type will ensure that <code><a href="http://localhost:8080/hello" class="bare">http://localhost:8080/hello</a></code> requests to <code>GreetingResource</code> initiate an Authorization code flow while <code><a href="http://localhost:8080/echo" class="bare">http://localhost:8080/echo</a></code> requests to <code>ApiEchoService</code>, initiated by <code>GreetingResource</code>, will lead to the authorization code flow tokens being propagated and accepted by <code>ApiEchoService</code> as bearer JWT access tokens.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next, add a REST client interface representing <code>ApiEchoService</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme;

import jakarta.ws.rs.POST;
import jakarta.ws.rs.Path;
import jakarta.ws.rs.Produces;
import jakarta.ws.rs.core.MediaType;

import org.eclipse.microprofile.rest.client.inject.RegisterRestClient;
import io.quarkus.oidc.token.propagation.common.AccessToken;

@RegisterRestClient
@AccessToken <i class="conum" data-value="1"></i><b>(1)</b>
@Path("/echo")
public interface ApiEchoServiceClient {

    @POST
    @Produces(MediaType.TEXT_PLAIN)
    String echoUserName(String username);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Propagate access token as an HTTP <code>Authorization: Bearer accesstoken</code> header</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And update the configuration for the Quarkus front-end application, <code>GreetingResource</code>, which has been created earlier, to request that an authorization code flow access token (as opposed to ID token) includes an <code>aud</code> (audience) claim targeting <code>ApiEchoService</code>, as well as configure the base URL for the <code>ApiEchoService</code> REST client:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-configuration hljs" data-lang="configuration">quarkus.oidc.auth-server-url=https://dev-3ve0cgn7.us.auth0.com
quarkus.oidc.application-type=hybrid
quarkus.oidc.authentication.scopes=profile
quarkus.oidc.authentication.extra-params.audience=https://quarkus-auth0 <i class="conum" data-value="1"></i><b>(1)</b>
quarkus.oidc.client-id=sKQu1dXjHB6r0sra0Y1YCqBZKWXqCkly
quarkus.oidc.credentials.secret=${client-secret}

# Point to the custom roles claim
quarkus.oidc.roles.role-claim-path="https://quarkus-security.com/roles"

# Logout
quarkus.oidc.end-session-path=v2/logout
quarkus.oidc.logout.post-logout-uri-param=returnTo
quarkus.oidc.logout.extra-params.client_id=${quarkus.oidc.client-id}
quarkus.oidc.logout.path=/logout
quarkus.oidc.logout.post-logout-path=/hello/post-logout
quarkus.http.auth.permission.authenticated.paths=/logout
quarkus.http.auth.permission.authenticated.policy=authenticated

quarkus.oidc.token.verify-access-token-with-user-info=true

org.acme.ApiEchoServiceClient/mp-rest/url=http://localhost:${port} <i class="conum" data-value="2"></i><b>(2)</b>

quarkus.test.native-image-profile=test
%prod.port=8080
%dev.port=8080
%test.port=8081</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Pass an extra <code>audience</code> query parameter to the Auth0 authorization endpoint during the authorization code flow redirect from Quarkus to Auth0.
It will ensure that the access token is issued in the JWT format and includes an <code>aud</code> (audience) claim which will contain <code><a href="https://quarkus-auth0" class="bare">https://quarkus-auth0</a></code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Point <code>ApiEchoServiceClient</code> to the <code>ApiEchoService</code> endpoint. HTTP port in the <code>org.acme.ApiEchoServiceClient/mp-rest/url=http://localhost:${port}</code> property is parameterized to ensure the correct URL is built while using the dev, test and prod modes.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finally update <code>GreetingResource</code> to request that <code>ApiEchoService</code> echoes a user name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme;

import io.quarkus.oidc.UserInfo;
import io.quarkus.security.Authenticated;
import jakarta.annotation.security.RolesAllowed;
import jakarta.inject.Inject;
import jakarta.ws.rs.GET;
import jakarta.ws.rs.Path;
import jakarta.ws.rs.Produces;
import jakarta.ws.rs.core.MediaType;

import org.eclipse.microprofile.rest.client.inject.RestClient;

@Path("/hello")
public class GreetingResource {
    @Inject
    @RestClient
    ApiEchoServiceClient echoClient; <i class="conum" data-value="1"></i><b>(1)</b>

    @Inject
    UserInfo userInfo;

    @GET
    @RolesAllowed("admin")
    @Produces(MediaType.TEXT_PLAIN)
    public String hello() {
        return "Hello, " + echoClient.echoUserName(userInfo.getName()); <i class="conum" data-value="2"></i><b>(2)</b>
    }

    @GET
    @Path("post-logout")
    @Produces(MediaType.TEXT_PLAIN)
    public String postLogout() {
        return "You were logged out";
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Inject <code>ApiEchoServiceClient</code> REST client</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use <code>ApiEchoServiceClient</code> to echo the user name.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Open a browser, access <a href="http://localhost:8080/hello" class="bare">http://localhost:8080/hello</a> and get your name displayed in the browser.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s go to <a href="http://localhost:8080/q/dev-ui" class="bare">http://localhost:8080/q/dev-ui</a>, select the <code>OpenId Connect</code> card, login to Auth0, and check the Access token content:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/auth0-devui-jwt-accesstoken.png" alt="Auth0 DevUI JWT Access Token">
</div>
</div>
<div class="paragraph">
<p>As you can see, the access token is no longer encrypted as shown in the <a href="#opaque-access-tokens">Access Quarkus with opaque Auth0 access tokens</a> section and indeed it is in the JWT format now.</p>
</div>
</div>
<div class="sect2">
<h3 id="permission-based-access-control"><a class="anchor" href="#permission-based-access-control"></a>Permission Based Access Control</h3>
<div class="paragraph">
<p>We have discussed in the <a href="#role-based-access-control">Role-based access control</a> section how to get Quarkus to check a namespace qualified claim containing user roles and use this information to enforce role-based access control. You have configured Auth0 to add the custom roles claim to both ID and access tokens.</p>
</div>
<div class="paragraph">
<p>However, Permission Based Access Control is better suited to the case where an access token is propagated by the front-end endpoint to a microservice which will check if a given access token has been authorized for this service to perform a concrete action, as opposed to this token vouching for a user be in a specific role. For example, being in the admin role does not necessarily mean the user is allowed to have a read and write access to some of this microservice&#8217;s content.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s see how Permission Based Access Control constraints can be applied to <code>ApiEchoService</code>.</p>
</div>
<div class="paragraph">
<p>Go to the Auth0 dashboard, add an <code>echo:name</code> permission to the <code>QuarkusAuth0API</code> API:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/auth0-api-permissions.png" alt="Auth0 API permissions">
</div>
</div>
<div class="paragraph">
<p>The <code>echo:name</code> permission will be included in the access token as a standard OAuth2 <code>scope</code> claim value if this scope will also be requested during the authorization code flow. Update the configuration as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-configuration hljs" data-lang="configuration">quarkus.oidc.auth-server-url=https://dev-3ve0cgn7.us.auth0.com
quarkus.oidc.application-type=hybrid
quarkus.oidc.authentication.scopes=profile,echo:name <i class="conum" data-value="1"></i><b>(1)</b>
quarkus.oidc.authentication.extra-params.audience=https://quarkus-auth0
quarkus.oidc.client-id=sKQu1dXjHB6r0sra0Y1YCqBZKWXqCkly
quarkus.oidc.credentials.secret=${client-secret}

# Point to the custom roles claim
quarkus.oidc.roles.role-claim-path="https://quarkus-security.com/roles"

# Logout
quarkus.oidc.end-session-path=v2/logout
quarkus.oidc.logout.post-logout-uri-param=returnTo
quarkus.oidc.logout.extra-params.client_id=${quarkus.oidc.client-id}
quarkus.oidc.logout.path=/logout
quarkus.oidc.logout.post-logout-path=/hello/post-logout
quarkus.http.auth.permission.authenticated.paths=/logout
quarkus.http.auth.permission.authenticated.policy=authenticated

quarkus.oidc.token.verify-access-token-with-user-info=true

org.acme.ApiEchoServiceClient/mp-rest/url=http://localhost:8080</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>An extra <code>echo:name</code> scope will be requested during the authorization code flow.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now update <code>ApiEchoService</code> to enforce Permission Based Access Control:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme;

import io.quarkus.security.PermissionsAllowed;
import jakarta.ws.rs.POST;
import jakarta.ws.rs.Path;
import jakarta.ws.rs.Produces;
import jakarta.ws.rs.core.MediaType;

@Path("/echo")
public class ApiEchoService {

    @POST
    @PermissionsAllowed("echo:name")
    @Produces(MediaType.TEXT_PLAIN)
    String echoUserName(String username) {
        return username;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is all what is needed as Quarkus OIDC automatically associates <code>scope</code> claim values as permissions with the current security identity.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You can enforce both Role Based and Permission Based Access Controls in Quarkus by combining <code>@RolesAllowed</code> and <code>@PermissionsAllowed</code> annotations.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Open a browser, access <a href="http://localhost:8080/hello" class="bare">http://localhost:8080/hello</a> and get the name displayed in the browser.</p>
</div>
<div class="paragraph">
<p>To confirm the permission is correctly enforced, change it to <code>echo.name</code>: <code>@PermissionsAllowed("echo.name")</code>. Clear the browser cache, access <a href="http://localhost:8080/hello" class="bare">http://localhost:8080/hello</a> again and you will get <code>403</code> reported by <code>ApiEchoService</code>. Now revert it back to <code>@PermissionsAllowed("echo:name")</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="integration-testing"><a class="anchor" href="#integration-testing"></a>Integration testing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You have already used OIDC DevUI SPA to login to Auth0 and test the Quarkus endpoint with the access token, updating the endpoint code along the way.</p>
</div>
<div class="paragraph">
<p>However, running tests is also essential, lets see how we can test the endpoint and configuration which you have developed during the course of this tutorial, using <a href="continuous-testing">Quarkus Continuous Testing</a> feature.</p>
</div>
<div class="paragraph">
<p>Start with the following test code :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme;

import io.quarkus.test.junit.QuarkusTest;
import org.junit.jupiter.api.Test;

import static io.restassured.RestAssured.given;
import static org.hamcrest.CoreMatchers.is;

@QuarkusTest
public class GreetingResourceTest {

    @Test
    public void testHelloEndpoint() {
        given()
          .when().get("/hello")
          .then()
             .statusCode(200)
             .body(is("Hello, Sergey Beryozkin"));
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you recall, when the application was started in dev mode, the following could be seen in the CLI window:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/auth0-devmode-started.png" alt="Auth0 DevMode started">
</div>
</div>
<div class="paragraph">
<p>Press <code>r</code> and notice this test failing with <code>403</code> which is expected because the test does not send a token to the endpoint:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/auth0-test-failure-403.png" alt="Auth0 test failure 403">
</div>
</div>
<div class="paragraph">
<p>Before fixing the test, let&#8217;s review the options available for testing Quarkus endpoints secured by OIDC. These options might vary, depending on which flow your application supports and how you prefer to test. Endpoints which use OIDC authorization code flow can be tested using <a href="security-oidc-code-flow-authentication#code-flow-integration-testing">one of these options</a> and endpoints which use Bearer token authentication can be tested using <a href="security-oidc-bearer-token-authentication#bearer-token-integration-testing">one of these options</a>.</p>
</div>
<div class="paragraph">
<p>As you can see, testing of the endpoints secured with Auth0 can be done with the help of <code>Wiremock</code>, or <code>@TestSecurity</code> annotation. Experiment with writing such tests on your own and reach out if you encounter any problems.</p>
</div>
<div class="paragraph">
<p>In this tutorial though, we will use a recently added <code>OidcTestClient</code> to support testing endpoints which use live Auth0 development tenants.</p>
</div>
<div class="paragraph">
<p>Here is a related fragment of the configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-configuration hljs" data-lang="configuration">quarkus.oidc.auth-server-url=https://dev-3ve0cgn7.us.auth0.com
quarkus.oidc.application-type=hybrid
quarkus.oidc.authentication.scopes=profile
quarkus.oidc.client-id=sKQu1dXjHB6r0sra0Y1YCqBZKWXqCkly
quarkus.oidc.credentials.secret=${client-secret}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In production, you will distinguish between prod and test level configuration with <code>%prod.</code> and <code>%test.</code> qualifiers. Let&#8217;s assume that the above configuration will indeed be prefixed with <code>%test.</code> in your real application, with this configuration also including the <code>%prod.</code> qualified Auth0 production tenant configuration.</p>
</div>
<div class="paragraph">
<p>Using <code>OidcTestClient</code> to test such configuration requires acquiring a token from the Auth0 dev tenant, using either OAuth2 <code>password</code> or <code>client_credentials</code> grant, we will try a <code>password</code> grant. Make sure the application registered in the Auth0 dashboard allows the <code>password</code> grant:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/auth0-password-grant.png" alt="Auth0 password grant">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It is important to clarify that we do not recommend using the deprecated OAuth2 <code>password</code> token grant in production. However using it can help testing the endpoint with tokens acquired from the live dev Auth0 tenant.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>OidcTestClient</code> should be used to test applications accepting bearer tokens which will work for the endpoint developed in this tutorial as it supports both authorization code flow and bearer token authentication. You would need to use OIDC WireMock or <code>HtmlUnit</code> directly against the Auth0 dev tenant if only the authorization code flow was supported - in the latter case <code>HtmlUnit</code> test code would have to be aligned with how Auth0 challenges users to enter their credentials. If you like, you can copy the <a href="security-oidc-code-flow-authentication#code-flow-integration-testing-wiremock">HtmlUnit test fragment</a> from the documentation and experiment with it.</p>
</div>
<div class="paragraph">
<p>In meantime we will now proceed with fixing the currently failing test using <code>OidcTestClient</code>.</p>
</div>
<div class="paragraph">
<p>First you must add the following dependency:</p>
</div>
<div class="listingblock primary asciidoc-tabs-target-sync-cli asciidoc-tabs-target-sync-maven">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-test-oidc-server&lt;/artifactId&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-target-sync-gradle">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gradle hljs" data-lang="gradle">testImplementation("io.quarkus:quarkus-test-oidc-server")</code></pre>
</div>
</div>
<div class="paragraph">
<p>which provides a utility class <code>io.quarkus.test.oidc.client.OidcTestClient</code> which can be used in tests for acquiring access tokens (This dependency also offers an OIDC WireMock support - review the documentation how to use it for testing if you want).</p>
</div>
<div class="paragraph">
<p>Now update the test code like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme;

import static io.restassured.RestAssured.given;
import static org.hamcrest.CoreMatchers.is;

import java.util.Map;

import org.junit.jupiter.api.AfterAll;
import org.junit.jupiter.api.Test;

import io.quarkus.test.junit.QuarkusTest;
import io.quarkus.test.oidc.client.OidcTestClient;

@QuarkusTest
public class GreetingResourceTest {

    static OidcTestClient oidcTestClient = new OidcTestClient();

    @AfterAll
    public static void close() {
        client.close();
    }

    @Test
    public void testHelloEndpoint() {
        given()
          .auth().oauth2(getAccessToken(`sberyozkin@gmail.com`, "userpassword"))
          .when().get("/hello")
          .then()
             .statusCode(200)
             .body(is("Hello, Sergey Beryozkin"));
    }

    private String getAccessToken(String name, String secret) {
        return oidcTestClient.getAccessToken(name, secret, <i class="conum" data-value="1"></i><b>(1)</b>
            Map.of("audience", "https://quarkus-auth0",
	           "scope", "openid profile"));
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>OidcTestClient</code> is used to acquire an access token, using one of the registered user&#8217;s name and password, as well as the <code>audience</code> and <code>scope</code> parameters.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>OidcTestClient</code> will itself find out the <code>Auth0</code> token endpoint address, client id and secret.</p>
</div>
<div class="paragraph">
<p>Press <code>r</code> again and have the test passing:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/auth0-test-success.png" alt="Auth0 test success">
</div>
</div>
<div class="paragraph">
<p>By the way, if you like, you can run the tests in Continuous mode directly from DevUI:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/auth0-continuous-testing.png" alt="Auth0 Continuous testing">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="production-mode"><a class="anchor" href="#production-mode"></a>Production mode</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You have developed and tested the Quarkus endpoint secured with Auth0 in the development mode.
The next step is to run your application in the production mode.
Choose between JVM and native modes.</p>
</div>
<div class="sect2">
<h3 id="run-the-application-in-jvm-mode"><a class="anchor" href="#run-the-application-in-jvm-mode"></a>Run the Application in JVM mode</h3>
<div class="paragraph">
<p>Compile the application:</p>
</div>
<div class="listingblock primary asciidoc-tabs-sync-cli">
<div class="title">CLI</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">quarkus build</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-sync-maven">
<div class="title">Maven</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw install</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-sync-gradle">
<div class="title">Gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./gradlew build</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run the application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">java -jar target/quarkus-app/quarkus-run.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>Open a browser, access <a href="http://localhost:8080/hello" class="bare">http://localhost:8080/hello</a> and get the name displayed in the browser.</p>
</div>
</div>
<div class="sect2">
<h3 id="run-the-application-in-native-mode"><a class="anchor" href="#run-the-application-in-native-mode"></a>Run the application in native mode</h3>
<div class="paragraph">
<p>You can compile this same demo into native mode without needing any modifications.
This implies that you no longer need to install a JVM on your production environment.
The runtime technology is included in the produced binary and optimized to run with minimal resources required.</p>
</div>
<div class="paragraph">
<p>Compilation takes a bit longer, so this step is disabled by default.</p>
</div>
<div class="paragraph">
<p>Build your application again by enabling the <code>native</code> profile:</p>
</div>
<div class="listingblock primary asciidoc-tabs-sync-cli">
<div class="title">CLI</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">quarkus build --native</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-sync-maven">
<div class="title">Maven</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw install -Dnative</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-sync-gradle">
<div class="title">Gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./gradlew build -Dquarkus.native.enabled=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next run the following binary directly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./target/quarkus-auth0-1.0.0-SNAPSHOT-runner</code></pre>
</div>
</div>
<div class="paragraph">
<p>Open a browser, access <a href="http://localhost:8080/hello" class="bare">http://localhost:8080/hello</a> and get the name displayed in the browser.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="troubleshooting"><a class="anchor" href="#troubleshooting"></a>Troubleshooting</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The steps described in this tutorial should work exactly as the tutorial describes. You might have to clear the browser cookies when accessing the updated Quarkus endpoint if you have already completed the authentication. You might need to restart the Quarkus application manually in dev mode but it is not expected. If you need help completing this tutorial, you can get in touch with the Quarkus team.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="summary"><a class="anchor" href="#summary"></a>Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This tutorial demonstrated how Quarkus endpoints can be secured with the <code>quarkus-oidc</code> extension and Auth0 using Authorization code and Bearer token authentication flows, with both flows being supported by the same endpoint code.
Without writing a single line of code, you have added support for the custom Auth0 logout flow and enabled role-based access control with a custom Auth0 namespace qualified claim.
Token propagation from the front-end endpoint to the microservice endpoint has been achieved by adding the <code>@AccessToken</code> annotation to the microservice REST client.
Microservice endpoint activated the permission-based access control with the <code>@PermissionsAllowed</code> annotation.
You used Quarkus dev mode to update the code and configuration without restarting the endpoint, and you also used the OIDC Dev UI to visualize and test Auth0 tokens.
You used the continuous testing feature of Quarkus to complement OIDC Dev UI tests with integration tests against the live Auth0 development tenant.
Finally, you have run the application in JVM and native modes.</p>
</div>
<div class="paragraph">
<p>Enjoy!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="references"><a class="anchor" href="#references"></a>References</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="security-overview">Quarkus Security overview</a></p>
</li>
<li>
<p><a href="security-oidc-code-flow-authentication">OIDC code flow mechanism for protecting web applications</a></p>
</li>
<li>
<p><a href="security-openid-connect-providers">Configuring well-known OpenID Connect providers</a></p>
</li>
</ul>
</div>
</div>
</div>
    </div>
    <div class="grid__item width-4-12 width-12-12-m tocwrapper">
      <div class="hide-mobile toc"><ul class="sectlevel1">
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#create-an-auth0-application">Create an Auth0 application</a></li>
<li><a href="#create-a-quarkus-application">Create a Quarkus application</a></li>
<li><a href="#test-the-quarkus-endpoint">Test the Quarkus endpoint</a></li>
<li><a href="#looking-at-auth0-tokens-in-the-oidc-dev-ui">Looking at Auth0 tokens in the OIDC Dev UI</a></li>
<li><a href="#logout-support">Logout support</a></li>
<li><a href="#role-based-access-control">Role-based access control</a></li>
<li><a href="#opaque-access-tokens">Access Quarkus with opaque Auth0 access tokens</a></li>
<li><a href="#token-propagation">Propagate access tokens to microservices</a>
<ul class="sectlevel2">
<li><a href="#jwt-access-tokens">Access tokens in JWT format</a></li>
<li><a href="#api-microservice">API microservice</a></li>
<li><a href="#permission-based-access-control">Permission Based Access Control</a></li>
</ul>
</li>
<li><a href="#integration-testing">Integration testing</a></li>
<li><a href="#production-mode">Production mode</a>
<ul class="sectlevel2">
<li><a href="#run-the-application-in-jvm-mode">Run the Application in JVM mode</a></li>
<li><a href="#run-the-application-in-native-mode">Run the application in native mode</a></li>
</ul>
</li>
<li><a href="#troubleshooting">Troubleshooting</a></li>
<li><a href="#summary">Summary</a></li>
<li><a href="#references">References</a></li>
</ul></div>
    </div>
  </div>
  </div>

  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_reverse.svg" class="project-logo" title="Quarkus"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">Quarkus is open. All dependencies of this project are available under the <a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>Apache Software License 2.0</a> or compatible license.<br /><br />This website was built with <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a>, is hosted on <a href='https://pages.github.com/' target='_blank'>GitHub Pages</a> and is completely open source. If you want to make it better, <a href='https://github.com/quarkusio/quarkusio.github.io' target='_blank'>fork the website</a> and show us what you’ve got.</p>

    
      <div class="width-1-12 project-links">
        <span>Navigation</span>
        <ul class="footer-links">
          
          
            <li><a href="/" target="_blank">Home</a></li>
          
          
          
            <li><a href="/about" target="_blank">About</a></li>
          
          
          
            <li><a href="/blog" target="_blank">Blog</a></li>
          
          
          
            <li><a href="/insights" target="_blank">Podcast</a></li>
          
          
          
            <li><a href="/events" target="_blank">Events</a></li>
          
          
          
            <li><a href="/newsletter" target="_blank">Newsletter</a></li>
          
          
          
            <li><a href="/userstories" target="_blank">User Stories</a></li>
          
          
          
            <li><a href="https://github.com/orgs/quarkusio/projects/13/views/1" target="_blank">Roadmap</a></li>
          
          
          
            <li><a href="/security" target="_blank">Security&nbsp;policy</a></li>
          
          
          
            <li><a href="/usage" target="_blank">Usage</a></li>
          
          
          
            <li><a href="/brand" target="_blank">Brand</a></li>
          
          
          
            <li><a href="/desktopwallpapers" target="_blank">Wallpapers</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Follow Us</span>
        <ul class="footer-links">
          
          
            <li><a href="https://x.com/quarkusio" target="_blank">X</a></li>
          
          
          
            <li><a href="https://bsky.app/profile/quarkus.io" target="_blank">Bluesky</a></li>
          
          
          
            <li><a rel="me" href="https://fosstodon.org/@quarkusio" target="_blank">Mastodon</a></li>
            
          
          
            <li><a href="https://www.facebook.com/quarkusio" target="_blank">Facebook</a></li>
          
          
          
            <li><a href="https://www.linkedin.com/company/quarkusio/" target="_blank">Linkedin</a></li>
          
          
          
            <li><a href="https://www.youtube.com/channel/UCaW8QG_QoIk_FnjLgr5eOqg" target="_blank">Youtube</a></li>
          
          
          
            <li><a href="https://github.com/quarkusio" target="_blank">GitHub</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-2-12 project-links">
        <span>Get Help</span>
        <ul class="footer-links">
          
          
            <li><a href="/support" target="_blank">Support</a></li>
          
          
          
            <li><a href="/guides" target="_blank">Guides</a></li>
          
          
          
            <li><a href="/faq" target="_blank">FAQ</a></li>
          
          
          
            <li><a href="/get-started" target="_blank">Get Started</a></li>
          
          
          
            <li><a href="https://stackoverflow.com/questions/tagged/quarkus" target="_blank">Stack Overflow</a></li>
          
          
          
            <li><a href="https://github.com/quarkusio/quarkus/discussions" target="_blank">Discussions</a></li>
          
          
          
            <li><a href="https://groups.google.com/forum/#!forum/quarkus-dev" target="_blank">Development mailing list</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Languages</span>
        <ul class="footer-links">
          
          
            <li><a href="https://quarkus.io/" target="_blank">English</a></li>
          
          
          
            <li><a href="https://pt.quarkus.io/" target="_blank">Português&nbsp;(Brasileiro)</a></li>
          
          
          
            <li><a href="https://es.quarkus.io/" target="_blank">Español</a></li>
          
          
          
            <li><a href="https://cn.quarkus.io/" target="_blank">简体中文</a></li>
          
          
          
            <li><a href="https://ja.quarkus.io/" target="_blank">日本語</a></li>
          
          
        </ul>
      </div>
    

    
      <div class="width-4-12 more-links">
        <span>Quarkus is made of community projects</span>
        <ul class="footer-links">
          
            <li><a blah href="https://vertx.io/" target="_blank">Eclipse Vert.x</a></li>
          
            <li><a blah href="https://smallrye.io" target="_blank">SmallRye</a></li>
          
            <li><a blah href="https://hibernate.org" target="_blank">Hibernate</a></li>
          
            <li><a blah href="https://netty.io" target="_blank">Netty</a></li>
          
            <li><a blah href="https://resteasy.github.io" target="_blank">RESTEasy</a></li>
          
            <li><a blah href="https://camel.apache.org" target="_blank">Apache Camel</a></li>
          
            <li><a blah href="https://microprofile.io" target="_blank">Eclipse MicroProfile</a></li>
          
            <li><a blah href="https://code.quarkus.io/" target="_blank">And many more...</a></li>
          
        </ul>
      </div>
    
  </div>
</div>

  <div class="content redhat-footer">
  <div class="grid-wrapper">
    <span class="licence">
      <i class="fab fa-creative-commons"></i><i class="fab fa-creative-commons-by"></i> <a href="https://creativecommons.org/licenses/by/3.0/" target="_blank">CC by 3.0</a> | <a href="https://www.redhat.com/en/about/privacy-policy">Privacy Policy</a>
    </span>
    <span class="redhat">
      Sponsored by
    </span>
    <span class="redhat-logo">
      <a href="https://www.redhat.com/" target="_blank"><img src="/assets/images/redhat_reversed.svg"></a>
    </span>
  </div>
</div>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/scroll-down.js"></script>
  <script src="/assets/javascript/satellite.js" type="text/javascript"></script>
  <script src="/guides/javascript/config.js" type="text/javascript"></script>
  <script src="/assets/javascript/guides-version-dropdown.js" type="text/javascript"></script>
  <script src="/assets/javascript/back-to-top.js" type="text/javascript"></script>
  <script src="/assets/javascript/clipboard.min.js" type="text/javascript"></script>
  <script src="/assets/javascript/copy.js" type="text/javascript"></script>
  <script src="/assets/javascript/asciidoc-tabs.js" type="text/javascript"></script>
  <script src="/assets/javascript/future-date.js" type="text/javascript"></script>
</body>

</html>
