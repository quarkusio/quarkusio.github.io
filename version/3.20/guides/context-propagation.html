<!DOCTYPE html>
<html lang="en">







<head>
  <title>Context Propagation in Quarkus - 3.20 - Quarkus</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="
  connect-src 'self' https://dpm.demdex.net https://adobedc.demdex.net https://analytics.ossupstream.org/ https://search.quarkus.io https://smetrics.redhat.com; 
  script-src 'self' 'unsafe-inline' 'unsafe-eval'
      
      https://assets.adobedtm.com
      js.bizographics.com
      https://www.redhat.com
      https://static.redhat.com
      https://app.requestly.io/
      jsonip.com
      https://ajax.googleapis.com
      https://use.fontawesome.com
      http://www.youtube.com
      http://www.googleadservices.com
      https://googleads.g.doubleclick.net
      https://giscus.app
      https://analytics.ossupstream.org/
      https://app.mailjet.com;

  style-src 'self' https://fonts.googleapis.com https://use.fontawesome.com; 
  img-src 'self' * data:; 
  media-src 'self'; 
  frame-src https://redhat.demdex.net https://www.youtube.com https://player.restream.io https://app.mailjet.com http://xy0p2.mjt.lu https://mj.quarkus.io https://giscus.app; 
  base-uri 'none'; 
  object-src 'none'; 
  form-action 'none'; 
  font-src 'self' https://use.fontawesome.com https://fonts.gstatic.com;" />
  <script id="adobe_dtm" src="https://www.redhat.com/dtm.js" type="text/javascript"></script>
  <script src="/assets/javascript/highlight.pack.js" type="text/javascript"></script>
  <META HTTP-EQUIV='X-XSS-Protection' CONTENT="1; mode=block">
  <META HTTP-EQUIV='X-Content-Type-Options' CONTENT="nosniff">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Quarkus: Supersonic Subatomic Java">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@QuarkusIO"> 
  <meta name="twitter:creator" content="@QuarkusIO">
  <meta property="og:url" content="https://quarkus.io/version/3.20/guides/context-propagation" />
  <meta property="og:title" content="Context Propagation in Quarkus - 3.20" />
  <meta property="og:description" content="Quarkus: Supersonic Subatomic Java" />
  <meta property="og:image" content="https://quarkus.io/assets/images/quarkus_card.png" />
  
  <link rel="canonical" href="https://quarkus.io/guides/context-propagation">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/guides/stylesheet/config.css" />
  <link rel="stylesheet" href="/assets/css/main.css?2021-07-29" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.5.2/css/all.css" crossorigin="anonymous">
  <link rel="alternate" type="application/rss+xml"  href="/feed.xml" title="Quarkus">
  <script src="/assets/javascript/hl.js" type="text/javascript"></script>
  
  
  
  
  <link rel="alternate" hreflang="en" href="https://quarkus.io/version/3.20/guides/context-propagation" />
  
  <link rel="alternate" hreflang="pt-br" href="https://pt.quarkus.io/version/3.20/guides/context-propagation" />
  
  <link rel="alternate" hreflang="es" href="https://es.quarkus.io/version/3.20/guides/context-propagation" />
  
  <link rel="alternate" hreflang="zh" href="https://cn.quarkus.io/version/3.20/guides/context-propagation" />
  
  <link rel="alternate" hreflang="ja" href="https://ja.quarkus.io/version/3.20/guides/context-propagation" />
  
  <link rel="alternate" hreflang="x-default" href="https://quarkus.io/" />  
  <script src="/assets/javascript/tracking.js"></script>
  
  <script src="/assets/javascript/colormode.js" type="text/javascript"></script>

</head>

<body class="guides">

  
  <div class="nav-wrapper">
  <div class="grid-wrapper">
    <div class="width-12-12">
      <input type="checkbox" id="checkbox" />
      <nav id="main-nav" class="main-nav">
        <div class="logo-wrapper">
           <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_600px_reverse.png" class="project-logo" title="Quarkus"></a>
        </div>
    <label class="nav-toggle" for="checkbox">
      <i class="fa fa-bars"></i>
    </label>
    <ul id="menu" class="menu">
      <li class="dropdown">
        <span href="/about/">Why<i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/about" class="">WHAT IS QUARKUS?</a></li>
          <li><a href="/developer-joy" class="">DEVELOPER JOY</a></li>
          <li><a href="/performance" class="">PERFORMANCE</a></li>
          <li><a href="/kubernetes-native" class="">KUBERNETES NATIVE</a></li>
          <li><a href="/standards" class="">STANDARDS</a></li>
          <li><a href="/versatility" class="">VERSATILITY</a></li>
          <li><a href="/container-first" class="">CONTAINER FIRST</a></li>          
        </ul>
      </li>
      <li class="dropdown">
        <span href="/learn/">Learn<i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/get-started" class="">GET STARTED</a></li>
          <li><a href="/guides" class="active">DOCUMENTATION</a></li>
          <li><a href="/userstories/" class="">USER STORIES</a></li>  
          <li><a href="/qtips" class="">"Q" TIP VIDEOS</a></li>          
          <li><a href="/books" class="">BOOKS</a></li>
          </ul>
      </li>
      <li class="dropdown">
        <span href="https://quarkus.io/extensions/">Extensions<i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <!-- Note that quarkus.io is hardcoded here, because it is the only url which supports extensions -->
          <li><a href="https://quarkus.io/extensions/" class="">BROWSE EXTENSIONS</a></li>
          <li><a href="/faq/#what-is-a-quarkus-extension" class="">USE EXTENSIONS</a></li>
          <li><a href="/guides/writing-extensions" class="">CREATE EXTENSIONS</a></li>
          <li><a href="https://hub.quarkiverse.io" class="">SHARE EXTENSIONS</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="/community/">Community<i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/support/" class="">SUPPORT</a></li>
          <li><a href="/blog" class="">BLOG</a></li>
          <li><a href="/discussion" class="">DISCUSSION</a></li>
          <li><a href="/working-groups" class="">WORKING GROUPS</a></li>
          <li><a href="/insights" class="">PODCAST</a></li>
          <li><a href="/events" class="">EVENTS</a></li>
          <li><a href="/newsletter" class="">NEWSLETTER</a></li>
          <li><a href="https://github.com/orgs/quarkusio/projects/13/views/1" class="">ROADMAP</a></li>
          </ul>
      </li>
      <li>
        <a href="https://code.quarkus.io" class="button-cta secondary white">START CODING</a>
      </li>
      <li class="dropdown">
        <span href="/language/"><div class="fas fa-globe langicon"></div><i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="https://quarkus.io/version/3.20/guides/context-propagation" >OFFICIAL (ENGLISH)</a></li>
          <li><a href="https://pt.quarkus.io/version/3.20/guides/context-propagation">PORTUGUÊS (BR)</a></li>
          <li><a href="https://es.quarkus.io/version/3.20/guides/context-propagation">ESPAÑOL</a></li>
          <li><a href="https://cn.quarkus.io/version/3.20/guides/context-propagation">简体中文</a></li>
          <li><a href="https://ja.quarkus.io/version/3.20/guides/context-propagation">日本語</a></li>
          </ul>
      </li>
      <li>
        <span href="#" class="modeswitcher" id='theme-toggle'><i class="fas fa-sun"></i><i class="fas fa-moon"></i><i class="fas fa-cog"></i></span>
      </li>
    </ul>
      </nav>
    </div>
  </div>
</div>

  <div class="content">
    







<section class="full-width-version-bg flexfilterbar guides">
  <div class="guideflexcontainer">
    <div class="docslink">
      <a class="returnlink" href="/version/3.20/guides/"> Back to Guides</a>
    </div>
    <div class="flexlabel">
      <label>By Version</label>
    </div>
    <div class="guidepulldown version">
    <select id="guide-version-dropdown">
      
        
        
        <option value="main" >Main - SNAPSHOT</option>
        
        
        
        <option value="latest" >3.23.4 - Latest</option>
        
        
        
        <option value="3.20" selected>3.20</option>
        
        
        
        <option value="3.15" >3.15</option>
        
        
        
        <option value="3.8" >3.8</option>
        
        
        
        <option value="3.2" >3.2</option>
        
        
        
        <option value="2.16" >2.16</option>
        
        
        
        <option value="2.13" >2.13</option>
        </select>
    </div>
  </div>
</section>

<div class="guide">
  <div class="grid-wrapper">
    <div class="grid__item width-8-12 width-12-12-m">
      
      <h1 class="text-caps">Context Propagation in Quarkus </h1>
      <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Traditional blocking code uses <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/ThreadLocal.html"><code>ThreadLocal</code></a>
 variables to store contextual objects in order to avoid
passing them as parameters everywhere. Many Quarkus extensions require those contextual objects to operate
properly: <a href="rest-json">Quarkus REST (formerly RESTEasy Reactive)</a>, <a href="cdi-reference">ArC</a> and <a href="transaction">Transaction</a>
for example.</p>
</div>
<div class="paragraph">
<p>If you write reactive/async code, you have to cut your work into a pipeline of code blocks that get executed
"later", and in practice after the method you defined them in have returned. As such, <code>try/finally</code> blocks
as well as <code>ThreadLocal</code> variables stop working, because your reactive code gets executed in another thread,
after the caller ran its <code>finally</code> block.</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/smallrye/smallrye-context-propagation">SmallRye Context Propagation</a> an implementation of
<a href="https://github.com/eclipse/microprofile-context-propagation">MicroProfile Context Propagation</a> was made to
make those Quarkus extensions work properly in reactive/async settings. It works by capturing those contextual
values that used to be in thread-locals, and restoring them when your code is called.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="solution"><a class="anchor" href="#solution"></a>Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We recommend that you follow the instructions in the next sections and create the application step by step.
However, you can go right to the completed example.</p>
</div>
<div class="paragraph">
<p>Clone the Git repository: <code>git clone -b 3.20 <a href="https://github.com/quarkusio/quarkus-quickstarts.git" class="bare">https://github.com/quarkusio/quarkus-quickstarts.git</a></code>, or download an <a href="https://github.com/quarkusio/quarkus-quickstarts/archive/3.20.zip">archive</a>.</p>
</div>
<div class="paragraph">
<p>The solution is located in the <code>context-propagation-quickstart</code> <a href="https://github.com/quarkusio/quarkus-quickstarts/tree/3.20/context-propagation-quickstart">directory</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="setting-it-up"><a class="anchor" href="#setting-it-up"></a>Setting it up</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you are using <a href="https://smallrye.io/smallrye-mutiny">Mutiny</a> (the <code>quarkus-mutiny</code> extension), you just need to add
the <code>quarkus-smallrye-context-propagation</code> extension to enable context propagation.</p>
</div>
<div class="paragraph">
<p>In other words, add the following dependencies to your build file:</p>
</div>
<div class="listingblock primary asciidoc-tabs-target-sync-cli asciidoc-tabs-target-sync-maven">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;!-- Quarkus REST extension if not already included --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-rest&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;!-- Context Propagation extension --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-smallrye-context-propagation&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-target-sync-gradle">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gradle hljs" data-lang="gradle">// Quarkus REST extension if not already included
implementation("io.quarkus:quarkus-rest")
// Context Propagation extension
implementation("io.quarkus:quarkus-smallrye-context-propagation")</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this, you will get context propagation for ArC, Quarkus REST and transactions, if you are using them.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="usage-example-with-mutiny"><a class="anchor" href="#usage-example-with-mutiny"></a>Usage example with Mutiny</h2>
<div class="sectionbody">
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Mutiny</div>
<div class="paragraph">
<p>This section uses Mutiny reactive types.
If you are not familiar with Mutiny, check <a href="mutiny-primer">Mutiny - an intuitive reactive programming library</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s write a REST endpoint that reads the next 3 items from a <a href="kafka">Kafka topic</a>, stores them in a database using
<a href="hibernate-orm-panache">Hibernate ORM with Panache</a> (all in the same transaction) before returning
them to the client, you can do it like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    // Get the prices stream
    @Inject
    @Channel("prices") Publisher&lt;Double&gt; prices;

    @Transactional
    @GET
    @Path("/prices")
    @RestStreamElementType(MediaType.TEXT_PLAIN)
    public Publisher&lt;Double&gt; prices() {
        // get the next three prices from the price stream
        return Multi.createFrom().publisher(prices)
                .select().first(3)
                // The items are received from the event loop, so cannot use Hibernate ORM (classic)
                // Switch to a worker thread, the transaction will be propagated
                .emitOn(Infrastructure.getDefaultExecutor())
                .map(price -&gt; {
                    // store each price before we send them
                    Price priceEntity = new Price();
                    priceEntity.value = price;
                    // here we are all in the same transaction
                    // thanks to context propagation
                    priceEntity.persist();
                    return price;
                    // the transaction is committed once the stream completes
                });
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that thanks to Mutiny support for context propagation, this works out of the box.
The 3 items are persisted using the same transaction and this transaction is committed when the stream completes.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="usage-example-for-completionstage"><a class="anchor" href="#usage-example-for-completionstage"></a>Usage example for <code>CompletionStage</code></h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you are using <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/CompletionStage.html"><code>CompletionStage</code></a>
you need manual context propagation. You can do that by injecting a <code>ThreadContext</code>
or <code>ManagedExecutor</code> that will propagate every context. For example, here we use the <a href="vertx">Vert.x Web Client</a>
to get the list of Star Wars people, then store them in the database using
<a href="hibernate-orm-panache">Hibernate ORM with Panache</a> (all in the same transaction) before returning
them to the client as JSON using <a href="rest-json">Jackson or JSON-B</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    @Inject ThreadContext threadContext;
    @Inject ManagedExecutor managedExecutor;
    @Inject Vertx vertx;

    @Transactional
    @GET
    @Path("/people")
    public CompletionStage&lt;List&lt;Person&gt;&gt; people() throws SystemException {
        // Create a REST client to the Star Wars API
        WebClient client = WebClient.create(vertx,
                         new WebClientOptions()
                          .setDefaultHost("swapi.tech")
                          .setDefaultPort(443)
                          .setSsl(true));
        // get the list of Star Wars people, with context capture
        return threadContext.withContextCapture(client.get("/api/people/").send())
                .thenApplyAsync(response -&gt; {
                    JsonObject json = response.bodyAsJsonObject();
                    List&lt;Person&gt; persons = new ArrayList&lt;&gt;(json.getInteger("count"));
                    // Store them in the DB
                    // Note that we're still in the same transaction as the outer method
                    for (Object element : json.getJsonArray("results")) {
                        Person person = new Person();
                        person.name = ((JsonObject) element).getString("name");
                        person.persist();
                        persons.add(person);
                    }
                    return persons;
                }, managedExecutor);
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using <code>ThreadContext</code> or <code>ManagedExecutor</code> you can wrap most useful functional types and <code>CompletionStage</code>
in order to get context propagated.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The injected <code>ManagedExecutor</code> uses the Quarkus thread pool.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="overriding-which-contexts-are-propagated"><a class="anchor" href="#overriding-which-contexts-are-propagated"></a>Overriding which contexts are propagated</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By default, all available contexts are propagated. However, you can override this behaviour in several ways.</p>
</div>
<div class="sect2">
<h3 id="using-configuration"><a class="anchor" href="#using-configuration"></a>Using configuration</h3>
<div class="paragraph">
<p>The following configuration properties allow you to specify the default sets of propagated contexts:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Configuration property</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>mp.context.ThreadContext.propagated</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The comma-separated set of propagated contexts</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Remaining</code> (all non-explicitly list contexts)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>mp.context.ThreadContext.cleared</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The comma-separated set of cleared contexts</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>None</code> (no context), unless neither the propagated nor cleared sets contain <code>Remaining</code>, in which case the default is <code>Remaining</code> (all non-explicitly listed contexts)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>mp.context.ThreadContext.unchanged</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The comma-separated set of unchanged contexts</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>None</code> (no context)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following contexts are available in Quarkus either out of the box, or depending on whether you include
their extensions:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Context Name</th>
<th class="tableblock halign-left valign-top">Name Constant</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>None</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://javadoc.io/static/org.eclipse.microprofile.context-propagation/microprofile-context-propagation-api/1.2/org/eclipse/microprofile/context/ThreadContext.html#NONE"><code>ThreadContext.NONE</code></a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Can be used to specify an empty set of contexts, but setting the value to empty works too</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Remaining</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://javadoc.io/static/org.eclipse.microprofile.context-propagation/microprofile-context-propagation-api/1.2/org/eclipse/microprofile/context/ThreadContext.html#ALL_REMAINING"><code>ThreadContext.ALL_REMAINING</code></a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All the contexts that are not explicitly listed in other sets</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Transaction</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://javadoc.io/static/org.eclipse.microprofile.context-propagation/microprofile-context-propagation-api/1.2/org/eclipse/microprofile/context/ThreadContext.html#TRANSACTION"><code>ThreadContext.TRANSACTION</code></a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The JTA transaction context</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CDI</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://javadoc.io/static/org.eclipse.microprofile.context-propagation/microprofile-context-propagation-api/1.2/org/eclipse/microprofile/context/ThreadContext.html#CDI"><code>ThreadContext.CDI</code></a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The CDI (ArC) context</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Servlet</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The servlet context</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Jakarta REST</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Quarkus REST or RESTEasy Classic context</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Application</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://javadoc.io/static/org.eclipse.microprofile.context-propagation/microprofile-context-propagation-api/1.2/org/eclipse/microprofile/context/ThreadContext.html#APPLICATION"><code>ThreadContext.APPLICATION</code></a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The current <code>ThreadContextClassLoader</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="overriding-the-propagated-contexts-using-annotations"><a class="anchor" href="#overriding-the-propagated-contexts-using-annotations"></a>Overriding the propagated contexts using annotations</h3>
<div class="paragraph">
<p>In order for automatic context propagation, such as Mutiny uses, to be overridden in specific methods,
you can use the <a href="https://javadoc.io/doc/io.smallrye/smallrye-context-propagation-api/latest/io/smallrye/context/api/CurrentThreadContext.html"><code>@CurrentThreadContext</code></a>
annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    // Get the prices stream
    @Inject
    @Channel("prices") Publisher&lt;Double&gt; prices;

    @GET
    @Path("/prices")
    @RestStreamElementType(MediaType.TEXT_PLAIN)
    // Get rid of all context propagation, since we don't need it here
    @CurrentThreadContext(propagated = {}, unchanged = ThreadContext.ALL_REMAINING)
    public Publisher&lt;Double&gt; prices() {
        // get the next three prices from the price stream
        return Multi.createFrom().publisher(prices)
                .select().first(3);
    }</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="overriding-the-propagated-contexts-using-cdi-injection"><a class="anchor" href="#overriding-the-propagated-contexts-using-cdi-injection"></a>Overriding the propagated contexts using CDI injection</h3>
<div class="paragraph">
<p>You can also inject a custom-built <code>ThreadContext</code> using the <a href="https://javadoc.io/doc/io.smallrye/smallrye-context-propagation-api/latest/io/smallrye/context/api/ThreadContextConfig.html"><code>@ThreadContextConfig</code></a> annotation on your injection point:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    // Get the prices stream
    @Inject
    @Channel("prices") Publisher&lt;Double&gt; prices;
    // Get a ThreadContext that doesn't propagate context
    @Inject
    @ThreadContextConfig(unchanged = ThreadContext.ALL_REMAINING)
    SmallRyeThreadContext threadContext;

    @GET
    @Path("/prices")
    @RestStreamElementType(MediaType.TEXT_PLAIN)
    public Publisher&lt;Double&gt; prices() {
        // Get rid of all context propagation, since we don't need it here
        try(CleanAutoCloseable ac = SmallRyeThreadContext.withThreadContext(threadContext)){
            // get the next three prices from the price stream
            return Multi.createFrom().publisher(prices)
                    .select().first(3);
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Likewise, there is a similar way to inject a configured instance of <code>ManagedExecutor</code> using the <a href="https://javadoc.io/doc/io.smallrye/smallrye-context-propagation-api/latest/io/smallrye/context/api/ManagedExecutorConfig.html"><code>@ManagedExecutorConfig</code></a> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    // Custom ManagedExecutor with different async limit, queue and no propagation
    @Inject
    @ManagedExecutorConfig(maxAsync = 2, maxQueued = 3, cleared = ThreadContext.ALL_REMAINING)
    ManagedExecutor configuredCustomExecutor;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sharing-configured-cdi-instances-of-managedexecutor-and-threadcontext"><a class="anchor" href="#sharing-configured-cdi-instances-of-managedexecutor-and-threadcontext"></a>Sharing configured CDI instances of ManagedExecutor and ThreadContext</h3>
<div class="paragraph">
<p>If you need to inject the same <code>ManagedExecutor</code> or <code>ThreadContext</code> into several places and share its capacity, you can name the instance with <a href="https://javadoc.io/doc/io.smallrye/smallrye-context-propagation-api/latest/io/smallrye/context/api/NamedInstance.html"><code>@NamedInstance</code></a> annotation.
<code>@NamedInstance</code> is a CDI qualifier and all injections of the same type and name will therefore share the same underlying instance.
If you also need to customize your instance, you can do so using <code>@ManagedExecutorConfig</code>/<code>ThreadContextConfig</code> annotation on one of its injection points:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    // Custom configured ManagedExecutor with name
    @Inject
    @ManagedExecutorConfig(maxAsync = 2, maxQueued = 3, cleared = ThreadContext.ALL_REMAINING)
    @NamedInstance("myExecutor")
    ManagedExecutor sharedConfiguredExecutor;

    // Since this executor has the same name, it will be the same instance as above
    @Inject
    @NamedInstance("myExecutor")
    ManagedExecutor sameExecutor;

    // Custom ThreadContext with a name
    @Inject
    @ThreadContextConfig(unchanged = ThreadContext.ALL_REMAINING)
    @NamedInstance("myContext")
    ThreadContext sharedConfiguredThreadContext;

    // Given equal value of @NamedInstance, this ThreadContext will be the same as the above one
    @Inject
    @NamedInstance("myContext")
    ThreadContext sameContext;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="context-propagation-for-cdi"><a class="anchor" href="#context-propagation-for-cdi"></a>Context Propagation for CDI</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In terms of CDI, <code>@RequestScoped</code>, <code>@ApplicationScoped</code> and <code>@Singleton</code> beans get propagated and are available in other threads.
<code>@Dependent</code> beans as well as any custom scoped beans cannot be automatically propagated via CDI Context Propagation.</p>
</div>
<div class="paragraph">
<p><code>@ApplicationScoped</code> and <code>@Singleton</code> beans are always active scopes and as such are easy to deal with - context propagation tasks can work with those beans so long as the CDI container is running.
However, <code>@RequestScoped</code> beans are a different story. They are only active for a short period of time which can be bound either to HTTP request or some other request/task when manually activated/deactivated.
In this case user must be aware that once the original thread gets to an end of a request, it will terminate the context, calling <code>@PreDestroy</code> on those beans and then clearing them from the context.
Subsequent attempts to access those beans from other threads can result in unexpected behaviour.
It is therefore recommended to make sure all tasks using request scoped beans via context propagation are performed in such a manner that they don&#8217;t outlive the original request duration.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Due to the above described behavior, it is recommended to avoid using <code>@PreDestroy</code> on <code>@RequestScoped</code> beans when working with Context Propagation in CDI.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
    </div>
    <div class="grid__item width-4-12 width-12-12-m tocwrapper">
      <div class="hide-mobile toc"><ul class="sectlevel1">
<li><a href="#solution">Solution</a></li>
<li><a href="#setting-it-up">Setting it up</a></li>
<li><a href="#usage-example-with-mutiny">Usage example with Mutiny</a></li>
<li><a href="#usage-example-for-completionstage">Usage example for <code>CompletionStage</code></a></li>
<li><a href="#overriding-which-contexts-are-propagated">Overriding which contexts are propagated</a>
<ul class="sectlevel2">
<li><a href="#using-configuration">Using configuration</a></li>
<li><a href="#overriding-the-propagated-contexts-using-annotations">Overriding the propagated contexts using annotations</a></li>
<li><a href="#overriding-the-propagated-contexts-using-cdi-injection">Overriding the propagated contexts using CDI injection</a></li>
<li><a href="#sharing-configured-cdi-instances-of-managedexecutor-and-threadcontext">Sharing configured CDI instances of ManagedExecutor and ThreadContext</a></li>
</ul>
</li>
<li><a href="#context-propagation-for-cdi">Context Propagation for CDI</a></li>
</ul></div>
    </div>
  </div>
  </div>

  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_reverse.svg" class="project-logo" title="Quarkus"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">Quarkus is open. All dependencies of this project are available under the <a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>Apache Software License 2.0</a> or compatible license.<br /><br />This website was built with <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a>, is hosted on <a href='https://pages.github.com/' target='_blank'>GitHub Pages</a> and is completely open source. If you want to make it better, <a href='https://github.com/quarkusio/quarkusio.github.io' target='_blank'>fork the website</a> and show us what you’ve got.</p>

    
      <div class="width-1-12 project-links">
        <span>Navigation</span>
        <ul class="footer-links">
          
          
            <li><a href="/" target="_blank">Home</a></li>
          
          
          
            <li><a href="/about" target="_blank">About</a></li>
          
          
          
            <li><a href="/blog" target="_blank">Blog</a></li>
          
          
          
            <li><a href="/insights" target="_blank">Podcast</a></li>
          
          
          
            <li><a href="/events" target="_blank">Events</a></li>
          
          
          
            <li><a href="/newsletter" target="_blank">Newsletter</a></li>
          
          
          
            <li><a href="/userstories" target="_blank">User Stories</a></li>
          
          
          
            <li><a href="https://github.com/orgs/quarkusio/projects/13/views/1" target="_blank">Roadmap</a></li>
          
          
          
            <li><a href="/security" target="_blank">Security&nbsp;policy</a></li>
          
          
          
            <li><a href="/usage" target="_blank">Usage</a></li>
          
          
          
            <li><a href="/brand" target="_blank">Brand</a></li>
          
          
          
            <li><a href="/desktopwallpapers" target="_blank">Wallpapers</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Follow Us</span>
        <ul class="footer-links">
          
          
            <li><a href="https://x.com/quarkusio" target="_blank">X</a></li>
          
          
          
            <li><a href="https://bsky.app/profile/quarkus.io" target="_blank">Bluesky</a></li>
          
          
          
            <li><a rel="me" href="https://fosstodon.org/@quarkusio" target="_blank">Mastodon</a></li>
            
          
          
            <li><a href="https://www.facebook.com/quarkusio" target="_blank">Facebook</a></li>
          
          
          
            <li><a href="https://www.linkedin.com/company/quarkusio/" target="_blank">Linkedin</a></li>
          
          
          
            <li><a href="https://www.youtube.com/channel/UCaW8QG_QoIk_FnjLgr5eOqg" target="_blank">Youtube</a></li>
          
          
          
            <li><a href="https://github.com/quarkusio" target="_blank">GitHub</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-2-12 project-links">
        <span>Get Help</span>
        <ul class="footer-links">
          
          
            <li><a href="/support" target="_blank">Support</a></li>
          
          
          
            <li><a href="/guides" target="_blank">Guides</a></li>
          
          
          
            <li><a href="/faq" target="_blank">FAQ</a></li>
          
          
          
            <li><a href="/get-started" target="_blank">Get Started</a></li>
          
          
          
            <li><a href="https://stackoverflow.com/questions/tagged/quarkus" target="_blank">Stack Overflow</a></li>
          
          
          
            <li><a href="https://github.com/quarkusio/quarkus/discussions" target="_blank">Discussions</a></li>
          
          
          
            <li><a href="https://groups.google.com/forum/#!forum/quarkus-dev" target="_blank">Development mailing list</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Languages</span>
        <ul class="footer-links">
          
          
            <li><a href="https://quarkus.io/" target="_blank">English</a></li>
          
          
          
            <li><a href="https://pt.quarkus.io/" target="_blank">Português&nbsp;(Brasileiro)</a></li>
          
          
          
            <li><a href="https://es.quarkus.io/" target="_blank">Español</a></li>
          
          
          
            <li><a href="https://cn.quarkus.io/" target="_blank">简体中文</a></li>
          
          
          
            <li><a href="https://ja.quarkus.io/" target="_blank">日本語</a></li>
          
          
        </ul>
      </div>
    

    
      <div class="width-4-12 more-links">
        <span>Quarkus is made of community projects</span>
        <ul class="footer-links">
          
            <li><a blah href="https://vertx.io/" target="_blank">Eclipse Vert.x</a></li>
          
            <li><a blah href="https://smallrye.io" target="_blank">SmallRye</a></li>
          
            <li><a blah href="https://hibernate.org" target="_blank">Hibernate</a></li>
          
            <li><a blah href="https://netty.io" target="_blank">Netty</a></li>
          
            <li><a blah href="https://resteasy.github.io" target="_blank">RESTEasy</a></li>
          
            <li><a blah href="https://camel.apache.org" target="_blank">Apache Camel</a></li>
          
            <li><a blah href="https://microprofile.io" target="_blank">Eclipse MicroProfile</a></li>
          
            <li><a blah href="https://code.quarkus.io/" target="_blank">And many more...</a></li>
          
        </ul>
      </div>
    
  </div>
</div>

  <div class="content redhat-footer">
  <div class="grid-wrapper">
    <span class="licence">
      <i class="fab fa-creative-commons"></i><i class="fab fa-creative-commons-by"></i> <a href="https://creativecommons.org/licenses/by/3.0/" target="_blank">CC by 3.0</a> | <a href="https://www.redhat.com/en/about/privacy-policy">Privacy Policy</a>
    </span>
    <span class="redhat">
      Sponsored by
    </span>
    <span class="redhat-logo">
      <a href="https://www.redhat.com/" target="_blank"><img src="/assets/images/redhat_reversed.svg"></a>
    </span>
  </div>
</div>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/scroll-down.js"></script>
  <script src="/assets/javascript/satellite.js" type="text/javascript"></script>
  <script src="/guides/javascript/config.js" type="text/javascript"></script>
  <script src="/assets/javascript/guides-version-dropdown.js" type="text/javascript"></script>
  <script src="/assets/javascript/back-to-top.js" type="text/javascript"></script>
  <script src="/assets/javascript/clipboard.min.js" type="text/javascript"></script>
  <script src="/assets/javascript/copy.js" type="text/javascript"></script>
  <script src="/assets/javascript/asciidoc-tabs.js" type="text/javascript"></script>
  <script src="/assets/javascript/future-date.js" type="text/javascript"></script>
</body>

</html>
